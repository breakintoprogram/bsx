# file opened: h:\My Code\Breadboard Z80\Z80\BBC Basic\build.z80
   1  0000              			ORG 0x8200
   2  8200
   3  8200              			MODULE BUILD
   4  8200
   5  8200 CD 4E 8E     			CALL    TELL
   6  8203 42 53 58 20  			DEFM	"BSX Breadboard Computer 0.1\n\r"
   6  8207 42 72 65 61
   6  820B 64 62 6F 61
   6  820F 72 64 20 43
   6  8213 6F 6D 70 75
   6  8217 74 65 72 20
   6  821B 30 2E 31 0A
   6  821F 0D
   7  8220 0A 0D        			DEFM	"\n\r"
   8  8222 00           			DEFB    0
   9  8223
  10  8223              			include "main.z80"
# file opened: h:\My Code\Breadboard Z80\Z80\BBC Basic\main.z80
   1+ 8223              ;
   2+ 8223              ;BBC BASIC INTERPRETER - Z80 VERSION
   3+ 8223              ;COMMAND, ERROR AND LEXICAL ANALYSIS MODULE - "MAIN"
   4+ 8223              ;(C) COPYRIGHT  R.T.RUSSELL  1984
   5+ 8223              ;VERSION 2.3, 07-05-1984
   6+ 8223              ;VERSION 3.0, 01-03-1987
   7+ 8223              ;
   8+ 8223              			MODULE MAIN
   9+ 8223              ;
  10+ 8223              TERROR:			EQU     85H
  11+ 8223              LINE:			EQU     86H
  12+ 8223              ELSE:			EQU     8BH
  13+ 8223              THEN:			EQU     8CH
  14+ 8223              LINO:			EQU     8DH
  15+ 8223              FN:			EQU     0A4H
  16+ 8223              TO:			EQU     0B8H
  17+ 8223              REN:			EQU     0CCH
  18+ 8223              DATA:			EQU     0DCH
  19+ 8223              DIM:			EQU     0DEH
  20+ 8223              FOR:			EQU     0E3H
  21+ 8223              GOSUB:			EQU     0E4H
  22+ 8223              GOTO:			EQU     0E5H
  23+ 8223              TIF:			EQU     0E7H
  24+ 8223              LOCAL:			EQU     0EAH
  25+ 8223              NEXT:			EQU     0EDH
  26+ 8223              ON:			EQU     0EEH
  27+ 8223              PROC:			EQU     0F2H
  28+ 8223              REM:			EQU     0F4H
  29+ 8223              REPEAT:			EQU     0F5H
  30+ 8223              RESTOR:			EQU     0F7H
  31+ 8223              TRACE:			EQU     0FCH
  32+ 8223              UNTIL:			EQU     0FDH
  33+ 8223              ;
  34+ 8223              TOKLO:			EQU     8FH
  35+ 8223              TOKHI:			EQU     93H
  36+ 8223              OFFSET:			EQU     0CFH-TOKLO
  37+ 8223
  38+ 8223              ;START:			JP      COLD
  39+ 8223              ;			JP      WARM
  40+ 8223              ;			JP      ESCAPE
  41+ 8223              ;			JP      EXTERR
  42+ 8223              ;			JP      TELL
  43+ 8223              ;			JP      TEXT
  44+ 8223              ;			JP      SETTOP
  45+ 8223              ;			JP      CLEAR
  46+ 8223              ;			JP      RUN0
  47+ 8223              ;			JP      OSCLI
  48+ 8223              ;			JP      OSBGET
  49+ 8223              ;			JP      OSBPUT
  50+ 8223              ;			JP      OSSTAT
  51+ 8223              ;			JP      OSSHUT
  52+ 8223
  53+ 8223 21 00 B6     COLD:			LD      HL,STAVAR       ;COLD START
  54+ 8226 F9           			LD      SP,HL
  55+ 8227 36 0A        			LD      (HL),10
  56+ 8229 2C           			INC     L
  57+ 822A 36 09        			LD      (HL),9
  58+ 822C 2C           			INC     L
  59+ 822D AF           			XOR     A
  60+ 822E 77           PURGE:			LD      (HL),A          ;CLEAR SCRATCHPAD
  61+ 822F 2C           			INC     L
  62+ 8230 20 FC        			JR      NZ,PURGE
  63+ 8232 3E 37        			LD      A,37H           ;V3.0
  64+ 8234 32 FE B6     			LD      (LISTON),A
  65+ 8237 21 6E 82     			LD      HL,NOTICE
  66+ 823A 22 EE B6     			LD      (ERRTXT),HL
  67+ 823D CD E6 B2     			CALL    OSINIT
  68+ 8240 ED 53 E4 B6  			LD      (HIMEM),DE
  69+ 8244 22 DC B6     			LD      (PAGE),HL
  70+ 8247 CD E7 89     			CALL    NEWIT
  71+ 824A C2 D3 8E     			JP      NZ,CHAIN0       ;AUTO-RUN
  72+ 824D CD 4E 8E     			CALL    TELL
  73+ 8250 42 42 43 20  			DEFM    "BBC BASIC (Z80) Version 3.00\n\r"
  73+ 8254 42 41 53 49
  73+ 8258 43 20 28 5A
  73+ 825C 38 30 29 20
  73+ 8260 56 65 72 73
  73+ 8264 69 6F 6E 20
  73+ 8268 33 2E 30 30
  73+ 826C 0A 0D
  74+ 826E 28 43 29 20  NOTICE:			DEFM    "(C) Copyright R.T.Russell 1987\n\r"
  74+ 8272 43 6F 70 79
  74+ 8276 72 69 67 68
  74+ 827A 74 20 52 2E
  74+ 827E 54 2E 52 75
  74+ 8282 73 73 65 6C
  74+ 8286 6C 20 31 39
  74+ 828A 38 37 0A 0D
  75+ 828E 0A 0D        			DEFM	"\n\r"
  76+ 8290 00           			DEFB    0
  77+ 8291 F6           @WARM:			DEFB    0F6H
  78+ 8292 37           @CLOOP:			SCF
  79+ 8293 ED 7B E4 B6  			LD      SP,(HIMEM)
  80+ 8297 CD D7 B2     			CALL    PROMPT          ;PROMPT USER
  81+ 829A 21 FE B6     			LD      HL,LISTON
  82+ 829D 7E           			LD      A,(HL)
  83+ 829E E6 0F        			AND     0FH             ;LISTO
  84+ 82A0 F6 30        			OR      30H             ;OPT 3
  85+ 82A2 77           			LD      (HL),A
  86+ 82A3 ED 62        			SBC     HL,HL           ;HL <- 0 (V3.0)
  87+ 82A5 22 EC B6     			LD      (ERRTRP),HL
  88+ 82A8 22 F4 B6     			LD      (ERRLIN),HL
  89+ 82AB 2A EA B6     			LD      HL,(AUTONO)
  90+ 82AE 22 E6 B6     			LD      (LINENO),HL
  91+ 82B1 7C           			LD      A,H
  92+ 82B2 B5           			OR      L
  93+ 82B3 28 17        			JR      Z,NOAUTO
  94+ 82B5 E5           			PUSH    HL
  95+ 82B6 CD 28 8B     			CALL    PBCD            ;AUTO NUMBER
  96+ 82B9 E1           			POP     HL
  97+ 82BA ED 4B FF B6  			LD      BC,(INCREM)
  98+ 82BE 06 00        			LD      B,0
  99+ 82C0 09           			ADD     HL,BC
 100+ 82C1 DA 09 8D     			JP      C,TOOBIG
 101+ 82C4 22 EA B6     			LD      (AUTONO),HL
 102+ 82C7 3E 20        			LD      A,' '
 103+ 82C9 CD 97 8A     			CALL    OUTCHR
 104+ 82CC 21 00 B4     NOAUTO:			LD      HL,ACCS
 105+ 82CF CD EF B2     			CALL    OSLINE          ;GET CONSOLE INPUT
 106+ 82D2 AF           			XOR     A
 107+ 82D3 32 FB B6     			LD      (COUNT),A
 108+ 82D6 FD 21 00 B4  			LD      IY,ACCS
 109+ 82DA CD E4 8C     			CALL    LINNUM
 110+ 82DD CD 9B A6     			CALL    NXT
 111+ 82E0 7C           			LD      A,H
 112+ 82E1 B5           			OR      L
 113+ 82E2 28 03        			JR      Z,LNZERO        ;FOR AUTO (NON-MAPPED)
 114+ 82E4 22 E6 B6     			LD      (LINENO),HL
 115+ 82E7 11 00 B5     LNZERO:			LD      DE,BUFFER
 116+ 82EA 0E 01        			LD      C,1             ;LEFT MODE
 117+ 82EC CD 78 8D     			CALL    LEXAN2          ;LEXICAL ANALYSIS
 118+ 82EF 12           			LD      (DE),A          ;TERMINATOR
 119+ 82F0 AF           			XOR     A
 120+ 82F1 47           			LD      B,A
 121+ 82F2 4B           			LD      C,E             ;BC=LINE LENGTH
 122+ 82F3 13           			INC     DE
 123+ 82F4 12           			LD      (DE),A          ;ZERO NEXT
 124+ 82F5 2A E6 B6     			LD      HL,(LINENO)
 125+ 82F8 7C           			LD      A,H
 126+ 82F9 B5           			OR      L
 127+ 82FA FD 21 00 B5  			LD      IY,BUFFER       ;FOR XEQ
 128+ 82FE CA 0B 8F     			JP      Z,XEQ           ;DIRECT MODE
 129+ 8301 C5           			PUSH    BC
 130+ 8302 E5           			PUSH    HL
 131+ 8303 CD CB 89     			CALL    SETTOP          ;SET TOP
 132+ 8306 E1           			POP     HL
 133+ 8307 CD CE 8A     			CALL    FINDL
 134+ 830A CC 8B 89     			CALL    Z,DEL
 135+ 830D C1           			POP     BC
 136+ 830E 79           			LD      A,C
 137+ 830F B7           			OR      A
 138+ 8310 CA 92 82     			JP      Z,CLOOP         ;DELETE LINE ONLY
 139+ 8313 C6 04        			ADD     A,4
 140+ 8315 4F           			LD      C,A             ;LENGTH INCLUSIVE
 141+ 8316 D5           			PUSH    DE              ;LINE NUMBER
 142+ 8317 C5           			PUSH    BC              ;SAVE LINE LENGTH
 143+ 8318 EB           			EX      DE,HL
 144+ 8319 2A DE B6     			LD      HL,(TOP)
 145+ 831C E5           			PUSH    HL
 146+ 831D 09           			ADD     HL,BC
 147+ 831E E5           			PUSH    HL
 148+ 831F 24           			INC     H
 149+ 8320 AF           			XOR     A
 150+ 8321 ED 72        			SBC     HL,SP
 151+ 8323 E1           			POP     HL
 152+ 8324 D2 FE 88     			JP      NC,ERROR        ;"No room"
 153+ 8327 22 DE B6     			LD      (TOP),HL
 154+ 832A E3           			EX      (SP),HL
 155+ 832B E5           			PUSH    HL
 156+ 832C 23           			INC     HL
 157+ 832D B7           			OR      A
 158+ 832E ED 52        			SBC     HL,DE
 159+ 8330 44           			LD      B,H             ;BC=AMOUNT TO MOVE
 160+ 8331 4D           			LD      C,L
 161+ 8332 E1           			POP     HL
 162+ 8333 D1           			POP     DE
 163+ 8334 28 02        			JR      Z,ATEND
 164+ 8336 ED B8        			LDDR                    ;MAKE SPACE
 165+ 8338 C1           ATEND:			POP     BC              ;LINE LENGTH
 166+ 8339 D1           			POP     DE              ;LINE NUMBER
 167+ 833A 23           			INC     HL
 168+ 833B 71           			LD      (HL),C          ;STORE LENGTH
 169+ 833C 23           			INC     HL
 170+ 833D 73           			LD      (HL),E          ;STORE LINE NUMBER
 171+ 833E 23           			INC     HL
 172+ 833F 72           			LD      (HL),D
 173+ 8340 23           			INC     HL
 174+ 8341 11 00 B5     			LD      DE,BUFFER
 175+ 8344 EB           			EX      DE,HL
 176+ 8345 0D           			DEC     C
 177+ 8346 0D           			DEC     C
 178+ 8347 0D           			DEC     C
 179+ 8348 ED B0        			LDIR                    ;ADD LINE
 180+ 834A CD C0 89     			CALL    CLEAN
 181+ 834D C3 92 82     			JP      CLOOP
 182+ 8350              ;
 183+ 8350              ;LIST OF TOKENS AND KEYWORDS.
 184+ 8350              ;IF A KEYWORD IS FOLLOWED BY NUL THEN IT WILL
 185+ 8350              ; ONLY MATCH WITH THE WORD FOLLOWED IMMEDIATELY
 186+ 8350              ; BY A DELIMITER.
 187+ 8350              ;
 188+ 8350 80           KEYWDS:			DEFB    80H
 189+ 8351 41 4E 44     			DEFM    'AND'
 190+ 8354 94           			DEFB    94H
 191+ 8355 41 42 53     			DEFM    'ABS'
 192+ 8358 95           			DEFB    95H
 193+ 8359 41 43 53     			DEFM    'ACS'
 194+ 835C 96           			DEFB    96H
 195+ 835D 41 44 56 41  			DEFM    'ADVAL'
 195+ 8361 4C
 196+ 8362 97           			DEFB    97H
 197+ 8363 41 53 43     			DEFM    'ASC'
 198+ 8366 98           			DEFB    98H
 199+ 8367 41 53 4E     			DEFM    'ASN'
 200+ 836A 99           			DEFB    99H
 201+ 836B 41 54 4E     			DEFM    'ATN'
 202+ 836E C6           			DEFB    0C6H
 203+ 836F 41 55 54 4F  			DEFM    'AUTO'
 204+ 8373 9A           			DEFB    9AH
 205+ 8374 42 47 45 54  			DEFM    'BGET'
 206+ 8378 00           			DEFB    0
 207+ 8379 D5           			DEFB    0D5H
 208+ 837A 42 50 55 54  			DEFM    'BPUT'
 209+ 837E 00           			DEFB    0
 210+ 837F FB           			DEFB    0FBH
 211+ 8380 43 4F 4C 4F  			DEFM    'COLOUR'
 211+ 8384 55 52
 212+ 8386 FB           			DEFB    0FBH
 213+ 8387 43 4F 4C 4F  			DEFM    'COLOR'
 213+ 838B 52
 214+ 838C D6           			DEFB    0D6H
 215+ 838D 43 41 4C 4C  			DEFM    'CALL'
 216+ 8391 D7           			DEFB    0D7H
 217+ 8392 43 48 41 49  			DEFM    'CHAIN'
 217+ 8396 4E
 218+ 8397 BD           			DEFB    0BDH
 219+ 8398 43 48 52 24  			DEFM    'CHR$'
 220+ 839C D8           			DEFB    0D8H
 221+ 839D 43 4C 45 41  			DEFM    'CLEAR'
 221+ 83A1 52
 222+ 83A2 00           			DEFB    0
 223+ 83A3 D9           			DEFB    0D9H
 224+ 83A4 43 4C 4F 53  			DEFM    'CLOSE'
 224+ 83A8 45
 225+ 83A9 00           			DEFB    0
 226+ 83AA DA           			DEFB    0DAH
 227+ 83AB 43 4C 47     			DEFM    'CLG'
 228+ 83AE 00           			DEFB    0
 229+ 83AF DB           			DEFB    0DBH
 230+ 83B0 43 4C 53     			DEFM    'CLS'
 231+ 83B3 00           			DEFB    0
 232+ 83B4 9B           			DEFB    9BH
 233+ 83B5 43 4F 53     			DEFM    'COS'
 234+ 83B8 9C           			DEFB    9CH
 235+ 83B9 43 4F 55 4E  			DEFM    'COUNT'
 235+ 83BD 54
 236+ 83BE 00           			DEFB    0
 237+ 83BF DC           			DEFB    0DCH
 238+ 83C0 44 41 54 41  			DEFM    'DATA'
 239+ 83C4 9D           			DEFB    9DH
 240+ 83C5 44 45 47     			DEFM    'DEG'
 241+ 83C8 DD           			DEFB    0DDH
 242+ 83C9 44 45 46     			DEFM    'DEF'
 243+ 83CC C7           			DEFB    0C7H
 244+ 83CD 44 45 4C 45  			DEFM    'DELETE'
 244+ 83D1 54 45
 245+ 83D3 81           			DEFB    81H
 246+ 83D4 44 49 56     			DEFM    'DIV'
 247+ 83D7 DE           			DEFB    0DEH
 248+ 83D8 44 49 4D     			DEFM    'DIM'
 249+ 83DB DF           			DEFB    0DFH
 250+ 83DC 44 52 41 57  			DEFM    'DRAW'
 251+ 83E0 E1           			DEFB    0E1H
 252+ 83E1 45 4E 44 50  			DEFM    'ENDPROC'
 252+ 83E5 52 4F 43
 253+ 83E8 00           			DEFB    0
 254+ 83E9 E0           			DEFB    0E0H
 255+ 83EA 45 4E 44     			DEFM    'END'
 256+ 83ED 00           			DEFB    0
 257+ 83EE E2           			DEFB    0E2H
 258+ 83EF 45 4E 56 45  			DEFM    'ENVELOPE'
 258+ 83F3 4C 4F 50 45
 259+ 83F7 8B           			DEFB    8BH
 260+ 83F8 45 4C 53 45  			DEFM    'ELSE'
 261+ 83FC A0           			DEFB    0A0H
 262+ 83FD 45 56 41 4C  			DEFM    'EVAL'
 263+ 8401 9E           			DEFB    9EH
 264+ 8402 45 52 4C     			DEFM    'ERL'
 265+ 8405 00           			DEFB    0
 266+ 8406 85           			DEFB    85H
 267+ 8407 45 52 52 4F  			DEFM    'ERROR'
 267+ 840B 52
 268+ 840C C5           			DEFB    0C5H
 269+ 840D 45 4F 46     			DEFM    'EOF'
 270+ 8410 00           			DEFB    0
 271+ 8411 82           			DEFB    82H
 272+ 8412 45 4F 52     			DEFM    'EOR'
 273+ 8415 9F           			DEFB    9FH
 274+ 8416 45 52 52     			DEFM    'ERR'
 275+ 8419 00           			DEFB    0
 276+ 841A A1           			DEFB    0A1H
 277+ 841B 45 58 50     			DEFM    'EXP'
 278+ 841E A2           			DEFB    0A2H
 279+ 841F 45 58 54     			DEFM    'EXT'
 280+ 8422 00           			DEFB    0
 281+ 8423 E3           			DEFB    0E3H
 282+ 8424 46 4F 52     			DEFM    'FOR'
 283+ 8427 A3           			DEFB    0A3H
 284+ 8428 46 41 4C 53  			DEFM    'FALSE'
 284+ 842C 45
 285+ 842D 00           			DEFB    0
 286+ 842E A4           			DEFB    0A4H
 287+ 842F 46 4E        			DEFM    'FN'
 288+ 8431 E5           			DEFB    0E5H
 289+ 8432 47 4F 54 4F  			DEFM    'GOTO'
 290+ 8436 BE           			DEFB    0BEH
 291+ 8437 47 45 54 24  			DEFM    'GET$'
 292+ 843B A5           			DEFB    0A5H
 293+ 843C 47 45 54     			DEFM    'GET'
 294+ 843F E4           			DEFB    0E4H
 295+ 8440 47 4F 53 55  			DEFM    'GOSUB'
 295+ 8444 42
 296+ 8445 E6           			DEFB    0E6H
 297+ 8446 47 43 4F 4C  			DEFM    'GCOL'
 298+ 844A 93           			DEFB    93H
 299+ 844B 48 49 4D 45  			DEFM    'HIMEM'
 299+ 844F 4D
 300+ 8450 00           			DEFB    0
 301+ 8451 E8           			DEFB    0E8H
 302+ 8452 49 4E 50 55  			DEFM    'INPUT'
 302+ 8456 54
 303+ 8457 E7           			DEFB    0E7H
 304+ 8458 49 46        			DEFM    'IF'
 305+ 845A BF           			DEFB    0BFH
 306+ 845B 49 4E 4B 45  			DEFM    'INKEY$'
 306+ 845F 59 24
 307+ 8461 A6           			DEFB    0A6H
 308+ 8462 49 4E 4B 45  			DEFM    'INKEY'
 308+ 8466 59
 309+ 8467 A8           			DEFB    0A8H
 310+ 8468 49 4E 54     			DEFM    'INT'
 311+ 846B A7           			DEFB    0A7H
 312+ 846C 49 4E 53 54  			DEFM    'INSTR('
 312+ 8470 52 28
 313+ 8472 C9           			DEFB    0C9H
 314+ 8473 4C 49 53 54  			DEFM    'LIST'
 315+ 8477 86           			DEFB    86H
 316+ 8478 4C 49 4E 45  			DEFM    'LINE'
 317+ 847C C8           			DEFB    0C8H
 318+ 847D 4C 4F 41 44  			DEFM    'LOAD'
 319+ 8481 92           			DEFB    92H
 320+ 8482 4C 4F 4D 45  			DEFM    'LOMEM'
 320+ 8486 4D
 321+ 8487 00           			DEFB    0
 322+ 8488 EA           			DEFB    0EAH
 323+ 8489 4C 4F 43 41  			DEFM    'LOCAL'
 323+ 848D 4C
 324+ 848E C0           			DEFB    0C0H
 325+ 848F 4C 45 46 54  			DEFM    'LEFT$('
 325+ 8493 24 28
 326+ 8495 A9           			DEFB    0A9H
 327+ 8496 4C 45 4E     			DEFM    'LEN'
 328+ 8499 E9           			DEFB    0E9H
 329+ 849A 4C 45 54     			DEFM    'LET'
 330+ 849D AB           			DEFB    0ABH
 331+ 849E 4C 4F 47     			DEFM    'LOG'
 332+ 84A1 AA           			DEFB    0AAH
 333+ 84A2 4C 4E        			DEFM    'LN'
 334+ 84A4 C1           			DEFB    0C1H
 335+ 84A5 4D 49 44 24  			DEFM    'MID$('
 335+ 84A9 28
 336+ 84AA EB           			DEFB    0EBH
 337+ 84AB 4D 4F 44 45  			DEFM    'MODE'
 338+ 84AF 83           			DEFB    83H
 339+ 84B0 4D 4F 44     			DEFM    'MOD'
 340+ 84B3 EC           			DEFB    0ECH
 341+ 84B4 4D 4F 56 45  			DEFM    'MOVE'
 342+ 84B8 ED           			DEFB    0EDH
 343+ 84B9 4E 45 58 54  			DEFM    'NEXT'
 344+ 84BD CA           			DEFB    0CAH
 345+ 84BE 4E 45 57     			DEFM    'NEW'
 346+ 84C1 00           			DEFB    0
 347+ 84C2 AC           			DEFB    0ACH
 348+ 84C3 4E 4F 54     			DEFM    'NOT'
 349+ 84C6 CB           			DEFB    0CBH
 350+ 84C7 4F 4C 44     			DEFM    'OLD'
 351+ 84CA 00           			DEFB    0
 352+ 84CB EE           			DEFB    0EEH
 353+ 84CC 4F 4E        			DEFM    'ON'
 354+ 84CE 87           			DEFB    87H
 355+ 84CF 4F 46 46     			DEFM    'OFF'
 356+ 84D2 84           			DEFB    84H
 357+ 84D3 4F 52        			DEFM    'OR'
 358+ 84D5 8E           			DEFB    8EH
 359+ 84D6 4F 50 45 4E  			DEFM    'OPENIN'
 359+ 84DA 49 4E
 360+ 84DC AE           			DEFB    0AEH
 361+ 84DD 4F 50 45 4E  			DEFM    'OPENOUT'
 361+ 84E1 4F 55 54
 362+ 84E4 AD           			DEFB    0ADH
 363+ 84E5 4F 50 45 4E  			DEFM    'OPENUP'
 363+ 84E9 55 50
 364+ 84EB FF           			DEFB    0FFH
 365+ 84EC 4F 53 43 4C  			DEFM    'OSCLI'
 365+ 84F0 49
 366+ 84F1 F1           			DEFB    0F1H
 367+ 84F2 50 52 49 4E  			DEFM    'PRINT'
 367+ 84F6 54
 368+ 84F7 90           			DEFB    90H
 369+ 84F8 50 41 47 45  			DEFM    'PAGE'
 370+ 84FC 00           			DEFB    0
 371+ 84FD 8F           			DEFB    8FH
 372+ 84FE 50 54 52     			DEFM    'PTR'
 373+ 8501 00           			DEFB    0
 374+ 8502 AF           			DEFB    0AFH
 375+ 8503 50 49        			DEFM    'PI'
 376+ 8505 00           			DEFB    0
 377+ 8506 F0           			DEFB    0F0H
 378+ 8507 50 4C 4F 54  			DEFM    'PLOT'
 379+ 850B B0           			DEFB    0B0H
 380+ 850C 50 4F 49 4E  			DEFM    'POINT('
 380+ 8510 54 28
 381+ 8512 F2           			DEFB    0F2H
 382+ 8513 50 52 4F 43  			DEFM    'PROC'
 383+ 8517 B1           			DEFB    0B1H
 384+ 8518 50 4F 53     			DEFM    'POS'
 385+ 851B 00           			DEFB    0
 386+ 851C CE           			DEFB    0CEH
 387+ 851D 50 55 54     			DEFM    'PUT'
 388+ 8520 F8           			DEFB    0F8H
 389+ 8521 52 45 54 55  			DEFM    'RETURN'
 389+ 8525 52 4E
 390+ 8527 00           			DEFB    0
 391+ 8528 F5           			DEFB    0F5H
 392+ 8529 52 45 50 45  			DEFM    'REPEAT'
 392+ 852D 41 54
 393+ 852F F6           			DEFB    0F6H
 394+ 8530 52 45 50 4F  			DEFM    'REPORT'
 394+ 8534 52 54
 395+ 8536 00           			DEFB    0
 396+ 8537 F3           			DEFB    0F3H
 397+ 8538 52 45 41 44  			DEFM    'READ'
 398+ 853C F4           			DEFB    0F4H
 399+ 853D 52 45 4D     			DEFM    'REM'
 400+ 8540 F9           			DEFB    0F9H
 401+ 8541 52 55 4E     			DEFM    'RUN'
 402+ 8544 00           			DEFB    0
 403+ 8545 B2           			DEFB    0B2H
 404+ 8546 52 41 44     			DEFM    'RAD'
 405+ 8549 F7           			DEFB    0F7H
 406+ 854A 52 45 53 54  			DEFM    'RESTORE'
 406+ 854E 4F 52 45
 407+ 8551 C2           			DEFB    0C2H
 408+ 8552 52 49 47 48  			DEFM    'RIGHT$('
 408+ 8556 54 24 28
 409+ 8559 B3           			DEFB    0B3H
 410+ 855A 52 4E 44     			DEFM    'RND'
 411+ 855D 00           			DEFB    0
 412+ 855E CC           			DEFB    0CCH
 413+ 855F 52 45 4E 55  			DEFM    'RENUMBER'
 413+ 8563 4D 42 45 52
 414+ 8567 88           			DEFB    88H
 415+ 8568 53 54 45 50  			DEFM    'STEP'
 416+ 856C CD           			DEFB    0CDH
 417+ 856D 53 41 56 45  			DEFM    'SAVE'
 418+ 8571 B4           			DEFB    0B4H
 419+ 8572 53 47 4E     			DEFM    'SGN'
 420+ 8575 B5           			DEFB    0B5H
 421+ 8576 53 49 4E     			DEFM    'SIN'
 422+ 8579 B6           			DEFB    0B6H
 423+ 857A 53 51 52     			DEFM    'SQR'
 424+ 857D 89           			DEFB    89H
 425+ 857E 53 50 43     			DEFM    'SPC'
 426+ 8581 C3           			DEFB    0C3H
 427+ 8582 53 54 52 24  			DEFM    'STR$'
 428+ 8586 C4           			DEFB    0C4H
 429+ 8587 53 54 52 49  			DEFM    'STRING$('
 429+ 858B 4E 47 24 28
 430+ 858F D4           			DEFB    0D4H
 431+ 8590 53 4F 55 4E  			DEFM    'SOUND'
 431+ 8594 44
 432+ 8595 FA           			DEFB    0FAH
 433+ 8596 53 54 4F 50  			DEFM    'STOP'
 434+ 859A 00           			DEFB    0
 435+ 859B B7           			DEFB    0B7H
 436+ 859C 54 41 4E     			DEFM    'TAN'
 437+ 859F 8C           			DEFB    8CH
 438+ 85A0 54 48 45 4E  			DEFM    'THEN'
 439+ 85A4 B8           			DEFB    0B8H
 440+ 85A5 54 4F        			DEFM    'TO'
 441+ 85A7 8A           			DEFB    8AH
 442+ 85A8 54 41 42 28  			DEFM    'TAB('
 443+ 85AC FC           			DEFB    0FCH
 444+ 85AD 54 52 41 43  			DEFM    'TRACE'
 444+ 85B1 45
 445+ 85B2 91           			DEFB    91H
 446+ 85B3 54 49 4D 45  			DEFM    'TIME'
 447+ 85B7 00           			DEFB    0
 448+ 85B8 B9           			DEFB    0B9H
 449+ 85B9 54 52 55 45  			DEFM    'TRUE'
 450+ 85BD 00           			DEFB    0
 451+ 85BE FD           			DEFB    0FDH
 452+ 85BF 55 4E 54 49  			DEFM    'UNTIL'
 452+ 85C3 4C
 453+ 85C4 BA           			DEFB    0BAH
 454+ 85C5 55 53 52     			DEFM    'USR'
 455+ 85C8 EF           			DEFB    0EFH
 456+ 85C9 56 44 55     			DEFM    'VDU'
 457+ 85CC BB           			DEFB    0BBH
 458+ 85CD 56 41 4C     			DEFM    'VAL'
 459+ 85D0 BC           			DEFB    0BCH
 460+ 85D1 56 50 4F 53  			DEFM    'VPOS'
 461+ 85D5 00           			DEFB    0
 462+ 85D6 FE           			DEFB    0FEH
 463+ 85D7 57 49 44 54  			DEFM    'WIDTH'
 463+ 85DB 48
 464+ 85DC D3           			DEFB    0D3H
 465+ 85DD 48 49 4D 45  			DEFM    'HIMEM'
 465+ 85E1 4D
 466+ 85E2 D2           			DEFB    0D2H
 467+ 85E3 4C 4F 4D 45  			DEFM    'LOMEM'
 467+ 85E7 4D
 468+ 85E8 D0           			DEFB    0D0H
 469+ 85E9 50 41 47 45  			DEFM    'PAGE'
 470+ 85ED CF           			DEFB    0CFH
 471+ 85EE 50 54 52     			DEFM    'PTR'
 472+ 85F1 D1           			DEFB    0D1H
 473+ 85F2 54 49 4D 45  			DEFM    'TIME'
 474+ 85F6 01           			DEFB    1
 475+ 85F7 4D 69 73 73  			DEFM    'Missing '
 475+ 85FB 69 6E 67 20
 476+ 85FF 02           			DEFB    2
 477+ 8600 4E 6F 20 73  			DEFM    'No such '
 477+ 8604 75 63 68 20
 478+ 8608 03           			DEFB    3
 479+ 8609 42 61 64 20  			DEFM    'Bad '
 480+ 860D 04           			DEFB    4
 481+ 860E 20 72 61 6E  			DEFM    ' range'
 481+ 8612 67 65
 482+ 8614 05           			DEFB    5
 483+ 8615 76 61 72 69  			DEFM    'variable'
 483+ 8619 61 62 6C 65
 484+ 861D 06           			DEFB    6
 485+ 861E 4F 75 74 20  			DEFM    'Out of'
 485+ 8622 6F 66
 486+ 8624 07           			DEFB    7
 487+ 8625 4E 6F 20     			DEFM    'No '
 488+ 8628 08           			DEFB    8
 489+ 8629 20 73 70 61  			DEFM    ' space'
 489+ 862D 63 65
 490+ 862F              KEYWDL:			EQU     $-KEYWDS
 491+ 862F FF FF        			DEFW    -1
 492+ 8631              ;
 493+ 8631              ;ERROR MESSAGES:
 494+ 8631              ;
 495+ 8631 07           ERRWDS:			DEFB    7
 496+ 8632 72 6F 6F 6D  			DEFM    'room'
 497+ 8636 00           			DEFB    0
 498+ 8637 06           			DEFB    6
 499+ 8638 04           			DEFB    4
 500+ 8639 00           			DEFB    0
 501+ 863A 00 00        			DEFW    0
 502+ 863C 4D 69 73 74  			DEFM    'Mistake'
 502+ 8640 61 6B 65
 503+ 8643 00           			DEFB    0
 504+ 8644 01           			DEFB    1
 505+ 8645 2C           			DEFM    ','
 506+ 8646 00           			DEFB    0
 507+ 8647 54 79 70 65  			DEFM    'Type mismatch'
 507+ 864B 20 6D 69 73
 507+ 864F 6D 61 74 63
 507+ 8653 68
 508+ 8654 00           			DEFB    0
 509+ 8655 07           			DEFB    7
 510+ 8656 A4           			DEFB    FN
 511+ 8657 00 00        			DEFW    0
 512+ 8659 01           			DEFB    1
 513+ 865A 22           			DEFM    34		;ASCII ""
 514+ 865B 00           			DEFB    0
 515+ 865C 03           			DEFB    3
 516+ 865D DE           			DEFB    DIM
 517+ 865E 00           			DEFB    0
 518+ 865F DE           			DEFB    DIM
 519+ 8660 08           			DEFB    8
 520+ 8661 00           			DEFB    0
 521+ 8662 4E 6F 74 20  			DEFM    'Not '
 522+ 8666 EA           			DEFB    LOCAL
 523+ 8667 00           			DEFB    0
 524+ 8668 07           			DEFB    7
 525+ 8669 F2           			DEFB    PROC
 526+ 866A 00           			DEFB    0
 527+ 866B 41 72 72 61  			DEFM    'Array'
 527+ 866F 79
 528+ 8670 00           			DEFB    0
 529+ 8671 53 75 62 73  			DEFM    'Subscript'
 529+ 8675 63 72 69 70
 529+ 8679 74
 530+ 867A 00           			DEFB    0
 531+ 867B 53 79 6E 74  			DEFM    'Syntax error'
 531+ 867F 61 78 20 65
 531+ 8683 72 72 6F 72
 532+ 8687 00           			DEFB    0
 533+ 8688 45 73 63 61  			DEFM    'Escape'
 533+ 868C 70 65
 534+ 868E 00           			DEFB    0
 535+ 868F 44 69 76 69  			DEFM    'Division by zero'
 535+ 8693 73 69 6F 6E
 535+ 8697 20 62 79 20
 535+ 869B 7A 65 72 6F
 536+ 869F 00           			DEFB    0
 537+ 86A0 53 74 72 69  			DEFM    'String too long'
 537+ 86A4 6E 67 20 74
 537+ 86A8 6F 6F 20 6C
 537+ 86AC 6F 6E 67
 538+ 86AF 00           			DEFB    0
 539+ 86B0 54 6F 6F 20  			DEFM    'Too big'
 539+ 86B4 62 69 67
 540+ 86B7 00           			DEFB    0
 541+ 86B8 2D 76 65 20  			DEFM    '-ve root'
 541+ 86BC 72 6F 6F 74
 542+ 86C0 00           			DEFB    0
 543+ 86C1 4C 6F 67     			DEFM    'Log'
 544+ 86C4 04           			DEFB    4
 545+ 86C5 00           			DEFB    0
 546+ 86C6 41 63 63 75  			DEFM    'Accuracy lost'
 546+ 86CA 72 61 63 79
 546+ 86CE 20 6C 6F 73
 546+ 86D2 74
 547+ 86D3 00           			DEFB    0
 548+ 86D4 45 78 70     			DEFM    'Exp'
 549+ 86D7 04           			DEFB    4
 550+ 86D8 00 00        			DEFW    0
 551+ 86DA 02           			DEFB    2
 552+ 86DB 05           			DEFB    5
 553+ 86DC 00           			DEFB    0
 554+ 86DD 01           			DEFB    1
 555+ 86DE 29           			DEFM    ')'
 556+ 86DF 00           			DEFB    0
 557+ 86E0 03           			DEFB    3
 558+ 86E1 48 45 58     			DEFM    'HEX'
 559+ 86E4 00           			DEFB    0
 560+ 86E5 02           			DEFB    2
 561+ 86E6 A4           			DEFB    FN
 562+ 86E7 2F           			DEFM    '/'
 563+ 86E8 F2           			DEFB    PROC
 564+ 86E9 00           			DEFB    0
 565+ 86EA 03           			DEFB    3
 566+ 86EB 63 61 6C 6C  			DEFM    'call'
 567+ 86EF 00           			DEFB    0
 568+ 86F0 41 72 67 75  			DEFM    'Arguments'
 568+ 86F4 6D 65 6E 74
 568+ 86F8 73
 569+ 86F9 00           			DEFB    0
 570+ 86FA 07           			DEFB    7
 571+ 86FB E3           			DEFB    FOR
 572+ 86FC 00           			DEFB    0
 573+ 86FD 43 61 6E 27  			DEFM    'Can''t match '
 573+ 8701 74 20 6D 61
 573+ 8705 74 63 68 20
 574+ 8709 E3           			DEFB    FOR
 575+ 870A 00           			DEFB    0
 576+ 870B E3           			DEFB    FOR
 577+ 870C 20           			DEFM    ' '
 578+ 870D 05           			DEFB    5
 579+ 870E 00 00        			DEFW    0
 580+ 8710 07           			DEFB    7
 581+ 8711 B8           			DEFB    TO
 582+ 8712 00 00        			DEFW    0
 583+ 8714 07           			DEFB    7
 584+ 8715 E4           			DEFB    GOSUB
 585+ 8716 00           			DEFB    0
 586+ 8717 EE           			DEFB    ON
 587+ 8718 20 73 79 6E  			DEFM    ' syntax'
 587+ 871C 74 61 78
 588+ 871F 00           			DEFB    0
 589+ 8720 EE           			DEFB    ON
 590+ 8721 04           			DEFB    4
 591+ 8722 00           			DEFB    0
 592+ 8723 02           			DEFB    2
 593+ 8724 6C 69 6E 65  			DEFM    'line'
 594+ 8728 00           			DEFB    0
 595+ 8729 06           			DEFB    6
 596+ 872A 20           			DEFM    ' '
 597+ 872B DC           			DEFB    DATA
 598+ 872C 00           			DEFB    0
 599+ 872D 07           			DEFB    7
 600+ 872E F5           			DEFB    REPEAT
 601+ 872F 00 00        			DEFW    0
 602+ 8731 01           			DEFB    1
 603+ 8732 23           			DEFM    '#'
 604+ 8733 00           			DEFB    0
 605+ 8734              ;
 606+ 8734              ;COMMANDS:
 607+ 8734              ;
 608+ 8734              ;DELETE line,line
 609+ 8734              ;
 610+ 8734 CD CB 89     @DELETE:		CALL    SETTOP          ;SET TOP
 611+ 8737 CD 31 8D     			CALL    DLPAIR
 612+ 873A 7E           DELET1:			LD      A,(HL)
 613+ 873B B7           			OR      A
 614+ 873C 28 71        			JR      Z,WARMNC
 615+ 873E 23           			INC     HL
 616+ 873F 5E           			LD      E,(HL)
 617+ 8740 23           			INC     HL
 618+ 8741 56           			LD      D,(HL)
 619+ 8742 7A           			LD      A,D
 620+ 8743 B3           			OR      E
 621+ 8744 28 1A        			JR      Z,CLOOP1        ;LINE NUMBER ZERO
 622+ 8746 2B           			DEC     HL
 623+ 8747 2B           			DEC     HL
 624+ 8748 EB           			EX      DE,HL
 625+ 8749 37           			SCF
 626+ 874A ED 42        			SBC     HL,BC
 627+ 874C EB           			EX      DE,HL
 628+ 874D 30 60        			JR      NC,WARMNC
 629+ 874F C5           			PUSH    BC
 630+ 8750 CD 8B 89     			CALL    DEL
 631+ 8753 C1           			POP     BC
 632+ 8754 18 E4        			JR      DELET1
 633+ 8756              ;
 634+ 8756              ;LISTO expr
 635+ 8756              ;
 636+ 8756 FD 23        LISTO:			INC     IY              ;SKIP "O"
 637+ 8758 CD B7 A0     			CALL    EXPRI
 638+ 875B D9           			EXX
 639+ 875C 7D           			LD      A,L
 640+ 875D 32 FE B6     			LD      (LISTON),A
 641+ 8760 C3 92 82     CLOOP1:			JP      CLOOP
 642+ 8763              ;
 643+ 8763              ;LIST
 644+ 8763              ;LIST line
 645+ 8763              ;LIST line,line [IF string]
 646+ 8763              ;LIST ,line
 647+ 8763              ;LIST line,
 648+ 8763              ;
 649+ 8763 FE 4F        @LIST:			CP      'O'
 650+ 8765 28 EF        			JR      Z,LISTO
 651+ 8767 CD 31 8D     			CALL    DLPAIR
 652+ 876A CD 9B A6     			CALL    NXT
 653+ 876D FE E7        			CP      TIF             ;IF CLAUSE ?
 654+ 876F 3E 00        			LD      A,0             ;INIT IF-CLAUSE LENGTH
 655+ 8771 20 15        			JR      NZ,LISTB
 656+ 8773 FD 23        			INC     IY              ;SKIP IF
 657+ 8775 CD 9B A6     			CALL    NXT             ;SKIP SPACES (IF ANY)
 658+ 8778 EB           			EX      DE,HL
 659+ 8779 FD E5        			PUSH    IY
 660+ 877B E1           			POP     HL              ;HL ADDRESSES IF CLAUSE
 661+ 877C 3E 0D        			LD      A,CR
 662+ 877E C5           			PUSH    BC
 663+ 877F 01 00 01     			LD      BC,256
 664+ 8782 ED B1        			CPIR                    ;LOCATE CR
 665+ 8784 79           			LD      A,C
 666+ 8785 2F           			CPL                     ;A = SUBSTRING LENGTH
 667+ 8786 C1           			POP     BC
 668+ 8787 EB           			EX      DE,HL
 669+ 8788 5F           LISTB:			LD      E,A             ;IF-CLAUSE LENGTH
 670+ 8789 78           			LD      A,B
 671+ 878A B1           			OR      C
 672+ 878B 20 01        			JR      NZ,LISTA
 673+ 878D 0B           			DEC     BC
 674+ 878E D9           LISTA:			EXX
 675+ 878F DD 21 FE B6  			LD      IX,LISTON
 676+ 8793 01 00 00     			LD      BC,0            ;INDENTATION COUNT
 677+ 8796 D9           			EXX
 678+ 8797 3E 14        			LD      A,20
 679+ 8799              ;
 680+ 8799 C5           LISTC:			PUSH    BC              ;SAVE HIGH LINE NUMBER
 681+ 879A D5           			PUSH    DE              ;SAVE IF-CLAUSE LENGTH
 682+ 879B E5           			PUSH    HL              ;SAVE PROGRAM POINTER
 683+ 879C 08           			EX      AF,AF'
 684+ 879D 7E           			LD      A,(HL)
 685+ 879E B7           			OR      A
 686+ 879F 28 0E        			JR      Z,WARMNC
 687+ 87A1              ;
 688+ 87A1              ;CHECK IF PAST TERMINATING LINE NUMBER:
 689+ 87A1              ;
 690+ 87A1 7B           			LD      A,E             ;A = IF-CLAUSE LENGTH
 691+ 87A2 23           			INC     HL
 692+ 87A3 5E           			LD      E,(HL)
 693+ 87A4 23           			INC     HL
 694+ 87A5 56           			LD      D,(HL)          ;DE = LINE NUMBER
 695+ 87A6 2B           			DEC     HL
 696+ 87A7 2B           			DEC     HL
 697+ 87A8 D5           			PUSH    DE              ;SAVE LINE NUMBER
 698+ 87A9 EB           			EX      DE,HL
 699+ 87AA 37           			SCF
 700+ 87AB ED 42        			SBC     HL,BC
 701+ 87AD EB           			EX      DE,HL
 702+ 87AE D1           			POP     DE              ;RESTORE LINE NUMBER
 703+ 87AF D2 91 82     WARMNC:			JP      NC,WARM
 704+ 87B2 4E           			LD      C,(HL)          ;C = LINE LENGTH + 4
 705+ 87B3 47           			LD      B,A             ;B = IF-CLAUSE LENGTH
 706+ 87B4              ;
 707+ 87B4              ;CHECK IF "UNLISTABLE":
 708+ 87B4              ;
 709+ 87B4 7A           			LD      A,D
 710+ 87B5 B3           			OR      E
 711+ 87B6 CA 92 82     			JP      Z,CLOOP
 712+ 87B9              ;
 713+ 87B9              ;CHECK FOR IF CLAUSE:
 714+ 87B9              ;
 715+ 87B9 23           			INC     HL
 716+ 87BA 23           			INC     HL
 717+ 87BB 23           			INC     HL              ;HL ADDRESSES LINE TEXT
 718+ 87BC 0D           			DEC     C
 719+ 87BD 0D           			DEC     C
 720+ 87BE 0D           			DEC     C
 721+ 87BF 0D           			DEC     C               ;C = LINE LENGTH
 722+ 87C0 D5           			PUSH    DE              ;SAVE LINE NUMBER
 723+ 87C1 E5           			PUSH    HL              ;SAVE LINE ADDRESS
 724+ 87C2 AF           			XOR     A               ;A <- 0
 725+ 87C3 B8           			CP      B               ;WAS THERE AN IF-CLAUSE
 726+ 87C4 FD E5        			PUSH    IY
 727+ 87C6 D1           			POP     DE              ;DE ADDRESSES IF-CLAUSE
 728+ 87C7 C4 56 A4     			CALL    NZ,SEARCH       ;SEARCH FOR IF CLAUSE
 729+ 87CA E1           			POP     HL              ;RESTORE LINE ADDRESS
 730+ 87CB D1           			POP     DE              ;RESTORE LINE NUMBER
 731+ 87CC FD E5        			PUSH    IY
 732+ 87CE CC 07 8A     			CALL    Z,LISTIT        ;LIST IF MATCH
 733+ 87D1 FD E1        			POP     IY
 734+ 87D3              ;
 735+ 87D3 08           			EX      AF,AF'
 736+ 87D4 3D           			DEC     A
 737+ 87D5 CD 04 B3     			CALL    LTRAP
 738+ 87D8 E1           			POP     HL              ;RESTORE POINTER
 739+ 87D9 5E           			LD      E,(HL)
 740+ 87DA 16 00        			LD      D,0
 741+ 87DC 19           			ADD     HL,DE           ;ADDRESS NEXT LINE
 742+ 87DD D1           			POP     DE              ;RESTORE IF-CLAUSE LEN
 743+ 87DE C1           			POP     BC              ;RESTORE HI LINE NUMBER
 744+ 87DF 18 B8        			JR      LISTC
 745+ 87E1              ;
 746+ 87E1              ;RENUMBER
 747+ 87E1              ;RENUMBER start
 748+ 87E1              ;RENUMBER start,increment
 749+ 87E1              ;RENUMBER ,increment
 750+ 87E1              ;
 751+ 87E1 CD EF 89     @RENUM:			CALL    CLEAR           ;USES DYNAMIC AREA
 752+ 87E4 CD 0E 8D     			CALL    PAIR            ;LOAD HL,BC
 753+ 87E7 D9           			EXX
 754+ 87E8 2A DC B6     			LD      HL,(PAGE)
 755+ 87EB ED 5B E0 B6  			LD      DE,(LOMEM)
 756+ 87EF 7E           RENUM1:			LD      A,(HL)          ;BUILD TABLE
 757+ 87F0 B7           			OR      A
 758+ 87F1 28 30        			JR      Z,RENUM2
 759+ 87F3 23           			INC     HL
 760+ 87F4 4E           			LD      C,(HL)          ;OLD LINE NUMBER
 761+ 87F5 23           			INC     HL
 762+ 87F6 46           			LD      B,(HL)
 763+ 87F7 78           			LD      A,B
 764+ 87F8 B1           			OR      C
 765+ 87F9 CA 92 82     			JP      Z,CLOOP         ;LINE NUMBER ZERO
 766+ 87FC EB           			EX      DE,HL
 767+ 87FD 71           			LD      (HL),C
 768+ 87FE 23           			INC     HL
 769+ 87FF 70           			LD      (HL),B
 770+ 8800 23           			INC     HL
 771+ 8801 D9           			EXX
 772+ 8802 E5           			PUSH    HL
 773+ 8803 09           			ADD     HL,BC           ;ADD INCREMENT
 774+ 8804 DA 09 8D     			JP      C,TOOBIG        ;"Too big"
 775+ 8807 D9           			EXX
 776+ 8808 C1           			POP     BC
 777+ 8809 71           			LD      (HL),C
 778+ 880A 23           			INC     HL
 779+ 880B 70           			LD      (HL),B
 780+ 880C 23           			INC     HL
 781+ 880D EB           			EX      DE,HL
 782+ 880E 2B           			DEC     HL
 783+ 880F 2B           			DEC     HL
 784+ 8810 AF           			XOR     A
 785+ 8811 47           			LD      B,A
 786+ 8812 4E           			LD      C,(HL)
 787+ 8813 09           			ADD     HL,BC           ;NEXT LINE
 788+ 8814 EB           			EX      DE,HL
 789+ 8815 E5           			PUSH    HL
 790+ 8816 24           			INC     H
 791+ 8817 ED 72        			SBC     HL,SP
 792+ 8819 E1           			POP     HL
 793+ 881A EB           			EX      DE,HL
 794+ 881B 38 D2        			JR      C,RENUM1        ;CONTINUE
 795+ 881D CD 13 89     			CALL    EXTERR          ;"RENUMBER space'
 796+ 8820 CC           			DEFB    REN
 797+ 8821 08           			DEFB    8
 798+ 8822 00           			DEFB    0
 799+ 8823              ;
 800+ 8823 EB           RENUM2:			EX      DE,HL
 801+ 8824 36 FF        			LD      (HL),-1
 802+ 8826 23           			INC     HL
 803+ 8827 36 FF        			LD      (HL),-1
 804+ 8829 ED 5B E0 B6  			LD      DE,(LOMEM)
 805+ 882D D9           			EXX
 806+ 882E 2A DC B6     			LD      HL,(PAGE)
 807+ 8831 4E           RENUM3:			LD      C,(HL)
 808+ 8832 79           			LD      A,C
 809+ 8833 B7           			OR      A
 810+ 8834 CA 91 82     			JP      Z,WARM
 811+ 8837 D9           			EXX
 812+ 8838 EB           			EX      DE,HL
 813+ 8839 23           			INC     HL
 814+ 883A 23           			INC     HL
 815+ 883B 5E           			LD      E,(HL)
 816+ 883C 23           			INC     HL
 817+ 883D 56           			LD      D,(HL)
 818+ 883E 23           			INC     HL
 819+ 883F D5           			PUSH    DE
 820+ 8840 EB           			EX      DE,HL
 821+ 8841 22 E6 B6     			LD      (LINENO),HL
 822+ 8844 D9           			EXX
 823+ 8845 D1           			POP     DE
 824+ 8846 23           			INC     HL
 825+ 8847 73           			LD      (HL),E          ;NEW LINE NUMBER
 826+ 8848 23           			INC     HL
 827+ 8849 72           			LD      (HL),D
 828+ 884A 23           			INC     HL
 829+ 884B 0D           			DEC     C
 830+ 884C 0D           			DEC     C
 831+ 884D 0D           			DEC     C
 832+ 884E 06 00        			LD      B,0
 833+ 8850 3E 8D        RENUM7:			LD      A,LINO
 834+ 8852 ED B1        			CPIR                    ;SEARCH FOR LINE NUMBER
 835+ 8854 20 DB        			JR      NZ,RENUM3
 836+ 8856 C5           			PUSH    BC
 837+ 8857 E5           			PUSH    HL
 838+ 8858 E5           			PUSH    HL
 839+ 8859 FD E1        			POP     IY
 840+ 885B D9           			EXX
 841+ 885C CD 49 A5     			CALL    DECODE          ;DECODE LINE NUMBER
 842+ 885F D9           			EXX
 843+ 8860 44           			LD      B,H
 844+ 8861 4D           			LD      C,L
 845+ 8862 2A E0 B6     			LD      HL,(LOMEM)
 846+ 8865 5E           RENUM4:			LD      E,(HL)          ;CROSS-REFERENCE TABLE
 847+ 8866 23           			INC     HL
 848+ 8867 56           			LD      D,(HL)
 849+ 8868 23           			INC     HL
 850+ 8869 EB           			EX      DE,HL
 851+ 886A B7           			OR      A               ;CLEAR CARRY
 852+ 886B ED 42        			SBC     HL,BC
 853+ 886D EB           			EX      DE,HL
 854+ 886E 5E           			LD      E,(HL)          ;NEW NUMBER
 855+ 886F 23           			INC     HL
 856+ 8870 56           			LD      D,(HL)
 857+ 8871 23           			INC     HL
 858+ 8872 38 F1        			JR      C,RENUM4
 859+ 8874 EB           			EX      DE,HL
 860+ 8875 28 19        			JR      Z,RENUM5        ;FOUND
 861+ 8877 CD 4E 8E     			CALL    TELL
 862+ 887A 46 61 69 6C  			DEFM    'Failed at '
 862+ 887E 65 64 20 61
 862+ 8882 74 20
 863+ 8884 00           			DEFB    0
 864+ 8885 2A E6 B6     			LD      HL,(LINENO)
 865+ 8888 CD 24 8B     			CALL    PBCDL
 866+ 888B CD 90 8A     			CALL    CRLF
 867+ 888E 18 06        			JR      RENUM6
 868+ 8890 D1           RENUM5:			POP     DE
 869+ 8891 D5           			PUSH    DE
 870+ 8892 1B           			DEC     DE
 871+ 8893 CD 1C 8E     			CALL    ENCODE          ;RE-WRITE NUMBER
 872+ 8896 E1           RENUM6:			POP     HL
 873+ 8897 C1           			POP     BC
 874+ 8898 18 B6        			JR      RENUM7
 875+ 889A              ;
 876+ 889A              ;AUTO
 877+ 889A              ;AUTO start,increment
 878+ 889A              ;AUTO start
 879+ 889A              ;AUTO ,increment
 880+ 889A              ;
 881+ 889A CD 0E 8D     @AUTO:			CALL    PAIR
 882+ 889D 22 EA B6     			LD      (AUTONO),HL
 883+ 88A0 79           			LD      A,C
 884+ 88A1 32 FF B6     			LD      (INCREM),A
 885+ 88A4 18 29        			JR      CLOOP0
 886+ 88A6              ;
 887+ 88A6              ;BAD
 888+ 88A6              ;NEW
 889+ 88A6              ;
 890+ 88A6 CD 4E 8E     BAD:			CALL    TELL            ;"Bad program'
 891+ 88A9 03           			DEFB    3
 892+ 88AA 70 72 6F 67  			DEFM    'program'
 892+ 88AE 72 61 6D
 893+ 88B1 0D           			DEFB    CR
 894+ 88B2 0A           			DEFB    LF
 895+ 88B3 00           			DEFB    0
 896+ 88B4 CD E7 89     @NEW:			CALL    NEWIT
 897+ 88B7 18 16        			JR      CLOOP0
 898+ 88B9              ;
 899+ 88B9              ;OLD
 900+ 88B9              ;
 901+ 88B9 2A DC B6     @OLD:			LD      HL,(PAGE)
 902+ 88BC E5           			PUSH    HL
 903+ 88BD 23           			INC     HL
 904+ 88BE 23           			INC     HL
 905+ 88BF 23           			INC     HL
 906+ 88C0 01 FC 00     			LD      BC,252
 907+ 88C3 3E 0D        			LD      A,CR
 908+ 88C5 ED B1        			CPIR
 909+ 88C7 20 DD        			JR      NZ,BAD
 910+ 88C9 7D           			LD      A,L
 911+ 88CA E1           			POP     HL
 912+ 88CB 77           			LD      (HL),A
 913+ 88CC CD C0 89     			CALL    CLEAN
 914+ 88CF C3 92 82     CLOOP0:			JP      CLOOP
 915+ 88D2              ;
 916+ 88D2              ;LOAD filename
 917+ 88D2              ;
 918+ 88D2 CD C0 A0     @LOAD:			CALL    EXPRS           ;GET FILENAME
 919+ 88D5 3E 0D        			LD      A,CR
 920+ 88D7 12           			LD      (DE),A
 921+ 88D8 CD A6 89     			CALL    LOAD0
 922+ 88DB CD EF 89     			CALL    CLEAR
 923+ 88DE 18 1B        			JR      WARM0
 924+ 88E0              ;
 925+ 88E0              ;SAVE filename
 926+ 88E0              ;
 927+ 88E0 CD CB 89     @SAVE:			CALL    SETTOP          ;SET TOP
 928+ 88E3 CD C0 A0     			CALL    EXPRS           ;FILENAME
 929+ 88E6 3E 0D        			LD      A,CR
 930+ 88E8 12           			LD      (DE),A
 931+ 88E9 ED 5B DC B6  			LD      DE,(PAGE)
 932+ 88ED 2A DE B6     			LD      HL,(TOP)
 933+ 88F0 B7           			OR      A
 934+ 88F1 ED 52        			SBC     HL,DE
 935+ 88F3 44           			LD      B,H             ;LENGTH OF PROGRAM
 936+ 88F4 4D           			LD      C,L
 937+ 88F5 21 00 B4     			LD      HL,ACCS
 938+ 88F8 CD 04 B3     			CALL    OSSAVE
 939+ 88FB C3 91 82     WARM0:			JP      WARM
 940+ 88FE              ;
 941+ 88FE              ;ERROR
 942+ 88FE              ;
 943+ 88FE ED 7B E4 B6  @ERROR:			LD      SP,(HIMEM)
 944+ 8902 21 31 86     			LD      HL,ERRWDS
 945+ 8905 B7           			OR      A
 946+ 8906 28 0A        			JR      Z,ERROR1
 947+ 8908 47           			LD      B,A             ;ERROR NUMBER
 948+ 8909 08           			EX      AF,AF'
 949+ 890A AF           			XOR     A
 950+ 890B BE           ERROR0:			CP      (HL)
 951+ 890C 23           			INC     HL
 952+ 890D 20 FC        			JR      NZ,ERROR0
 953+ 890F 10 FA        			DJNZ    ERROR0
 954+ 8911 08           			EX      AF,AF'
 955+ 8912 E5           ERROR1:			PUSH    HL
 956+ 8913 E1           @EXTERR:		POP     HL
 957+ 8914 22 EE B6     			LD      (ERRTXT),HL
 958+ 8917 ED 7B E4 B6  			LD      SP,(HIMEM)
 959+ 891B 32 FD B6     			LD      (ERR),A
 960+ 891E CD E7 8A     			CALL    SETLIN
 961+ 8921 22 F2 B6     			LD      (ERL),HL
 962+ 8924 B7           			OR      A
 963+ 8925 28 0B        			JR      Z,ERROR2
 964+ 8927 2A EC B6     			LD      HL,(ERRTRP)
 965+ 892A 7C           			LD      A,H
 966+ 892B B5           			OR      L
 967+ 892C E5           			PUSH    HL
 968+ 892D FD E1        			POP     IY
 969+ 892F C2 0B 8F     			JP      NZ,XEQ          ;ERROR TRAPPED
 970+ 8932 21 00 00     ERROR2:			LD      HL,0
 971+ 8935 22 EA B6     			LD      (AUTONO),HL
 972+ 8938 22 E8 B6     			LD      (TRACEN),HL     ;CANCEL TRACE
 973+ 893B CD 04 B3     			CALL    RESET           ;RESET OPSYS
 974+ 893E CD 90 8A     			CALL    CRLF
 975+ 8941 CD 42 8E     			CALL    REPORT          ;MESSAGE
 976+ 8944 CD 11 8B     			CALL    SAYLN
 977+ 8947 1E 00        			LD      E,0
 978+ 8949 DC 04 B3     			CALL    C,OSSHUT        ;CLOSE ALL FILES
 979+ 894C CD 90 8A     			CALL    CRLF
 980+ 894F C3 92 82     			JP      CLOOP
 981+ 8952              ;
 982+ 8952              ;SUBROUTINES:
 983+ 8952              ;
 984+ 8952              ;
 985+ 8952              ;LEX - SEARCH FOR KEYWORDS
 986+ 8952              ;   Inputs: HL = start of keyword table
 987+ 8952              ;           IY = start of match text
 988+ 8952              ;  Outputs: If found, Z-flag set, A=token.
 989+ 8952              ;           If not found, Z-flag reset, A=(IY).
 990+ 8952              ;           IY updated (if NZ, IY unchanged).
 991+ 8952              ; Destroys: A,B,H,L,IY,F
 992+ 8952              ;
 993+ 8952 21 50 83     LEX:			LD      HL,KEYWDS
 994+ 8955 FD 7E 00     LEX0:			LD      A,(IY)
 995+ 8958 46           			LD      B,(HL)
 996+ 8959 23           			INC     HL
 997+ 895A BE           			CP      (HL)
 998+ 895B 28 08        			JR      Z,LEX2
 999+ 895D D8           			RET     C               ;FAIL EXIT
1000+ 895E 23           LEX1:			INC     HL
1001+ 895F CB 7E        			BIT     7,(HL)
1002+ 8961 28 FB        			JR      Z,LEX1
1003+ 8963 18 F0        			JR      LEX0
1004+ 8965 FD E5        LEX2:			PUSH    IY              ;SAVE POINTER
1005+ 8967 23           LEX3:			INC     HL
1006+ 8968 CB 7E        			BIT     7,(HL)
1007+ 896A 20 1B        			JR      NZ,LEX6         ;FOUND
1008+ 896C FD 23        			INC     IY
1009+ 896E FD 7E 00     			LD      A,(IY)
1010+ 8971 FE 2E        			CP      '.'
1011+ 8973 28 12        			JR      Z,LEX6          ;FOUND (ABBREV.)
1012+ 8975 BE           			CP      (HL)
1013+ 8976 28 EF        			JR      Z,LEX3
1014+ 8978 CD 55 8D     			CALL    RANGE1
1015+ 897B 38 04        			JR      C,LEX5
1016+ 897D FD E1        LEX4:			POP     IY              ;RESTORE POINTER
1017+ 897F 18 DD        			JR      LEX1
1018+ 8981 7E           LEX5:			LD      A,(HL)
1019+ 8982 B7           			OR      A
1020+ 8983 20 F8        			JR      NZ,LEX4
1021+ 8985 FD 2B        			DEC     IY
1022+ 8987 F1           LEX6:			POP     AF
1023+ 8988 AF           			XOR     A
1024+ 8989 78           			LD      A,B
1025+ 898A C9           			RET
1026+ 898B              ;
1027+ 898B              ;DEL - DELETE A PROGRAM LINE.
1028+ 898B              ;   Inputs: HL addresses program line.
1029+ 898B              ; Destroys: B,C,F
1030+ 898B              ;
1031+ 898B D5           DEL:			PUSH    DE
1032+ 898C E5           			PUSH    HL
1033+ 898D E5           			PUSH    HL
1034+ 898E 06 00        			LD      B,0
1035+ 8990 4E           			LD      C,(HL)
1036+ 8991 09           			ADD     HL,BC
1037+ 8992 E5           			PUSH    HL
1038+ 8993 EB           			EX      DE,HL
1039+ 8994 2A DE B6     			LD      HL,(TOP)
1040+ 8997 ED 52        			SBC     HL,DE
1041+ 8999 44           			LD      B,H
1042+ 899A 4D           			LD      C,L
1043+ 899B E1           			POP     HL
1044+ 899C D1           			POP     DE
1045+ 899D ED B0        			LDIR                    ;DELETE LINE
1046+ 899F ED 53 DE B6  			LD      (TOP),DE
1047+ 89A3 E1           			POP     HL
1048+ 89A4 D1           			POP     DE
1049+ 89A5 C9           			RET
1050+ 89A6              ;
1051+ 89A6              ;LOAD0 - LOAD A DISK FILE THEN CLEAN.
1052+ 89A6              ;   Inputs: Filename in ACCS (term CR)
1053+ 89A6              ; Destroys: A,B,C,D,E,H,L,F
1054+ 89A6              ;
1055+ 89A6              ;CLEAN - CHECK FOR BAD PROGRAM, FIND END OF TEXT
1056+ 89A6              ; AND WRITE FF FF, THEN LOAD (TOP).
1057+ 89A6              ; Destroys: A,B,C,H,L,F
1058+ 89A6              ;
1059+ 89A6 ED 5B DC B6  @LOAD0: 		LD      DE,(PAGE)
1060+ 89AA 21 00 FF     			LD      HL,-256
1061+ 89AD 39           			ADD     HL,SP
1062+ 89AE ED 52        			SBC     HL,DE           ;FIND AVAILABLE SPACE
1063+ 89B0 44           			LD      B,H
1064+ 89B1 4D           			LD      C,L
1065+ 89B2 21 00 B4     			LD      HL,ACCS
1066+ 89B5 CD 04 B3     			CALL    OSLOAD          ;LOAD
1067+ 89B8 D4 E7 89     			CALL    NC,NEWIT
1068+ 89BB 3E 00        			LD      A,0
1069+ 89BD D2 FE 88     			JP      NC,ERROR        ;"No room"
1070+ 89C0 CD CB 89     CLEAN:			CALL    SETTOP
1071+ 89C3 2B           			DEC     HL
1072+ 89C4 36 FF        			LD      (HL),-1         ;WRITE &FFFF
1073+ 89C6 2B           			DEC     HL
1074+ 89C7 36 FF        			LD      (HL),-1
1075+ 89C9 18 24        			JR      CLEAR
1076+ 89CB              ;
1077+ 89CB 2A DC B6     SETTOP:			LD      HL,(PAGE)
1078+ 89CE 06 00        			LD      B,0
1079+ 89D0 3E 0D        			LD      A,CR
1080+ 89D2 4E           SETOP1:			LD      C,(HL)
1081+ 89D3 0C           			INC     C
1082+ 89D4 0D           			DEC     C
1083+ 89D5 28 09        			JR      Z,SETOP2
1084+ 89D7 09           			ADD     HL,BC
1085+ 89D8 2B           			DEC     HL
1086+ 89D9 BE           			CP      (HL)
1087+ 89DA 23           			INC     HL
1088+ 89DB 28 F5        			JR      Z,SETOP1
1089+ 89DD C3 A6 88     			JP      BAD
1090+ 89E0 23           SETOP2:			INC     HL              ;N.B. CALLED FROM NEWIT
1091+ 89E1 23           			INC     HL
1092+ 89E2 23           			INC     HL
1093+ 89E3 22 DE B6     			LD      (TOP),HL
1094+ 89E6 C9           			RET
1095+ 89E7              ;
1096+ 89E7              ;NEWIT - NEW PROGRAM THEN CLEAR
1097+ 89E7              ;   Destroys: H,L
1098+ 89E7              ;
1099+ 89E7              ;CLEAR - CLEAR ALL DYNAMIC VARIABLES INCLUDING
1100+ 89E7              ; FUNCTION AND PROCEDURE POINTERS.
1101+ 89E7              ;   Destroys: Nothing
1102+ 89E7              ;
1103+ 89E7 2A DC B6     NEWIT:			LD      HL,(PAGE)
1104+ 89EA 36 00        			LD      (HL),0
1105+ 89EC CD E0 89     			CALL    SETOP2
1106+ 89EF E5           @CLEAR:			PUSH    HL
1107+ 89F0 2A DE B6     			LD      HL,(TOP)
1108+ 89F3 22 E0 B6     			LD      (LOMEM),HL
1109+ 89F6 22 E2 B6     			LD      (FREE),HL
1110+ 89F9 21 6C B6     			LD      HL,DYNVAR
1111+ 89FC C5           			PUSH    BC
1112+ 89FD 06 70        			LD      B,2*(54+2)
1113+ 89FF 36 00        CLEAR1:			LD      (HL),0
1114+ 8A01 23           			INC     HL
1115+ 8A02 10 FB        			DJNZ    CLEAR1
1116+ 8A04 C1           			POP     BC
1117+ 8A05 E1           			POP     HL
1118+ 8A06 C9           			RET
1119+ 8A07              ;
1120+ 8A07              ;LISTIT - LIST A PROGRAM LINE.
1121+ 8A07              ;    Inputs: HL addresses line
1122+ 8A07              ;            DE = line number (binary)
1123+ 8A07              ;            IX addresses LISTON
1124+ 8A07              ;  Destroys: A,D,E,B',C',D',E',H',L',IY,F
1125+ 8A07              ;
1126+ 8A07 E5           LISTIT:			PUSH    HL
1127+ 8A08 EB           			EX      DE,HL
1128+ 8A09 C5           			PUSH    BC
1129+ 8A0A CD 28 8B     			CALL    PBCD
1130+ 8A0D C1           			POP     BC
1131+ 8A0E E1           			POP     HL
1132+ 8A0F 7E           			LD      A,(HL)
1133+ 8A10 FE ED        			CP      NEXT
1134+ 8A12 CC 73 8A     			CALL    Z,INDENT
1135+ 8A15 FE FD        			CP      UNTIL
1136+ 8A17 CC 73 8A     			CALL    Z,INDENT
1137+ 8A1A D9           			EXX
1138+ 8A1B 3E 20        			LD      A,' '
1139+ 8A1D DD CB 00 46  			BIT     0,(IX)
1140+ 8A21 C4 97 8A     			CALL    NZ,OUTCHR
1141+ 8A24 78           			LD      A,B
1142+ 8A25 87           			ADD     A,A
1143+ 8A26 DD CB 00 4E  			BIT     1,(IX)
1144+ 8A2A C4 4D 99     			CALL    NZ,FILL
1145+ 8A2D 79           			LD      A,C
1146+ 8A2E 87           			ADD     A,A
1147+ 8A2F DD CB 00 56  			BIT     2,(IX)
1148+ 8A33 C4 4D 99     			CALL    NZ,FILL
1149+ 8A36 D9           			EXX
1150+ 8A37 7E           			LD      A,(HL)
1151+ 8A38 FE E3        			CP      FOR
1152+ 8A3A CC 73 8A     			CALL    Z,INDENT
1153+ 8A3D FE F5        			CP      REPEAT
1154+ 8A3F CC 73 8A     			CALL    Z,INDENT
1155+ 8A42 1E 00        			LD      E,0
1156+ 8A44 7E           LIST8:			LD      A,(HL)
1157+ 8A45 23           			INC     HL
1158+ 8A46 FE 0D        			CP      CR
1159+ 8A48 28 46        			JR      Z,CRLF
1160+ 8A4A FE 22        			CP      34		;ASCII ""
1161+ 8A4C 20 01        			JR      NZ,LIST7
1162+ 8A4E 1C           			INC     E
1163+ 8A4F CD 67 8A     LIST7:			CALL    LOUT
1164+ 8A52 18 F0        			JR      LIST8
1165+ 8A54              ;
1166+ 8A54 E5           PRLINO:			PUSH    HL
1167+ 8A55 FD E1        			POP     IY
1168+ 8A57 C5           			PUSH    BC
1169+ 8A58 CD 49 A5     			CALL    DECODE
1170+ 8A5B C1           			POP     BC
1171+ 8A5C D9           			EXX
1172+ 8A5D C5           			PUSH    BC
1173+ 8A5E CD 24 8B     			CALL    PBCDL
1174+ 8A61 C1           			POP     BC
1175+ 8A62 D9           			EXX
1176+ 8A63 FD E5        			PUSH    IY
1177+ 8A65 E1           			POP     HL
1178+ 8A66 C9           			RET
1179+ 8A67              ;
1180+ 8A67 CB 43        LOUT:			BIT     0,E
1181+ 8A69 20 2C        			JR      NZ,OUTCHR
1182+ 8A6B FE 8D        			CP      LINO
1183+ 8A6D 28 E5        			JR      Z,PRLINO
1184+ 8A6F CD B0 8A     			CALL    OUT
1185+ 8A72 7E           			LD      A,(HL)
1186+ 8A73 D9           INDENT:			EXX
1187+ 8A74 FE E3        			CP      FOR
1188+ 8A76 28 08        			JR      Z,IND1
1189+ 8A78 FE ED        			CP      NEXT
1190+ 8A7A 20 05        			JR      NZ,IND2
1191+ 8A7C 05           			DEC     B
1192+ 8A7D F2 81 8A     			JP      P,IND2
1193+ 8A80 04           IND1:			INC     B
1194+ 8A81 FE F5        IND2:			CP      REPEAT
1195+ 8A83 28 08        			JR      Z,IND3
1196+ 8A85 FE FD        			CP      UNTIL
1197+ 8A87 20 05        			JR      NZ,IND4
1198+ 8A89 0D           			DEC     C
1199+ 8A8A F2 8E 8A     			JP      P,IND4
1200+ 8A8D 0C           IND3:			INC     C
1201+ 8A8E D9           IND4:			EXX
1202+ 8A8F C9           			RET
1203+ 8A90              ;
1204+ 8A90              ;CRLF - SEND CARRIAGE RETURN, LINE FEED.
1205+ 8A90              ;  Destroys: A,F
1206+ 8A90              ;OUTCHR - OUTPUT A CHARACTER TO CONSOLE.
1207+ 8A90              ;    Inputs: A = character
1208+ 8A90              ;  Destroys: A,F
1209+ 8A90              ;
1210+ 8A90 3E 0D        @CRLF:			LD      A,CR
1211+ 8A92 CD 97 8A     			CALL    OUTCHR
1212+ 8A95 3E 0A        			LD      A,LF
1213+ 8A97 CD D9 B2     @OUTCHR:		CALL    OSWRCH
1214+ 8A9A D6 0D        			SUB     CR
1215+ 8A9C 28 05        			JR      Z,CARRET
1216+ 8A9E D8           			RET     C               ;NON-PRINTING
1217+ 8A9F 3A FB B6     			LD      A,(COUNT)
1218+ 8AA2 3C           			INC     A
1219+ 8AA3 32 FB B6     CARRET:			LD      (COUNT),A
1220+ 8AA6 C8           			RET     Z
1221+ 8AA7 E5           			PUSH    HL
1222+ 8AA8 2A FC B6     			LD      HL,(WIDTH)
1223+ 8AAB BD           			CP      L
1224+ 8AAC E1           			POP     HL
1225+ 8AAD C0           			RET     NZ
1226+ 8AAE 18 E0        			JR      CRLF
1227+ 8AB0              ;
1228+ 8AB0              ;OUT - SEND CHARACTER OR KEYWORD
1229+ 8AB0              ;   Inputs: A = character (>=10, <128)
1230+ 8AB0              ;           A = Token (<10, >=128)
1231+ 8AB0              ;  Destroys: A,F
1232+ 8AB0              ;
1233+ 8AB0 FE 8A        @OUT:			CP      138
1234+ 8AB2 EA 97 8A     			JP      PE,OUTCHR
1235+ 8AB5 C5           			PUSH    BC
1236+ 8AB6 E5           			PUSH    HL
1237+ 8AB7 21 50 83     			LD      HL,KEYWDS
1238+ 8ABA 01 DF 02     			LD      BC,KEYWDL
1239+ 8ABD ED B1        			CPIR
1240+ 8ABF 7E           TOKEN1:			LD      A,(HL)
1241+ 8AC0 23           			INC     HL
1242+ 8AC1 FE 8A        			CP      138
1243+ 8AC3 F5           			PUSH    AF
1244+ 8AC4 EC 97 8A     			CALL    PE,OUTCHR
1245+ 8AC7 F1           			POP     AF
1246+ 8AC8 EA BF 8A     			JP      PE,TOKEN1
1247+ 8ACB E1           			POP     HL
1248+ 8ACC C1           			POP     BC
1249+ 8ACD C9           			RET
1250+ 8ACE              ;
1251+ 8ACE              ;FINDL - FIND PROGRAM LINE.
1252+ 8ACE              ;   Inputs: HL = line number (binary)
1253+ 8ACE              ;  Outputs: HL addresses line (if found)
1254+ 8ACE              ;           DE = line number
1255+ 8ACE              ;           Z-flag set if found.
1256+ 8ACE              ; Destroys: A,B,C,D,E,H,L,F
1257+ 8ACE              ;
1258+ 8ACE EB           @FINDL:			EX      DE,HL
1259+ 8ACF 2A DC B6     			LD      HL,(PAGE)
1260+ 8AD2 AF           			XOR     A               ;A=0
1261+ 8AD3 BE           			CP      (HL)
1262+ 8AD4 3C           			INC     A
1263+ 8AD5 D0           			RET     NC
1264+ 8AD6 AF           			XOR     A               ;CLEAR CARRY
1265+ 8AD7 47           			LD      B,A
1266+ 8AD8 4E           FINDL1:			LD      C,(HL)
1267+ 8AD9 E5           			PUSH    HL
1268+ 8ADA 23           			INC     HL
1269+ 8ADB 7E           			LD      A,(HL)
1270+ 8ADC 23           			INC     HL
1271+ 8ADD 66           			LD      H,(HL)
1272+ 8ADE 6F           			LD      L,A
1273+ 8ADF ED 52        			SBC     HL,DE
1274+ 8AE1 E1           			POP     HL
1275+ 8AE2 D0           			RET     NC              ;FOUND OR PAST
1276+ 8AE3 09           			ADD     HL,BC
1277+ 8AE4 C3 D8 8A     			JP      FINDL1
1278+ 8AE7              ;
1279+ 8AE7              ;SETLIN - Search program for line containing address.
1280+ 8AE7              ;         Update (LINENO).
1281+ 8AE7              ;   Inputs: Address in (ERRLIN)
1282+ 8AE7              ;  Outputs: Line number in HL and (LINENO)
1283+ 8AE7              ; Destroys: B,C,D,E,H,L,F
1284+ 8AE7              ;
1285+ 8AE7 06 00        @SETLIN:		LD      B,0
1286+ 8AE9 ED 5B F4 B6  			LD      DE,(ERRLIN)
1287+ 8AED 2A DC B6     			LD      HL,(PAGE)
1288+ 8AF0 B7           			OR      A
1289+ 8AF1 ED 52        			SBC     HL,DE
1290+ 8AF3 19           			ADD     HL,DE
1291+ 8AF4 30 16        			JR      NC,SET3
1292+ 8AF6 4E           SET1:			LD      C,(HL)
1293+ 8AF7 0C           			INC     C
1294+ 8AF8 0D           			DEC     C
1295+ 8AF9 28 11        			JR      Z,SET3
1296+ 8AFB 09           			ADD     HL,BC
1297+ 8AFC ED 52        			SBC     HL,DE
1298+ 8AFE 19           			ADD     HL,DE
1299+ 8AFF 38 F5        			JR      C,SET1
1300+ 8B01 ED 42        			SBC     HL,BC
1301+ 8B03 23           			INC     HL
1302+ 8B04 5E           			LD      E,(HL)          ;LINE NUMBER
1303+ 8B05 23           			INC     HL
1304+ 8B06 56           			LD      D,(HL)
1305+ 8B07 EB           			EX      DE,HL
1306+ 8B08 22 E6 B6     SET2:			LD      (LINENO),HL
1307+ 8B0B C9           			RET
1308+ 8B0C 21 00 00     SET3:			LD      HL,0
1309+ 8B0F 18 F7        			JR      SET2
1310+ 8B11              ;
1311+ 8B11              ;SAYLN - PRINT " at line nnnn" MESSAGE.
1312+ 8B11              ;  Outputs: Carry=0 if line number is zero.
1313+ 8B11              ;           Carry=1 if line number is non-zero.
1314+ 8B11              ; Destroys: A,B,C,D,E,H,L,F
1315+ 8B11              ;
1316+ 8B11 2A E6 B6     @SAYLN:			LD      HL,(LINENO)
1317+ 8B14 7C           			LD      A,H
1318+ 8B15 B5           			OR      L
1319+ 8B16 C8           			RET     Z
1320+ 8B17 CD 4E 8E     			CALL    TELL
1321+ 8B1A 20 61 74 20  			DEFM    ' at line '
1321+ 8B1E 6C 69 6E 65
1321+ 8B22 20
1322+ 8B23 00           			DEFB    0
1323+ 8B24 0E 00        @PBCDL:			LD      C,0
1324+ 8B26 18 02        			JR      PBCD0
1325+ 8B28              ;
1326+ 8B28              ;PBCD - PRINT NUMBER AS DECIMAL INTEGER.
1327+ 8B28              ;   Inputs: HL = number (binary).
1328+ 8B28              ;  Outputs: Carry = 1
1329+ 8B28              ; Destroys: A,B,C,D,E,H,L,F
1330+ 8B28              ;
1331+ 8B28 0E 20        PBCD:			LD      C,' '
1332+ 8B2A 06 05        PBCD0:			LD      B,5
1333+ 8B2C 11 10 27     			LD      DE,10000
1334+ 8B2F AF           PBCD1:			XOR     A
1335+ 8B30 ED 52        PBCD2:			SBC     HL,DE
1336+ 8B32 3C           			INC     A
1337+ 8B33 30 FB        			JR      NC,PBCD2
1338+ 8B35 19           			ADD     HL,DE
1339+ 8B36 3D           			DEC     A
1340+ 8B37 28 04        			JR      Z,PBCD3
1341+ 8B39 CB E1        			SET     4,C
1342+ 8B3B CB E9        			SET     5,C
1343+ 8B3D B1           PBCD3:			OR      C
1344+ 8B3E C4 97 8A     			CALL    NZ,OUTCHR
1345+ 8B41 78           			LD      A,B
1346+ 8B42 FE 05        			CP      5
1347+ 8B44 28 06        			JR      Z,PBCD4
1348+ 8B46 29           			ADD     HL,HL
1349+ 8B47 54           			LD      D,H
1350+ 8B48 5D           			LD      E,L
1351+ 8B49 29           			ADD     HL,HL
1352+ 8B4A 29           			ADD     HL,HL
1353+ 8B4B 19           			ADD     HL,DE
1354+ 8B4C 11 E8 03     PBCD4:			LD      DE,1000
1355+ 8B4F 10 DE        			DJNZ    PBCD1
1356+ 8B51 37           			SCF
1357+ 8B52 C9           			RET
1358+ 8B53              ;
1359+ 8B53              ;PUTVAR - CREATE VARIABLE AND INITIALISE TO ZERO.
1360+ 8B53              ;   Inputs: HL, IY as returned from GETVAR (NZ).
1361+ 8B53              ;  Outputs: As GETVAR.
1362+ 8B53              ; Destroys: everything
1363+ 8B53              ;
1364+ 8B53 CD A0 8C     @PUTVAR:		CALL    CREATE
1365+ 8B56 FD 7E 00     			LD      A,(IY)
1366+ 8B59 FE 28        			CP      '('
1367+ 8B5B 20 68        			JR      NZ,GETVZ        ;SET EXIT CONDITIONS
1368+ 8B5D 3E 0E        ARRAY:			LD      A,14            ;'Array'
1369+ 8B5F C3 FE 88     ERROR3:			JP      ERROR
1370+ 8B62              ;
1371+ 8B62              ;GETVAR - GET LOCATION OF VARIABLE, RETURN IN HL & IX
1372+ 8B62              ;   Inputs: IY addresses first character.
1373+ 8B62              ;  Outputs: Carry set and NZ if illegal character.
1374+ 8B62              ;           Z-flag set if variable found, then:
1375+ 8B62              ;            A = variable type (0,4,5,128 or 129)
1376+ 8B62              ;            HL = IX = variable pointer.
1377+ 8B62              ;            IY updated
1378+ 8B62              ;           If Z-flag & carry reset, then:
1379+ 8B62              ;            HL, IY set for subsequent PUTVAR call.
1380+ 8B62              ; Destroys: everything
1381+ 8B62              ;
1382+ 8B62 FD 7E 00     @GETVAR:		LD      A,(IY)
1383+ 8B65 FE 24        			CP      '$'
1384+ 8B67 28 62        			JR      Z,GETV4
1385+ 8B69 FE 21        			CP      '!'
1386+ 8B6B 28 62        			JR      Z,GETV5
1387+ 8B6D FE 3F        			CP      '?'
1388+ 8B6F 28 62        			JR      Z,GETV6
1389+ 8B71 CD 18 8C     			CALL    LOCATE
1390+ 8B74 C0           			RET     NZ
1391+ 8B75 FD 7E 00     			LD      A,(IY)
1392+ 8B78 FE 28        			CP      '('             ;ARRAY?
1393+ 8B7A 20 41        			JR      NZ,GETVX        ;EXIT
1394+ 8B7C D5           			PUSH    DE              ;SAVE TYPE
1395+ 8B7D 7E           			LD      A,(HL)          ;NO. OF DIMENSIONS
1396+ 8B7E B7           			OR      A
1397+ 8B7F 28 DC        			JR      Z,ARRAY
1398+ 8B81 23           			INC     HL
1399+ 8B82 11 00 00     			LD      DE,0            ;ACCUMULATOR
1400+ 8B85 F5           			PUSH    AF
1401+ 8B86 FD 23        			INC     IY              ;SKIP (
1402+ 8B88 18 04        			JR      GETV3
1403+ 8B8A F5           GETV2:			PUSH    AF
1404+ 8B8B CD 53 A6     			CALL    COMMA
1405+ 8B8E E5           GETV3:			PUSH    HL
1406+ 8B8F D5           			PUSH    DE
1407+ 8B90 CD B7 A0     			CALL    EXPRI           ;SUBSCRIPT
1408+ 8B93 D9           			EXX
1409+ 8B94 D1           			POP     DE
1410+ 8B95 E3           			EX      (SP),HL
1411+ 8B96 4E           			LD      C,(HL)
1412+ 8B97 23           			INC     HL
1413+ 8B98 46           			LD      B,(HL)
1414+ 8B99 23           			INC     HL
1415+ 8B9A E3           			EX      (SP),HL
1416+ 8B9B EB           			EX      DE,HL
1417+ 8B9C D5           			PUSH    DE
1418+ 8B9D CD C6 99     			CALL    MUL16           ;HL=HL*BC
1419+ 8BA0 D1           			POP     DE
1420+ 8BA1 19           			ADD     HL,DE
1421+ 8BA2 EB           			EX      DE,HL
1422+ 8BA3 B7           			OR      A
1423+ 8BA4 ED 42        			SBC     HL,BC
1424+ 8BA6 3E 0F        			LD      A,15
1425+ 8BA8 30 B5        			JR      NC,ERROR3       ;"Subscript"
1426+ 8BAA E1           			POP     HL
1427+ 8BAB F1           			POP     AF
1428+ 8BAC 3D           			DEC     A               ;DIMENSION COUNTER
1429+ 8BAD 20 DB        			JR      NZ,GETV2
1430+ 8BAF CD 5F A6     			CALL    BRAKET          ;CLOSING BRACKET
1431+ 8BB2 F1           			POP     AF              ;RESTORE TYPE
1432+ 8BB3 E5           			PUSH    HL
1433+ 8BB4 CD B9 99     			CALL    X4OR5           ;DE=DE*n
1434+ 8BB7 E1           			POP     HL
1435+ 8BB8 19           			ADD     HL,DE
1436+ 8BB9 57           			LD      D,A             ;TYPE
1437+ 8BBA FD 7E 00     			LD      A,(IY)
1438+ 8BBD FE 3F        GETVX:			CP      '?'
1439+ 8BBF 28 1D        			JR      Z,GETV9
1440+ 8BC1 FE 21        			CP      '!'
1441+ 8BC3 28 15        			JR      Z,GETV8
1442+ 8BC5 E5           GETVZ:			PUSH    HL              ;SET EXIT CONDITIONS
1443+ 8BC6 DD E1        			POP     IX
1444+ 8BC8 7A           			LD      A,D
1445+ 8BC9 BF           			CP      A
1446+ 8BCA C9           			RET
1447+ 8BCB              ;
1448+ 8BCB              ;PROCESS UNARY & BINARY INDIRECTION:
1449+ 8BCB              ;
1450+ 8BCB 3E 80        GETV4:			LD      A,128           ;STATIC STRING
1451+ 8BCD 18 05        			JR      GETV7
1452+ 8BCF 3E 04        GETV5:			LD      A,4             ;UNARY 32-BIT INDIRN.
1453+ 8BD1 18 01        			JR      GETV7
1454+ 8BD3 AF           GETV6:			XOR     A               ;UNARY 8-BIT INDIRECTION
1455+ 8BD4 21 00 00     GETV7:			LD      HL,0
1456+ 8BD7 F5           			PUSH    AF
1457+ 8BD8 18 15        			JR      GETV0
1458+ 8BDA              ;
1459+ 8BDA 06 04        GETV8:			LD      B,4             ;32-BIT BINARY INDIRN.
1460+ 8BDC 18 02        			JR      GETVA
1461+ 8BDE 06 00        GETV9:			LD      B,0             ;8-BIT BINARY INDIRN.
1462+ 8BE0 E5           GETVA:			PUSH    HL
1463+ 8BE1 DD E1        			POP     IX
1464+ 8BE3 7A           			LD      A,D             ;TYPE
1465+ 8BE4 FE 81        			CP      129
1466+ 8BE6 C8           			RET     Z               ;STRING!
1467+ 8BE7 C5           			PUSH    BC
1468+ 8BE8 CD 70 A1     			CALL    LOADN           ;LEFT OPERAND
1469+ 8BEB CD 5E A3     			CALL    SFIX
1470+ 8BEE D9           			EXX
1471+ 8BEF E5           GETV0:			PUSH    HL
1472+ 8BF0 FD 23        			INC     IY
1473+ 8BF2 CD CE A0     			CALL    ITEMI
1474+ 8BF5 D9           			EXX
1475+ 8BF6 D1           			POP     DE
1476+ 8BF7 F1           			POP     AF
1477+ 8BF8 19           			ADD     HL,DE
1478+ 8BF9 E5           			PUSH    HL
1479+ 8BFA DD E1        			POP     IX
1480+ 8BFC BF           			CP      A
1481+ 8BFD C9           			RET
1482+ 8BFE              ;
1483+ 8BFE              ;GETDEF - Find entry for FN or PROC in dynamic area.
1484+ 8BFE              ;   Inputs: IY addresses byte following "DEF" token.
1485+ 8BFE              ;  Outputs: Z flag set if found
1486+ 8BFE              ;           Carry set if neither FN or PROC first.
1487+ 8BFE              ;           If Z: HL points to entry
1488+ 8BFE              ;                 IY addresses delimiter
1489+ 8BFE              ; Destroys: A,D,E,H,L,IY,F
1490+ 8BFE              ;
1491+ 8BFE FD 7E 01     @GETDEF:		LD      A,(IY+1)
1492+ 8C01 CD 55 8D     			CALL    RANGE1
1493+ 8C04 D8           			RET     C
1494+ 8C05 FD 7E 00     			LD      A,(IY)
1495+ 8C08 21 D8 B6     			LD      HL,FNPTR
1496+ 8C0B FE A4        			CP      FN
1497+ 8C0D 28 43        			JR      Z,LOC2
1498+ 8C0F 21 DA B6     			LD      HL,PROPTR
1499+ 8C12 FE F2        			CP      PROC
1500+ 8C14 28 3C        			JR      Z,LOC2
1501+ 8C16 37           			SCF
1502+ 8C17 C9           			RET
1503+ 8C18              ;
1504+ 8C18              ;LOCATE - Try to locate variable name in static or
1505+ 8C18              ;dynamic variables.  If illegal first character return
1506+ 8C18              ;carry, non-zero.  If found, return no-carry, zero.
1507+ 8C18              ;If not found, return no-carry, non-zero.
1508+ 8C18              ;   Inputs: IY addresses first character of name.
1509+ 8C18              ;           A=(IY)
1510+ 8C18              ;  Outputs: Z-flag set if found, then:
1511+ 8C18              ;            IY addresses terminator
1512+ 8C18              ;            HL addresses location of variable
1513+ 8C18              ;            D=type of variable:  4 = integer
1514+ 8C18              ;                                 5 = floating point
1515+ 8C18              ;                               129 = string
1516+ 8C18              ; Destroys: A,D,E,H,L,IY,F
1517+ 8C18              ;
1518+ 8C18 D6 40        LOCATE:			SUB     '@'
1519+ 8C1A D8           			RET     C
1520+ 8C1B 26 00        			LD      H,0
1521+ 8C1D FE 1B        			CP      'Z'-'@'+1
1522+ 8C1F 30 1D        			JR      NC,LOC0         ;NOT STATIC
1523+ 8C21 87           			ADD     A,A
1524+ 8C22 6F           			LD      L,A
1525+ 8C23 FD 7E 01     			LD      A,(IY+1)        ;2nd CHARACTER
1526+ 8C26 FE 25        			CP      '%'
1527+ 8C28 20 20        			JR      NZ,LOC1         ;NOT STATIC
1528+ 8C2A FD 7E 02     			LD      A,(IY+2)
1529+ 8C2D FE 28        			CP      '('
1530+ 8C2F 28 19        			JR      Z,LOC1          ;NOT STATIC
1531+ 8C31 29           			ADD     HL,HL
1532+ 8C32 11 00 B6     			LD      DE,STAVAR       ;STATIC VARIABLES
1533+ 8C35 19           			ADD     HL,DE
1534+ 8C36 FD 23        			INC     IY
1535+ 8C38 FD 23        			INC     IY
1536+ 8C3A 16 04        			LD      D,4             ;INTEGER TYPE
1537+ 8C3C AF           			XOR     A
1538+ 8C3D C9           			RET
1539+ 8C3E              ;
1540+ 8C3E FE 1F        LOC0:			CP      '_'-'@'
1541+ 8C40 D8           			RET     C
1542+ 8C41 FE 3B        			CP      'z'-'@'+1
1543+ 8C43 3F           			CCF
1544+ 8C44 3D           			DEC     A               ;SET NZ
1545+ 8C45 D8           			RET     C
1546+ 8C46 D6 03        			SUB     3
1547+ 8C48 87           			ADD     A,A
1548+ 8C49 6F           			LD      L,A
1549+ 8C4A 11 6C B6     LOC1:			LD      DE,DYNVAR       ;DYNAMIC VARIABLES
1550+ 8C4D 2D           			DEC     L
1551+ 8C4E 2D           			DEC     L
1552+ 8C4F 37           			SCF
1553+ 8C50 F8           			RET     M
1554+ 8C51 19           			ADD     HL,DE
1555+ 8C52 5E           LOC2:			LD      E,(HL)
1556+ 8C53 23           			INC     HL
1557+ 8C54 56           			LD      D,(HL)
1558+ 8C55 7A           			LD      A,D
1559+ 8C56 B3           			OR      E
1560+ 8C57 28 45        			JR      Z,LOC6          ;UNDEFINED VARIABLE
1561+ 8C59 62           			LD      H,D
1562+ 8C5A 6B           			LD      L,E
1563+ 8C5B 23           			INC     HL              ;SKIP LINK
1564+ 8C5C 23           			INC     HL
1565+ 8C5D FD E5        			PUSH    IY
1566+ 8C5F 7E           LOC3:			LD      A,(HL)          ;COMPARE
1567+ 8C60 23           			INC     HL
1568+ 8C61 FD 23        			INC     IY
1569+ 8C63 FD BE 00     			CP      (IY)
1570+ 8C66 28 F7        			JR      Z,LOC3
1571+ 8C68 B7           			OR      A               ;0=TERMINATOR
1572+ 8C69 28 06        			JR      Z,LOC5          ;FOUND (MAYBE)
1573+ 8C6B FD E1        LOC4:			POP     IY
1574+ 8C6D EB           			EX      DE,HL
1575+ 8C6E C3 52 8C     			JP      LOC2            ;TRY NEXT ENTRY
1576+ 8C71              ;
1577+ 8C71 FD 2B        LOC5:			DEC     IY
1578+ 8C73 FD 7E 00     			LD      A,(IY)
1579+ 8C76 FE 28        			CP      '('
1580+ 8C78 28 13        			JR      Z,LOC5A         ;FOUND
1581+ 8C7A FD 23        			INC     IY
1582+ 8C7C CD 49 8D     			CALL    RANGE
1583+ 8C7F 38 0C        			JR      C,LOC5A         ;FOUND
1584+ 8C81 FE 28        			CP      '('
1585+ 8C83 28 E6        			JR      Z,LOC4          ;KEEP LOOKING
1586+ 8C85 FD 7E FF     			LD      A,(IY-1)
1587+ 8C88 CD 55 8D     			CALL    RANGE1
1588+ 8C8B 30 DE        			JR      NC,LOC4         ;KEEP LOOKING
1589+ 8C8D D1           LOC5A:			POP     DE
1590+ 8C8E FD 7E FF     TYPE:			LD      A,(IY-1)
1591+ 8C91 FE 24        			CP      '$'
1592+ 8C93 16 81        			LD      D,129
1593+ 8C95 C8           			RET     Z               ;STRING
1594+ 8C96 FE 25        			CP      '%'
1595+ 8C98 16 04        			LD      D,4
1596+ 8C9A C8           			RET     Z               ;INTEGER
1597+ 8C9B 14           			INC     D
1598+ 8C9C BF           			CP      A
1599+ 8C9D C9           			RET
1600+ 8C9E              ;
1601+ 8C9E 3C           LOC6:			INC     A               ;SET NZ
1602+ 8C9F C9           			RET
1603+ 8CA0              ;
1604+ 8CA0              ;CREATE - CREATE NEW ENTRY, INITIALISE TO ZERO.
1605+ 8CA0              ;   Inputs: HL, IY as returned from LOCATE (NZ).
1606+ 8CA0              ;  Outputs: As LOCATE, GETDEF.
1607+ 8CA0              ; Destroys: As LOCATE, GETDEF.
1608+ 8CA0              ;
1609+ 8CA0 AF           @CREATE:		XOR     A
1610+ 8CA1 ED 5B E2 B6  			LD      DE,(FREE)
1611+ 8CA5 72           			LD      (HL),D
1612+ 8CA6 2B           			DEC     HL
1613+ 8CA7 73           			LD      (HL),E
1614+ 8CA8 EB           			EX      DE,HL
1615+ 8CA9 77           			LD      (HL),A
1616+ 8CAA 23           			INC     HL
1617+ 8CAB 77           			LD      (HL),A
1618+ 8CAC 23           			INC     HL
1619+ 8CAD FD 23        LOC7:			INC     IY
1620+ 8CAF CD 49 8D     			CALL    RANGE           ;END OF VARIABLE?
1621+ 8CB2 38 14        			JR      C,LOC8
1622+ 8CB4 77           			LD      (HL),A
1623+ 8CB5 23           			INC     HL
1624+ 8CB6 CD 55 8D     			CALL    RANGE1
1625+ 8CB9 30 F2        			JR      NC,LOC7
1626+ 8CBB FE 28        			CP      '('
1627+ 8CBD 28 09        			JR      Z,LOC8
1628+ 8CBF FD 7E 01     			LD      A,(IY+1)
1629+ 8CC2 FE 28        			CP      '('
1630+ 8CC4 28 E7        			JR      Z,LOC7
1631+ 8CC6 FD 23        			INC     IY
1632+ 8CC8 36 00        LOC8:			LD      (HL),0          ;TERMINATOR
1633+ 8CCA 23           			INC     HL
1634+ 8CCB E5           			PUSH    HL
1635+ 8CCC CD 8E 8C     			CALL    TYPE
1636+ 8CCF 3E 05        			LD      A,5
1637+ 8CD1 BA           			CP      D
1638+ 8CD2 28 01        			JR      Z,LOC9
1639+ 8CD4 3D           			DEC     A
1640+ 8CD5 36 00        LOC9:			LD      (HL),0          ;INITIALISE TO ZERO
1641+ 8CD7 23           			INC     HL
1642+ 8CD8 3D           			DEC     A
1643+ 8CD9 20 FA        			JR      NZ,LOC9
1644+ 8CDB 22 E2 B6     			LD      (FREE),HL
1645+ 8CDE CD E2 97     			CALL    CHECK
1646+ 8CE1 E1           			POP     HL
1647+ 8CE2 AF           			XOR     A
1648+ 8CE3 C9           			RET
1649+ 8CE4              ;
1650+ 8CE4              ;LINNUM - GET LINE NUMBER FROM TEXT STRING
1651+ 8CE4              ;   Inputs: IY = Text Pointer
1652+ 8CE4              ;  Outputs: HL = Line number (zero if none)
1653+ 8CE4              ;           IY updated
1654+ 8CE4              ; Destroys: A,D,E,H,L,IY,F
1655+ 8CE4              ;
1656+ 8CE4 CD 9B A6     LINNUM:			CALL    NXT
1657+ 8CE7 21 00 00     			LD      HL,0
1658+ 8CEA FD 7E 00     LINNM1:			LD      A,(IY)
1659+ 8CED D6 30        			SUB     '0'
1660+ 8CEF D8           			RET     C
1661+ 8CF0 FE 0A        			CP      10
1662+ 8CF2 D0           			RET     NC
1663+ 8CF3 FD 23        			INC     IY
1664+ 8CF5 54           			LD      D,H
1665+ 8CF6 5D           			LD      E,L
1666+ 8CF7 29           			ADD     HL,HL           ;*2
1667+ 8CF8 38 0F        			JR      C,TOOBIG
1668+ 8CFA 29           			ADD     HL,HL           ;*4
1669+ 8CFB 38 0C        			JR      C,TOOBIG
1670+ 8CFD 19           			ADD     HL,DE           ;*5
1671+ 8CFE 38 09        			JR      C,TOOBIG
1672+ 8D00 29           			ADD     HL,HL           ;*10
1673+ 8D01 38 06        			JR      C,TOOBIG
1674+ 8D03 5F           			LD      E,A
1675+ 8D04 16 00        			LD      D,0
1676+ 8D06 19           			ADD     HL,DE           ;ADD IN DIGIT
1677+ 8D07 30 E1        			JR      NC,LINNM1
1678+ 8D09 3E 14        TOOBIG:			LD      A,20
1679+ 8D0B C3 FE 88     			JP      ERROR           ;"Too big"
1680+ 8D0E              ;
1681+ 8D0E              ;PAIR - GET PAIR OF LINE NUMBERS FOR RENUMBER/AUTO.
1682+ 8D0E              ;   Inputs: IY = text pointer
1683+ 8D0E              ;  Outputs: HL = first number (10 by default)
1684+ 8D0E              ;           BC = second number (10 by default)
1685+ 8D0E              ; Destroys: A,B,C,D,E,H,L,B',C',D',E',H',L',IY,F
1686+ 8D0E              ;
1687+ 8D0E CD E4 8C     PAIR:			CALL    LINNUM          ;FIRST
1688+ 8D11 7C           			LD      A,H
1689+ 8D12 B5           			OR      L
1690+ 8D13 20 02        			JR      NZ,PAIR1
1691+ 8D15 2E 0A        			LD      L,10
1692+ 8D17 CD E5 98     PAIR1:			CALL    TERM?
1693+ 8D1A FD 23        			INC     IY
1694+ 8D1C E5           			PUSH    HL
1695+ 8D1D 21 0A 00     			LD      HL,10
1696+ 8D20 C4 E4 8C     			CALL    NZ,LINNUM       ;SECOND
1697+ 8D23 E3           			EX      (SP),HL
1698+ 8D24 C1           			POP     BC
1699+ 8D25 78           			LD      A,B
1700+ 8D26 B1           			OR      C
1701+ 8D27 C0           			RET     NZ
1702+ 8D28 CD 13 89     			CALL    EXTERR
1703+ 8D2B 53 69 6C 6C  			DEFM    'Silly'
1703+ 8D2F 79
1704+ 8D30 00           			DEFB    0
1705+ 8D31              ;
1706+ 8D31              ;DLPAIR - GET PAIR OF LINE NUMBERS FOR DELETE/LIST.
1707+ 8D31              ;   Inputs: IY = text pointer
1708+ 8D31              ;  Outputs: HL = points to program text
1709+ 8D31              ;           BC = second number (0 by default)
1710+ 8D31              ; Destroys: A,B,C,D,E,H,L,IY,F
1711+ 8D31              ;
1712+ 8D31 CD E4 8C     DLPAIR:			CALL    LINNUM
1713+ 8D34 E5           			PUSH    HL
1714+ 8D35 CD E5 98     			CALL    TERM?
1715+ 8D38 28 09        			JR      Z,DLP1
1716+ 8D3A FE E7        			CP      TIF
1717+ 8D3C 28 05        			JR      Z,DLP1
1718+ 8D3E FD 23        			INC     IY
1719+ 8D40 CD E4 8C     			CALL    LINNUM
1720+ 8D43 E3           DLP1:			EX      (SP),HL
1721+ 8D44 CD CE 8A     			CALL    FINDL
1722+ 8D47 C1           			POP     BC
1723+ 8D48 C9           			RET
1724+ 8D49              ;
1725+ 8D49              ;TEST FOR VALID CHARACTER IN VARIABLE NAME:
1726+ 8D49              ;   Inputs: IY addresses character
1727+ 8D49              ;  Outputs: Carry set if out-of-range.
1728+ 8D49              ; Destroys: A,F
1729+ 8D49              ;
1730+ 8D49 FD 7E 00     @RANGE:			LD      A,(IY)
1731+ 8D4C FE 24        			CP      '$'
1732+ 8D4E C8           			RET     Z
1733+ 8D4F FE 25        			CP      '%'
1734+ 8D51 C8           			RET     Z
1735+ 8D52 FE 28        			CP      '('
1736+ 8D54 C8           			RET     Z
1737+ 8D55 FE 30        RANGE1:			CP      '0'
1738+ 8D57 D8           			RET     C
1739+ 8D58 FE 3A        			CP      '9'+1
1740+ 8D5A 3F           			CCF
1741+ 8D5B D0           			RET     NC
1742+ 8D5C FE 40        			CP      '@'             ;V2.4
1743+ 8D5E C8           			RET     Z
1744+ 8D5F FE 41        RANGE2:			CP      'A'
1745+ 8D61 D8           			RET     C
1746+ 8D62 FE 5B        			CP      'Z'+1
1747+ 8D64 3F           			CCF
1748+ 8D65 D0           			RET     NC
1749+ 8D66 FE 5F        			CP      '_'
1750+ 8D68 D8           			RET     C
1751+ 8D69 FE 7B        			CP      'z'+1
1752+ 8D6B 3F           			CCF
1753+ 8D6C C9           			RET
1754+ 8D6D              ;
1755+ 8D6D AF           SPACE: 			XOR     A
1756+ 8D6E CD 13 89     			CALL    EXTERR          ;"LINE space"
1757+ 8D71 86           			DEFB    LINE
1758+ 8D72 08           			DEFB    8
1759+ 8D73 00           			DEFB    0
1760+ 8D74              ;
1761+ 8D74              ;LEXAN - LEXICAL ANALYSIS.
1762+ 8D74              ;  Bit 0,C: 1=left, 0=right
1763+ 8D74              ;  Bit 3,C: 1=in HEX
1764+ 8D74              ;  Bit 4,C: 1=accept line number
1765+ 8D74              ;  Bit 5,C: 1=in variable, FN, PROC
1766+ 8D74              ;  Bit 6,C: 1=in REM, DATA, *
1767+ 8D74              ;  Bit 7,C: 1=in quotes
1768+ 8D74              ;   Inputs: IY addresses source string
1769+ 8D74              ;           DE addresses destination string
1770+ 8D74              ;           (must be page boundary)
1771+ 8D74              ;           C  sets initial mode
1772+ 8D74              ;  Outputs: DE, IY updated
1773+ 8D74              ;           A holds carriage return
1774+ 8D74              ;
1775+ 8D74 12           LEXAN1:			LD      (DE),A          ;TRANSFER TO BUFFER
1776+ 8D75 13           			INC     DE              ;INCREMENT POINTERS
1777+ 8D76 FD 23        			INC     IY
1778+ 8D78 7B           @LEXAN2:		LD      A,E             ;MAIN ENTRY
1779+ 8D79 FE FC        			CP      252             ;TEST LENGTH
1780+ 8D7B 30 F0        			JR      NC,SPACE        ;LINE TOO LONG
1781+ 8D7D FD 7E 00     			LD      A,(IY)
1782+ 8D80 FE 0D        			CP      CR
1783+ 8D82 C8           			RET     Z               ;END OF LINE
1784+ 8D83 CD 55 8D     			CALL    RANGE1
1785+ 8D86 30 04        			JR      NC,LEXAN3
1786+ 8D88 CB A9        			RES     5,C             ;NOT IN VARIABLE
1787+ 8D8A CB 99        			RES     3,C             ;NOT IN HEX
1788+ 8D8C FE 20        LEXAN3:			CP      ' '
1789+ 8D8E 28 E4        			JR      Z,LEXAN1        ;PASS SPACES
1790+ 8D90 FE 2C        			CP      ','
1791+ 8D92 28 E0        			JR      Z,LEXAN1        ;PASS COMMAS
1792+ 8D94 FE 47        			CP      'G'
1793+ 8D96 38 02        			JR      C,LEXAN4
1794+ 8D98 CB 99        			RES     3,C             ;NOT IN HEX
1795+ 8D9A FE 22        LEXAN4:			CP      34		;ASCII ""
1796+ 8D9C 20 05        			JR      NZ,LEXAN5
1797+ 8D9E CB 11        			RL      C
1798+ 8DA0 3F           			CCF                     ;TOGGLE C7
1799+ 8DA1 CB 19        			RR      C
1800+ 8DA3 CB 61        LEXAN5:			BIT     4,C
1801+ 8DA5 28 10        			JR      Z,LEXAN6
1802+ 8DA7 CB A1        			RES     4,C
1803+ 8DA9 C5           			PUSH    BC
1804+ 8DAA D5           			PUSH    DE
1805+ 8DAB CD E4 8C     			CALL    LINNUM          ;GET LINE NUMBER
1806+ 8DAE D1           			POP     DE
1807+ 8DAF C1           			POP     BC
1808+ 8DB0 7C           			LD      A,H
1809+ 8DB1 B5           			OR      L
1810+ 8DB2 C4 1C 8E     			CALL    NZ,ENCODE       ;ENCODE LINE NUMBER
1811+ 8DB5 18 C1        			JR      LEXAN2          ;CONTINUE
1812+ 8DB7              ;
1813+ 8DB7 0D           LEXAN6:			DEC     C
1814+ 8DB8 28 09        			JR      Z,LEXAN7        ;C=1 (LEFT)
1815+ 8DBA 0C           			INC     C
1816+ 8DBB 20 B7        			JR      NZ,LEXAN1
1817+ 8DBD B7           			OR      A
1818+ 8DBE F4 52 89     			CALL    P,LEX           ;TOKENISE IF POSS.
1819+ 8DC1 18 12        			JR      LEXAN8
1820+ 8DC3              ;
1821+ 8DC3 FE 2A        LEXAN7:			CP      '*'
1822+ 8DC5 28 16        			JR      Z,LEXAN9
1823+ 8DC7 B7           			OR      A
1824+ 8DC8 F4 52 89     			CALL    P,LEX           ;TOKENISE IF POSS.
1825+ 8DCB FE 8F        			CP      TOKLO
1826+ 8DCD 38 06        			JR      C,LEXAN8
1827+ 8DCF FE 94        			CP      TOKHI+1
1828+ 8DD1 30 02        			JR      NC,LEXAN8
1829+ 8DD3 C6 40        			ADD     A,OFFSET        ;LEFT VERSION
1830+ 8DD5 FE F4        LEXAN8:			CP      REM
1831+ 8DD7 28 04        			JR      Z,LEXAN9
1832+ 8DD9 FE DC        			CP      DATA
1833+ 8DDB 20 02        			JR      NZ,LEXANA
1834+ 8DDD CB F1        LEXAN9:			SET     6,C             ;QUIT TOKENISING
1835+ 8DDF FE A4        LEXANA:			CP      FN
1836+ 8DE1 28 09        			JR      Z,LEXANB
1837+ 8DE3 FE F2        			CP      PROC
1838+ 8DE5 28 05        			JR      Z,LEXANB
1839+ 8DE7 CD 5F 8D     			CALL    RANGE2
1840+ 8DEA 38 02        			JR      C,LEXANC
1841+ 8DEC CB E9        LEXANB:			SET     5,C             ;IN VARIABLE/FN/PROC
1842+ 8DEE FE 26        LEXANC:			CP      '&'
1843+ 8DF0 20 02        			JR      NZ,LEXAND
1844+ 8DF2 CB D9        			SET     3,C             ;IN HEX
1845+ 8DF4 21 13 8E     LEXAND:			LD      HL,LIST1
1846+ 8DF7 C5           			PUSH    BC
1847+ 8DF8 01 06 00     			LD      BC,LIST1L
1848+ 8DFB ED B1        			CPIR
1849+ 8DFD C1           			POP     BC
1850+ 8DFE 20 02        			JR      NZ,LEXANE
1851+ 8E00 CB E1        			SET     4,C             ;ACCEPT LINE NUMBER
1852+ 8E02 21 17 8E     LEXANE:			LD      HL,LIST2
1853+ 8E05 C5           			PUSH    BC
1854+ 8E06 01 05 00     			LD      BC,LIST2L
1855+ 8E09 ED B1        			CPIR
1856+ 8E0B C1           			POP     BC
1857+ 8E0C 20 02        			JR      NZ,LEXANF
1858+ 8E0E CB C1        			SET     0,C             ;ENTER LEFT MODE
1859+ 8E10 C3 74 8D     LEXANF:			JP      LEXAN1
1860+ 8E13              ;
1861+ 8E13 E5           LIST1:			DEFB    GOTO
1862+ 8E14 E4           			DEFB    GOSUB
1863+ 8E15 F7           			DEFB    RESTOR
1864+ 8E16 FC           			DEFB    TRACE
1865+ 8E17 8C           LIST2:			DEFB    THEN
1866+ 8E18 8B           			DEFB    ELSE
1867+ 8E19              LIST1L:			EQU     $-LIST1
1868+ 8E19 F5           			DEFB    REPEAT
1869+ 8E1A 85           			DEFB    TERROR
1870+ 8E1B 3A           			DEFB    ':'
1871+ 8E1C              LIST2L:			EQU     $-LIST2
1872+ 8E1C              ;
1873+ 8E1C              ;ENCODE - ENCODE LINE NUMBER INTO PSEUDO-BINARY FORM.
1874+ 8E1C              ;   Inputs: HL=line number, DE=string pointer
1875+ 8E1C              ;  Outputs: DE updated, BIT 4,C set.
1876+ 8E1C              ; Destroys: A,B,C,D,E,H,L,F
1877+ 8E1C              ;
1878+ 8E1C CB E1        ENCODE:			SET     4,C
1879+ 8E1E EB           			EX      DE,HL
1880+ 8E1F 36 8D        			LD      (HL),LINO
1881+ 8E21 23           			INC     HL
1882+ 8E22 7A           			LD      A,D
1883+ 8E23 E6 C0        			AND     0C0H
1884+ 8E25 0F           			RRCA
1885+ 8E26 0F           			RRCA
1886+ 8E27 47           			LD      B,A
1887+ 8E28 7B           			LD      A,E
1888+ 8E29 E6 C0        			AND     0C0H
1889+ 8E2B B0           			OR      B
1890+ 8E2C 0F           			RRCA
1891+ 8E2D 0F           			RRCA
1892+ 8E2E EE 54        			XOR     01010100B
1893+ 8E30 77           			LD      (HL),A
1894+ 8E31 23           			INC     HL
1895+ 8E32 7B           			LD      A,E
1896+ 8E33 E6 3F        			AND     3FH
1897+ 8E35 F6 40        			OR      '@'
1898+ 8E37 77           			LD      (HL),A
1899+ 8E38 23           			INC     HL
1900+ 8E39 7A           			LD      A,D
1901+ 8E3A E6 3F        			AND     3FH
1902+ 8E3C F6 40        			OR      '@'
1903+ 8E3E 77           			LD      (HL),A
1904+ 8E3F 23           			INC     HL
1905+ 8E40 EB           			EX      DE,HL
1906+ 8E41 C9           			RET
1907+ 8E42              ;
1908+ 8E42              ;TEXT - OUTPUT MESSAGE.
1909+ 8E42              ;   Inputs: HL addresses text (terminated by nul)
1910+ 8E42              ;  Outputs: HL addresses character following nul.
1911+ 8E42              ; Destroys: A,H,L,F
1912+ 8E42              ;
1913+ 8E42 2A EE B6     @REPORT:		LD      HL,(ERRTXT)
1914+ 8E45 7E           TEXT:			LD      A,(HL)
1915+ 8E46 23           			INC     HL
1916+ 8E47 B7           			OR      A
1917+ 8E48 C8           			RET     Z
1918+ 8E49 CD B0 8A     			CALL    OUT
1919+ 8E4C 18 F7        			JR      TEXT
1920+ 8E4E              ;
1921+ 8E4E              ;TELL - OUTPUT MESSAGE.
1922+ 8E4E              ;   Inputs: Text follows subroutine call (term=nul)
1923+ 8E4E              ; Destroys: A,F
1924+ 8E4E              ;
1925+ 8E4E E3           @TELL:			EX      (SP),HL         ;GET RETURN ADDRESS
1926+ 8E4F CD 45 8E     			CALL    TEXT
1927+ 8E52 E3           			EX      (SP),HL
1928+ 8E53 C9           			RET
1929+ 8E54              ;
1930+ 8E54              CR:			EQU     0DH
1931+ 8E54              LF:			EQU     0AH
1932+ 8E54              ESC:			EQU     1BH
1933+ 8E54
1934+ 8E54              			ENDMODULE
# file closed: h:\My Code\Breadboard Z80\Z80\BBC Basic\main.z80
  11  8E54              			include "exec.z80"
# file opened: h:\My Code\Breadboard Z80\Z80\BBC Basic\exec.z80
   1+ 8E54              ;
   2+ 8E54              ;BBC BASIC INTERPRETER - Z80 VERSION
   3+ 8E54              ;STATEMENT EXECUTION & ASSEMBLER MODULE - "EXEC"
   4+ 8E54              ;(C) COPYRIGHT  R.T.RUSSELL  1984
   5+ 8E54              ;VERSION 2.1, 22-01-1984
   6+ 8E54              ;VERSION 3.0, 02-03-1987
   7+ 8E54              ;VERSION 3.1, 11-06-1987
   8+ 8E54              ;
   9+ 8E54              			MODULE EXEC
  10+ 8E54              ;
  11+ 8E54              TAND:			EQU     80H
  12+ 8E54              TOR:			EQU     84H
  13+ 8E54              TERROR:			EQU     85H
  14+ 8E54              LINE:			EQU     86H
  15+ 8E54              OFF:			EQU     87H
  16+ 8E54              STEP:			EQU     88H
  17+ 8E54              SPC:			EQU     89H
  18+ 8E54              TAB:			EQU     8AH
  19+ 8E54              ELSE:			EQU     8BH
  20+ 8E54              THEN:			EQU     8CH
  21+ 8E54              LINO:			EQU     8DH
  22+ 8E54              TO:			EQU     0B8H
  23+ 8E54              TCMD:			EQU     0C6H
  24+ 8E54              TCALL:			EQU     0D6H
  25+ 8E54              DATA:			EQU     0DCH
  26+ 8E54              DEF:			EQU     0DDH
  27+ 8E54              TGOSUB:			EQU     0E4H
  28+ 8E54              TGOTO:			EQU     0E5H
  29+ 8E54              TON:			EQU     0EEH
  30+ 8E54              TPROC:			EQU     0F2H
  31+ 8E54              TSTOP:			EQU     0FAH
  32+ 8E54              ;
  33+ 8E54 9A 88        CMDTAB:			DEFW    AUTO
  34+ 8E56 34 87        			DEFW    DELETE
  35+ 8E58 D2 88        			DEFW    LOAD
  36+ 8E5A 63 87        			DEFW    LIST
  37+ 8E5C B4 88        			DEFW    NEW
  38+ 8E5E B9 88        			DEFW    OLD
  39+ 8E60 E1 87        			DEFW    RENUM
  40+ 8E62 E0 88        			DEFW    SAVE
  41+ 8E64 5B 97        			DEFW    PUT
  42+ 8E66 11 96        			DEFW    PTR
  43+ 8E68 26 96        			DEFW    PAGEV
  44+ 8E6A 35 96        			DEFW    TIMEV
  45+ 8E6C 56 96        			DEFW    LOMEMV
  46+ 8E6E 69 96        			DEFW    HIMEMV
  47+ 8E70 B9 B2        			DEFW    SOUND
  48+ 8E72 DD 96        			DEFW    BPUT
  49+ 8E74 F0 96        			DEFW    CALL
  50+ 8E76 CD 8E        			DEFW    CHAIN
  51+ 8E78 EB 95        			DEFW    CLR
  52+ 8E7A D4 96        			DEFW    CLOSE
  53+ 8E7C B9 B2        			DEFW    CLG
  54+ 8E7E C8 95        			DEFW    CLS
  55+ 8E80 84 8F        			DEFW    REM             ;DATA
  56+ 8E82 84 8F        			DEFW    REM             ;DEF
  57+ 8E84 31 90        			DEFW    DIM
  58+ 8E86 B9 B2        			DEFW    DRAW
  59+ 8E88 33 8F        			DEFW    END
  60+ 8E8A 20 94        			DEFW    ENDPRO
  61+ 8E8C B9 B2        			DEFW    ENVEL
  62+ 8E8E 75 92        			DEFW    FOR
  63+ 8E90 30 92        			DEFW    GOSUB
  64+ 8E92 19 92        			DEFW    GOTO
  65+ 8E94 B9 B2        			DEFW    GCOL
  66+ 8E96 9B 95        			DEFW    IF
  67+ 8E98 AB 94        			DEFW    INPUT
  68+ 8E9A A4 8F        			DEFW    LET
  69+ 8E9C D2 93        			DEFW    LOCAL
  70+ 8E9E B9 B2        			DEFW    MODE
  71+ 8EA0 B9 B2        			DEFW    MOVE
  72+ 8EA2 BA 92        			DEFW    NEXT
  73+ 8EA4 B3 91        			DEFW    ON
  74+ 8EA6 B3 96        			DEFW    VDU
  75+ 8EA8 B9 B2        			DEFW    PLOT
  76+ 8EAA DE 90        			DEFW    PRINT
  77+ 8EAC 43 93        			DEFW    PROC
  78+ 8EAE 4A 95        			DEFW    READ
  79+ 8EB0 84 8F        			DEFW    REM
  80+ 8EB2 4B 92        			DEFW    REPEAT
  81+ 8EB4 E5 95        			DEFW    REPOR
  82+ 8EB6 F3 95        			DEFW    RESTOR
  83+ 8EB8 3B 92        			DEFW    RETURN
  84+ 8EBA C8 8E        			DEFW    RUN
  85+ 8EBC D2 95        			DEFW    STOP
  86+ 8EBE B9 B2        			DEFW    COLOUR
  87+ 8EC0 99 96        			DEFW    TRACE
  88+ 8EC2 53 92        			DEFW    UNTIL
  89+ 8EC4 8E 96        			DEFW    WIDTHV
  90+ 8EC6 70 8F        			DEFW    CLI             ;OSCLI
  91+ 8EC8              ;
  92+ 8EC8 CD E5 98     RUN:			CALL    TERM?
  93+ 8ECB 28 0D        			JR      Z,RUN0
  94+ 8ECD CD C0 A0     CHAIN:			CALL    EXPRS
  95+ 8ED0 3E 0D        			LD      A,CR
  96+ 8ED2 12           			LD      (DE),A
  97+ 8ED3 ED 7B E4 B6  @CHAIN0:		LD      SP,(HIMEM)
  98+ 8ED7 CD A6 89     			CALL    LOAD0
  99+ 8EDA ED 7B E4 B6  @RUN0:			LD      SP,(HIMEM)      ;PREPARE FOR RUN
 100+ 8EDE DD 21 F6 B6  			LD      IX,RANDOM
 101+ 8EE2              ; dtrg: bugfix here; on emulators, R is always zero, and the original
 102+ 8EE2              ; code always waiting until it was non-zero, resulting in a hang.
 103+ 8EE2              ; Instead we crudely hack around it.
 104+ 8EE2 ED 5F        			ld      a, r
 105+ 8EE4 20 01        			jr      nz, 1F
 106+ 8EE6 3C           			inc     a
 107+ 8EE7              ;
 108+ 8EE7 07           1:			RLCA
 109+ 8EE8 07           			RLCA
 110+ 8EE9 DD 77 03     			LD      (IX+3),A
 111+ 8EEC 9F           			SBC     A,A
 112+ 8EED DD 77 04     			LD      (IX+4),A
 113+ 8EF0 CD EF 89     			CALL    CLEAR
 114+ 8EF3 21 00 00     			LD      HL,0
 115+ 8EF6 22 EC B6     			LD      (ERRTRP),HL
 116+ 8EF9 2A DC B6     			LD      HL,(PAGE)
 117+ 8EFC 3E DC        			LD      A,DATA
 118+ 8EFE CD A3 99     			CALL    SEARCH          ;LOOK FOR "DATA"
 119+ 8F01 22 F0 B6     			LD      (DATPTR),HL     ;SET DATA POINTER
 120+ 8F04 FD 2A DC B6  			LD      IY,(PAGE)
 121+ 8F08 CD 43 8F     XEQ0:			CALL    NEWLIN
 122+ 8F0B FD 22 F4 B6  @XEQ:			LD      (ERRLIN),IY     ;ERROR POINTER
 123+ 8F0F CD 04 B3     			CALL    TRAP            ;CHECK KEYBOARD
 124+ 8F12 CD 9B A6     XEQ1:			CALL    NXT
 125+ 8F15 FD 23        			INC     IY
 126+ 8F17 FE 3A        			CP      ':'             ;SEPARATOR
 127+ 8F19 28 F7        			JR      Z,XEQ1
 128+ 8F1B FE 0D        			CP      CR
 129+ 8F1D 28 E9        			JR      Z,XEQ0          ;NEW PROGRAM LINE
 130+ 8F1F D6 C6        			SUB     TCMD
 131+ 8F21 38 6F        			JR      C,LET0          ;IMPLIED "LET"
 132+ 8F23 87           			ADD     A,A
 133+ 8F24 4F           			LD      C,A
 134+ 8F25 06 00        			LD      B,0
 135+ 8F27 21 54 8E     			LD      HL,CMDTAB
 136+ 8F2A 09           			ADD     HL,BC
 137+ 8F2B 7E           			LD      A,(HL)          ;TABLE ENTRY
 138+ 8F2C 23           			INC     HL
 139+ 8F2D 66           			LD      H,(HL)
 140+ 8F2E 6F           			LD      L,A
 141+ 8F2F CD 9B A6     			CALL    NXT
 142+ 8F32 E9           			JP      (HL)            ;EXECUTE STATEMENT
 143+ 8F33              ;
 144+ 8F33              ;END
 145+ 8F33              ;
 146+ 8F33 CD E7 8A     END:			CALL    SETLIN          ;FIND CURRENT LINE
 147+ 8F36 7C           			LD      A,H
 148+ 8F37 B5           			OR      L               ;DIRECT?
 149+ 8F38 CA 92 82     			JP      Z,CLOOP
 150+ 8F3B 1E 00        			LD      E,0
 151+ 8F3D CD 04 B3     			CALL    OSSHUT          ;CLOSE ALL FILES
 152+ 8F40 C3 91 82     			JP      WARM            ;"Ready"
 153+ 8F43              ;
 154+ 8F43 FD 7E 00     NEWLIN:			LD      A,(IY+0)        ;A=LINE LENGTH
 155+ 8F46 01 03 00     			LD      BC,3
 156+ 8F49 FD 09        			ADD     IY,BC
 157+ 8F4B B7           			OR      A
 158+ 8F4C 28 E5        			JR      Z,END           ;LENGTH=0, EXIT
 159+ 8F4E 2A E8 B6     			LD      HL,(TRACEN)
 160+ 8F51 7C           			LD      A,H
 161+ 8F52 B5           			OR      L
 162+ 8F53 C8           			RET     Z
 163+ 8F54 FD 56 FF     			LD      D,(IY-1)        ;DE = LINE NUMBER
 164+ 8F57 FD 5E FE     			LD      E,(IY-2)
 165+ 8F5A ED 52        			SBC     HL,DE
 166+ 8F5C D8           			RET     C
 167+ 8F5D EB           			EX      DE,HL
 168+ 8F5E 3E 5B        			LD      A,'['           ;TRACE
 169+ 8F60 CD 97 8A     			CALL    OUTCHR
 170+ 8F63 CD 24 8B     			CALL    PBCDL
 171+ 8F66 3E 5D        			LD      A,']'
 172+ 8F68 CD 97 8A     			CALL    OUTCHR
 173+ 8F6B 3E 20        			LD      A,' '
 174+ 8F6D C3 97 8A     			JP      OUTCHR
 175+ 8F70              ;
 176+ 8F70              ;ROUTINES FOR EACH STATEMENT:
 177+ 8F70              ;
 178+ 8F70              ;OSCLI
 179+ 8F70              ;
 180+ 8F70 CD C0 A0     CLI:			CALL    EXPRS
 181+ 8F73 3E 0D        			LD      A,CR
 182+ 8F75 12           			LD      (DE),A
 183+ 8F76 21 00 B4     			LD      HL,ACCS
 184+ 8F79 CD 04 B3     			CALL    OSCLI
 185+ 8F7C 18 8D        			JR      XEQ
 186+ 8F7E              ;
 187+ 8F7E              ;REM, *
 188+ 8F7E              ;
 189+ 8F7E FD E5        EXT:			PUSH    IY
 190+ 8F80 E1           			POP     HL
 191+ 8F81 CD 04 B3     			CALL    OSCLI
 192+ 8F84 FD E5        REM:			PUSH    IY
 193+ 8F86 E1           			POP     HL
 194+ 8F87 3E 0D        			LD      A,CR
 195+ 8F89 47           			LD      B,A
 196+ 8F8A ED B1        			CPIR                    ;FIND LINE END
 197+ 8F8C E5           			PUSH    HL
 198+ 8F8D FD E1        			POP     IY
 199+ 8F8F C3 08 8F     			JP      XEQ0
 200+ 8F92              ;
 201+ 8F92              ;[LET] var = expr
 202+ 8F92              ;
 203+ 8F92 FE C5        LET0:			CP      ELSE-TCMD
 204+ 8F94 28 EE        			JR      Z,REM
 205+ 8F96 FE 64        			CP      ('*'-TCMD) AND 0xFF
 206+ 8F98 28 E4        			JR      Z,EXT
 207+ 8F9A FE 77        			CP      ('='-TCMD) AND 0xFF
 208+ 8F9C 28 4C        			JR      Z,FNEND
 209+ 8F9E FE 95        			CP      ('['-TCMD) AND 0xFF
 210+ 8FA0 28 1E        			JR      Z,ASM
 211+ 8FA2 FD 2B        			DEC     IY
 212+ 8FA4 CD 6D 97     LET:			CALL    ASSIGN
 213+ 8FA7 CA 0B 8F     			JP      Z,XEQ
 214+ 8FAA 38 36        			JR      C,SYNTAX        ;"Syntax error"
 215+ 8FAC F5           			PUSH    AF              ;SAVE STRING TYPE
 216+ 8FAD CD F9 98     			CALL    EQUALS
 217+ 8FB0 E5           			PUSH    HL
 218+ 8FB1 CD C0 A0     			CALL    EXPRS
 219+ 8FB4 DD E1        			POP     IX
 220+ 8FB6 F1           			POP     AF
 221+ 8FB7 CD AA 97     			CALL    STACCS
 222+ 8FBA C3 0B 8F     XEQR:			JP      XEQ
 223+ 8FBD              ;
 224+ 8FBD CD 43 8F     ASM0:			CALL    NEWLIN
 225+ 8FC0 FD 22 F4 B6  ASM:			LD      (ERRLIN),IY
 226+ 8FC4 CD 04 B3     			CALL    TRAP
 227+ 8FC7 CD EC 99     			CALL    ASSEM
 228+ 8FCA 38 16        			JR      C,SYNTAX
 229+ 8FCC FE 0D        			CP      CR
 230+ 8FCE 28 ED        			JR      Z,ASM0
 231+ 8FD0 21 FE B6     			LD      HL,LISTON
 232+ 8FD3 7E           			LD      A,(HL)
 233+ 8FD4 E6 0F        			AND     0FH
 234+ 8FD6 F6 30        			OR      30H
 235+ 8FD8 77           			LD      (HL),A
 236+ 8FD9 18 DF        			JR      XEQR
 237+ 8FDB              ;
 238+ 8FDB CD 62 8B     VAR:			CALL    GETVAR
 239+ 8FDE C8           			RET     Z
 240+ 8FDF D2 53 8B     			JP      NC,PUTVAR
 241+ 8FE2 3E 10        @SYNTAX:		LD      A,16            ;"Syntax error"
 242+ 8FE4 21           			DEFB    21H
 243+ 8FE5 3E 11        @ESCAPE:		LD      A,17            ;"Escape"
 244+ 8FE7 C3 FE 88     ERROR0:			JP      ERROR
 245+ 8FEA              ;
 246+ 8FEA              ;=
 247+ 8FEA              ;
 248+ 8FEA CD A7 9F     FNEND:			CALL    EXPR            ;FUNCTION RESULT
 249+ 8FED 43           			LD      B,E
 250+ 8FEE EB           			EX      DE,HL
 251+ 8FEF D9           			EXX                     ;SAVE RESULT
 252+ 8FF0 EB           			EX      DE,HL           ; IN DEB'C'D'E'
 253+ 8FF1 C1           FNEND5:			POP     BC
 254+ 8FF2 21 C5 98     			LD      HL,LOCCHK
 255+ 8FF5 B7           			OR      A
 256+ 8FF6 ED 42        			SBC     HL,BC
 257+ 8FF8 28 19        			JR      Z,FNEND0        ;LOCAL VARIABLE
 258+ 8FFA 21 43 93     			LD      HL,FNCHK
 259+ 8FFD B7           			OR      A
 260+ 8FFE ED 42        			SBC     HL,BC
 261+ 9000 3E 07        			LD      A,7
 262+ 9002 20 E3        			JR      NZ,ERROR0       ;"No FN"
 263+ 9004 FD E1        			POP     IY
 264+ 9006 FD 22 F4 B6  			LD      (ERRLIN),IY     ;IN CASE OF ERROR
 265+ 900A EB           			EX      DE,HL
 266+ 900B D9           			EXX
 267+ 900C EB           			EX      DE,HL
 268+ 900D 11 00 B4     			LD      DE,ACCS
 269+ 9010 58           			LD      E,B
 270+ 9011 08           			EX      AF,AF'
 271+ 9012 C9           			RET
 272+ 9013              ;
 273+ 9013 DD E1        FNEND0:			POP     IX
 274+ 9015 C1           			POP     BC
 275+ 9016 78           			LD      A,B
 276+ 9017 B7           			OR      A
 277+ 9018 FA 24 90     			JP      M,FNEND1        ;STRING
 278+ 901B E1           			POP     HL
 279+ 901C D9           			EXX
 280+ 901D E1           			POP     HL
 281+ 901E D9           			EXX
 282+ 901F CD 81 97     			CALL    STORE
 283+ 9022 18 CD        			JR      FNEND5
 284+ 9024 21 00 00     FNEND1:			LD      HL,0
 285+ 9027 39           			ADD     HL,SP
 286+ 9028 D5           			PUSH    DE
 287+ 9029 59           			LD      E,C
 288+ 902A CD AD 97     			CALL    STORES
 289+ 902D D1           			POP     DE
 290+ 902E F9           			LD      SP,HL
 291+ 902F 18 C0        			JR      FNEND5
 292+ 9031              ;
 293+ 9031              ;DIM var(dim1[,dim2[,...]])[,var(...]
 294+ 9031              ;DIM var expr[,var expr...]
 295+ 9031              ;
 296+ 9031 CD 62 8B     DIM:			CALL    GETVAR          ;VARIABLE
 297+ 9034 38 7B        			JR      C,BADDIM
 298+ 9036 CA B9 90     			JP      Z,DIM4
 299+ 9039 CD A0 8C     			CALL    CREATE
 300+ 903C E5           			PUSH    HL
 301+ 903D DD E1        			POP     IX
 302+ 903F FD 7E 00     			LD      A,(IY)
 303+ 9042 FE 28        			CP      '('
 304+ 9044 7A           			LD      A,D
 305+ 9045 20 72        			JR      NZ,DIM4
 306+ 9047 E5           			PUSH    HL
 307+ 9048 F5           			PUSH    AF              ;SAVE TYPE
 308+ 9049 11 01 00     			LD      DE,1
 309+ 904C 42           			LD      B,D             ;DIMENSION COUNTER
 310+ 904D FD 23        DIM1:			INC     IY
 311+ 904F C5           			PUSH    BC
 312+ 9050 D5           			PUSH    DE
 313+ 9051 DD E5        			PUSH    IX
 314+ 9053 CD B7 A0     			CALL    EXPRI           ;DIMENSION SIZE
 315+ 9056 CB 7C        			BIT     7,H
 316+ 9058 20 57        			JR      NZ,BADDIM
 317+ 905A D9           			EXX
 318+ 905B 23           			INC     HL
 319+ 905C DD E1        			POP     IX
 320+ 905E DD 23        			INC     IX
 321+ 9060 DD 75 00     			LD      (IX),L          ;SAVE SIZE
 322+ 9063 DD 23        			INC     IX
 323+ 9065 DD 74 00     			LD      (IX),H
 324+ 9068 C1           			POP     BC
 325+ 9069 CD C6 99     			CALL    MUL16           ;HL=HL*BC
 326+ 906C 38 46        			JR      C,NOROOM        ;TOO LARGE
 327+ 906E EB           			EX      DE,HL           ;DE=PRODUCT
 328+ 906F C1           			POP     BC
 329+ 9070 04           			INC     B               ;DIMENSION COUNTER
 330+ 9071 FD 7E 00     			LD      A,(IY)
 331+ 9074 FE 2C        			CP      ','             ;ANOTHER
 332+ 9076 28 D5        			JR      Z,DIM1
 333+ 9078 CD 5F A6     			CALL    BRAKET          ;CLOSING BRACKET
 334+ 907B F1           			POP     AF              ;RESTORE TYPE
 335+ 907C DD 23        			INC     IX
 336+ 907E DD E3        			EX      (SP),IX
 337+ 9080 DD 70 00     			LD      (IX),B          ;NO. OF DIMENSIONS
 338+ 9083 CD B9 99     			CALL    X4OR5           ;DE=DE*n
 339+ 9086 E1           			POP     HL
 340+ 9087 38 2B        			JR      C,NOROOM
 341+ 9089 19           DIM3:			ADD     HL,DE
 342+ 908A 38 28        			JR      C,NOROOM
 343+ 908C E5           			PUSH    HL
 344+ 908D 24           			INC     H
 345+ 908E 28 24        			JR      Z,NOROOM
 346+ 9090 ED 72        			SBC     HL,SP
 347+ 9092 30 20        			JR      NC,NOROOM       ;OUT OF SPACE
 348+ 9094 E1           			POP     HL
 349+ 9095 22 E2 B6     			LD      (FREE),HL
 350+ 9098 7A           DIM2:			LD      A,D
 351+ 9099 B3           			OR      E
 352+ 909A 28 06        			JR      Z,DIM5
 353+ 909C 2B           			DEC     HL
 354+ 909D 36 00        			LD      (HL),0          ;INITIALISE ARRAY
 355+ 909F 1B           			DEC     DE
 356+ 90A0 18 F6        			JR      DIM2
 357+ 90A2 CD 9B A6     DIM5:			CALL    NXT
 358+ 90A5 FE 2C        			CP      ','             ;ANOTHER VARIABLE?
 359+ 90A7 C2 0B 8F     			JP      NZ,XEQ
 360+ 90AA FD 23        			INC     IY
 361+ 90AC CD 9B A6     			CALL    NXT
 362+ 90AF 18 80        			JR      DIM
 363+ 90B1              ;
 364+ 90B1 3E 0A        BADDIM:			LD      A,10            ;"Bad DIM"
 365+ 90B3 21           			DEFB    21H
 366+ 90B4 3E 0B        NOROOM:			LD      A,11            ;"DIM space"
 367+ 90B6 C3 FE 88     ERROR1:			JP      ERROR
 368+ 90B9              ;
 369+ 90B9 B7           DIM4:			OR      A
 370+ 90BA 28 F5        			JR      Z,BADDIM
 371+ 90BC FA B1 90     			JP      M,BADDIM
 372+ 90BF 47           			LD      B,A
 373+ 90C0 FD 7E FF     			LD      A,(IY-1)
 374+ 90C3 FE 29        			CP      ')'
 375+ 90C5 78           			LD      A,B
 376+ 90C6 28 E9        			JR      Z,BADDIM
 377+ 90C8 2A E2 B6     			LD      HL,(FREE)
 378+ 90CB D9           			EXX
 379+ 90CC 21 00 00     			LD      HL,0
 380+ 90CF 4C           			LD      C,H
 381+ 90D0 CD 81 97     			CALL    STORE           ;RESERVED AREA
 382+ 90D3 CD B7 A0     			CALL    EXPRI
 383+ 90D6 D9           			EXX
 384+ 90D7 23           			INC     HL
 385+ 90D8 EB           			EX      DE,HL
 386+ 90D9 2A E2 B6     			LD      HL,(FREE)
 387+ 90DC 18 AB        			JR      DIM3
 388+ 90DE              ;
 389+ 90DE              ;PRINT list...
 390+ 90DE              ;PRINT #channel,list...
 391+ 90DE              ;
 392+ 90DE FE 23        PRINT:			CP      '#'
 393+ 90E0 20 6B        			JR      NZ,PRINT0
 394+ 90E2 CD E4 99     			CALL    CHNL            ;CHANNEL NO. = E
 395+ 90E5 CD 9B A6     PRNTN1:			CALL    NXT
 396+ 90E8 FE 2C        			CP      ','
 397+ 90EA C2 0B 8F     			JP      NZ,XEQ
 398+ 90ED FD 23        			INC     IY
 399+ 90EF D5           			PUSH    DE
 400+ 90F0 CD A7 9F     			CALL    EXPR            ;ITEM TO PRINT
 401+ 90F3 08           			EX      AF,AF'
 402+ 90F4 FA 14 91     			JP      M,PRNTN2        ;STRING
 403+ 90F7 D1           			POP     DE
 404+ 90F8 C5           			PUSH    BC
 405+ 90F9 D9           			EXX
 406+ 90FA 7D           			LD      A,L
 407+ 90FB D9           			EXX
 408+ 90FC CD 04 B3     			CALL    OSBPUT
 409+ 90FF D9           			EXX
 410+ 9100 7C           			LD      A,H
 411+ 9101 D9           			EXX
 412+ 9102 CD 04 B3     			CALL    OSBPUT
 413+ 9105 7D           			LD      A,L
 414+ 9106 CD 04 B3     			CALL    OSBPUT
 415+ 9109 7C           			LD      A,H
 416+ 910A CD 04 B3     			CALL    OSBPUT
 417+ 910D C1           			POP     BC
 418+ 910E 79           			LD      A,C
 419+ 910F CD 04 B3     			CALL    OSBPUT
 420+ 9112 18 D1        			JR      PRNTN1
 421+ 9114 4B           PRNTN2:			LD      C,E
 422+ 9115 D1           			POP     DE
 423+ 9116 21 00 B4     			LD      HL,ACCS
 424+ 9119 0C           			INC     C
 425+ 911A 0D           PRNTN3:			DEC     C
 426+ 911B 28 09        			JR      Z,PRNTN4
 427+ 911D 7E           			LD      A,(HL)
 428+ 911E 23           			INC     HL
 429+ 911F C5           			PUSH    BC
 430+ 9120 CD 04 B3     			CALL    OSBPUT
 431+ 9123 C1           			POP     BC
 432+ 9124 18 F4        			JR      PRNTN3
 433+ 9126 3E 0D        PRNTN4:			LD      A,CR
 434+ 9128 CD 04 B3     			CALL    OSBPUT
 435+ 912B 18 B8        			JR      PRNTN1
 436+ 912D              ;
 437+ 912D 06 02        PRINT6:			LD      B,2
 438+ 912F 18 22        			JR      PRINTC
 439+ 9131 01 00 01     PRINT8:			LD      BC,100H
 440+ 9134 18 1D        			JR      PRINTC
 441+ 9136 21 00 B6     PRINT9:			LD      HL,STAVAR
 442+ 9139 AF           			XOR     A
 443+ 913A BE           			CP      (HL)
 444+ 913B 28 10        			JR      Z,PRINT0
 445+ 913D 3A FB B6     			LD      A,(COUNT)
 446+ 9140 B7           			OR      A
 447+ 9141 28 0A        			JR      Z,PRINT0
 448+ 9143 96           PRINTA:			SUB     (HL)
 449+ 9144 28 07        			JR      Z,PRINT0
 450+ 9146 30 FB        			JR      NC,PRINTA
 451+ 9148 ED 44        			NEG
 452+ 914A CD 4D 99     			CALL    FILL
 453+ 914D 3A 00 B6     PRINT0:			LD      A,(STAVAR)
 454+ 9150 4F           			LD      C,A             ;PRINTS
 455+ 9151 06 00        			LD      B,0             ;PRINTF
 456+ 9153 CD E5 98     PRINTC:			CALL    TERM?
 457+ 9156 28 38        			JR      Z,PRINT4
 458+ 9158 CB 80        			RES     0,B
 459+ 915A FD 23        			INC     IY
 460+ 915C FE 7E        			CP      '~'
 461+ 915E 28 CD        			JR      Z,PRINT6
 462+ 9160 FE 3B        			CP      ';'
 463+ 9162 28 CD        			JR      Z,PRINT8
 464+ 9164 FE 2C        			CP      ','
 465+ 9166 28 CE        			JR      Z,PRINT9
 466+ 9168 CD 06 99     			CALL    FORMAT          ;SPC, TAB, '
 467+ 916B 28 E6        			JR      Z,PRINTC
 468+ 916D FD 2B        			DEC     IY
 469+ 916F C5           			PUSH    BC
 470+ 9170 CD A7 9F     			CALL    EXPR            ;VARIABLE TYPE
 471+ 9173 08           			EX      AF,AF'
 472+ 9174 FA 8A 91     			JP      M,PRINT3        ;STRING
 473+ 9177 D1           			POP     DE
 474+ 9178 D5           			PUSH    DE
 475+ 9179 CB 4A        			BIT     1,D
 476+ 917B F5           			PUSH    AF
 477+ 917C CC B9 A5     			CALL    Z,STR           ;DECIMAL
 478+ 917F F1           			POP     AF
 479+ 9180 C4 76 A5     			CALL    NZ,HEXSTR       ;HEX
 480+ 9183 C1           			POP     BC
 481+ 9184 C5           			PUSH    BC
 482+ 9185 79           			LD      A,C
 483+ 9186 93           			SUB     E
 484+ 9187 D4 4D 99     			CALL    NC,FILL         ;RIGHT JUSTIFY
 485+ 918A C1           PRINT3:			POP     BC
 486+ 918B CD 5B 99     			CALL    PTEXT           ;PRINT
 487+ 918E 18 C3        			JR      PRINTC
 488+ 9190 CB 40        PRINT4:			BIT     0,B
 489+ 9192 CC 90 8A     			CALL    Z,CRLF
 490+ 9195 C3 0B 8F     			JP      XEQ
 491+ 9198              ;
 492+ 9198              ;
 493+ 9198 FD 23        ONERR:			INC     IY              ;SKIP "ERROR"
 494+ 919A 21 00 00     			LD      HL,0
 495+ 919D 22 EC B6     			LD      (ERRTRP),HL
 496+ 91A0 CD 9B A6     			CALL    NXT
 497+ 91A3 FE 87        			CP      OFF
 498+ 91A5 FD 23        			INC     IY
 499+ 91A7 CA 0B 8F     			JP      Z,XEQ
 500+ 91AA FD 2B        			DEC     IY
 501+ 91AC FD 22 EC B6  			LD      (ERRTRP),IY
 502+ 91B0 C3 84 8F     			JP      REM
 503+ 91B3              ;
 504+ 91B3              ;ON expr GOTO line[,line...] [ELSE statement]
 505+ 91B3              ;ON expr GOTO line[,line...] [ELSE line]
 506+ 91B3              ;ON expr GOSUB line[,line...] [ELSE statement]
 507+ 91B3              ;ON expr GOSUB line[,line...] [ELSE line]
 508+ 91B3              ;ON expr PROCone [,PROCtwo..] [ELSE PROCotherwise]
 509+ 91B3              ;ON ERROR statement [:statement...]
 510+ 91B3              ;ON ERROR OFF
 511+ 91B3              ;
 512+ 91B3 FE 85        ON:			CP      TERROR
 513+ 91B5 28 E1        			JR      Z,ONERR         ;"ON ERROR"
 514+ 91B7 CD B7 A0     			CALL    EXPRI
 515+ 91BA FD 7E 00     			LD      A,(IY)
 516+ 91BD FD 23        			INC     IY
 517+ 91BF 1E 2C        			LD      E,','           ;SEPARATOR
 518+ 91C1 FE E5        			CP      TGOTO
 519+ 91C3 28 0B        			JR      Z,ON1
 520+ 91C5 FE E4        			CP      TGOSUB
 521+ 91C7 28 07        			JR      Z,ON1
 522+ 91C9 1E F2        			LD      E,TPROC
 523+ 91CB BB           			CP      E
 524+ 91CC 3E 27        			LD      A,39
 525+ 91CE 20 41        			JR      NZ,ERROR2       ;"ON syntax"
 526+ 91D0 57           ON1:			LD      D,A
 527+ 91D1 D9           			EXX
 528+ 91D2 E5           			PUSH    HL
 529+ 91D3 D9           			EXX
 530+ 91D4 C1           			POP     BC              ;ON INDEX
 531+ 91D5 78           			LD      A,B
 532+ 91D6 B4           			OR      H
 533+ 91D7 B5           			OR      L
 534+ 91D8 20 27        			JR      NZ,ON4          ;OUT OF RANGE
 535+ 91DA B1           			OR      C
 536+ 91DB 28 24        			JR      Z,ON4
 537+ 91DD 0D           			DEC     C
 538+ 91DE 28 0D        			JR      Z,ON3           ;INDEX=1
 539+ 91E0 CD E5 98     ON2:			CALL    TERM?
 540+ 91E3 28 1C        			JR      Z,ON4           ;OUT OF RANGE
 541+ 91E5 FD 23        			INC     IY              ;SKIP DELIMITER
 542+ 91E7 BB           			CP      E
 543+ 91E8 20 F6        			JR      NZ,ON2
 544+ 91EA 0D           			DEC     C
 545+ 91EB 20 F3        			JR      NZ,ON2
 546+ 91ED 7B           ON3:			LD      A,E
 547+ 91EE FE F2        			CP      TPROC
 548+ 91F0 28 22        			JR      Z,ONPROC
 549+ 91F2 D5           			PUSH    DE
 550+ 91F3 CD CE A0     			CALL    ITEMI           ;LINE NUMBER
 551+ 91F6 D1           			POP     DE
 552+ 91F7 7A           			LD      A,D
 553+ 91F8 FE E5        			CP      TGOTO
 554+ 91FA 28 26        			JR      Z,GOTO2
 555+ 91FC CD F1 98     			CALL    SPAN            ;SKIP REST OF LIST
 556+ 91FF 18 32        			JR      GOSUB1
 557+ 9201              ;
 558+ 9201 FD 7E 00     ON4:			LD      A,(IY)
 559+ 9204 FD 23        			INC     IY
 560+ 9206 FE 8B        			CP      ELSE
 561+ 9208 CA AD 95     			JP      Z,IF1           ;ELSE CLAUSE
 562+ 920B FE 0D        			CP      CR
 563+ 920D 20 F2        			JR      NZ,ON4
 564+ 920F 3E 28        			LD      A,40
 565+ 9211 C3 FE 88     ERROR2:			JP      ERROR           ;"ON range"
 566+ 9214              ;
 567+ 9214 3E EE        ONPROC:			LD      A,TON
 568+ 9216 C3 43 93     			JP      PROC
 569+ 9219              ;
 570+ 9219              ;GOTO line
 571+ 9219              ;
 572+ 9219 CD CE A0     GOTO:			CALL    ITEMI           ;LINE NUMBER
 573+ 921C CD E5 98     GOTO1:			CALL    TERM?
 574+ 921F C2 E2 8F     			JP      NZ,SYNTAX
 575+ 9222 D9           GOTO2:			EXX
 576+ 9223 CD CE 8A     			CALL    FINDL
 577+ 9226 E5           			PUSH    HL
 578+ 9227 FD E1        			POP     IY
 579+ 9229 CA 08 8F     			JP      Z,XEQ0
 580+ 922C 3E 29        			LD      A,41
 581+ 922E 18 E1        			JR      ERROR2          ;"No such line"
 582+ 9230              ;
 583+ 9230              ;GOSUB line
 584+ 9230              ;
 585+ 9230 CD CE A0     GOSUB:			CALL    ITEMI           ;LINE NUMBER
 586+ 9233 FD E5        GOSUB1:			PUSH    IY              ;TEXT POINTER
 587+ 9235 CD E2 97     			CALL    CHECK           ;CHECK ROOM
 588+ 9238 CD 1C 92     			CALL    GOTO1           ;SAVE MARKER
 589+ 923B              GOSCHK:			EQU     $
 590+ 923B              ;
 591+ 923B              ;RETURN
 592+ 923B              ;
 593+ 923B D1           RETURN:			POP     DE              ;MARKER
 594+ 923C 21 3B 92     			LD      HL,GOSCHK
 595+ 923F B7           			OR      A
 596+ 9240 ED 52        			SBC     HL,DE
 597+ 9242 FD E1        			POP     IY
 598+ 9244 CA 0B 8F     			JP      Z,XEQ
 599+ 9247 3E 26        			LD      A,38
 600+ 9249 18 C6        			JR      ERROR2          ;"No GOSUB"
 601+ 924B              ;
 602+ 924B              ;REPEAT
 603+ 924B              ;
 604+ 924B FD E5        REPEAT:			PUSH    IY
 605+ 924D CD E2 97     			CALL    CHECK
 606+ 9250 CD 0B 8F     			CALL    XEQ
 607+ 9253              REPCHK:			EQU     $
 608+ 9253              ;
 609+ 9253              ;UNTIL expr
 610+ 9253              ;
 611+ 9253 C1           UNTIL:			POP     BC
 612+ 9254 C5           			PUSH    BC
 613+ 9255 21 53 92     			LD      HL,REPCHK
 614+ 9258 B7           			OR      A
 615+ 9259 ED 42        			SBC     HL,BC
 616+ 925B 3E 2B        			LD      A,43
 617+ 925D 20 B2        			JR      NZ,ERROR2       ;"No REPEAT"
 618+ 925F CD B7 A0     			CALL    EXPRI
 619+ 9262 CD 42 A5     			CALL    TEST
 620+ 9265 C1           			POP     BC
 621+ 9266 D1           			POP     DE
 622+ 9267 20 05        			JR      NZ,XEQ2         ;TRUE
 623+ 9269 D5           			PUSH    DE
 624+ 926A C5           			PUSH    BC
 625+ 926B D5           			PUSH    DE
 626+ 926C FD E1        			POP     IY
 627+ 926E C3 0B 8F     XEQ2:			JP      XEQ
 628+ 9271              ;
 629+ 9271              ;FOR var = expr TO expr [STEP expr]
 630+ 9271              ;
 631+ 9271 3E 22        FORVAR:			LD      A,34
 632+ 9273 18 9C        			JR      ERROR2          ;"FOR variable"
 633+ 9275              ;
 634+ 9275 CD 6D 97     FOR:			CALL    ASSIGN
 635+ 9278 20 F7        			JR      NZ,FORVAR       ;"FOR variable"
 636+ 927A F5           			PUSH    AF              ;SAVE TYPE
 637+ 927B FD 7E 00     			LD      A,(IY)
 638+ 927E FE B8        			CP      TO
 639+ 9280 3E 24        			LD      A,36
 640+ 9282 20 8D        			JR      NZ,ERROR2       ;"No TO"
 641+ 9284 FD 23        			INC     IY
 642+ 9286 DD E5        			PUSH    IX
 643+ 9288 CD B0 A0     			CALL    EXPRN           ;LIMIT
 644+ 928B DD E1        			POP     IX
 645+ 928D F1           			POP     AF
 646+ 928E 47           			LD      B,A             ;TYPE
 647+ 928F C5           			PUSH    BC              ;SAVE ON STACK
 648+ 9290 E5           			PUSH    HL
 649+ 9291 21 00 00     			LD      HL,0
 650+ 9294 4C           			LD      C,H
 651+ 9295 D9           			EXX
 652+ 9296 E5           			PUSH    HL
 653+ 9297 21 01 00     			LD      HL,1            ;PRESET STEP
 654+ 929A D9           			EXX
 655+ 929B FD 7E 00     			LD      A,(IY)
 656+ 929E FE 88        			CP      STEP
 657+ 92A0 20 09        			JR      NZ,FOR1
 658+ 92A2 FD 23        			INC     IY
 659+ 92A4 DD E5        			PUSH    IX
 660+ 92A6 CD B0 A0     			CALL    EXPRN           ;STEP
 661+ 92A9 DD E1        			POP     IX
 662+ 92AB C5           FOR1:			PUSH    BC
 663+ 92AC E5           			PUSH    HL
 664+ 92AD D9           			EXX
 665+ 92AE E5           			PUSH    HL
 666+ 92AF D9           			EXX
 667+ 92B0 FD E5        			PUSH    IY              ;SAVE TEXT POINTER
 668+ 92B2 DD E5        			PUSH    IX              ;LOOP VARIABLE
 669+ 92B4 CD E2 97     			CALL    CHECK
 670+ 92B7 CD 0B 8F     			CALL    XEQ
 671+ 92BA              FORCHK:			EQU     $
 672+ 92BA              ;
 673+ 92BA              ;NEXT [var[,var...]]
 674+ 92BA              ;
 675+ 92BA C1           NEXT:			POP     BC              ;MARKER
 676+ 92BB 21 BA 92     			LD      HL,FORCHK
 677+ 92BE B7           			OR      A
 678+ 92BF ED 42        			SBC     HL,BC
 679+ 92C1 3E 20        			LD      A,32
 680+ 92C3 20 77        			JR      NZ,ERROR3       ;"No FOR"
 681+ 92C5 CD E5 98     			CALL    TERM?
 682+ 92C8 E1           			POP     HL
 683+ 92C9 E5           			PUSH    HL
 684+ 92CA C5           			PUSH    BC
 685+ 92CB E5           			PUSH    HL
 686+ 92CC C4 62 8B     			CALL    NZ,GETVAR       ;VARIABLE
 687+ 92CF D1           			POP     DE
 688+ 92D0 EB           			EX      DE,HL
 689+ 92D1 B7           			OR      A
 690+ 92D2 ED 52        NEXT0:			SBC     HL,DE
 691+ 92D4 20 54        			JR      NZ,NEXT1
 692+ 92D6 D5           			PUSH    DE
 693+ 92D7 DD 21 08 00  			LD      IX,6+2
 694+ 92DB DD 39        			ADD     IX,SP
 695+ 92DD CD E8 A1     			CALL    DLOAD5          ;STEP
 696+ 92E0 DD 7E 0B     			LD      A,(IX+11)       ;TYPE
 697+ 92E3 DD E1        			POP     IX
 698+ 92E5 CD 70 A1     			CALL    LOADN           ;LOOP VARIABLE
 699+ 92E8 CB 7A        			BIT     7,D             ;SIGN?
 700+ 92EA F5           			PUSH    AF
 701+ 92EB 3E 0B        			LD      A,'+' AND 0FH
 702+ 92ED CD BF A6     			CALL    FPP             ;ADD STEP
 703+ 92F0 38 4A        			JR      C,ERROR3
 704+ 92F2 F1           			POP     AF              ;RESTORE TYPE
 705+ 92F3 F5           			PUSH    AF
 706+ 92F4 CD 81 97     			CALL    STORE           ;UPDATE VARIABLE
 707+ 92F7 DD 21 0E 00  			LD      IX,12+2
 708+ 92FB DD 39        			ADD     IX,SP
 709+ 92FD CD E8 A1     			CALL    DLOAD5          ;LIMIT
 710+ 9300 F1           			POP     AF
 711+ 9301 CC 3A A5     			CALL    Z,SWAP
 712+ 9304 3E 08        			LD      A,0+('<'-4) AND 0FH
 713+ 9306 CD BF A6     			CALL    FPP             ;TEST AGAINST LIMIT
 714+ 9309 38 31        			JR      C,ERROR3
 715+ 930B 24           			INC     H
 716+ 930C 20 11        			JR      NZ,LOOP         ;KEEP LOOPING
 717+ 930E 21 12 00     			LD      HL,18
 718+ 9311 39           			ADD     HL,SP
 719+ 9312 F9           			LD      SP,HL
 720+ 9313 CD 9B A6     			CALL    NXT
 721+ 9316 FE 2C        			CP      ','
 722+ 9318 C2 0B 8F     			JP      NZ,XEQ
 723+ 931B FD 23        			INC     IY
 724+ 931D 18 9B        			JR      NEXT
 725+ 931F              ;
 726+ 931F C1           LOOP:			POP     BC
 727+ 9320 D1           			POP     DE
 728+ 9321 FD E1        			POP     IY
 729+ 9323 FD E5        			PUSH    IY
 730+ 9325 D5           			PUSH    DE
 731+ 9326 C5           			PUSH    BC
 732+ 9327 C3 0B 8F     			JP      XEQ
 733+ 932A              ;
 734+ 932A 21 12 00     NEXT1:			LD      HL,18
 735+ 932D 39           			ADD     HL,SP
 736+ 932E F9           			LD      SP,HL           ;"POP" THE STACK
 737+ 932F C1           			POP     BC
 738+ 9330 21 BA 92     			LD      HL,FORCHK
 739+ 9333 ED 42        			SBC     HL,BC
 740+ 9335 E1           			POP     HL              ;VARIABLE POINTER
 741+ 9336 E5           			PUSH    HL
 742+ 9337 C5           			PUSH    BC
 743+ 9338 28 98        			JR      Z,NEXT0
 744+ 933A 3E 21        			LD      A,33
 745+ 933C C3 FE 88     ERROR3:			JP      ERROR           ;"Can't match FOR"
 746+ 933F              ;
 747+ 933F              ;FNname
 748+ 933F              ;N.B. ENTERED WITH A <> TON
 749+ 933F              ;
 750+ 933F F5           @FN:			PUSH    AF              ;MAKE SPACE ON STACK
 751+ 9340 CD 47 93     			CALL    PROC1
 752+ 9343              FNCHK:			EQU     $
 753+ 9343              ;
 754+ 9343              ;PROCname
 755+ 9343              ;N.B. ENTERED WITH A = ON PROC FLAG
 756+ 9343              ;
 757+ 9343 F5           PROC:			PUSH    AF              ;MAKE SPACE ON STACK
 758+ 9344 CD 47 93     			CALL    PROC1
 759+ 9347              PROCHK:			EQU     $
 760+ 9347              PROC1:
 760+ 9347 CD E2 97      			CALL    CHECK
 761+ 934A FD 2B        			DEC     IY
 762+ 934C FD E5        			PUSH    IY
 763+ 934E CD FE 8B     			CALL    GETDEF
 764+ 9351 C1           			POP     BC
 765+ 9352 28 39        			JR      Z,PROC4
 766+ 9354 3E 1E        			LD      A,30
 767+ 9356 38 E4        			JR      C,ERROR3        ;"Bad call"
 768+ 9358 C5           			PUSH    BC
 769+ 9359 2A DC B6     			LD      HL,(PAGE)
 770+ 935C 3E DD        PROC2:			LD      A,DEF
 771+ 935E CD A3 99     			CALL    SEARCH          ;LOOK FOR "DEF"
 772+ 9361 38 21        			JR      C,PROC3
 773+ 9363 E5           			PUSH    HL
 774+ 9364 FD E1        			POP     IY
 775+ 9366 FD 23        			INC     IY              ;SKIP DEF
 776+ 9368 CD 9B A6     			CALL    NXT
 777+ 936B CD FE 8B     			CALL    GETDEF
 778+ 936E FD E5        			PUSH    IY
 779+ 9370 D1           			POP     DE
 780+ 9371 38 09        			JR      C,PROC6
 781+ 9373 C4 A0 8C     			CALL    NZ,CREATE
 782+ 9376 FD E5        			PUSH    IY
 783+ 9378 D1           			POP     DE
 784+ 9379 73           			LD      (HL),E
 785+ 937A 23           			INC     HL
 786+ 937B 72           			LD      (HL),D          ;SAVE ADDRESS
 787+ 937C EB           PROC6:			EX      DE,HL
 788+ 937D 3E 0D        			LD      A,CR
 789+ 937F 47           			LD      B,A
 790+ 9380 ED B1        			CPIR                    ;SKIP TO END OF LINE
 791+ 9382 18 D8        			JR      PROC2
 792+ 9384 FD E1        PROC3:			POP     IY              ;RESTORE TEXT POINTER
 793+ 9386 CD FE 8B     			CALL    GETDEF
 794+ 9389 3E 1D        			LD      A,29
 795+ 938B 20 AF        			JR      NZ,ERROR3       ;"No such FN/PROC"
 796+ 938D 5E           PROC4:			LD      E,(HL)
 797+ 938E 23           			INC     HL
 798+ 938F 56           			LD      D,(HL)          ;GET ADDRESS
 799+ 9390 21 02 00     			LD      HL,2
 800+ 9393 39           			ADD     HL,SP
 801+ 9394 CD 9B A6     			CALL    NXT             ;ALLOW SPACE BEFORE (
 802+ 9397 D5           			PUSH    DE              ;EXCHANGE DE,IY
 803+ 9398 FD E3        			EX      (SP),IY
 804+ 939A D1           			POP     DE
 805+ 939B FE 28        			CP      '('             ;ARGUMENTS?
 806+ 939D 20 1B        			JR      NZ,PROC5
 807+ 939F CD 9B A6     			CALL    NXT             ;ALLOW SPACE BEFORE (
 808+ 93A2 FE 28        			CP      '('
 809+ 93A4 C2 E2 8F     			JP      NZ,SYNTAX       ;"Syntax error"
 810+ 93A7 FD E5        			PUSH    IY
 811+ 93A9 C1           			POP     BC              ;SAVE IY IN BC
 812+ 93AA D9           			EXX
 813+ 93AB CD 73 98     			CALL    SAVLOC          ;SAVE DUMMY VARIABLES
 814+ 93AE CD 5F A6     			CALL    BRAKET          ;CLOSING BRACKET
 815+ 93B1 D9           			EXX
 816+ 93B2 C5           			PUSH    BC
 817+ 93B3 FD E1        			POP     IY              ;RESTORE IY
 818+ 93B5 E5           			PUSH    HL
 819+ 93B6 CD FE 97     			CALL    ARGUE           ;TRANSFER ARGUMENTS
 820+ 93B9 E1           			POP     HL
 821+ 93BA 73           PROC5:			LD      (HL),E          ;SAVE "RETURN ADDRESS"
 822+ 93BB 23           			INC     HL
 823+ 93BC 7E           			LD      A,(HL)
 824+ 93BD 72           			LD      (HL),D
 825+ 93BE FE EE        			CP      TON             ;WAS IT "ON PROC" ?
 826+ 93C0 C2 0B 8F     			JP      NZ,XEQ
 827+ 93C3 D5           			PUSH    DE
 828+ 93C4 FD E3        			EX      (SP),IY
 829+ 93C6 CD F1 98     			CALL    SPAN            ;SKIP REST OF ON LIST
 830+ 93C9 FD E3        			EX      (SP),IY
 831+ 93CB D1           			POP     DE
 832+ 93CC 72           			LD      (HL),D
 833+ 93CD 2B           			DEC     HL
 834+ 93CE 73           			LD      (HL),E
 835+ 93CF C3 0B 8F     			JP      XEQ
 836+ 93D2              ;
 837+ 93D2              ;LOCAL var[,var...]
 838+ 93D2              ;
 839+ 93D2 C1           LOCAL:			POP     BC
 840+ 93D3 C5           			PUSH    BC
 841+ 93D4 21 43 93     			LD      HL,FNCHK
 842+ 93D7 B7           			OR      A
 843+ 93D8 ED 42        			SBC     HL,BC
 844+ 93DA 28 13        			JR      Z,LOCAL1
 845+ 93DC 21 47 93     			LD      HL,PROCHK
 846+ 93DF B7           			OR      A
 847+ 93E0 ED 42        			SBC     HL,BC
 848+ 93E2 28 0B        			JR      Z,LOCAL1
 849+ 93E4 21 C5 98     			LD      HL,LOCCHK
 850+ 93E7 B7           			OR      A
 851+ 93E8 ED 42        			SBC     HL,BC
 852+ 93EA 3E 0C        			LD      A,12
 853+ 93EC C2 FE 88     			JP      NZ,ERROR        ;"Not LOCAL"
 854+ 93EF FD E5        LOCAL1:			PUSH    IY
 855+ 93F1 C1           			POP     BC
 856+ 93F2 D9           			EXX
 857+ 93F3 FD 2B        			DEC     IY
 858+ 93F5 CD 73 98     			CALL    SAVLOC
 859+ 93F8 D9           			EXX
 860+ 93F9 C5           			PUSH    BC
 861+ 93FA FD E1        			POP     IY
 862+ 93FC CD 62 8B     LOCAL2:			CALL    GETVAR
 863+ 93FF C2 E2 8F     			JP      NZ,SYNTAX
 864+ 9402 B7           			OR      A               ;TYPE
 865+ 9403 08           			EX      AF,AF'
 866+ 9404 CD E1 A5     			CALL    ZERO
 867+ 9407 08           			EX      AF,AF'
 868+ 9408 F5           			PUSH    AF
 869+ 9409 F4 81 97     			CALL    P,STORE         ;ZERO
 870+ 940C F1           			POP     AF
 871+ 940D 59           			LD      E,C
 872+ 940E FC AD 97     			CALL    M,STORES
 873+ 9411 CD 9B A6     			CALL    NXT
 874+ 9414 FE 2C        			CP      ','
 875+ 9416 C2 0B 8F     			JP      NZ,XEQ
 876+ 9419 FD 23        			INC     IY
 877+ 941B CD 9B A6     			CALL    NXT
 878+ 941E 18 DC        			JR      LOCAL2
 879+ 9420              ;
 880+ 9420              ;ENDPROC
 881+ 9420              ;
 882+ 9420 C1           ENDPRO:			POP     BC
 883+ 9421 21 C5 98     			LD      HL,LOCCHK
 884+ 9424 B7           			OR      A
 885+ 9425 ED 42        			SBC     HL,BC
 886+ 9427 28 10        			JR      Z,UNSTK         ;LOCAL VARIABLE
 887+ 9429 21 47 93     			LD      HL,PROCHK       ;PROC MARKER
 888+ 942C B7           			OR      A
 889+ 942D ED 42        			SBC     HL,BC
 890+ 942F FD E1        			POP     IY
 891+ 9431 CA 0B 8F     			JP      Z,XEQ
 892+ 9434 3E 0D        			LD      A,13
 893+ 9436 C3 FE 88     			JP      ERROR           ;"No PROC"
 894+ 9439              ;
 895+ 9439 DD E1        UNSTK:			POP     IX
 896+ 943B C1           			POP     BC
 897+ 943C 78           			LD      A,B
 898+ 943D B7           			OR      A
 899+ 943E FA 4A 94     			JP      M,UNSTK1        ;STRING
 900+ 9441 E1           			POP     HL
 901+ 9442 D9           			EXX
 902+ 9443 E1           			POP     HL
 903+ 9444 D9           			EXX
 904+ 9445 CD 81 97     			CALL    STORE
 905+ 9448 18 D6        			JR      ENDPRO
 906+ 944A 21 00 00     UNSTK1:			LD      HL,0
 907+ 944D 39           			ADD     HL,SP
 908+ 944E 59           			LD      E,C
 909+ 944F CD AD 97     			CALL    STORES
 910+ 9452 F9           			LD      SP,HL
 911+ 9453 18 CB        			JR      ENDPRO
 912+ 9455              ;
 913+ 9455              ;INPUT #channel,var,var...
 914+ 9455              ;
 915+ 9455 CD E4 99     INPUTN:			CALL    CHNL            ;E = CHANNEL NUMBER
 916+ 9458 CD 9B A6     INPN1:			CALL    NXT
 917+ 945B FE 2C        			CP      ','
 918+ 945D C2 0B 8F     			JP      NZ,XEQ
 919+ 9460 FD 23        			INC     IY
 920+ 9462 CD 9B A6     			CALL    NXT
 921+ 9465 D5           			PUSH    DE
 922+ 9466 CD DB 8F     			CALL    VAR
 923+ 9469 D1           			POP     DE
 924+ 946A F5           			PUSH    AF              ;SAVE TYPE
 925+ 946B E5           			PUSH    HL              ;VARPTR
 926+ 946C B7           			OR      A
 927+ 946D FA 92 94     			JP      M,INPN2         ;STRING
 928+ 9470 CD 04 B3     			CALL    OSBGET
 929+ 9473 D9           			EXX
 930+ 9474 6F           			LD      L,A
 931+ 9475 D9           			EXX
 932+ 9476 CD 04 B3     			CALL    OSBGET
 933+ 9479 D9           			EXX
 934+ 947A 67           			LD      H,A
 935+ 947B D9           			EXX
 936+ 947C CD 04 B3     			CALL    OSBGET
 937+ 947F 6F           			LD      L,A
 938+ 9480 CD 04 B3     			CALL    OSBGET
 939+ 9483 67           			LD      H,A
 940+ 9484 CD 04 B3     			CALL    OSBGET
 941+ 9487 4F           			LD      C,A
 942+ 9488 DD E1        			POP     IX
 943+ 948A F1           			POP     AF              ;RESTORE TYPE
 944+ 948B D5           			PUSH    DE              ;SAVE CHANNEL
 945+ 948C CD 81 97     			CALL    STORE
 946+ 948F D1           			POP     DE
 947+ 9490 18 C6        			JR      INPN1
 948+ 9492 21 00 B4     INPN2:			LD      HL,ACCS
 949+ 9495 CD 04 B3     INPN3:			CALL    OSBGET
 950+ 9498 FE 0D        			CP      CR
 951+ 949A 28 04        			JR      Z,INPN4
 952+ 949C 77           			LD      (HL),A
 953+ 949D 2C           			INC     L
 954+ 949E 20 F5        			JR      NZ,INPN3
 955+ 94A0 DD E1        INPN4:			POP     IX
 956+ 94A2 F1           			POP     AF
 957+ 94A3 D5           			PUSH    DE
 958+ 94A4 EB           			EX      DE,HL
 959+ 94A5 CD AA 97     			CALL    STACCS
 960+ 94A8 D1           			POP     DE
 961+ 94A9 18 AD        			JR      INPN1
 962+ 94AB              ;
 963+ 94AB              ;INPUT ['][SPC(x)][TAB(x[,y])]["prompt",]var[,var...]
 964+ 94AB              ;INPUT LINE [SPC(x)][TAB(x[,y])]["prompt",]var[,var...]
 965+ 94AB              ;
 966+ 94AB FE 23        INPUT:			CP      '#'
 967+ 94AD 28 A6        			JR      Z,INPUTN
 968+ 94AF 0E 00        			LD      C,0             ;FLAG PROMPT
 969+ 94B1 FE 86        			CP      LINE
 970+ 94B3 20 04        			JR      NZ,INPUT0
 971+ 94B5 FD 23        			INC     IY              ;SKIP "LINE"
 972+ 94B7 0E 80        			LD      C,80H
 973+ 94B9 21 00 B5     INPUT0:			LD      HL,BUFFER
 974+ 94BC 36 0D        			LD      (HL),CR         ;INITIALISE EMPTY
 975+ 94BE CD E5 98     INPUT1:			CALL    TERM?
 976+ 94C1 CA 0B 8F     			JP      Z,XEQ           ;DONE
 977+ 94C4 FD 23        			INC     IY
 978+ 94C6 FE 2C        			CP      ','
 979+ 94C8 28 51        			JR      Z,INPUT3        ;SKIP COMMA
 980+ 94CA FE 3B        			CP      ';'
 981+ 94CC 28 4D        			JR      Z,INPUT3
 982+ 94CE E5           			PUSH    HL              ;SAVE BUFFER POINTER
 983+ 94CF FE 22        			CP      34		;ASCII ""
 984+ 94D1 20 0A        			JR      NZ,INPUT6
 985+ 94D3 C5           			PUSH    BC
 986+ 94D4 CD B2 A1     			CALL    CONS
 987+ 94D7 C1           			POP     BC
 988+ 94D8 CD 5B 99     			CALL    PTEXT           ;PRINT PROMPT
 989+ 94DB 18 05        			JR      INPUT9
 990+ 94DD CD 06 99     INPUT6:			CALL    FORMAT          ;SPC, TAB, '
 991+ 94E0 20 05        			JR      NZ,INPUT2
 992+ 94E2 E1           INPUT9:			POP     HL
 993+ 94E3 CB C1        			SET     0,C             ;FLAG NO PROMPT
 994+ 94E5 18 D2        			JR      INPUT0
 995+ 94E7 FD 2B        INPUT2:			DEC     IY
 996+ 94E9 C5           			PUSH    BC
 997+ 94EA CD DB 8F     			CALL    VAR
 998+ 94ED C1           			POP     BC
 999+ 94EE E1           			POP     HL
1000+ 94EF F5           			PUSH    AF              ;SAVE TYPE
1001+ 94F0 7E           			LD      A,(HL)
1002+ 94F1 23           			INC     HL
1003+ 94F2 FE 0D        			CP      CR              ;BUFFER EMPTY?
1004+ 94F4 CC 1F 95     			CALL    Z,REFILL
1005+ 94F7 CB 79        			BIT     7,C
1006+ 94F9 F5           			PUSH    AF
1007+ 94FA C4 79 99     			CALL    NZ,LINES
1008+ 94FD F1           			POP     AF
1009+ 94FE CC 68 99     			CALL    Z,FETCHS
1010+ 9501 F1           			POP     AF              ;RESTORE TYPE
1011+ 9502 C5           			PUSH    BC
1012+ 9503 E5           			PUSH    HL
1013+ 9504 B7           			OR      A
1014+ 9505 FA 16 95     			JP      M,INPUT4        ;STRING
1015+ 9508 F5           			PUSH    AF
1016+ 9509 DD E5        			PUSH    IX
1017+ 950B CD 69 A3     			CALL    VAL0
1018+ 950E DD E1        			POP     IX
1019+ 9510 F1           			POP     AF
1020+ 9511 CD 81 97     			CALL    STORE
1021+ 9514 18 03        			JR      INPUT5
1022+ 9516 CD AA 97     INPUT4:			CALL    STACCS
1023+ 9519 E1           INPUT5:			POP     HL
1024+ 951A C1           			POP     BC
1025+ 951B CB 81        INPUT3:			RES     0,C
1026+ 951D 18 9F        			JR      INPUT1
1027+ 951F              ;
1028+ 951F CB 41        REFILL:			BIT     0,C
1029+ 9521 20 0A        			JR      NZ,REFIL0       ;NO PROMPT
1030+ 9523 3E 3F        			LD      A,'?'
1031+ 9525 CD 97 8A     			CALL    OUTCHR          ;PROMPT
1032+ 9528 3E 20        			LD      A,' '
1033+ 952A CD 97 8A     			CALL    OUTCHR
1034+ 952D 21 00 B5     REFIL0:			LD      HL,BUFFER
1035+ 9530 C5           			PUSH    BC
1036+ 9531 E5           			PUSH    HL
1037+ 9532 DD E5        			PUSH    IX
1038+ 9534 CD EF B2     			CALL    OSLINE
1039+ 9537 DD E1        			POP     IX
1040+ 9539 E1           			POP     HL
1041+ 953A C1           			POP     BC
1042+ 953B 47           			LD      B,A             ;POS AT ENTRY
1043+ 953C AF           			XOR     A
1044+ 953D 32 FB B6     			LD      (COUNT),A
1045+ 9540 B8           			CP      B
1046+ 9541 C8           			RET     Z
1047+ 9542 7E           REFIL1:			LD      A,(HL)
1048+ 9543 FE 0D        			CP      CR
1049+ 9545 C8           			RET     Z
1050+ 9546 23           			INC     HL
1051+ 9547 10 F9        			DJNZ    REFIL1
1052+ 9549 C9           			RET
1053+ 954A              ;
1054+ 954A              ;READ var[,var...]
1055+ 954A              ;
1056+ 954A FE 23        READ:			CP      '#'
1057+ 954C CA 55 94     			JP      Z,INPUTN
1058+ 954F 2A F0 B6     			LD      HL,(DATPTR)
1059+ 9552 7E           READ0:			LD      A,(HL)
1060+ 9553 23           			INC     HL              ;SKIP COMMA OR "DATA"
1061+ 9554 FE 0D        			CP      CR              ;END OF DATA STMT?
1062+ 9556 CC 8F 95     			CALL    Z,GETDAT
1063+ 9559 E5           			PUSH    HL
1064+ 955A CD DB 8F     			CALL    VAR
1065+ 955D E1           			POP     HL
1066+ 955E B7           			OR      A
1067+ 955F FA 75 95     			JP      M,READ1         ;STRING
1068+ 9562 E5           			PUSH    HL
1069+ 9563 FD E3        			EX      (SP),IY
1070+ 9565 F5           			PUSH    AF              ;SAVE TYPE
1071+ 9566 DD E5        			PUSH    IX
1072+ 9568 CD B0 A0     			CALL    EXPRN
1073+ 956B DD E1        			POP     IX
1074+ 956D F1           			POP     AF
1075+ 956E CD 81 97     			CALL    STORE
1076+ 9571 FD E3        			EX      (SP),IY
1077+ 9573 18 07        			JR      READ2
1078+ 9575 CD 68 99     READ1:			CALL    FETCHS
1079+ 9578 E5           			PUSH    HL
1080+ 9579 CD AA 97     			CALL    STACCS
1081+ 957C E1           READ2:			POP     HL
1082+ 957D 22 F0 B6     			LD      (DATPTR),HL
1083+ 9580 CD 9B A6     			CALL    NXT
1084+ 9583 FE 2C        			CP      ','
1085+ 9585 C2 0B 8F     			JP      NZ,XEQ
1086+ 9588 FD 23        			INC     IY
1087+ 958A CD 9B A6     			CALL    NXT
1088+ 958D 18 C3        			JR      READ0
1089+ 958F              ;
1090+ 958F 3E DC        GETDAT:			LD      A,DATA
1091+ 9591 CD A3 99     			CALL    SEARCH
1092+ 9594 23           			INC     HL
1093+ 9595 D0           			RET     NC
1094+ 9596 3E 2A        			LD      A,42
1095+ 9598 C3 FE 88     ERROR4:			JP      ERROR           ;"Out of DATA"
1096+ 959B              ;
1097+ 959B              ;IF expr statement
1098+ 959B              ;IF expr THEN statement [ELSE statement]
1099+ 959B              ;IF expr THEN line [ELSE line]
1100+ 959B              ;
1101+ 959B CD B7 A0     IF:			CALL    EXPRI
1102+ 959E CD 42 A5     			CALL    TEST
1103+ 95A1 28 15        			JR      Z,IFNOT         ;FALSE
1104+ 95A3 FD 7E 00     			LD      A,(IY)
1105+ 95A6 FE 8C        			CP      THEN
1106+ 95A8 C2 0B 8F     			JP      NZ,XEQ
1107+ 95AB FD 23        			INC     IY              ;SKIP "THEN"
1108+ 95AD CD 9B A6     IF1:			CALL    NXT
1109+ 95B0 FE 8D        			CP      LINO
1110+ 95B2 C2 0B 8F     			JP      NZ,XEQ          ;STATEMENT FOLLOWS
1111+ 95B5 C3 19 92     			JP      GOTO            ;LINE NO. FOLLOWS
1112+ 95B8 FD 7E 00     IFNOT:			LD      A,(IY)
1113+ 95BB FE 0D        			CP      CR
1114+ 95BD FD 23        			INC     IY
1115+ 95BF CA 08 8F     			JP      Z,XEQ0          ;END OF LINE
1116+ 95C2 FE 8B        			CP      ELSE
1117+ 95C4 20 F2        			JR      NZ,IFNOT
1118+ 95C6 18 E5        			JR      IF1
1119+ 95C8              ;
1120+ 95C8              ;CLS
1121+ 95C8              ;
1122+ 95C8 CD C3 B2     CLS:			CALL    CLRSCN
1123+ 95CB AF           			XOR     A
1124+ 95CC 32 FB B6     			LD      (COUNT),A
1125+ 95CF C3 0B 8F     			JP      XEQ
1126+ 95D2              ;
1127+ 95D2              ;STOP
1128+ 95D2              ;
1129+ 95D2 CD 4E 8E     STOP:			CALL    TELL
1130+ 95D5 0D           			DEFB    CR
1131+ 95D6 0A           			DEFB    LF
1132+ 95D7 FA           			DEFB    TSTOP
1133+ 95D8 00           			DEFB    0
1134+ 95D9 CD E7 8A     			CALL    SETLIN          ;FIND CURRENT LINE
1135+ 95DC CD 11 8B     			CALL    SAYLN
1136+ 95DF CD 90 8A     			CALL    CRLF
1137+ 95E2 C3 92 82     			JP      CLOOP
1138+ 95E5              ;
1139+ 95E5              ;REPORT
1140+ 95E5              ;
1141+ 95E5 CD 42 8E     REPOR:			CALL    REPORT
1142+ 95E8 C3 0B 8F     			JP      XEQ
1143+ 95EB              ;
1144+ 95EB              ;CLEAR
1145+ 95EB              ;
1146+ 95EB CD EF 89     CLR:			CALL    CLEAR
1147+ 95EE 2A DC B6     			LD      HL,(PAGE)
1148+ 95F1 18 13        			JR      RESTR1
1149+ 95F3              ;
1150+ 95F3              ;RESTORE [line]
1151+ 95F3              ;
1152+ 95F3 2A DC B6     RESTOR:			LD      HL,(PAGE)
1153+ 95F6 CD E5 98     			CALL    TERM?
1154+ 95F9 28 0B        			JR      Z,RESTR1
1155+ 95FB CD CE A0     			CALL    ITEMI
1156+ 95FE D9           			EXX
1157+ 95FF CD CE 8A     			CALL    FINDL           ;SEARCH FOR LINE
1158+ 9602 3E 29        			LD      A,41
1159+ 9604 20 92        			JR      NZ,ERROR4       ;"No such line"
1160+ 9606 3E DC        RESTR1:			LD      A,DATA
1161+ 9608 CD A3 99     			CALL    SEARCH
1162+ 960B 22 F0 B6     			LD      (DATPTR),HL
1163+ 960E C3 0B 8F     			JP      XEQ
1164+ 9611              ;
1165+ 9611              ;PTR#channel=expr
1166+ 9611              ;PAGE=expr
1167+ 9611              ;TIME=expr
1168+ 9611              ;LOMEM=expr
1169+ 9611              ;HIMEM=expr
1170+ 9611              ;
1171+ 9611 CD DA 99     PTR:			CALL    CHANEL
1172+ 9614 CD F9 98     			CALL    EQUALS
1173+ 9617 7B           			LD      A,E
1174+ 9618 F5           			PUSH    AF
1175+ 9619 CD B7 A0     			CALL    EXPRI
1176+ 961C E5           			PUSH    HL
1177+ 961D D9           			EXX
1178+ 961E D1           			POP     DE
1179+ 961F F1           			POP     AF
1180+ 9620 CD 04 B3     			CALL    PUTPTR
1181+ 9623 C3 0B 8F     			JP      XEQ
1182+ 9626              ;
1183+ 9626 CD F9 98     PAGEV:			CALL    EQUALS
1184+ 9629 CD B7 A0     			CALL    EXPRI
1185+ 962C D9           			EXX
1186+ 962D 2E 00        			LD      L,0
1187+ 962F 22 DC B6     			LD      (PAGE),HL
1188+ 9632 C3 0B 8F     			JP      XEQ
1189+ 9635              ;
1190+ 9635 FE 24        TIMEV:			CP      '$'
1191+ 9637 28 0F        			JR      Z,TIMEVS
1192+ 9639 CD F9 98     			CALL    EQUALS
1193+ 963C CD B7 A0     			CALL    EXPRI
1194+ 963F E5           			PUSH    HL
1195+ 9640 D9           			EXX
1196+ 9641 D1           			POP     DE
1197+ 9642 CD C4 B2     			CALL    PUTIME
1198+ 9645 C3 0B 8F     			JP      XEQ
1199+ 9648              ;
1200+ 9648 FD 23        TIMEVS:			INC     IY              ;SKIP '$'
1201+ 964A CD F9 98     			CALL    EQUALS
1202+ 964D CD C0 A0     			CALL    EXPRS
1203+ 9650 CD B9 B2     			CALL    PUTIMS
1204+ 9653 C3 0B 8F     			JP      XEQ
1205+ 9656              ;
1206+ 9656 CD F9 98     LOMEMV:			CALL    EQUALS
1207+ 9659 CD B7 A0     			CALL    EXPRI
1208+ 965C CD EF 89     			CALL    CLEAR
1209+ 965F D9           			EXX
1210+ 9660 22 E0 B6     			LD      (LOMEM),HL
1211+ 9663 22 E2 B6     			LD      (FREE),HL
1212+ 9666 C3 0B 8F     			JP      XEQ
1213+ 9669              ;
1214+ 9669 CD F9 98     HIMEMV:			CALL    EQUALS
1215+ 966C CD B7 A0     			CALL    EXPRI
1216+ 966F D9           			EXX
1217+ 9670 ED 5B E2 B6  			LD      DE,(FREE)
1218+ 9674 14           			INC     D
1219+ 9675 AF           			XOR     A
1220+ 9676 ED 52        			SBC     HL,DE
1221+ 9678 19           			ADD     HL,DE
1222+ 9679 DA FE 88     			JP      C,ERROR         ;"No room"
1223+ 967C ED 5B E4 B6  			LD      DE,(HIMEM)
1224+ 9680 22 E4 B6     			LD      (HIMEM),HL
1225+ 9683 EB           			EX      DE,HL
1226+ 9684 ED 72        			SBC     HL,SP
1227+ 9686 C2 0B 8F     			JP      NZ,XEQ
1228+ 9689 EB           			EX      DE,HL
1229+ 968A F9           			LD      SP,HL           ;LOAD STACK POINTER
1230+ 968B C3 0B 8F     			JP      XEQ
1231+ 968E              ;
1232+ 968E              ;WIDTH expr
1233+ 968E              ;
1234+ 968E CD B7 A0     WIDTHV:			CALL    EXPRI
1235+ 9691 D9           			EXX
1236+ 9692 7D           			LD      A,L
1237+ 9693 32 FC B6     			LD      (WIDTH),A
1238+ 9696 C3 0B 8F     			JP      XEQ
1239+ 9699              ;
1240+ 9699              ;TRACE ON
1241+ 9699              ;TRACE OFF
1242+ 9699              ;TRACE line
1243+ 9699              ;
1244+ 9699 FD 23        TRACE:			INC     IY
1245+ 969B 21 00 00     			LD      HL,0
1246+ 969E FE EE        			CP      TON
1247+ 96A0 28 0A        			JR      Z,TRACE0
1248+ 96A2 FE 87        			CP      OFF
1249+ 96A4 28 07        			JR      Z,TRACE1
1250+ 96A6 FD 2B        			DEC     IY
1251+ 96A8 CD B7 A0     			CALL    EXPRI
1252+ 96AB D9           			EXX
1253+ 96AC 2B           TRACE0:			DEC     HL
1254+ 96AD 22 E8 B6     TRACE1:			LD      (TRACEN),HL
1255+ 96B0 C3 0B 8F     			JP      XEQ
1256+ 96B3              ;
1257+ 96B3              ;VDU expr,expr;....
1258+ 96B3              ;
1259+ 96B3 CD B7 A0     VDU:			CALL    EXPRI
1260+ 96B6 D9           			EXX
1261+ 96B7 7D           			LD      A,L
1262+ 96B8 CD D9 B2     			CALL    OSWRCH
1263+ 96BB FD 7E 00     			LD      A,(IY)
1264+ 96BE FE 2C        			CP      ','
1265+ 96C0 28 08        			JR      Z,VDU2
1266+ 96C2 FE 3B        			CP      ';'
1267+ 96C4 20 06        			JR      NZ,VDU3
1268+ 96C6 7C           			LD      A,H
1269+ 96C7 CD D9 B2     			CALL    OSWRCH
1270+ 96CA FD 23        VDU2:			INC     IY
1271+ 96CC CD E5 98     VDU3:			CALL    TERM?
1272+ 96CF 20 E2        			JR      NZ,VDU
1273+ 96D1 C3 0B 8F     			JP      XEQ
1274+ 96D4              ;
1275+ 96D4              ;CLOSE channel number
1276+ 96D4              ;
1277+ 96D4 CD DA 99     CLOSE:			CALL    CHANEL
1278+ 96D7 CD 04 B3     			CALL    OSSHUT
1279+ 96DA C3 0B 8F     			JP      XEQ
1280+ 96DD              ;
1281+ 96DD              ;BPUT channel,byte
1282+ 96DD              ;
1283+ 96DD CD DA 99     BPUT:			CALL    CHANEL          ;CHANNEL NUMBER
1284+ 96E0 D5           			PUSH    DE
1285+ 96E1 CD 53 A6     			CALL    COMMA
1286+ 96E4 CD B7 A0     			CALL    EXPRI           ;BYTE
1287+ 96E7 D9           			EXX
1288+ 96E8 7D           			LD      A,L
1289+ 96E9 D1           			POP     DE
1290+ 96EA CD 04 B3     			CALL    OSBPUT
1291+ 96ED C3 0B 8F     			JP      XEQ
1292+ 96F0              ;
1293+ 96F0              ;CALL address[,var[,var...]]
1294+ 96F0              ;
1295+ 96F0 CD B7 A0     CALL:			CALL    EXPRI           ;ADDRESS
1296+ 96F3 D9           			EXX
1297+ 96F4 E5           			PUSH    HL              ;SAVE IT
1298+ 96F5 06 00        			LD      B,0             ;PARAMETER COUNTER
1299+ 96F7 11 00 B5     			LD      DE,BUFFER       ;VECTOR
1300+ 96FA CD 9B A6     CALL1:			CALL    NXT
1301+ 96FD FE 2C        			CP      ','
1302+ 96FF 20 17        			JR      NZ,CALL2
1303+ 9701 FD 23        			INC     IY
1304+ 9703 04           			INC     B
1305+ 9704 CD 9B A6     			CALL    NXT
1306+ 9707 C5           			PUSH    BC
1307+ 9708 D5           			PUSH    DE
1308+ 9709 CD DB 8F     			CALL    VAR
1309+ 970C D1           			POP     DE
1310+ 970D C1           			POP     BC
1311+ 970E 13           			INC     DE
1312+ 970F 12           			LD      (DE),A          ;PARAMETER TYPE
1313+ 9710 13           			INC     DE
1314+ 9711 EB           			EX      DE,HL
1315+ 9712 73           			LD      (HL),E          ;PARAMETER ADDRESS
1316+ 9713 23           			INC     HL
1317+ 9714 72           			LD      (HL),D
1318+ 9715 EB           			EX      DE,HL
1319+ 9716 18 E2        			JR      CALL1
1320+ 9718 78           CALL2:			LD      A,B
1321+ 9719 32 00 B5     			LD      (BUFFER),A      ;PARAMETER COUNT
1322+ 971C E1           			POP     HL              ;RESTORE ADDRESS
1323+ 971D CD 27 97     			CALL    USR1
1324+ 9720 C3 0B 8F     			JP      XEQ
1325+ 9723              ;
1326+ 9723              ;USR(address)
1327+ 9723              ;
1328+ 9723 CD CE A0     @USR:			CALL    ITEMI
1329+ 9726 D9           			EXX
1330+ 9727 E5           USR1:			PUSH    HL              ;ADDRESS ON STACK
1331+ 9728 FD E3        			EX      (SP),IY
1332+ 972A 24           			INC     H               ;PAGE &FF?
1333+ 972B 21 56 97     			LD      HL,USR2         ;RETURN ADDRESS
1334+ 972E E5           			PUSH    HL
1335+ 972F DD 21 00 B6  			LD      IX,STAVAR
1336+ 9733 CC 04 B3     			CALL    Z,OSCALL        ;INTERCEPT PAGE &FF
1337+ 9736 DD 4E 18     			LD      C,(IX+24)
1338+ 9739 C5           			PUSH    BC
1339+ 973A F1           			POP     AF              ;LOAD FLAGS
1340+ 973B DD 7E 04     			LD      A,(IX+4)        ;LOAD Z80 REGISTERS
1341+ 973E DD 46 08     			LD      B,(IX+8)
1342+ 9741 DD 4E 0C     			LD      C,(IX+12)
1343+ 9744 DD 56 10     			LD      D,(IX+16)
1344+ 9747 DD 5E 14     			LD      E,(IX+20)
1345+ 974A DD 66 20     			LD      H,(IX+32)
1346+ 974D DD 6E 30     			LD      L,(IX+48)
1347+ 9750 DD 21 00 B5  			LD      IX,BUFFER
1348+ 9754 FD E9        			JP      (IY)            ;OFF TO USER ROUTINE
1349+ 9756 FD E1        USR2:			POP     IY
1350+ 9758 AF           			XOR     A
1351+ 9759 4F           			LD      C,A
1352+ 975A C9           			RET
1353+ 975B              ;
1354+ 975B              ;PUT port,data
1355+ 975B              ;
1356+ 975B CD B7 A0     PUT:			CALL    EXPRI           ;PORT ADDRESS
1357+ 975E D9           			EXX
1358+ 975F E5           			PUSH    HL
1359+ 9760 CD 53 A6     			CALL    COMMA
1360+ 9763 CD B7 A0     			CALL    EXPRI           ;DATA
1361+ 9766 D9           			EXX
1362+ 9767 C1           			POP     BC
1363+ 9768 ED 69        			OUT     (C),L           ;OUTPUT TO PORT BC
1364+ 976A C3 0B 8F     			JP      XEQ
1365+ 976D              ;
1366+ 976D              ;SUBROUTINES:
1367+ 976D              ;
1368+ 976D              ;ASSIGN - Assign a numeric value to a variable.
1369+ 976D              ;Outputs: NC,  Z - OK, numeric.
1370+ 976D              ;         NC, NZ - OK, string.
1371+ 976D              ;          C, NZ - illegal
1372+ 976D              ;
1373+ 976D CD 62 8B     ASSIGN:			CALL    GETVAR          ;VARIABLE
1374+ 9770 D8           			RET     C               ;ILLEGAL VARIABLE
1375+ 9771 C4 53 8B     			CALL    NZ,PUTVAR
1376+ 9774 B7           			OR      A
1377+ 9775 F8           			RET     M               ;STRING VARIABLE
1378+ 9776 F5           			PUSH    AF              ;NUMERIC TYPE
1379+ 9777 CD F9 98     			CALL    EQUALS
1380+ 977A E5           			PUSH    HL
1381+ 977B CD B0 A0     			CALL    EXPRN
1382+ 977E DD E1        			POP     IX
1383+ 9780 F1           			POP     AF
1384+ 9781 CB 47        STORE:			BIT     0,A
1385+ 9783 28 13        			JR      Z,STOREI
1386+ 9785 BF           			CP      A               ;SET ZERO
1387+ 9786 DD 71 04     @STORE5:		LD      (IX+4),C
1388+ 9789 D9           @STORE4:		EXX
1389+ 978A DD 75 00     			LD      (IX+0),L
1390+ 978D DD 74 01     			LD      (IX+1),H
1391+ 9790 D9           			EXX
1392+ 9791 DD 75 02     			LD      (IX+2),L
1393+ 9794 DD 74 03     			LD      (IX+3),H
1394+ 9797 C9           			RET
1395+ 9798 F5           STOREI:			PUSH    AF
1396+ 9799 0C           			INC     C               ;SPEED - & PRESERVE F'
1397+ 979A 0D           			DEC     C               ; WHEN CALLED BY FNEND0
1398+ 979B C4 5E A3     			CALL    NZ,SFIX         ;CONVERT TO INTEGER
1399+ 979E F1           			POP     AF
1400+ 979F FE 04        			CP      4
1401+ 97A1 28 E6        			JR      Z,STORE4
1402+ 97A3 BF           			CP      A               ;SET ZERO
1403+ 97A4 D9           STORE1:			EXX
1404+ 97A5 DD 75 00     			LD      (IX+0),L
1405+ 97A8 D9           			EXX
1406+ 97A9 C9           			RET
1407+ 97AA              ;
1408+ 97AA 21 00 B4     STACCS:			LD      HL,ACCS
1409+ 97AD 1F           STORES:			RRA
1410+ 97AE 30 3F        			JR      NC,STORS3       ;FIXED STRING
1411+ 97B0 E5           			PUSH    HL
1412+ 97B1 CD 7C A1     			CALL    LOAD4
1413+ 97B4 7B           			LD      A,E             ;LENGTH OF STRING
1414+ 97B5 D9           			EXX
1415+ 97B6 6F           			LD      L,A
1416+ 97B7 7C           			LD      A,H             ;LENGTH ALLOCATED
1417+ 97B8 D9           			EXX
1418+ 97B9 BB           			CP      E
1419+ 97BA 30 14        			JR      NC,STORS1       ;ENOUGH ROOM
1420+ 97BC D9           			EXX
1421+ 97BD 65           			LD      H,L
1422+ 97BE D9           			EXX
1423+ 97BF E5           			PUSH    HL
1424+ 97C0 06 00        			LD      B,0
1425+ 97C2 4F           			LD      C,A
1426+ 97C3 09           			ADD     HL,BC
1427+ 97C4 ED 4B E2 B6  			LD      BC,(FREE)
1428+ 97C8 ED 42        			SBC     HL,BC           ;IS STRING LAST?
1429+ 97CA E1           			POP     HL
1430+ 97CB 37           			SCF
1431+ 97CC 28 02        			JR      Z,STORS1
1432+ 97CE 60           			LD      H,B
1433+ 97CF 69           			LD      L,C
1434+ 97D0 CD 89 97     STORS1:			CALL    STORE4          ;PRESERVES CARRY!
1435+ 97D3 06 00        			LD      B,0
1436+ 97D5 4B           			LD      C,E
1437+ 97D6 EB           			EX      DE,HL
1438+ 97D7 E1           			POP     HL
1439+ 97D8 0D           			DEC     C
1440+ 97D9 0C           			INC     C
1441+ 97DA C8           			RET     Z               ;NULL STRING
1442+ 97DB ED B0        			LDIR
1443+ 97DD D0           			RET     NC              ;STRING REPLACED
1444+ 97DE ED 53 E2 B6  			LD      (FREE),DE
1445+ 97E2 E5           @CHECK:			PUSH    HL
1446+ 97E3 2A E2 B6     			LD      HL,(FREE)
1447+ 97E6 24           			INC     H
1448+ 97E7 ED 72        			SBC     HL,SP
1449+ 97E9 E1           			POP     HL
1450+ 97EA D8           			RET     C
1451+ 97EB AF           			XOR     A
1452+ 97EC C3 FE 88     			JP      ERROR           ;"No room"
1453+ 97EF              ;
1454+ 97EF 4B           STORS3:			LD      C,E
1455+ 97F0 DD E5        			PUSH    IX
1456+ 97F2 D1           			POP     DE
1457+ 97F3 AF           			XOR     A
1458+ 97F4 47           			LD      B,A
1459+ 97F5 B9           			CP      C
1460+ 97F6 28 02        			JR      Z,STORS5
1461+ 97F8 ED B0        			LDIR
1462+ 97FA 3E 0D        STORS5:			LD      A,CR
1463+ 97FC 12           			LD      (DE),A
1464+ 97FD C9           			RET
1465+ 97FE              ;
1466+ 97FE              ;ARGUE: TRANSFER FN OR PROC ARGUMENTS FROM THE
1467+ 97FE              ; CALLING STATEMENT TO THE DUMMY VARIABLES VIA
1468+ 97FE              ; THE STACK.  IT MUST BE DONE THIS WAY TO MAKE
1469+ 97FE              ; PROCFRED(A,B)    DEF PROCFRED(B,A)     WORK.
1470+ 97FE              ;   Inputs: DE addresses parameter list
1471+ 97FE              ;           IY addresses dummy variable list
1472+ 97FE              ;  Outputs: DE,IY updated
1473+ 97FE              ; Destroys: Everything
1474+ 97FE              ;
1475+ 97FE 3E FF        ARGUE:			LD      A,-1
1476+ 9800 F5           			PUSH    AF              ;PUT MARKER ON STACK
1477+ 9801 FD 23        ARGUE1:			INC     IY              ;BUMP PAST ( OR ,
1478+ 9803 13           			INC     DE
1479+ 9804 D5           			PUSH    DE
1480+ 9805 CD 9B A6     			CALL    NXT
1481+ 9808 CD 62 8B     			CALL    GETVAR
1482+ 980B 38 38        			JR      C,ARGERR
1483+ 980D C4 53 8B     			CALL    NZ,PUTVAR
1484+ 9810 D1           			POP     DE
1485+ 9811 E5           			PUSH    HL              ;VARPTR
1486+ 9812 B7           			OR      A               ;TYPE
1487+ 9813 F5           			PUSH    AF
1488+ 9814 D5           			PUSH    DE
1489+ 9815 FD E3        			EX      (SP),IY
1490+ 9817 FA 2C 98     			JP      M,ARGUE2        ;STRING
1491+ 981A CD B0 A0     			CALL    EXPRN           ;PARAMETER VALUE
1492+ 981D FD E3        			EX      (SP),IY
1493+ 981F D1           			POP     DE
1494+ 9820 F1           			POP     AF
1495+ 9821 D9           			EXX
1496+ 9822 E5           			PUSH    HL
1497+ 9823 D9           			EXX
1498+ 9824 E5           			PUSH    HL
1499+ 9825 47           			LD      B,A
1500+ 9826 C5           			PUSH    BC
1501+ 9827 CD E2 97     			CALL    CHECK           ;CHECK ROOM
1502+ 982A 18 0D        			JR      ARGUE4
1503+ 982C CD C0 A0     ARGUE2:			CALL    EXPRS
1504+ 982F FD E3        			EX      (SP),IY
1505+ 9831 D9           			EXX
1506+ 9832 D1           			POP     DE
1507+ 9833 D9           			EXX
1508+ 9834 F1           			POP     AF
1509+ 9835 CD 02 A6     			CALL    PUSHS
1510+ 9838 D9           			EXX
1511+ 9839 CD 9B A6     ARGUE4:			CALL    NXT
1512+ 983C FE 2C        			CP      ','
1513+ 983E 20 0A        			JR      NZ,ARGUE5
1514+ 9840 1A           			LD      A,(DE)
1515+ 9841 FE 2C        			CP      ','
1516+ 9843 28 BC        			JR      Z,ARGUE1        ;ANOTHER
1517+ 9845 3E 1F        ARGERR:			LD      A,31
1518+ 9847 C3 FE 88     			JP      ERROR           ;"Arguments"
1519+ 984A CD 5F A6     ARGUE5:			CALL    BRAKET
1520+ 984D 1A           			LD      A,(DE)
1521+ 984E FE 29        			CP      ')'
1522+ 9850 20 F3        			JR      NZ,ARGERR
1523+ 9852 13           			INC     DE
1524+ 9853 D9           			EXX
1525+ 9854 C1           ARGUE6:			POP     BC
1526+ 9855 78           			LD      A,B
1527+ 9856 3C           			INC     A
1528+ 9857 D9           			EXX
1529+ 9858 C8           			RET     Z               ;MARKER POPPED
1530+ 9859 D9           			EXX
1531+ 985A 3D           			DEC     A
1532+ 985B FA 69 98     			JP      M,ARGUE7        ;STRING
1533+ 985E E1           			POP     HL
1534+ 985F D9           			EXX
1535+ 9860 E1           			POP     HL
1536+ 9861 D9           			EXX
1537+ 9862 DD E1        			POP     IX
1538+ 9864 CD 81 97     			CALL    STORE           ;WRITE TO DUMMY
1539+ 9867 18 EB        			JR      ARGUE6
1540+ 9869 CD 21 A6     ARGUE7:			CALL    POPS
1541+ 986C DD E1        			POP     IX
1542+ 986E CD AA 97     			CALL    STACCS
1543+ 9871 18 E1        			JR      ARGUE6
1544+ 9873              ;
1545+ 9873              ;SAVLOC: SUBROUTINE TO STACK LOCAL PARAMETERS
1546+ 9873              ;  OF A FUNCTION OR PROCEDURE.
1547+ 9873              ;THERE IS A LOT OF STACK MANIPULATION - CARE!!
1548+ 9873              ;   Inputs: IY is parameters pointer
1549+ 9873              ;  Outputs: IY updated
1550+ 9873              ; Destroys: A,B,C,D,E,H,L,IX,IY,F,SP
1551+ 9873              ;
1552+ 9873 D1           SAVLOC:			POP     DE              ;RETURN ADDRESS
1553+ 9874 FD 23        SAVLO1:			INC     IY              ;BUMP PAST ( OR ,
1554+ 9876 CD 9B A6     			CALL    NXT
1555+ 9879 D5           			PUSH    DE
1556+ 987A D9           			EXX
1557+ 987B C5           			PUSH    BC
1558+ 987C D5           			PUSH    DE
1559+ 987D E5           			PUSH    HL
1560+ 987E D9           			EXX
1561+ 987F CD DB 8F     			CALL    VAR             ;DUMMY VARIABLE
1562+ 9882 D9           			EXX
1563+ 9883 E1           			POP     HL
1564+ 9884 D1           			POP     DE
1565+ 9885 C1           			POP     BC
1566+ 9886 D9           			EXX
1567+ 9887 D1           			POP     DE
1568+ 9888 B7           			OR      A               ;TYPE
1569+ 9889 FA 9A 98     			JP      M,SAVLO2        ;STRING
1570+ 988C D9           			EXX
1571+ 988D E5           			PUSH    HL              ;SAVE H'L'
1572+ 988E D9           			EXX
1573+ 988F 47           			LD      B,A             ;TYPE
1574+ 9890 CD 70 A1     			CALL    LOADN
1575+ 9893 D9           			EXX
1576+ 9894 E3           			EX      (SP),HL
1577+ 9895 D9           			EXX
1578+ 9896 E5           			PUSH    HL
1579+ 9897 C5           			PUSH    BC
1580+ 9898 18 26        			JR      SAVLO4
1581+ 989A F5           SAVLO2:			PUSH    AF              ;STRING TYPE
1582+ 989B D5           			PUSH    DE
1583+ 989C D9           			EXX
1584+ 989D E5           			PUSH    HL
1585+ 989E D9           			EXX
1586+ 989F CD FA A1     			CALL    LOADS
1587+ 98A2 D9           			EXX
1588+ 98A3 E1           			POP     HL
1589+ 98A4 D9           			EXX
1590+ 98A5 4B           			LD      C,E
1591+ 98A6 D1           			POP     DE
1592+ 98A7 CD E2 97     			CALL    CHECK
1593+ 98AA F1           			POP     AF              ;LEVEL STACK
1594+ 98AB 21 00 00     			LD      HL,0
1595+ 98AE 45           			LD      B,L
1596+ 98AF ED 42        			SBC     HL,BC
1597+ 98B1 39           			ADD     HL,SP
1598+ 98B2 F9           			LD      SP,HL
1599+ 98B3 47           			LD      B,A             ;TYPE
1600+ 98B4 C5           			PUSH    BC
1601+ 98B5 28 09        			JR      Z,SAVLO4
1602+ 98B7 D5           			PUSH    DE
1603+ 98B8 11 00 B4     			LD      DE,ACCS
1604+ 98BB EB           			EX      DE,HL
1605+ 98BC 45           			LD      B,L
1606+ 98BD ED B0        			LDIR                    ;SAVE STRING ON STACK
1607+ 98BF D1           			POP     DE
1608+ 98C0 DD E5        SAVLO4:			PUSH    IX              ;VARPTR
1609+ 98C2 CD C5 98     			CALL    SAVLO5
1610+ 98C5              LOCCHK:			EQU     $
1611+ 98C5 CD E2 97     SAVLO5:			CALL    CHECK
1612+ 98C8 CD 9B A6     			CALL    NXT
1613+ 98CB FE 2C        			CP      ','             ;MORE?
1614+ 98CD 28 A5        			JR      Z,SAVLO1
1615+ 98CF EB           			EX      DE,HL
1616+ 98D0 E9           			JP      (HL)            ;"RETURN"
1617+ 98D1              ;
1618+ 98D1 FD 7E 00     DELIM:			LD      A,(IY)          ;ASSEMBLER DELIMITER
1619+ 98D4 FE 20        			CP      ' '
1620+ 98D6 C8           			RET     Z
1621+ 98D7 FE 2C        			CP      ','
1622+ 98D9 C8           			RET     Z
1623+ 98DA FE 29        			CP      ')'
1624+ 98DC C8           			RET     Z
1625+ 98DD FE 3B        TERM:			CP      ';'             ;ASSEMBLER TERMINATOR
1626+ 98DF C8           			RET     Z
1627+ 98E0 FE 5C        			CP      '\'
1628+ 98E2 C8           			RET     Z
1629+ 98E3 18 06        			JR      TERM0
1630+ 98E5              ;
1631+ 98E5 CD 9B A6     @TERM?:			CALL    NXT
1632+ 98E8 FE 8B        			CP      ELSE
1633+ 98EA D0           			RET     NC
1634+ 98EB FE 3A        TERM0:			CP      ':'             ;ASSEMBLER SEPARATOR
1635+ 98ED D0           			RET     NC
1636+ 98EE FE 0D        			CP      CR
1637+ 98F0 C9           			RET
1638+ 98F1              ;
1639+ 98F1 CD E5 98     SPAN:			CALL    TERM?
1640+ 98F4 C8           			RET     Z
1641+ 98F5 FD 23        			INC     IY
1642+ 98F7 18 F8        			JR      SPAN
1643+ 98F9              ;
1644+ 98F9 CD 9B A6     EQUALS:			CALL    NXT
1645+ 98FC FD 23        			INC     IY
1646+ 98FE FE 3D        			CP      '='
1647+ 9900 C8           			RET     Z
1648+ 9901 3E 04        			LD      A,4
1649+ 9903 C3 FE 88     			JP      ERROR           ;"Mistake"
1650+ 9906              ;
1651+ 9906 FE 8A        FORMAT:			CP      TAB
1652+ 9908 28 0C        			JR      Z,DOTAB
1653+ 990A FE 89        			CP      SPC
1654+ 990C 28 38        			JR      Z,DOSPC
1655+ 990E FE 27        			CP      ''''
1656+ 9910 C0           			RET     NZ
1657+ 9911 CD 90 8A     			CALL    CRLF
1658+ 9914 AF           			XOR     A
1659+ 9915 C9           			RET
1660+ 9916              ;
1661+ 9916 C5           DOTAB:			PUSH    BC
1662+ 9917 CD B7 A0     			CALL    EXPRI
1663+ 991A D9           			EXX
1664+ 991B C1           			POP     BC
1665+ 991C FD 7E 00     			LD      A,(IY)
1666+ 991F FE 2C        			CP      ','
1667+ 9921 28 11        			JR      Z,DOTAB1
1668+ 9923 CD 5F A6     			CALL    BRAKET
1669+ 9926 7D           			LD      A,L
1670+ 9927 21 FB B6     TABIT:			LD      HL,COUNT
1671+ 992A BE           			CP      (HL)
1672+ 992B C8           			RET     Z
1673+ 992C F5           			PUSH    AF
1674+ 992D DC 90 8A     			CALL    C,CRLF
1675+ 9930 F1           			POP     AF
1676+ 9931 96           			SUB     (HL)
1677+ 9932 18 19        			JR      FILL
1678+ 9934 FD 23        DOTAB1:			INC     IY
1679+ 9936 C5           			PUSH    BC
1680+ 9937 E5           			PUSH    HL
1681+ 9938 CD B7 A0     			CALL    EXPRI
1682+ 993B D9           			EXX
1683+ 993C D1           			POP     DE
1684+ 993D C1           			POP     BC
1685+ 993E CD 5F A6     			CALL    BRAKET
1686+ 9941 CD CC B2     			CALL    PUTCSR
1687+ 9944 AF           			XOR     A
1688+ 9945 C9           			RET
1689+ 9946              ;
1690+ 9946 C5           DOSPC:			PUSH    BC
1691+ 9947 CD CE A0     			CALL    ITEMI
1692+ 994A D9           			EXX
1693+ 994B 7D           			LD      A,L
1694+ 994C C1           			POP     BC
1695+ 994D B7           @FILL:			OR      A
1696+ 994E C8           			RET     Z
1697+ 994F C5           			PUSH    BC
1698+ 9950 47           			LD      B,A
1699+ 9951 3E 20        FILL1:			LD      A,' '
1700+ 9953 CD 97 8A     			CALL    OUTCHR
1701+ 9956 10 F9        			DJNZ    FILL1
1702+ 9958 C1           			POP     BC
1703+ 9959 AF           			XOR     A
1704+ 995A C9           			RET
1705+ 995B              ;
1706+ 995B 21 00 B4     PTEXT:			LD      HL,ACCS
1707+ 995E 1C           			INC     E
1708+ 995F 1D           PTEXT1:			DEC     E
1709+ 9960 C8           			RET     Z
1710+ 9961 7E           			LD      A,(HL)
1711+ 9962 23           			INC     HL
1712+ 9963 CD 97 8A     			CALL    OUTCHR
1713+ 9966 18 F7        			JR      PTEXT1
1714+ 9968              ;
1715+ 9968 F5           FETCHS:			PUSH    AF
1716+ 9969 C5           			PUSH    BC
1717+ 996A E5           			PUSH    HL
1718+ 996B FD E3        			EX      (SP),IY
1719+ 996D CD 85 99     			CALL    XTRACT
1720+ 9970 CD 9B A6     			CALL    NXT
1721+ 9973 FD E3        			EX      (SP),IY
1722+ 9975 E1           			POP     HL
1723+ 9976 C1           			POP     BC
1724+ 9977 F1           			POP     AF
1725+ 9978 C9           			RET
1726+ 9979              ;
1727+ 9979 11 00 B4     LINES:			LD      DE,ACCS
1728+ 997C 7E           LINE1S:			LD      A,(HL)
1729+ 997D 12           			LD      (DE),A
1730+ 997E FE 0D        			CP      CR
1731+ 9980 C8           			RET     Z
1732+ 9981 23           			INC     HL
1733+ 9982 1C           			INC     E
1734+ 9983 18 F7        			JR      LINE1S
1735+ 9985              ;
1736+ 9985 CD 9B A6     XTRACT:			CALL    NXT
1737+ 9988 FE 22        			CP      34		;ASCII ""
1738+ 998A FD 23        			INC     IY
1739+ 998C CA B2 A1     			JP      Z,CONS
1740+ 998F FD 2B        			DEC     IY
1741+ 9991 11 00 B4     			LD      DE,ACCS
1742+ 9994 FD 7E 00     XTRAC1:			LD      A,(IY)
1743+ 9997 12           			LD      (DE),A
1744+ 9998 FE 2C        			CP      ','
1745+ 999A C8           			RET     Z
1746+ 999B FE 0D        			CP      CR
1747+ 999D C8           			RET     Z
1748+ 999E FD 23        			INC     IY
1749+ 99A0 1C           			INC     E
1750+ 99A1 18 F1        			JR      XTRAC1
1751+ 99A3              ;
1752+ 99A3 06 00        SEARCH:			LD      B,0
1753+ 99A5 4E           SRCH1:			LD      C,(HL)
1754+ 99A6 0C           			INC     C
1755+ 99A7 0D           			DEC     C
1756+ 99A8 28 0C        			JR      Z,SRCH2         ;FAIL
1757+ 99AA 23           			INC     HL
1758+ 99AB 23           			INC     HL
1759+ 99AC 23           			INC     HL
1760+ 99AD BE           			CP      (HL)
1761+ 99AE C8           			RET     Z
1762+ 99AF 0D           			DEC     C
1763+ 99B0 0D           			DEC     C
1764+ 99B1 0D           			DEC     C
1765+ 99B2 09           			ADD     HL,BC
1766+ 99B3 C3 A5 99     			JP      SRCH1
1767+ 99B6 2B           SRCH2:			DEC     HL              ;POINT TO CR
1768+ 99B7 37           			SCF
1769+ 99B8 C9           			RET
1770+ 99B9              ;
1771+ 99B9 FE 05        @X4OR5:			CP      5
1772+ 99BB 62           			LD      H,D
1773+ 99BC 6B           			LD      L,E
1774+ 99BD 29           			ADD     HL,HL
1775+ 99BE D8           			RET     C
1776+ 99BF 29           			ADD     HL,HL
1777+ 99C0 D8           			RET     C
1778+ 99C1 EB           			EX      DE,HL
1779+ 99C2 C0           			RET     NZ
1780+ 99C3 19           			ADD     HL,DE
1781+ 99C4 EB           			EX      DE,HL
1782+ 99C5 C9           			RET
1783+ 99C6              ;
1784+ 99C6 EB           @MUL16:			EX      DE,HL
1785+ 99C7 21 00 00     			LD      HL,0
1786+ 99CA 3E 10        			LD      A,16
1787+ 99CC 29           MUL161:			ADD     HL,HL
1788+ 99CD D8           			RET     C               ;OVERFLOW
1789+ 99CE CB 23        			SLA     E
1790+ 99D0 CB 12        			RL      D
1791+ 99D2 30 02        			JR      NC,MUL162
1792+ 99D4 09           			ADD     HL,BC
1793+ 99D5 D8           			RET     C
1794+ 99D6 3D           MUL162:			DEC     A
1795+ 99D7 20 F3        			JR      NZ,MUL161
1796+ 99D9 C9           			RET
1797+ 99DA              ;
1798+ 99DA CD 9B A6     @CHANEL:		CALL    NXT
1799+ 99DD FE 23        			CP      '#'
1800+ 99DF 3E 2D        			LD      A,45
1801+ 99E1 C2 FE 88     			JP      NZ,ERROR        ;"Missing #"
1802+ 99E4 FD 23        CHNL:			INC     IY              ;SKIP '#'
1803+ 99E6 CD CE A0     			CALL    ITEMI
1804+ 99E9 D9           			EXX
1805+ 99EA EB           			EX      DE,HL
1806+ 99EB C9           			RET
1807+ 99EC              ;
1808+ 99EC              ;ASSEMBLER:
1809+ 99EC              ;LANGUAGE-INDEPENDENT CONTROL SECTION:
1810+ 99EC              ; Outputs: A=delimiter, carry set if syntax error.
1811+ 99EC              ;
1812+ 99EC CD 62 9D     ASSEM:			CALL    SKIP
1813+ 99EF FD 23        			INC     IY
1814+ 99F1 FE 3A        			CP      ':'
1815+ 99F3 28 F7        			JR      Z,ASSEM
1816+ 99F5 FE 5D        			CP      ']'
1817+ 99F7 C8           			RET     Z
1818+ 99F8 FE 0D        			CP      CR
1819+ 99FA C8           			RET     Z
1820+ 99FB FD 2B        			DEC     IY
1821+ 99FD DD 2A 40 B6  			LD      IX,(PC)         ;PROGRAM COUNTER
1822+ 9A01 21 FE B6     			LD      HL,LISTON
1823+ 9A04 CB 76        			BIT     6,(HL)
1824+ 9A06 28 04        			JR      Z,ASSEM0
1825+ 9A08 DD 2A 3C B6  			LD      IX,(OC)         ;ORIGIN of CODE
1826+ 9A0C DD E5        ASSEM0:			PUSH    IX
1827+ 9A0E FD E5        			PUSH    IY
1828+ 9A10 CD A0 9A     			CALL    ASMB
1829+ 9A13 C1           			POP     BC
1830+ 9A14 D1           			POP     DE
1831+ 9A15 D8           			RET     C
1832+ 9A16 CD 62 9D     			CALL    SKIP
1833+ 9A19 37           			SCF
1834+ 9A1A C0           			RET     NZ
1835+ 9A1B FD 2B        			DEC     IY
1836+ 9A1D FD 23        ASSEM3:			INC     IY
1837+ 9A1F FD 7E 00     			LD      A,(IY)
1838+ 9A22 CD EB 98     			CALL    TERM0
1839+ 9A25 20 F6        			JR      NZ,ASSEM3
1840+ 9A27 3A FE B6     			LD      A,(LISTON)
1841+ 9A2A DD E5        			PUSH    IX
1842+ 9A2C E1           			POP     HL
1843+ 9A2D B7           			OR      A
1844+ 9A2E ED 52        			SBC     HL,DE
1845+ 9A30 EB           			EX      DE,HL           ;DE= NO. OF BYTES
1846+ 9A31 E5           			PUSH    HL
1847+ 9A32 2A 40 B6     			LD      HL,(PC)
1848+ 9A35 E5           			PUSH    HL
1849+ 9A36 19           			ADD     HL,DE
1850+ 9A37 22 40 B6     			LD      (PC),HL         ;UPDATE PC
1851+ 9A3A CB 77        			BIT     6,A
1852+ 9A3C 28 07        			JR      Z,ASSEM5
1853+ 9A3E 2A 3C B6     			LD      HL,(OC)
1854+ 9A41 19           			ADD     HL,DE
1855+ 9A42 22 3C B6     			LD      (OC),HL         ;UPDATE OC
1856+ 9A45 E1           ASSEM5:			POP     HL              ;OLD PC
1857+ 9A46 DD E1        			POP     IX              ;CODE HERE
1858+ 9A48 CB 67        			BIT     4,A
1859+ 9A4A 28 A0        			JR      Z,ASSEM
1860+ 9A4C 7C           			LD      A,H
1861+ 9A4D CD 8C 9A     			CALL    HEX
1862+ 9A50 7D           			LD      A,L
1863+ 9A51 CD 85 9A     			CALL    HEXSP
1864+ 9A54 AF           			XOR     A
1865+ 9A55 BB           			CP      E
1866+ 9A56 28 15        			JR      Z,ASSEM2
1867+ 9A58 3A FB B6     ASSEM1:			LD      A,(COUNT)
1868+ 9A5B FE 11        			CP      17
1869+ 9A5D 3E 05        			LD      A,5
1870+ 9A5F D4 27 99     			CALL    NC,TABIT        ;NEXT LINE
1871+ 9A62 DD 7E 00     			LD      A,(IX)
1872+ 9A65 CD 85 9A     			CALL    HEXSP
1873+ 9A68 DD 23        			INC     IX
1874+ 9A6A 1D           			DEC     E
1875+ 9A6B 20 EB        			JR      NZ,ASSEM1
1876+ 9A6D 3E 12        ASSEM2:			LD      A,18
1877+ 9A6F CD 27 99     			CALL    TABIT
1878+ 9A72 FD E5        			PUSH    IY
1879+ 9A74 E1           			POP     HL
1880+ 9A75 ED 42        			SBC     HL,BC
1881+ 9A77 0A           ASSEM4:			LD      A,(BC)
1882+ 9A78 CD B0 8A     			CALL    OUT
1883+ 9A7B 03           			INC     BC
1884+ 9A7C 2D           			DEC     L
1885+ 9A7D 20 F8        			JR      NZ,ASSEM4
1886+ 9A7F CD 90 8A     			CALL    CRLF
1887+ 9A82 C3 EC 99     			JP      ASSEM
1888+ 9A85              ;
1889+ 9A85 CD 8C 9A     HEXSP:			CALL    HEX
1890+ 9A88 3E 20        			LD      A,' '
1891+ 9A8A 18 11        			JR      OUTCH1
1892+ 9A8C F5           HEX:			PUSH    AF
1893+ 9A8D 0F           			RRCA
1894+ 9A8E 0F           			RRCA
1895+ 9A8F 0F           			RRCA
1896+ 9A90 0F           			RRCA
1897+ 9A91 CD 95 9A     			CALL    HEXOUT
1898+ 9A94 F1           			POP     AF
1899+ 9A95 E6 0F        HEXOUT:			AND     0FH
1900+ 9A97 C6 90        			ADD     A,90H
1901+ 9A99 27           			DAA
1902+ 9A9A CE 40        			ADC     A,40H
1903+ 9A9C 27           			DAA
1904+ 9A9D C3 B0 8A     OUTCH1:			JP      OUT
1905+ 9AA0              ;
1906+ 9AA0              ;PROCESSOR-SPECIFIC TRANSLATION SECTION:
1907+ 9AA0              ;
1908+ 9AA0              ;REGISTER USAGE: B - TYPE OF MOST RECENT OPERAND
1909+ 9AA0              ;                C - OPCODE BEING BUILT
1910+ 9AA0              ;                D - (IX) OR (IY) FLAG
1911+ 9AA0              ;                E - OFFSET FROM IX OR IY
1912+ 9AA0              ;               HL - NUMERIC OPERAND VALUE
1913+ 9AA0              ;               IX - CODE DESTINATION
1914+ 9AA0              ;               IY - SOURCE TEXT POINTER
1915+ 9AA0              ;   Inputs: A = initial character
1916+ 9AA0              ;  Outputs: Carry set if syntax error.
1917+ 9AA0              ;
1918+ 9AA0 FE 2E        ASMB:			CP      '.'
1919+ 9AA2 20 16        			JR      NZ,ASMB1
1920+ 9AA4 FD 23        			INC     IY
1921+ 9AA6 DD E5        			PUSH    IX
1922+ 9AA8 CD DB 8F     			CALL    VAR
1923+ 9AAB F5           			PUSH    AF
1924+ 9AAC CD E1 A5     			CALL    ZERO
1925+ 9AAF D9           			EXX
1926+ 9AB0 2A 40 B6     			LD      HL,(PC)
1927+ 9AB3 D9           			EXX
1928+ 9AB4 F1           			POP     AF
1929+ 9AB5 CD 81 97     			CALL    STORE
1930+ 9AB8 DD E1        			POP     IX
1931+ 9ABA CD 62 9D     ASMB1:			CALL    SKIP
1932+ 9ABD C8           			RET     Z
1933+ 9ABE FE D6        			CP      TCALL
1934+ 9AC0 0E C4        			LD      C,0C4H
1935+ 9AC2 FD 23        			INC     IY
1936+ 9AC4 CA B1 9B     			JP      Z,GRPC
1937+ 9AC7 FD 2B        			DEC     IY
1938+ 9AC9 21 74 9D     			LD      HL,OPCODS
1939+ 9ACC CD 19 9D     			CALL    FIND
1940+ 9ACF D8           			RET     C
1941+ 9AD0 48           			LD      C,B     ;ROOT OPCODE
1942+ 9AD1 16 00        			LD      D,0     ;CLEAR IX/IY FLAG
1943+ 9AD3              ;
1944+ 9AD3              ;GROUP 0 - TRIVIAL CASES REQUIRING NO COMPUTATION
1945+ 9AD3              ;GROUP 1 - AS GROUP 0 BUT WITH "ED" PREFIX
1946+ 9AD3              ;
1947+ 9AD3 D6 27        			SUB     39
1948+ 9AD5 30 07        			JR      NC,GROUP2
1949+ 9AD7 FE E8        			CP      15-39
1950+ 9AD9 D4 7F 9C     			CALL    NC,ED
1951+ 9ADC 18 68        			JR      BYTE0
1952+ 9ADE              ;
1953+ 9ADE              ;GROUP 2 - BIT, RES, SET
1954+ 9ADE              ;GROUP 3 - RLC, RRC, RL, RR, SLA, SRA, SRL
1955+ 9ADE              ;
1956+ 9ADE D6 0A        GROUP2:			SUB     10
1957+ 9AE0 30 0F        			JR      NC,GROUP4
1958+ 9AE2 FE F9        			CP      3-10
1959+ 9AE4 DC 09 9D     			CALL    C,BIT
1960+ 9AE7 D8           			RET     C
1961+ 9AE8 CD DE 9C     			CALL    REGLO
1962+ 9AEB D8           			RET     C
1963+ 9AEC CD 83 9C     			CALL    CB
1964+ 9AEF 18 55        			JR      BYTE0
1965+ 9AF1              ;
1966+ 9AF1              ;GROUP 4 - PUSH, POP, EX (SP)
1967+ 9AF1              ;
1968+ 9AF1 D6 03        GROUP4:			SUB     3
1969+ 9AF3 30 06        			JR      NC,GROUP5
1970+ 9AF5 CD FD 9C     G4:			CALL    PAIR
1971+ 9AF8 D8           			RET     C
1972+ 9AF9 18 4B        			JR      BYTE0
1973+ 9AFB              ;
1974+ 9AFB              ;GROUP 5 - SUB, AND, XOR, OR, CP
1975+ 9AFB              ;GROUP 6 - ADD, ADC, SBC
1976+ 9AFB              ;
1977+ 9AFB D6 0A        GROUP5:			SUB     8+2
1978+ 9AFD 30 32        			JR      NC,GROUP7
1979+ 9AFF FE FD        			CP      5-8
1980+ 9B01 06 07        			LD      B,7
1981+ 9B03 D4 91 9C     			CALL    NC,OPND
1982+ 9B06 78           			LD      A,B
1983+ 9B07 FE 07        			CP      7
1984+ 9B09 20 10        			JR      NZ,G6HL
1985+ 9B0B CD DE 9C     G6:			CALL    REGLO
1986+ 9B0E 79           			LD      A,C
1987+ 9B0F 30 28        			JR      NC,BIND1
1988+ 9B11 EE 46        			XOR     46H
1989+ 9B13 CD 85 9C     			CALL    BIND
1990+ 9B16 CD C1 9C     DB:			CALL    NUMBER
1991+ 9B19 18 78        			JR      VAL8
1992+ 9B1B              ;
1993+ 9B1B E6 3F        G6HL:			AND     3FH
1994+ 9B1D FE 0C        			CP      12
1995+ 9B1F 37           			SCF
1996+ 9B20 C0           			RET     NZ
1997+ 9B21 79           			LD      A,C
1998+ 9B22 FE 80        			CP      80H
1999+ 9B24 0E 09        			LD      C,9
2000+ 9B26 28 CD        			JR      Z,G4
2001+ 9B28 EE 1C        			XOR     1CH
2002+ 9B2A 0F           			RRCA
2003+ 9B2B 4F           			LD      C,A
2004+ 9B2C CD 7F 9C     			CALL    ED
2005+ 9B2F 18 C4        			JR      G4
2006+ 9B31              ;
2007+ 9B31              ;GROUP 7 - INC, DEC
2008+ 9B31              ;
2009+ 9B31 D6 02        GROUP7:			SUB     2
2010+ 9B33 30 14        			JR      NC,GROUP8
2011+ 9B35 CD E4 9C     			CALL    REGHI
2012+ 9B38 79           			LD      A,C
2013+ 9B39 D2 85 9C     BIND1:			JP      NC,BIND
2014+ 9B3C EE 64        			XOR     64H
2015+ 9B3E 07           			RLCA
2016+ 9B3F 07           			RLCA
2017+ 9B40 07           			RLCA
2018+ 9B41 4F           			LD      C,A
2019+ 9B42 CD 01 9D     			CALL    PAIR1
2020+ 9B45 D8           			RET     C
2021+ 9B46 79           BYTE0:			LD      A,C
2022+ 9B47 18 7F        			JR      BYTE2
2023+ 9B49              ;
2024+ 9B49              ;GROUP 8 - IN
2025+ 9B49              ;GROUP 9 - OUT
2026+ 9B49              ;
2027+ 9B49 D6 02        GROUP8:			SUB     2
2028+ 9B4B 30 21        			JR      NC,GROUPA
2029+ 9B4D FE FF        			CP      1-2
2030+ 9B4F CC 74 9C     			CALL    Z,CORN
2031+ 9B52 08           			EX      AF,AF'
2032+ 9B53 CD E4 9C     			CALL    REGHI
2033+ 9B56 D8           			RET     C
2034+ 9B57 08           			EX      AF,AF'
2035+ 9B58 DC 74 9C     			CALL    C,CORN
2036+ 9B5B 24           			INC     H
2037+ 9B5C 28 E8        			JR      Z,BYTE0
2038+ 9B5E 78           			LD      A,B
2039+ 9B5F FE 07        			CP      7
2040+ 9B61 37           			SCF
2041+ 9B62 C0           			RET     NZ
2042+ 9B63 79           			LD      A,C
2043+ 9B64 EE 03        			XOR     3
2044+ 9B66 07           			RLCA
2045+ 9B67 07           			RLCA
2046+ 9B68 07           			RLCA
2047+ 9B69 CD B1 9C     			CALL    BYTE
2048+ 9B6C 18 25        			JR      VAL8
2049+ 9B6E              ;
2050+ 9B6E              ;GROUP 10 - JR, DJNZ
2051+ 9B6E              ;
2052+ 9B6E D6 02        GROUPA:			SUB     2
2053+ 9B70 30 24        			JR      NC,GROUPB
2054+ 9B72 FE FF        			CP      1-2
2055+ 9B74 C4 EA 9C     			CALL    NZ,COND
2056+ 9B77 79           			LD      A,C
2057+ 9B78 30 02        			JR      NC,GRPA
2058+ 9B7A 3E 18        			LD      A,18H
2059+ 9B7C CD B1 9C     GRPA:			CALL    BYTE
2060+ 9B7F CD C1 9C     			CALL    NUMBER
2061+ 9B82 ED 5B 40 B6  			LD      DE,(PC)
2062+ 9B86 13           			INC     DE
2063+ 9B87 37           			SCF
2064+ 9B88 ED 52        			SBC     HL,DE
2065+ 9B8A 7D           			LD      A,L
2066+ 9B8B 17           			RLA
2067+ 9B8C 9F           			SBC     A,A
2068+ 9B8D BC           			CP      H
2069+ 9B8E 3E 01        TOOFAR:			LD      A,1
2070+ 9B90 C2 FE 88     			JP      NZ,ERROR        ;"Out of range"
2071+ 9B93 7D           VAL8:			LD      A,L
2072+ 9B94 18 32        			JR      BYTE2
2073+ 9B96              ;
2074+ 9B96              ;GROUP 11 - JP
2075+ 9B96              ;
2076+ 9B96 47           GROUPB:			LD      B,A
2077+ 9B97 20 16        			JR      NZ,GROUPC
2078+ 9B99 CD EA 9C     			CALL    COND
2079+ 9B9C 79           			LD      A,C
2080+ 9B9D 30 0B        			JR      NC,GRPB
2081+ 9B9F 78           			LD      A,B
2082+ 9BA0 E6 3F        			AND     3FH
2083+ 9BA2 FE 06        			CP      6
2084+ 9BA4 3E E9        			LD      A,0E9H
2085+ 9BA6 28 20        			JR      Z,BYTE2
2086+ 9BA8 3E C3        			LD      A,0C3H
2087+ 9BAA CD B1 9C     GRPB:			CALL    BYTE
2088+ 9BAD 18 05        			JR      ADDR
2089+ 9BAF              ;
2090+ 9BAF              ;GROUP 12 - CALL
2091+ 9BAF              ;
2092+ 9BAF 10 0C        GROUPC:			DJNZ    GROUPD
2093+ 9BB1 CD CC 9B     GRPC:			CALL    GRPE
2094+ 9BB4 CD C1 9C     ADDR:			CALL    NUMBER
2095+ 9BB7 CD 93 9B     VAL16:			CALL    VAL8
2096+ 9BBA 7C           			LD      A,H
2097+ 9BBB 18 0B        			JR      BYTE2
2098+ 9BBD              ;
2099+ 9BBD              ;GROUP 13 - RST
2100+ 9BBD              ;
2101+ 9BBD 10 0B        GROUPD:			DJNZ    GROUPE
2102+ 9BBF CD C1 9C     			CALL    NUMBER
2103+ 9BC2 A1           			AND     C
2104+ 9BC3 B4           			OR      H
2105+ 9BC4 20 C8        			JR      NZ,TOOFAR
2106+ 9BC6 7D           			LD      A,L
2107+ 9BC7 B1           			OR      C
2108+ 9BC8 18 78        BYTE2:  		JR      BYTE1
2109+ 9BCA              ;
2110+ 9BCA              ;GROUP 14 - RET
2111+ 9BCA              ;
2112+ 9BCA 10 0A        GROUPE:			DJNZ    GROUPF
2113+ 9BCC CD EA 9C     GRPE:			CALL    COND
2114+ 9BCF 79           			LD      A,C
2115+ 9BD0 30 70        			JR      NC,BYTE1
2116+ 9BD2 F6 09        			OR      9
2117+ 9BD4 18 6C        			JR      BYTE1
2118+ 9BD6              ;
2119+ 9BD6              ;GROUP 15 - LD
2120+ 9BD6              ;
2121+ 9BD6 10 6C        GROUPF:			DJNZ    MISC
2122+ 9BD8 CD 16 9D     			CALL    LDOP
2123+ 9BDB 30 5F        			JR      NC,LDA
2124+ 9BDD CD E4 9C     			CALL    REGHI
2125+ 9BE0 08           			EX      AF,AF'
2126+ 9BE1 CD 62 9D     			CALL    SKIP
2127+ 9BE4 FE 28        			CP      '('
2128+ 9BE6 28 1D        			JR      Z,LDIN
2129+ 9BE8 08           			EX      AF,AF'
2130+ 9BE9 D2 0B 9B     			JP      NC,G6
2131+ 9BEC 0E 01        			LD      C,1
2132+ 9BEE CD 01 9D     			CALL    PAIR1
2133+ 9BF1 D8           			RET     C
2134+ 9BF2 3E 0E        			LD      A,14
2135+ 9BF4 B8           			CP      B
2136+ 9BF5 47           			LD      B,A
2137+ 9BF6 CC FD 9C     			CALL    Z,PAIR
2138+ 9BF9 78           			LD      A,B
2139+ 9BFA E6 3F        			AND     3FH
2140+ 9BFC FE 0C        			CP      12
2141+ 9BFE 79           			LD      A,C
2142+ 9BFF 20 A9        			JR      NZ,GRPB
2143+ 9C01 3E F9        			LD      A,0F9H
2144+ 9C03 18 3D        			JR      BYTE1
2145+ 9C05              ;
2146+ 9C05 08           LDIN:			EX      AF,AF'
2147+ 9C06 C5           			PUSH    BC
2148+ 9C07 D4 DE 9C     			CALL    NC,REGLO
2149+ 9C0A 79           			LD      A,C
2150+ 9C0B C1           			POP     BC
2151+ 9C0C 30 77        			JR      NC,BIND
2152+ 9C0E 0E 0A        			LD      C,0AH
2153+ 9C10 CD 01 9D     			CALL    PAIR1
2154+ 9C13 CD 5B 9C     			CALL    LD16
2155+ 9C16 30 92        			JR      NC,GRPB
2156+ 9C18 CD C1 9C     			CALL    NUMBER
2157+ 9C1B 0E 02        			LD      C,2
2158+ 9C1D CD FD 9C     			CALL    PAIR
2159+ 9C20 CD 5B 9C     			CALL    LD16
2160+ 9C23 D8           			RET     C
2161+ 9C24 CD B1 9C     			CALL    BYTE
2162+ 9C27 18 8E        			JR      VAL16
2163+ 9C29              ;
2164+ 9C29              ;OPT - SET OPTION
2165+ 9C29              ;
2166+ 9C29 05           OPT:			DEC     B
2167+ 9C2A CA 16 9B     			JP      Z,DB
2168+ 9C2D 10 85        			DJNZ    ADDR
2169+ 9C2F CD C1 9C     			CALL    NUMBER
2170+ 9C32 21 FE B6     			LD      HL,LISTON
2171+ 9C35 4F           			LD      C,A
2172+ 9C36 ED 6F        			RLD
2173+ 9C38 79           			LD      A,C
2174+ 9C39 ED 67        			RRD
2175+ 9C3B C9           			RET
2176+ 9C3C              ;
2177+ 9C3C FE 04        LDA:			CP      4
2178+ 9C3E DC 7F 9C     			CALL    C,ED
2179+ 9C41 78           			LD      A,B
2180+ 9C42 18 6D        BYTE1:			JR      BYTE
2181+ 9C44              ;
2182+ 9C44              ;MISC - DEFB, DEFW, DEFM
2183+ 9C44              ;
2184+ 9C44 10 E3        MISC:			DJNZ    OPT
2185+ 9C46 DD E5        			PUSH    IX
2186+ 9C48 CD C0 A0     			CALL    EXPRS
2187+ 9C4B DD E1        			POP     IX
2188+ 9C4D 21 00 B4     			LD      HL,ACCS
2189+ 9C50 AF           DEFM1:			XOR     A
2190+ 9C51 BB           			CP      E
2191+ 9C52 C8           			RET     Z
2192+ 9C53 7E           			LD      A,(HL)
2193+ 9C54 23           			INC     HL
2194+ 9C55 CD B1 9C     			CALL    BYTE
2195+ 9C58 1D           			DEC     E
2196+ 9C59 18 F5        			JR      DEFM1
2197+ 9C5B              ;
2198+ 9C5B              ;SUBROUTINES:
2199+ 9C5B              ;
2200+ 9C5B 78           LD16:			LD      A,B
2201+ 9C5C 38 0E        			JR      C,LD8
2202+ 9C5E 78           			LD      A,B
2203+ 9C5F E6 3F        			AND     3FH
2204+ 9C61 FE 0C        			CP      12
2205+ 9C63 79           			LD      A,C
2206+ 9C64 C8           			RET     Z
2207+ 9C65 CD 7F 9C     			CALL    ED
2208+ 9C68 79           			LD      A,C
2209+ 9C69 F6 43        			OR      43H
2210+ 9C6B C9           			RET
2211+ 9C6C              ;
2212+ 9C6C FE 07        LD8:			CP      7
2213+ 9C6E 37           			SCF
2214+ 9C6F C0           			RET     NZ
2215+ 9C70 79           			LD      A,C
2216+ 9C71 F6 30        			OR      30H
2217+ 9C73 C9           			RET
2218+ 9C74              ;
2219+ 9C74 C5           CORN:			PUSH    BC
2220+ 9C75 CD 91 9C     			CALL    OPND
2221+ 9C78 CB 68        			BIT     5,B
2222+ 9C7A C1           			POP     BC
2223+ 9C7B 28 44        			JR      Z,NUMBER
2224+ 9C7D 26 FF        			LD      H,-1
2225+ 9C7F 3E ED        ED:			LD      A,0EDH
2226+ 9C81 18 2E        			JR      BYTE
2227+ 9C83              ;
2228+ 9C83 3E CB        CB:			LD      A,0CBH
2229+ 9C85 FE 76        BIND:			CP      76H
2230+ 9C87 37           			SCF
2231+ 9C88 C8           			RET     Z               ;REJECT LD (HL),(HL)
2232+ 9C89 CD B1 9C     			CALL    BYTE
2233+ 9C8C 14           			INC     D
2234+ 9C8D F0           			RET     P
2235+ 9C8E 7B           			LD      A,E
2236+ 9C8F 18 20        			JR      BYTE
2237+ 9C91              ;
2238+ 9C91 E5           OPND:			PUSH    HL
2239+ 9C92 21 BB 9E     			LD      HL,OPRNDS
2240+ 9C95 CD 19 9D     			CALL    FIND
2241+ 9C98 E1           			POP     HL
2242+ 9C99 D8           			RET     C
2243+ 9C9A CB 78        			BIT     7,B
2244+ 9C9C C8           			RET     Z
2245+ 9C9D CB 58        			BIT     3,B
2246+ 9C9F E5           			PUSH    HL
2247+ 9CA0 CC B8 9C     			CALL    Z,OFFSET
2248+ 9CA3 5D           			LD      E,L
2249+ 9CA4 E1           			POP     HL
2250+ 9CA5 3E DD        			LD      A,0DDH
2251+ 9CA7 CB 70        			BIT     6,B
2252+ 9CA9 28 02        			JR      Z,OP1
2253+ 9CAB 3E FD        			LD      A,0FDH
2254+ 9CAD B7           OP1:			OR      A
2255+ 9CAE 14           			INC     D
2256+ 9CAF 57           			LD      D,A
2257+ 9CB0 F8           			RET     M
2258+ 9CB1 DD 77 00     BYTE:			LD      (IX),A
2259+ 9CB4 DD 23        			INC     IX
2260+ 9CB6 B7           			OR      A
2261+ 9CB7 C9           			RET
2262+ 9CB8              ;
2263+ 9CB8 FD 7E 00     OFFSET:			LD      A,(IY)
2264+ 9CBB FE 29        			CP      ')'
2265+ 9CBD 21 00 00     			LD      HL,0
2266+ 9CC0 C8           			RET     Z
2267+ 9CC1 CD 62 9D     NUMBER:			CALL    SKIP
2268+ 9CC4 C5           			PUSH    BC
2269+ 9CC5 D5           			PUSH    DE
2270+ 9CC6 DD E5        			PUSH    IX
2271+ 9CC8 CD B7 A0     			CALL    EXPRI
2272+ 9CCB DD E1        			POP     IX
2273+ 9CCD D9           			EXX
2274+ 9CCE D1           			POP     DE
2275+ 9CCF C1           			POP     BC
2276+ 9CD0 7D           			LD      A,L
2277+ 9CD1 B7           			OR      A
2278+ 9CD2 C9           			RET
2279+ 9CD3              ;
2280+ 9CD3 CD 91 9C     REG:			CALL    OPND
2281+ 9CD6 D8           			RET     C
2282+ 9CD7 78           			LD      A,B
2283+ 9CD8 E6 3F        			AND     3FH
2284+ 9CDA FE 08        			CP      8
2285+ 9CDC 3F           			CCF
2286+ 9CDD C9           			RET
2287+ 9CDE              ;
2288+ 9CDE CD D3 9C     REGLO:			CALL    REG
2289+ 9CE1 D8           			RET     C
2290+ 9CE2 18 2F        			JR      ORC
2291+ 9CE4              ;
2292+ 9CE4 CD D3 9C     REGHI:			CALL    REG
2293+ 9CE7 D8           			RET     C
2294+ 9CE8 18 26        			JR      SHL3
2295+ 9CEA              ;
2296+ 9CEA CD 91 9C     COND:			CALL    OPND
2297+ 9CED D8           			RET     C
2298+ 9CEE 78           			LD      A,B
2299+ 9CEF E6 1F        			AND     1FH
2300+ 9CF1 D6 10        			SUB     16
2301+ 9CF3 30 1B        			JR      NC,SHL3
2302+ 9CF5 FE F1        			CP      -15
2303+ 9CF7 37           			SCF
2304+ 9CF8 C0           			RET     NZ
2305+ 9CF9 3E 03        			LD      A,3
2306+ 9CFB 18 13        			JR      SHL3
2307+ 9CFD              ;
2308+ 9CFD CD 91 9C     PAIR:			CALL    OPND
2309+ 9D00 D8           			RET     C
2310+ 9D01 78           PAIR1:			LD      A,B
2311+ 9D02 E6 0F        			AND     0FH
2312+ 9D04 D6 08        			SUB     8
2313+ 9D06 D8           			RET     C
2314+ 9D07 18 07        			JR      SHL3
2315+ 9D09              ;
2316+ 9D09 CD C1 9C     BIT:			CALL    NUMBER
2317+ 9D0C FE 08        			CP      8
2318+ 9D0E 3F           			CCF
2319+ 9D0F D8           			RET     C
2320+ 9D10 07           SHL3:			RLCA
2321+ 9D11 07           			RLCA
2322+ 9D12 07           			RLCA
2323+ 9D13 B1           ORC:			OR      C
2324+ 9D14 4F           			LD      C,A
2325+ 9D15 C9           			RET
2326+ 9D16              ;
2327+ 9D16 21 00 9F     LDOP:			LD      HL,LDOPS
2328+ 9D19 CD 62 9D     FIND:			CALL    SKIP
2329+ 9D1C 06 00        EXIT:			LD      B,0
2330+ 9D1E 37           			SCF
2331+ 9D1F C8           			RET     Z
2332+ 9D20 FE DD        			CP      DEF
2333+ 9D22 28 04        			JR      Z,FIND0
2334+ 9D24 FE 85        			CP      TOR+1
2335+ 9D26 3F           			CCF
2336+ 9D27 D8           			RET     C
2337+ 9D28 7E           FIND0:			LD      A,(HL)
2338+ 9D29 B7           			OR      A
2339+ 9D2A 28 F0        			JR      Z,EXIT
2340+ 9D2C FD AE 00     			XOR     (IY)
2341+ 9D2F E6 5F        			AND     01011111B
2342+ 9D31 28 09        			JR      Z,FIND2
2343+ 9D33 CB 7E        FIND1:			BIT     7,(HL)
2344+ 9D35 23           			INC     HL
2345+ 9D36 28 FB        			JR      Z,FIND1
2346+ 9D38 23           			INC     HL
2347+ 9D39 04           			INC     B
2348+ 9D3A 18 EC        			JR      FIND0
2349+ 9D3C              ;
2350+ 9D3C FD E5        FIND2:			PUSH    IY
2351+ 9D3E CB 7E        FIND3:			BIT     7,(HL)
2352+ 9D40 FD 23        			INC     IY
2353+ 9D42 23           			INC     HL
2354+ 9D43 20 10        			JR      NZ,FIND5
2355+ 9D45 BE           			CP      (HL)
2356+ 9D46 CC 61 9D     			CALL    Z,SKIP0
2357+ 9D49 7E           			LD      A,(HL)
2358+ 9D4A FD AE 00     			XOR     (IY)
2359+ 9D4D E6 5F        			AND     01011111B
2360+ 9D4F 28 ED        			JR      Z,FIND3
2361+ 9D51 FD E1        FIND4:			POP     IY
2362+ 9D53 18 DE        			JR      FIND1
2363+ 9D55              ;
2364+ 9D55 CD D1 98     FIND5:			CALL    DELIM
2365+ 9D58 C4 6E 9D     			CALL    NZ,SIGN
2366+ 9D5B 20 F4        			JR      NZ,FIND4
2367+ 9D5D 78           FIND6:			LD      A,B
2368+ 9D5E 46           			LD      B,(HL)
2369+ 9D5F E1           			POP     HL
2370+ 9D60 C9           			RET
2371+ 9D61              ;
2372+ 9D61 23           SKIP0:			INC     HL
2373+ 9D62 CD D1 98     SKIP:			CALL    DELIM
2374+ 9D65 C0           			RET     NZ
2375+ 9D66 CD DD 98     			CALL    TERM
2376+ 9D69 C8           			RET     Z
2377+ 9D6A FD 23        			INC     IY
2378+ 9D6C 18 F4        			JR      SKIP
2379+ 9D6E              ;
2380+ 9D6E FE 2B        SIGN:			CP      '+'
2381+ 9D70 C8           			RET     Z
2382+ 9D71 FE 2D        			CP      '-'
2383+ 9D73 C9           			RET
2384+ 9D74              ;
2385+ 9D74              ;.XLIST
2386+ 9D74 4E 4F        OPCODS:			DEFM    'NO'
2387+ 9D76 D0           			DEFB    'P'+80H
2388+ 9D77 00           			DEFB    0
2389+ 9D78 52 4C 43     			DEFM    'RLC'
2390+ 9D7B C1           			DEFB    'A'+80H
2391+ 9D7C 07           			DEFB    7
2392+ 9D7D 45 58        			DEFM    'EX'
2393+ 9D7F 00           			DEFB    0
2394+ 9D80 41 46        			DEFM    'AF'
2395+ 9D82 00           			DEFB    0
2396+ 9D83 41 46        			DEFM    'AF'
2397+ 9D85 A7           			DEFB    ''''+80H
2398+ 9D86 08           			DEFB    8
2399+ 9D87 52 52 43     			DEFM    'RRC'
2400+ 9D8A C1           			DEFB    'A'+80H
2401+ 9D8B 0F           			DEFB    0FH
2402+ 9D8C 52 4C        			DEFM    'RL'
2403+ 9D8E C1           			DEFB    'A'+80H
2404+ 9D8F 17           			DEFB    17H
2405+ 9D90 52 52        			DEFM    'RR'
2406+ 9D92 C1           			DEFB    'A'+80H
2407+ 9D93 1F           			DEFB    1FH
2408+ 9D94 44 41        			DEFM    'DA'
2409+ 9D96 C1           			DEFB    'A'+80H
2410+ 9D97 27           			DEFB    27H
2411+ 9D98 43 50        			DEFM    'CP'
2412+ 9D9A CC           			DEFB    'L'+80H
2413+ 9D9B 2F           			DEFB    2FH
2414+ 9D9C 53 43        			DEFM    'SC'
2415+ 9D9E C6           			DEFB    'F'+80H
2416+ 9D9F 37           			DEFB    37H
2417+ 9DA0 43 43        			DEFM    'CC'
2418+ 9DA2 C6           			DEFB    'F'+80H
2419+ 9DA3 3F           			DEFB    3FH
2420+ 9DA4 48 41 4C     			DEFM    'HAL'
2421+ 9DA7 D4           			DEFB    'T'+80H
2422+ 9DA8 76           			DEFB    76H
2423+ 9DA9 45 58        			DEFM    'EX'
2424+ 9DAB D8           			DEFB    'X'+80H
2425+ 9DAC D9           			DEFB    0D9H
2426+ 9DAD 45 58        			DEFM    'EX'
2427+ 9DAF 00           			DEFB    0
2428+ 9DB0 44 45        			DEFM    'DE'
2429+ 9DB2 00           			DEFB    0
2430+ 9DB3 48           			DEFM    'H'
2431+ 9DB4 CC           			DEFB    'L'+80H
2432+ 9DB5 EB           			DEFB    0EBH
2433+ 9DB6 44           			DEFM    'D'
2434+ 9DB7 C9           			DEFB    'I'+80H
2435+ 9DB8 F3           			DEFB    0F3H
2436+ 9DB9 45           			DEFM    'E'
2437+ 9DBA C9           			DEFB    'I'+80H
2438+ 9DBB FB           			DEFB    0FBH
2439+ 9DBC              ;
2440+ 9DBC 4E 45        			DEFM    'NE'
2441+ 9DBE C7           			DEFB    'G'+80H
2442+ 9DBF 44           			DEFB    44H
2443+ 9DC0 49 4D        			DEFM    'IM'
2444+ 9DC2 00           			DEFB    0
2445+ 9DC3 B0           			DEFB    '0'+80H
2446+ 9DC4 46           			DEFB    46H
2447+ 9DC5 52 45 54     			DEFM    'RET'
2448+ 9DC8 CE           			DEFB    'N'+80H
2449+ 9DC9 45           			DEFB    45H
2450+ 9DCA 52 45 54     			DEFM    'RET'
2451+ 9DCD C9           			DEFB    'I'+80H
2452+ 9DCE 4D           			DEFB    4DH
2453+ 9DCF 49 4D        			DEFM    'IM'
2454+ 9DD1 00           			DEFB    0
2455+ 9DD2 B1           			DEFB    '1'+80H
2456+ 9DD3 56           			DEFB    56H
2457+ 9DD4 49 4D        			DEFM    'IM'
2458+ 9DD6 00           			DEFB    0
2459+ 9DD7 B2           			DEFB    '2'+80H
2460+ 9DD8 5E           			DEFB    5EH
2461+ 9DD9 52 52        			DEFM    'RR'
2462+ 9DDB C4           			DEFB    'D'+80H
2463+ 9DDC 67           			DEFB    67H
2464+ 9DDD 52 4C        			DEFM    'RL'
2465+ 9DDF C4           			DEFB    'D'+80H
2466+ 9DE0 6F           			DEFB    6FH
2467+ 9DE1 4C 44        			DEFM    'LD'
2468+ 9DE3 C9           			DEFB    'I'+80H
2469+ 9DE4 A0           			DEFB    0A0H
2470+ 9DE5 43 50        			DEFM    'CP'
2471+ 9DE7 C9           			DEFB    'I'+80H
2472+ 9DE8 A1           			DEFB    0A1H
2473+ 9DE9 49 4E        			DEFM    'IN'
2474+ 9DEB C9           			DEFB    'I'+80H
2475+ 9DEC A2           			DEFB    0A2H
2476+ 9DED 4F 55 54     			DEFM    'OUT'
2477+ 9DF0 C9           			DEFB    'I'+80H
2478+ 9DF1 A3           			DEFB    0A3H
2479+ 9DF2 4C 44        			DEFM    'LD'
2480+ 9DF4 C4           			DEFB    'D'+80H
2481+ 9DF5 A8           			DEFB    0A8H
2482+ 9DF6 43 50        			DEFM    'CP'
2483+ 9DF8 C4           			DEFB    'D'+80H
2484+ 9DF9 A9           			DEFB    0A9H
2485+ 9DFA 49 4E        			DEFM    'IN'
2486+ 9DFC C4           			DEFB    'D'+80H
2487+ 9DFD AA           			DEFB    0AAH
2488+ 9DFE 4F 55 54     			DEFM    'OUT'
2489+ 9E01 C4           			DEFB    'D'+80H
2490+ 9E02 AB           			DEFB    0ABH
2491+ 9E03 4C 44 49     			DEFM    'LDI'
2492+ 9E06 D2           			DEFB    'R'+80H
2493+ 9E07 B0           			DEFB    0B0H
2494+ 9E08 43 50 49     			DEFM    'CPI'
2495+ 9E0B D2           			DEFB    'R'+80H
2496+ 9E0C B1           			DEFB    0B1H
2497+ 9E0D 49 4E 49     			DEFM    'INI'
2498+ 9E10 D2           			DEFB    'R'+80H
2499+ 9E11 B2           			DEFB    0B2H
2500+ 9E12 4F 54 49     			DEFM    'OTI'
2501+ 9E15 D2           			DEFB    'R'+80H
2502+ 9E16 B3           			DEFB    0B3H
2503+ 9E17 4C 44 44     			DEFM    'LDD'
2504+ 9E1A D2           			DEFB    'R'+80H
2505+ 9E1B B8           			DEFB    0B8H
2506+ 9E1C 43 50 44     			DEFM    'CPD'
2507+ 9E1F D2           			DEFB    'R'+80H
2508+ 9E20 B9           			DEFB    0B9H
2509+ 9E21 49 4E 44     			DEFM    'IND'
2510+ 9E24 D2           			DEFB    'R'+80H
2511+ 9E25 BA           			DEFB    0BAH
2512+ 9E26 4F 54 44     			DEFM    'OTD'
2513+ 9E29 D2           			DEFB    'R'+80H
2514+ 9E2A BB           			DEFB    0BBH
2515+ 9E2B              ;
2516+ 9E2B 42 49        			DEFM    'BI'
2517+ 9E2D D4           			DEFB    'T'+80H
2518+ 9E2E 40           			DEFB    40H
2519+ 9E2F 52 45        			DEFM    'RE'
2520+ 9E31 D3           			DEFB    'S'+80H
2521+ 9E32 80           			DEFB    80H
2522+ 9E33 53 45        			DEFM    'SE'
2523+ 9E35 D4           			DEFB    'T'+80H
2524+ 9E36 C0           			DEFB    0C0H
2525+ 9E37              ;
2526+ 9E37 52 4C        			DEFM    'RL'
2527+ 9E39 C3           			DEFB    'C'+80H
2528+ 9E3A 00           			DEFB    0
2529+ 9E3B 52 52        			DEFM    'RR'
2530+ 9E3D C3           			DEFB    'C'+80H
2531+ 9E3E 08           			DEFB    8
2532+ 9E3F 52           			DEFM    'R'
2533+ 9E40 CC           			DEFB    'L'+80H
2534+ 9E41 10           			DEFB    10H
2535+ 9E42 52           			DEFM    'R'
2536+ 9E43 D2           			DEFB    'R'+80H
2537+ 9E44 18           			DEFB    18H
2538+ 9E45 53 4C        			DEFM    'SL'
2539+ 9E47 C1           			DEFB    'A'+80H
2540+ 9E48 20           			DEFB    20H
2541+ 9E49 53 52        			DEFM    'SR'
2542+ 9E4B C1           			DEFB    'A'+80H
2543+ 9E4C 28           			DEFB    28H
2544+ 9E4D 53 52        			DEFM    'SR'
2545+ 9E4F CC           			DEFB    'L'+80H
2546+ 9E50 38           			DEFB    38H
2547+ 9E51              ;
2548+ 9E51 50 4F        			DEFM    'PO'
2549+ 9E53 D0           			DEFB    'P'+80H
2550+ 9E54 C1           			DEFB    0C1H
2551+ 9E55 50 55 53     			DEFM    'PUS'
2552+ 9E58 C8           			DEFB    'H'+80H
2553+ 9E59 C5           			DEFB    0C5H
2554+ 9E5A 45 58        			DEFM    'EX'
2555+ 9E5C 00           			DEFB    0
2556+ 9E5D 28 53        			DEFM    '(S'
2557+ 9E5F D0           			DEFB    'P'+80H
2558+ 9E60 E3           			DEFB    0E3H
2559+ 9E61              ;
2560+ 9E61 53 55        			DEFM    'SU'
2561+ 9E63 C2           			DEFB    'B'+80H
2562+ 9E64 90           			DEFB    90H
2563+ 9E65 41 4E        			DEFM    'AN'
2564+ 9E67 C4           			DEFB    'D'+80H
2565+ 9E68 A0           			DEFB    0A0H
2566+ 9E69 58 4F        			DEFM    'XO'
2567+ 9E6B D2           			DEFB    'R'+80H
2568+ 9E6C A8           			DEFB    0A8H
2569+ 9E6D 4F           			DEFM    'O'
2570+ 9E6E D2           			DEFB    'R'+80H
2571+ 9E6F B0           			DEFB    0B0H
2572+ 9E70 43           			DEFM    'C'
2573+ 9E71 D0           			DEFB    'P'+80H
2574+ 9E72 B8           			DEFB    0B8H
2575+ 9E73 80           			DEFB    TAND
2576+ 9E74 A0           			DEFB    0A0H
2577+ 9E75 84           			DEFB    TOR
2578+ 9E76 B0           			DEFB    0B0H
2579+ 9E77              ;
2580+ 9E77 41 44        			DEFM    'AD'
2581+ 9E79 C4           			DEFB    'D'+80H
2582+ 9E7A 80           			DEFB    80H
2583+ 9E7B 41 44        			DEFM    'AD'
2584+ 9E7D C3           			DEFB    'C'+80H
2585+ 9E7E 88           			DEFB    88H
2586+ 9E7F 53 42        			DEFM    'SB'
2587+ 9E81 C3           			DEFB    'C'+80H
2588+ 9E82 98           			DEFB    98H
2589+ 9E83              ;
2590+ 9E83 49 4E        			DEFM    'IN'
2591+ 9E85 C3           			DEFB    'C'+80H
2592+ 9E86 04           			DEFB    4
2593+ 9E87 44 45        			DEFM    'DE'
2594+ 9E89 C3           			DEFB    'C'+80H
2595+ 9E8A 05           			DEFB    5
2596+ 9E8B              ;
2597+ 9E8B 49           			DEFM    'I'
2598+ 9E8C CE           			DEFB    'N'+80H
2599+ 9E8D 40           			DEFB    40H
2600+ 9E8E 4F 55        			DEFM    'OU'
2601+ 9E90 D4           			DEFB    'T'+80H
2602+ 9E91 41           			DEFB    41H
2603+ 9E92              ;
2604+ 9E92 4A           			DEFM    'J'
2605+ 9E93 D2           			DEFB    'R'+80H
2606+ 9E94 20           			DEFB    20H
2607+ 9E95 44 4A 4E     			DEFM    'DJN'
2608+ 9E98 DA           			DEFB    'Z'+80H
2609+ 9E99 10           			DEFB    10H
2610+ 9E9A              ;
2611+ 9E9A 4A           			DEFM    'J'
2612+ 9E9B D0           			DEFB    'P'+80H
2613+ 9E9C C2           			DEFB    0C2H
2614+ 9E9D              ;
2615+ 9E9D 43 41 4C     			DEFM    'CAL'
2616+ 9EA0 CC           			DEFB    'L'+80H
2617+ 9EA1 C4           			DEFB    0C4H
2618+ 9EA2              ;
2619+ 9EA2 52 53        			DEFM    'RS'
2620+ 9EA4 D4           			DEFB    'T'+80H
2621+ 9EA5 C7           			DEFB    0C7H
2622+ 9EA6              ;
2623+ 9EA6 52 45        			DEFM    'RE'
2624+ 9EA8 D4           			DEFB    'T'+80H
2625+ 9EA9 C0           			DEFB    0C0H
2626+ 9EAA              ;
2627+ 9EAA 4C           			DEFM    'L'
2628+ 9EAB C4           			DEFB    'D'+80H
2629+ 9EAC 40           			DEFB    40H
2630+ 9EAD              ;
2631+ 9EAD 5D           			DEFB    DEF AND 7FH
2632+ 9EAE CD           			DEFB    'M'+80H
2633+ 9EAF 00           			DEFB    0
2634+ 9EB0              ;
2635+ 9EB0 5D           			DEFB    DEF AND 7FH
2636+ 9EB1 C2           			DEFB    'B'+80H
2637+ 9EB2 00           			DEFB    0
2638+ 9EB3              ;
2639+ 9EB3 4F 50        			DEFM    'OP'
2640+ 9EB5 D4           			DEFB    'T'+80H
2641+ 9EB6 00           			DEFB    0
2642+ 9EB7              ;
2643+ 9EB7 5D           			DEFB    DEF AND 7FH
2644+ 9EB8 D7           			DEFB    'W'+80H
2645+ 9EB9 00           			DEFB    0
2646+ 9EBA              ;
2647+ 9EBA 00           			DEFB    0
2648+ 9EBB              ;
2649+ 9EBB C2           OPRNDS:			DEFB    'B'+80H
2650+ 9EBC 00           			DEFB    0
2651+ 9EBD C3           			DEFB    'C'+80H
2652+ 9EBE 01           			DEFB    1
2653+ 9EBF C4           			DEFB    'D'+80H
2654+ 9EC0 02           			DEFB    2
2655+ 9EC1 C5           			DEFB    'E'+80H
2656+ 9EC2 03           			DEFB    3
2657+ 9EC3 C8           			DEFB    'H'+80H
2658+ 9EC4 04           			DEFB    4
2659+ 9EC5 CC           			DEFB    'L'+80H
2660+ 9EC6 05           			DEFB    5
2661+ 9EC7 28 48        			DEFM    '(H'
2662+ 9EC9 CC           			DEFB    'L'+80H
2663+ 9ECA 06           			DEFB    6
2664+ 9ECB C1           			DEFB    'A'+80H
2665+ 9ECC 07           			DEFB    7
2666+ 9ECD 28 49        			DEFM    '(I'
2667+ 9ECF D8           			DEFB    'X'+80H
2668+ 9ED0 86           			DEFB    86H
2669+ 9ED1 28 49        			DEFM    '(I'
2670+ 9ED3 D9           			DEFB    'Y'+80H
2671+ 9ED4 C6           			DEFB    0C6H
2672+ 9ED5              ;
2673+ 9ED5 42           			DEFM    'B'
2674+ 9ED6 C3           			DEFB    'C'+80H
2675+ 9ED7 08           			DEFB    8
2676+ 9ED8 44           			DEFM    'D'
2677+ 9ED9 C5           			DEFB    'E'+80H
2678+ 9EDA 0A           			DEFB    10
2679+ 9EDB 48           			DEFM    'H'
2680+ 9EDC CC           			DEFB    'L'+80H
2681+ 9EDD 0C           			DEFB    12
2682+ 9EDE 49           			DEFM    'I'
2683+ 9EDF D8           			DEFB    'X'+80H
2684+ 9EE0 8C           			DEFB    8CH
2685+ 9EE1 49           			DEFM    'I'
2686+ 9EE2 D9           			DEFB    'Y'+80H
2687+ 9EE3 CC           			DEFB    0CCH
2688+ 9EE4 41           			DEFM    'A'
2689+ 9EE5 C6           			DEFB    'F'+80H
2690+ 9EE6 0E           			DEFB    14
2691+ 9EE7 53           			DEFM    'S'
2692+ 9EE8 D0           			DEFB    'P'+80H
2693+ 9EE9 0E           			DEFB    14
2694+ 9EEA              ;
2695+ 9EEA 4E           			DEFM    'N'
2696+ 9EEB DA           			DEFB    'Z'+80H
2697+ 9EEC 10           			DEFB    16
2698+ 9EED DA           			DEFB    'Z'+80H
2699+ 9EEE 11           			DEFB    17
2700+ 9EEF 4E           			DEFM    'N'
2701+ 9EF0 C3           			DEFB    'C'+80H
2702+ 9EF1 12           			DEFB    18
2703+ 9EF2 50           			DEFM    'P'
2704+ 9EF3 CF           			DEFB    'O'+80H
2705+ 9EF4 14           			DEFB    20
2706+ 9EF5 50           			DEFM    'P'
2707+ 9EF6 C5           			DEFB    'E'+80H
2708+ 9EF7 15           			DEFB    21
2709+ 9EF8 D0           			DEFB    'P'+80H
2710+ 9EF9 16           			DEFB    22
2711+ 9EFA CD           			DEFB    'M'+80H
2712+ 9EFB 17           			DEFB    23
2713+ 9EFC              ;
2714+ 9EFC 28           			DEFM    '('
2715+ 9EFD C3           			DEFB    'C'+80H
2716+ 9EFE 20           			DEFB    20H
2717+ 9EFF              ;
2718+ 9EFF 00           			DEFB    0
2719+ 9F00              ;
2720+ 9F00 49           LDOPS:			DEFM    'I'
2721+ 9F01 00           			DEFB    0
2722+ 9F02 C1           			DEFB    'A'+80H
2723+ 9F03 47           			DEFB    47H
2724+ 9F04 52           			DEFM    'R'
2725+ 9F05 00           			DEFB    0
2726+ 9F06 C1           			DEFB    'A'+80H
2727+ 9F07 4F           			DEFB    4FH
2728+ 9F08 41           			DEFM    'A'
2729+ 9F09 00           			DEFB    0
2730+ 9F0A C9           			DEFB    'I'+80H
2731+ 9F0B 57           			DEFB    57H
2732+ 9F0C 41           			DEFM    'A'
2733+ 9F0D 00           			DEFB    0
2734+ 9F0E D2           			DEFB    'R'+80H
2735+ 9F0F 5F           			DEFB    5FH
2736+ 9F10 28 42 43     			DEFM    '(BC'
2737+ 9F13 00           			DEFB    0
2738+ 9F14 C1           			DEFB    'A'+80H
2739+ 9F15 02           			DEFB    2
2740+ 9F16 28 44 45     			DEFM    '(DE'
2741+ 9F19 00           			DEFB    0
2742+ 9F1A C1           			DEFB    'A'+80H
2743+ 9F1B 12           			DEFB    12H
2744+ 9F1C 41           			DEFM    'A'
2745+ 9F1D 00           			DEFB    0
2746+ 9F1E 28 42        			DEFM    '(B'
2747+ 9F20 C3           			DEFB    'C'+80H
2748+ 9F21 0A           			DEFB    0AH
2749+ 9F22 41           			DEFM    'A'
2750+ 9F23 00           			DEFB    0
2751+ 9F24 28 44        			DEFM    '(D'
2752+ 9F26 C5           			DEFB    'E'+80H
2753+ 9F27 1A           			DEFB    1AH
2754+ 9F28              ;
2755+ 9F28 00           			DEFB    0
2756+ 9F29              ;
2757+ 9F29              ; .LIST
2758+ 9F29              ;
2759+ 9F29              LF:			EQU     0AH
2760+ 9F29              CR:			EQU     0DH
2761+ 9F29              ;
2762+ 9F29              FIN:    		ENDMODULE
# file closed: h:\My Code\Breadboard Z80\Z80\BBC Basic\exec.z80
  12  9F29              			include "eval.z80"
# file opened: h:\My Code\Breadboard Z80\Z80\BBC Basic\eval.z80
   1+ 9F29              ;
   2+ 9F29              ;BBC BASIC INTERPRETER - Z80 VERSION
   3+ 9F29              ;EXPRESSION EVALUATION & ARITHMETIC MODULE - "EVAL"
   4+ 9F29              ;(C) COPYRIGHT  R.T.RUSSELL  1984
   5+ 9F29              ;VERSION 2.3, 07-05-1984
   6+ 9F29              ;Modified to use external FPP, 01-03-1987
   7+ 9F29              ;VERSION 3.0, 08-03-1987
   8+ 9F29              ;INSTR bug fixed, 30-09-1992
   9+ 9F29              ;
  10+ 9F29              ;BINARY FLOATING POINT REPRESENTATION:
  11+ 9F29              ;   32 BIT SIGN-MAGNITUDE NORMALIZED MANTISSA
  12+ 9F29              ;    8 BIT EXCESS-128 SIGNED EXPONENT
  13+ 9F29              ;   SIGN BIT REPLACES MANTISSA MSB (IMPLIED "1")
  14+ 9F29              ;   MANTISSA=0 & EXPONENT=0 IMPLIES VALUE IS ZERO.
  15+ 9F29              ;
  16+ 9F29              ;BINARY INTEGER REPRESENTATION:
  17+ 9F29              ;   32 BIT 2'S-COMPLEMENT SIGNED INTEGER
  18+ 9F29              ;    "EXPONENT" BYTE = 0 (WHEN PRESENT)
  19+ 9F29              ;
  20+ 9F29              ;NORMAL REGISTER ALLOCATION: MANTISSA - HLH'L'
  21+ 9F29              ;                            EXPONENT - C
  22+ 9F29              ;
  23+ 9F29              			MODULE EVAL
  24+ 9F29              ;
  25+ 9F29              ;TABLE OF ADDRESSES FOR FUNCTIONS:
  26+ 9F29              ;
  27+ 9F29              FUNTOK:			EQU     8DH             ;1st FUNCTION TOKEN
  28+ 9F29              ;
  29+ 9F29 49 A5        FUNTBL:			DEFW    DECODE          ;Line number
  30+ 9F2B A2 A2        			DEFW    OPENIN          ;OPENIN
  31+ 9F2D BF A2        			DEFW    PTR             ;PTR
  32+ 9F2F 74 A2        			DEFW    PAGEV           ;PAGE
  33+ 9F31 C7 A2        			DEFW    TIMEV           ;TIME
  34+ 9F33 6A A2        			DEFW    LOMEMV          ;LOMEM
  35+ 9F35 6F A2        			DEFW    HIMEMV          ;HIMEM
  36+ 9F37 13 A3        			DEFW    ABS             ;ABS
  37+ 9F39 4F A3        			DEFW    ACS             ;ACS
  38+ 9F3B B9 B2        			DEFW    ADVAL           ;ADVAL
  39+ 9F3D 57 A2        			DEFW    ASC             ;ASC
  40+ 9F3F 47 A3        			DEFW    ASN             ;ASN
  41+ 9F41 4B A3        			DEFW    ATN             ;ATN
  42+ 9F43 33 A2        			DEFW    BGET            ;BGET
  43+ 9F45 33 A3        			DEFW    COS             ;COS
  44+ 9F47 92 A2        			DEFW    COUNTV          ;COUNT
  45+ 9F49 1B A3        			DEFW    DEG             ;DEG
  46+ 9F4B 88 A2        			DEFW    ERLV            ;ERL
  47+ 9F4D 8D A2        			DEFW    ERRV            ;ERR
  48+ 9F4F 73 A3        			DEFW    EVAL            ;EVAL
  49+ 9F51 3B A3        			DEFW    EXP             ;EXP
  50+ 9F53 B7 A2        			DEFW    EXT             ;EXT
  51+ 9F55 E1 A5        			DEFW    ZERO            ;FALSE
  52+ 9F57 3F 93        			DEFW    FN              ;FN
  53+ 9F59 41 A2        			DEFW    GET             ;GET
  54+ 9F5B 3C A2        			DEFW    INKEY           ;INKEY
  55+ 9F5D 0C A4        			DEFW    INSTR           ;INSTR(
  56+ 9F5F 27 A3        			DEFW    INT             ;INT
  57+ 9F61 64 A2        			DEFW    LEN             ;LEN
  58+ 9F63 3F A3        			DEFW    LN              ;LN
  59+ 9F65 43 A3        			DEFW    LOG             ;LOG
  60+ 9F67 17 A3        			DEFW    NOTK            ;NOT
  61+ 9F69 9F A2        			DEFW    OPENUP          ;OPENUP
  62+ 9F6B 9D A2        			DEFW    OPENOT          ;OPENOUT
  63+ 9F6D 0F A3        			DEFW    PI              ;PI
  64+ 9F6F B9 B2        			DEFW    POINT           ;POINT(
  65+ 9F71 1C A2        			DEFW    POS             ;POS
  66+ 9F73 1F A3        			DEFW    RAD             ;RAD
  67+ 9F75 A0 A3        			DEFW    RND             ;RND
  68+ 9F77 23 A3        			DEFW    SGN             ;SGN
  69+ 9F79 37 A3        			DEFW    SIN             ;SIN
  70+ 9F7B 2B A3        			DEFW    SQR             ;SQR
  71+ 9F7D 2F A3        			DEFW    TAN             ;TAN
  72+ 9F7F 79 A2        			DEFW    TOPV            ;TO(P)
  73+ 9F81 04 A3        			DEFW    TRUE            ;TRUE
  74+ 9F83 23 97        			DEFW    USR             ;USR
  75+ 9F85 66 A3        			DEFW    VAL             ;VAL
  76+ 9F87 22 A2        			DEFW    VPOS            ;VPOS
  77+ 9F89 8A A4        			DEFW    CHRS            ;CHRS
  78+ 9F8B 91 A4        			DEFW    GETS            ;GETS
  79+ 9F8D 97 A4        			DEFW    INKEYS          ;INKEYS
  80+ 9F8F D8 A4        			DEFW    LEFTS           ;LEFTS(
  81+ 9F91 A7 A4        			DEFW    MIDS            ;MIDS(
  82+ 9F93 F3 A4        			DEFW    RIGHTS          ;RIGHTS(
  83+ 9F95 A1 A5        			DEFW    STRS            ;STR$
  84+ 9F97 07 A5        			DEFW    STRING          ;STRINGS(
  85+ 9F99 27 A2        			DEFW    EOF             ;EOF
  86+ 9F9B              ;
  87+ 9F9B              TCMD:			EQU     FUNTOK+($-FUNTBL)/2
  88+ 9F9B              ;
  89+ 9F9B              ANDK:			EQU     80H
  90+ 9F9B              DIVK:			EQU     81H
  91+ 9F9B              EORK:			EQU     82H
  92+ 9F9B              MODK:			EQU     83H
  93+ 9F9B              ORK:			EQU     84H
  94+ 9F9B              ;
  95+ 9F9B F2 A2        SOPTBL:			DEFW    SLE             ;<= (STRING)
  96+ 9F9D FA A2        			DEFW    SNE             ;<>
  97+ 9F9F EC A2        			DEFW    SGE             ;>=
  98+ 9FA1 DF A2        			DEFW    SLT             ;<
  99+ 9FA3 00 A3        			DEFW    SEQ             ;=
 100+ 9FA5 E5 A2        			DEFW    SGT             ;>
 101+ 9FA7              ;
 102+ 9FA7              ;EXPR - VARIABLE-TYPE EXPRESSION EVALUATION
 103+ 9FA7              ;     Expression type is returned in A'F':
 104+ 9FA7              ;        Numeric - A' bit 7=0, F' sign bit cleared.
 105+ 9FA7              ;         String - A' bit 7=1, F' sign bit set.
 106+ 9FA7              ;Floating-point or integer result returned in HLH'L'C
 107+ 9FA7              ; Integer result denoted by C=0 and HLH'L' non-zero.
 108+ 9FA7              ;String result returned in string accumulator, DE set.
 109+ 9FA7              ;
 110+ 9FA7              ;Hierarchy is: (1) Variables, functions,
 111+ 9FA7              ;                  constants, bracketed expressions.
 112+ 9FA7              ;              (2) ^
 113+ 9FA7              ;              (3) * / MOD DIV
 114+ 9FA7              ;              (4) + -
 115+ 9FA7              ;              (5) = <> <= >= > <
 116+ 9FA7              ;              (6) AND
 117+ 9FA7              ;              (7) EOR OR
 118+ 9FA7              ;
 119+ 9FA7 CD BC 9F     @EXPR:			CALL    EXPR1           ;GET FIRST OPERAND
 120+ 9FAA FE 82        EXPR0A:			CP      EORK            ;CHECK OPERATOR
 121+ 9FAC 28 03        			JR      Z,EXPR0B
 122+ 9FAE FE 84        			CP      ORK
 123+ 9FB0 C0           			RET     NZ
 124+ 9FB1 CD 6C A6     EXPR0B:			CALL    SAVE            ;SAVE FIRST OPERAND
 125+ 9FB4 CD BC 9F     			CALL    EXPR1           ;GET SECOND OPERAND
 126+ 9FB7 CD 7A A6     			CALL    DOIT            ;DO OPERATION
 127+ 9FBA 18 EE        			JR      EXPR0A          ;CONTINUE
 128+ 9FBC              ;
 129+ 9FBC CD CD 9F     EXPR1:			CALL    EXPR2
 130+ 9FBF FE 80        EXPR1A:			CP      ANDK
 131+ 9FC1 C0           			RET     NZ
 132+ 9FC2 CD 6C A6     			CALL    SAVE
 133+ 9FC5 CD CD 9F     			CALL    EXPR2
 134+ 9FC8 CD 7A A6     			CALL    DOIT
 135+ 9FCB 18 F2        			JR      EXPR1A
 136+ 9FCD              ;
 137+ 9FCD CD 2C A0     EXPR2:			CALL    EXPR3
 138+ 9FD0 CD 47 A6     			CALL    RELOP?
 139+ 9FD3 C0           			RET     NZ
 140+ 9FD4 47           			LD      B,A
 141+ 9FD5 FD 23        			INC     IY              ;BUMP OVER OPERATOR
 142+ 9FD7 CD 9B A6     			CALL    NXT
 143+ 9FDA CD 47 A6     			CALL    RELOP?          ;COMPOUND OPERATOR?
 144+ 9FDD 20 08        			JR      NZ,EXPR2B
 145+ 9FDF FD 23        			INC     IY
 146+ 9FE1 B8           			CP      B
 147+ 9FE2 CA E2 8F     			JP      Z,SYNTAX        ;ILLEGAL COMBINATION
 148+ 9FE5 80           			ADD     A,B
 149+ 9FE6 47           			LD      B,A
 150+ 9FE7 78           EXPR2B:			LD      A,B
 151+ 9FE8 08           			EX      AF,AF'
 152+ 9FE9 FA FF 9F     			JP      M,EXPR2S
 153+ 9FEC 08           			EX      AF,AF'
 154+ 9FED D6 04        			SUB     4
 155+ 9FEF FE 3A        			CP      '>'-4
 156+ 9FF1 20 02        			JR      NZ,EXPR2C
 157+ 9FF3 C6 02        			ADD     A,2
 158+ 9FF5 CD 6E A6     EXPR2C:			CALL    SAVE1
 159+ 9FF8 CD 2C A0     			CALL    EXPR3
 160+ 9FFB CD 7A A6     			CALL    DOIT            ;Must NOT be "JP DOIT"
 161+ 9FFE C9           			RET
 162+ 9FFF              ;
 163+ 9FFF 08           EXPR2S:			EX      AF,AF'
 164+ A000 3D           			DEC     A
 165+ A001 E6 07        			AND     7
 166+ A003 CD 02 A6     			CALL    PUSHS           ;SAVE STRING ON STACK
 167+ A006 F5           			PUSH    AF              ;SAVE OPERATOR
 168+ A007 CD 2C A0     			CALL    EXPR3           ;SECOND STRING
 169+ A00A 08           			EX      AF,AF'
 170+ A00B F2 DC A0     			JP      P,TYPE
 171+ A00E F1           			POP     AF
 172+ A00F 4B           			LD      C,E             ;LENGTH OF STRING #2
 173+ A010 D1           			POP     DE
 174+ A011 21 00 00     			LD      HL,0
 175+ A014 39           			ADD     HL,SP
 176+ A015 43           			LD      B,E             ;LENGTH OF STRING #1
 177+ A016 D5           			PUSH    DE
 178+ A017 11 00 B4     			LD      DE,ACCS
 179+ A01A EB           			EX      DE,HL
 180+ A01B CD A6 A6     			CALL    DISPT2
 181+ A01E D1           			POP     DE
 182+ A01F EB           			EX      DE,HL
 183+ A020 26 00        			LD      H,0
 184+ A022 39           			ADD     HL,SP
 185+ A023 F9           			LD      SP,HL
 186+ A024 EB           			EX      DE,HL
 187+ A025 AF           			XOR     A               ;NUMERIC MARKER
 188+ A026 4F           			LD      C,A             ;INTEGER MARKER
 189+ A027 08           			EX      AF,AF'
 190+ A028 FD 7E 00     			LD      A,(IY)
 191+ A02B C9           			RET
 192+ A02C              ;
 193+ A02C CD 7B A0     EXPR3:			CALL    EXPR4
 194+ A02F FE 2D        EXPR3A:			CP      '-'
 195+ A031 28 08        			JR      Z,EXPR3B
 196+ A033 FE 2B        			CP      '+'
 197+ A035 C0           			RET     NZ
 198+ A036 08           			EX      AF,AF'
 199+ A037 FA 46 A0     			JP      M,EXPR3S
 200+ A03A 08           			EX      AF,AF'
 201+ A03B CD 6C A6     EXPR3B:			CALL    SAVE
 202+ A03E CD 7B A0     			CALL    EXPR4
 203+ A041 CD 7A A6     			CALL    DOIT
 204+ A044 18 E9        			JR      EXPR3A
 205+ A046              ;
 206+ A046 08           EXPR3S:			EX      AF,AF'
 207+ A047 FD 23        			INC     IY              ;BUMP PAST '+'
 208+ A049 CD 02 A6     			CALL    PUSHS           ;SAVE STRING ON STACK
 209+ A04C CD 7B A0     			CALL    EXPR4           ;SECOND STRING
 210+ A04F 08           			EX      AF,AF'
 211+ A050 F2 DC A0     			JP      P,TYPE
 212+ A053 4B           			LD      C,E             ;C=LENGTH
 213+ A054 D1           			POP     DE
 214+ A055 D5           			PUSH    DE
 215+ A056 21 00 B4     			LD      HL,ACCS
 216+ A059 54           			LD      D,H
 217+ A05A 79           			LD      A,C
 218+ A05B B7           			OR      A
 219+ A05C 28 0F        			JR      Z,EXP3S3
 220+ A05E 45           			LD      B,L
 221+ A05F 6F           			LD      L,A             ;SOURCE
 222+ A060 83           			ADD     A,E
 223+ A061 5F           			LD      E,A             ;DESTINATION
 224+ A062 3E 13        			LD      A,19
 225+ A064 DA FE 88     			JP      C,ERROR         ;"String too long"
 226+ A067 D5           			PUSH    DE
 227+ A068 1D           			DEC     E
 228+ A069 2D           			DEC     L
 229+ A06A ED B8        			LDDR                    ;COPY
 230+ A06C D1           			POP     DE
 231+ A06D D9           EXP3S3:			EXX
 232+ A06E C1           			POP     BC
 233+ A06F CD 21 A6     			CALL    POPS            ;RESTORE FROM STACK
 234+ A072 D9           			EXX
 235+ A073 F6 80        			OR      80H             ;FLAG STRING
 236+ A075 08           			EX      AF,AF'
 237+ A076 FD 7E 00     			LD      A,(IY)
 238+ A079 18 B4        			JR      EXPR3A
 239+ A07B              ;
 240+ A07B CD 98 A0     EXPR4:			CALL    EXPR5
 241+ A07E FE 2A        EXPR4A:			CP      '*'
 242+ A080 28 0B        			JR      Z,EXPR4B
 243+ A082 FE 2F        			CP      '/'
 244+ A084 28 07        			JR      Z,EXPR4B
 245+ A086 FE 83        			CP      MODK
 246+ A088 28 03        			JR      Z,EXPR4B
 247+ A08A FE 81        			CP      DIVK
 248+ A08C C0           			RET     NZ
 249+ A08D CD 6C A6     EXPR4B:			CALL    SAVE
 250+ A090 CD 98 A0     			CALL    EXPR5
 251+ A093 CD 7A A6     			CALL    DOIT
 252+ A096 18 E6        			JR      EXPR4A
 253+ A098              ;
 254+ A098 CD 33 A1     EXPR5:			CALL    ITEM
 255+ A09B B7           			OR      A               ;TEST TYPE
 256+ A09C 08           			EX      AF,AF'          ;SAVE TYPE
 257+ A09D CD 9B A6     EXPR5A:			CALL    NXT
 258+ A0A0 FE 5E        			CP      '^'
 259+ A0A2 C0           			RET     NZ
 260+ A0A3 CD 6C A6     			CALL    SAVE
 261+ A0A6 CD 33 A1     			CALL    ITEM
 262+ A0A9 B7           			OR      A
 263+ A0AA 08           			EX      AF,AF'
 264+ A0AB CD 7A A6     			CALL    DOIT
 265+ A0AE 18 ED        			JR      EXPR5A
 266+ A0B0              ;
 267+ A0B0 CD A7 9F     @EXPRN:			CALL    EXPR
 268+ A0B3 08           			EX      AF,AF'
 269+ A0B4 F0           			RET     P
 270+ A0B5 18 25        			JR      TYPE
 271+ A0B7              ;
 272+ A0B7 CD A7 9F     @EXPRI:			CALL    EXPR
 273+ A0BA 08           			EX      AF,AF'
 274+ A0BB F2 5E A3     			JP      P,SFIX
 275+ A0BE 18 1C        			JR      TYPE
 276+ A0C0              ;
 277+ A0C0 CD A7 9F     @EXPRS:			CALL    EXPR
 278+ A0C3 08           			EX      AF,AF'
 279+ A0C4 F8           			RET     M
 280+ A0C5 18 15        			JR      TYPE
 281+ A0C7              ;
 282+ A0C7              ;
 283+ A0C7 CD 33 A1     ITEMN:			CALL    ITEM
 284+ A0CA B7           			OR      A
 285+ A0CB F0           			RET     P
 286+ A0CC 18 0E        			JR      TYPE
 287+ A0CE              ;
 288+ A0CE CD 33 A1     @ITEMI:			CALL    ITEM
 289+ A0D1 B7           			OR      A
 290+ A0D2 F2 5E A3     			JP      P,SFIX
 291+ A0D5 18 05        			JR      TYPE
 292+ A0D7              ;
 293+ A0D7 CD 33 A1     ITEMS:			CALL    ITEM
 294+ A0DA B7           			OR      A
 295+ A0DB F8           			RET     M
 296+ A0DC 3E 06        TYPE:			LD      A,6
 297+ A0DE C3 FE 88     			JP      ERROR           ;"Type mismatch"
 298+ A0E1              ;
 299+ A0E1 CD A7 9F     ITEM1:			CALL    EXPR            ;BRACKETED EXPR
 300+ A0E4 CD 5F A6     			CALL    BRAKET
 301+ A0E7 08           			EX      AF,AF'
 302+ A0E8 C9           			RET
 303+ A0E9              ;
 304+ A0E9              ;HEX - Get hexadecimal constant.
 305+ A0E9              ;   Inputs: ASCII string at (IY)
 306+ A0E9              ;  Outputs: Integer result in H'L'HL, C=0, A7=0.
 307+ A0E9              ;           IY updated (points to delimiter)
 308+ A0E9              ;
 309+ A0E9 CD E1 A5     HEX:			CALL    ZERO
 310+ A0EC CD 34 A6     			CALL    HEXDIG
 311+ A0EF 38 18        			JR      C,BADHEX
 312+ A0F1 FD 23        HEX1:			INC     IY
 313+ A0F3 E6 0F        			AND     0FH
 314+ A0F5 06 04        			LD      B,4
 315+ A0F7 D9           HEX2:			EXX
 316+ A0F8 29           			ADD     HL,HL
 317+ A0F9 D9           			EXX
 318+ A0FA ED 6A        			ADC     HL,HL
 319+ A0FC 10 F9        			DJNZ    HEX2
 320+ A0FE D9           			EXX
 321+ A0FF B5           			OR      L
 322+ A100 6F           			LD      L,A
 323+ A101 D9           			EXX
 324+ A102 CD 34 A6     			CALL    HEXDIG
 325+ A105 30 EA        			JR      NC,HEX1
 326+ A107 AF           			XOR     A
 327+ A108 C9           			RET
 328+ A109              ;
 329+ A109 3E 1C        BADHEX:			LD      A,28
 330+ A10B C3 FE 88     			JP      ERROR           ;"Bad HEX"
 331+ A10E              ;
 332+ A10E              ;MINUS - Unary minus.
 333+ A10E              ;   Inputs: IY = text pointer
 334+ A10E              ;  Outputs: Numeric result, same type as argument.
 335+ A10E              ;           Result in H'L'HLC
 336+ A10E              ;
 337+ A10E CD C7 A0     MINUS:			CALL    ITEMN
 338+ A111 0D           MINUS0:			DEC     C
 339+ A112 0C           			INC     C
 340+ A113 28 06        			JR      Z,NEGATE        ;ZERO/INTEGER
 341+ A115 7C           			LD      A,H
 342+ A116 EE 80        			XOR     80H             ;CHANGE SIGN (FP)
 343+ A118 67           			LD      H,A
 344+ A119 AF           			XOR     A               ;NUMERIC MARKER
 345+ A11A C9           			RET
 346+ A11B              ;
 347+ A11B D9           NEGATE:			EXX
 348+ A11C 7C           			LD      A,H
 349+ A11D 2F           			CPL
 350+ A11E 67           			LD      H,A
 351+ A11F 7D           			LD      A,L
 352+ A120 2F           			CPL
 353+ A121 6F           			LD      L,A
 354+ A122 D9           			EXX
 355+ A123 7C           			LD      A,H
 356+ A124 2F           			CPL
 357+ A125 67           			LD      H,A
 358+ A126 7D           			LD      A,L
 359+ A127 2F           			CPL
 360+ A128 6F           			LD      L,A
 361+ A129 D9           ADD1:			EXX
 362+ A12A 23           			INC     HL
 363+ A12B 7C           			LD      A,H
 364+ A12C B5           			OR      L
 365+ A12D D9           			EXX
 366+ A12E 3E 00        			LD      A,0             ;NUMERIC MARKER
 367+ A130 C0           			RET     NZ
 368+ A131 23           			INC     HL
 369+ A132 C9           			RET
 370+ A133              ;
 371+ A133              ;ITEM - VARIABLE TYPE NUMERIC OR STRING ITEM.
 372+ A133              ;Item type is returned in A:  Bit 7=0 numeric.
 373+ A133              ;                             Bit 7=1 string.
 374+ A133              ;Numeric item returned in HLH'L'C.
 375+ A133              ;String item returned in string accumulator,
 376+ A133              ;  DE addresses byte after last (E=length).
 377+ A133              ;
 378+ A133 CD E2 97     ITEM:			CALL    CHECK
 379+ A136 CD 9B A6     			CALL    NXT
 380+ A139 FD 23        			INC     IY
 381+ A13B FE 26        			CP      '&'
 382+ A13D 28 AA        			JR      Z,HEX           ;HEX CONSTANT
 383+ A13F FE 2D        			CP      '-'
 384+ A141 28 CB        			JR      Z,MINUS         ;UNARY MINUS
 385+ A143 FE 2B        			CP      '+'
 386+ A145 28 80        			JR      Z,ITEMN         ;UNARY PLUS
 387+ A147 FE 28        			CP      '('
 388+ A149 28 96        			JR      Z,ITEM1         ;EXPRESSION
 389+ A14B FE 22        			CP      34		;ASCII ""
 390+ A14D 28 63        			JR      Z,CONS          ;STRING CONSTANT
 391+ A14F FE C6        			CP      TCMD
 392+ A151 D2 E2 8F     			JP      NC,SYNTAX       ;SYNTAX ERROR
 393+ A154 FE 8D        			CP      FUNTOK
 394+ A156 D2 AC A6     			JP      NC,DISPAT       ;FUNCTION
 395+ A159 FD 2B        			DEC     IY
 396+ A15B FE 3A        			CP      ':'
 397+ A15D 30 08        			JR      NC,ITEM2        ;VARIABLE?
 398+ A15F FE 30        			CP      '0'
 399+ A161 30 74        			JR      NC,CON          ;NUMERIC CONSTANT
 400+ A163 FE 2E        			CP      '.'
 401+ A165 28 70        			JR      Z,CON           ;NUMERIC CONSTANT
 402+ A167 CD 62 8B     ITEM2:			CALL    GETVAR          ;VARIABLE
 403+ A16A 20 2B        			JR      NZ,NOSUCH
 404+ A16C B7           			OR      A
 405+ A16D FA FA A1     			JP      M,LOADS         ;STRING VARIABLE
 406+ A170 B7           @LOADN:			OR      A
 407+ A171 28 18        			JR      Z,LOAD1         ;BYTE VARIABLE
 408+ A173 0E 00        			LD      C,0
 409+ A175 CB 47        			BIT     0,A
 410+ A177 28 03        			JR      Z,LOAD4         ;INTEGER VARIABLE
 411+ A179 DD 4E 04     LOAD5:			LD      C,(IX+4)
 412+ A17C D9           @LOAD4:			EXX
 413+ A17D DD 6E 00     			LD      L,(IX+0)
 414+ A180 DD 66 01     			LD      H,(IX+1)
 415+ A183 D9           			EXX
 416+ A184 DD 6E 02     			LD      L,(IX+2)
 417+ A187 DD 66 03     			LD      H,(IX+3)
 418+ A18A C9           			RET
 419+ A18B              ;
 420+ A18B 21 00 00     LOAD1:			LD      HL,0
 421+ A18E D9           			EXX
 422+ A18F 26 00        			LD      H,0
 423+ A191 DD 6E 00     			LD      L,(IX+0)
 424+ A194 D9           			EXX
 425+ A195 4C           			LD      C,H
 426+ A196 C9           			RET
 427+ A197              ;
 428+ A197 DA E2 8F     NOSUCH:			JP      C,SYNTAX
 429+ A19A 3A FE B6     			LD      A,(LISTON)
 430+ A19D CB 6F        			BIT     5,A
 431+ A19F 3E 1A        			LD      A,26
 432+ A1A1 20 23        			JR      NZ,ERROR0       ;"No such variable"
 433+ A1A3 FD 23        NOS1:			INC     IY
 434+ A1A5 CD 49 8D     			CALL    RANGE
 435+ A1A8 30 F9        			JR      NC,NOS1
 436+ A1AA DD 21 40 B6  			LD      IX,PC
 437+ A1AE AF           			XOR     A
 438+ A1AF 4F           			LD      C,A
 439+ A1B0 18 CA        			JR      LOAD4
 440+ A1B2              ;
 441+ A1B2              ;CONS - Get string constant from ASCII string.
 442+ A1B2              ;   Inputs: ASCII string at (IY)
 443+ A1B2              ;  Outputs: Result in string accumulator.
 444+ A1B2              ;           D = MS byte of ACCS, E = string length
 445+ A1B2              ;           A7 = 1 (string marker)
 446+ A1B2              ;           IY updated
 447+ A1B2              ;
 448+ A1B2 11 00 B4     @CONS:			LD      DE,ACCS
 449+ A1B5 FD 7E 00     CONS3:			LD      A,(IY)
 450+ A1B8 FD 23        			INC     IY
 451+ A1BA FE 22        			CP      34		;ASCII ""
 452+ A1BC 28 0B        			JR      Z,CONS2
 453+ A1BE 12           CONS1:			LD      (DE),A
 454+ A1BF 1C           			INC     E
 455+ A1C0 FE 0D        			CP      CR
 456+ A1C2 20 F1        			JR      NZ,CONS3
 457+ A1C4 3E 09        			LD      A,9
 458+ A1C6 C3 FE 88     ERROR0:			JP      ERROR           ;"Missing """
 459+ A1C9              ;
 460+ A1C9 FD 7E 00     CONS2:			LD      A,(IY)
 461+ A1CC FE 34        			CP      0x34		;ASCII "
 462+ A1CE FD 23        			INC     IY
 463+ A1D0 28 EC        			JR      Z,CONS1
 464+ A1D2 FD 2B        			DEC     IY
 465+ A1D4 3E 80        			LD      A,80H           ;STRING MARKER
 466+ A1D6 C9           			RET
 467+ A1D7              ;
 468+ A1D7              ;CON - Get unsigned numeric constant from ASCII string.
 469+ A1D7              ;   Inputs: ASCII string at (IY).
 470+ A1D7              ;  Outputs: Variable-type result in HLH'L'C
 471+ A1D7              ;           IY updated (points to delimiter)
 472+ A1D7              ;           A7 = 0 (numeric marker)
 473+ A1D7              ;
 474+ A1D7 FD E5        CON:			PUSH    IY
 475+ A1D9 DD E1        			POP     IX
 476+ A1DB 3E 24        			LD      A,36
 477+ A1DD CD BF A6     			CALL    FPP
 478+ A1E0 38 E4        			JR      C,ERROR0
 479+ A1E2 DD E5        			PUSH    IX
 480+ A1E4 FD E1        			POP     IY
 481+ A1E6 AF           			XOR     A
 482+ A1E7 C9           			RET
 483+ A1E8              ;
 484+ A1E8 DD 46 04     @DLOAD5:		LD      B,(IX+4)
 485+ A1EB D9           			EXX
 486+ A1EC DD 5E 00     			LD      E,(IX+0)
 487+ A1EF DD 56 01     			LD      D,(IX+1)
 488+ A1F2 D9           			EXX
 489+ A1F3 DD 5E 02     			LD      E,(IX+2)
 490+ A1F6 DD 56 03     			LD      D,(IX+3)
 491+ A1F9 C9           			RET
 492+ A1FA              ;
 493+ A1FA 11 00 B4     @LOADS:			LD      DE,ACCS
 494+ A1FD 1F           			RRA
 495+ A1FE 30 10        			JR      NC,LOADS2       ;FIXED STRING
 496+ A200 CD 7C A1     			CALL    LOAD4
 497+ A203 D9           			EXX
 498+ A204 7D           			LD      A,L
 499+ A205 D9           			EXX
 500+ A206 B7           			OR      A
 501+ A207 4F           			LD      C,A
 502+ A208 3E 80        			LD      A,80H           ;STRING MARKER
 503+ A20A C8           			RET     Z
 504+ A20B 06 00        			LD      B,0
 505+ A20D ED B0        			LDIR
 506+ A20F C9           			RET
 507+ A210 7E           LOADS2:			LD      A,(HL)
 508+ A211 12           			LD      (DE),A
 509+ A212 23           			INC     HL
 510+ A213 FE 0D        			CP      CR
 511+ A215 3E 80        			LD      A,80H           ;STRING MARKER
 512+ A217 C8           			RET     Z
 513+ A218 1C           			INC     E
 514+ A219 20 F5        			JR      NZ,LOADS2
 515+ A21B C9           			RET                     ;RETURN NULL STRING
 516+ A21C              ;
 517+ A21C              ;VARIABLE-TYPE FUNCTIONS:
 518+ A21C              ;
 519+ A21C              ;Result returned in HLH'L'C (floating point)
 520+ A21C              ;Result returned in HLH'L' (C=0) (integer)
 521+ A21C              ;Result returned in string accumulator & DE (string)
 522+ A21C              ;All registers destroyed.
 523+ A21C              ;IY (text pointer) updated.
 524+ A21C              ;Bit 7 of A indicates type: 0 = numeric, 1 = string.
 525+ A21C              ;
 526+ A21C              ;
 527+ A21C              ;POS - horizontal cursor position.
 528+ A21C              ;VPOS - vertical cursor position.
 529+ A21C              ;EOF - return status of file.
 530+ A21C              ;BGET - read byte from file.
 531+ A21C              ;INKEY - as GET but wait only n centiseconds.
 532+ A21C              ;GET - wait for keypress and return ASCII value.
 533+ A21C              ;GET(n) - input from Z80 port n.
 534+ A21C              ;ASC - ASCII value of string.
 535+ A21C              ;LEN - length of string.
 536+ A21C              ;LOMEM - location of dynamic variables.
 537+ A21C              ;HIMEM - top of available RAM.
 538+ A21C              ;PAGE - start of current text page.
 539+ A21C              ;TOP - address of first free byte after program.
 540+ A21C              ;ERL - line number where last error occurred.
 541+ A21C              ;ERR - number of last error.
 542+ A21C              ;COUNT - number of printing characters since CR.
 543+ A21C              ;Results are integer numeric.
 544+ A21C              ;
 545+ A21C CD CD B2     POS:			CALL    GETCSR
 546+ A21F EB           			EX      DE,HL
 547+ A220 18 75        			JR      COUNT1
 548+ A222 CD CD B2     VPOS:			CALL    GETCSR
 549+ A225 18 70        			JR      COUNT1
 550+ A227 CD DA 99     EOF:			CALL    CHANEL
 551+ A22A CD 04 B3     			CALL    OSSTAT
 552+ A22D CA 04 A3     			JP      Z,TRUE
 553+ A230 C3 E1 A5     			JP      ZERO
 554+ A233 CD DA 99     BGET:			CALL    CHANEL          ;CHANNEL NUMBER
 555+ A236 CD 04 B3     			CALL    OSBGET
 556+ A239 6F           			LD      L,A
 557+ A23A 18 59        			JR      COUNT0
 558+ A23C CD 97 A4     INKEY:			CALL    INKEYS
 559+ A23F 18 19        			JR      ASC0
 560+ A241 CD 9B A6     GET:			CALL    NXT
 561+ A244 FE 28        			CP      '('
 562+ A246 20 0A        			JR      NZ,GET0
 563+ A248 CD CE A0     			CALL    ITEMI           ;PORT ADDRESS
 564+ A24B D9           			EXX
 565+ A24C 44           			LD      B,H
 566+ A24D 4D           			LD      C,L
 567+ A24E ED 68        			IN      L,(C)           ;INPUT FROM PORT BC
 568+ A250 18 43        			JR      COUNT0
 569+ A252 CD 91 A4     GET0:			CALL    GETS
 570+ A255 18 08        			JR      ASC1
 571+ A257 CD D7 A0     ASC:			CALL    ITEMS
 572+ A25A AF           ASC0:			XOR     A
 573+ A25B BB           			CP      E
 574+ A25C CA 04 A3     			JP      Z,TRUE          ;NULL STRING
 575+ A25F 2A 00 B4     ASC1:			LD      HL,(ACCS)
 576+ A262 18 31        			JR      COUNT0
 577+ A264 CD D7 A0     LEN:			CALL    ITEMS
 578+ A267 EB           			EX      DE,HL
 579+ A268 18 2B        			JR      COUNT0
 580+ A26A 2A E0 B6     LOMEMV:			LD      HL,(LOMEM)
 581+ A26D 18 28        			JR      COUNT1
 582+ A26F 2A E4 B6     HIMEMV:			LD      HL,(HIMEM)
 583+ A272 18 23        			JR      COUNT1
 584+ A274 2A DC B6     PAGEV:			LD      HL,(PAGE)
 585+ A277 18 1E        			JR      COUNT1
 586+ A279 FD 7E 00     TOPV:			LD      A,(IY)
 587+ A27C FD 23        			INC     IY              ;SKIP "P"
 588+ A27E FE 50        			CP      'P'
 589+ A280 C2 E2 8F     			JP      NZ,SYNTAX       ;"Syntax Error"
 590+ A283 2A DE B6     			LD      HL,(TOP)
 591+ A286 18 0F        			JR      COUNT1
 592+ A288 2A F2 B6     ERLV:			LD      HL,(ERL)
 593+ A28B 18 0A        			JR      COUNT1
 594+ A28D 2A FD B6     ERRV:			LD      HL,(ERR)
 595+ A290 18 03        			JR      COUNT0
 596+ A292 2A FB B6     COUNTV:			LD      HL,(COUNT)
 597+ A295 26 00        COUNT0:			LD      H,0
 598+ A297 D9           COUNT1:			EXX
 599+ A298 AF           			XOR     A
 600+ A299 4F           			LD      C,A             ;INTEGER MARKER
 601+ A29A 67           			LD      H,A
 602+ A29B 6F           			LD      L,A
 603+ A29C C9           			RET
 604+ A29D              ;
 605+ A29D              ;OPENIN - Open a file for reading.
 606+ A29D              ;OPENOUT - Open a file for writing.
 607+ A29D              ;OPENUP - Open a file for reading or writing.
 608+ A29D              ;Result is integer channel number (0 if error)
 609+ A29D              ;
 610+ A29D AF           OPENOT:			XOR     A
 611+ A29E 21           			DEFB    21H             ;SKIP NEXT 2 BYTES
 612+ A29F 3E 02        OPENUP:			LD      A,2
 613+ A2A1 21           			DEFB    21H             ;SKIP NEXT 2 BYTES
 614+ A2A2 3E 01        OPENIN:			LD      A,1
 615+ A2A4 F5           			PUSH    AF              ;SAVE OPEN TYPE
 616+ A2A5 CD D7 A0     			CALL    ITEMS           ;FILENAME
 617+ A2A8 3E 0D        			LD      A,CR
 618+ A2AA 12           			LD      (DE),A
 619+ A2AB F1           			POP     AF              ;RESTORE OPEN TYPE
 620+ A2AC C6 FF        			ADD     A,-1            ;AFFECT FLAGS
 621+ A2AE 21 00 B4     			LD      HL,ACCS
 622+ A2B1 CD 04 B3     			CALL    OSOPEN
 623+ A2B4 6F           			LD      L,A
 624+ A2B5 18 DE        			JR      COUNT0
 625+ A2B7              ;
 626+ A2B7              ;EXT - Return length of file.
 627+ A2B7              ;PTR - Return current file pointer.
 628+ A2B7              ;Results are integer numeric.
 629+ A2B7              ;
 630+ A2B7 CD DA 99     EXT:			CALL    CHANEL
 631+ A2BA CD 04 B3     			CALL    GETEXT
 632+ A2BD 18 12        			JR      TIME0
 633+ A2BF              ;
 634+ A2BF CD DA 99     PTR:			CALL    CHANEL
 635+ A2C2 CD 04 B3     			CALL    GETPTR
 636+ A2C5 18 0A        			JR      TIME0
 637+ A2C7              ;
 638+ A2C7              ;TIME - Return current value of elapsed time.
 639+ A2C7              ;Result is integer numeric.
 640+ A2C7              ;
 641+ A2C7 FD 7E 00     TIMEV:			LD      A,(IY)
 642+ A2CA FE 24        			CP      '$'
 643+ A2CC 28 09        			JR      Z,TIMEVS
 644+ A2CE CD C5 B2     			CALL    GETIME
 645+ A2D1 D5           TIME0:			PUSH    DE
 646+ A2D2 D9           			EXX
 647+ A2D3 E1           			POP     HL
 648+ A2D4 AF           			XOR     A
 649+ A2D5 4F           			LD      C,A
 650+ A2D6 C9           			RET
 651+ A2D7              ;
 652+ A2D7              ;TIME$ - Return date/time string.
 653+ A2D7              ;Result is string
 654+ A2D7              ;
 655+ A2D7 FD 23        TIMEVS:			INC     IY              ;SKIP $
 656+ A2D9 CD B9 B2     			CALL    GETIMS
 657+ A2DC 3E 80        			LD      A,80H           ;MARK STRING
 658+ A2DE C9           			RET
 659+ A2DF              ;
 660+ A2DF              ;String comparison:
 661+ A2DF              ;
 662+ A2DF CD DE A5     SLT:			CALL    SCP
 663+ A2E2 D0           			RET     NC
 664+ A2E3 18 1F        			JR      TRUE
 665+ A2E5              ;
 666+ A2E5 CD DE A5     SGT:			CALL    SCP
 667+ A2E8 C8           			RET     Z
 668+ A2E9 D8           			RET     C
 669+ A2EA 18 18        			JR      TRUE
 670+ A2EC              ;
 671+ A2EC CD DE A5     SGE:			CALL    SCP
 672+ A2EF D8           			RET     C
 673+ A2F0 18 12        			JR      TRUE
 674+ A2F2              ;
 675+ A2F2 CD DE A5     SLE:			CALL    SCP
 676+ A2F5 28 0D        			JR      Z,TRUE
 677+ A2F7 D0           			RET     NC
 678+ A2F8 18 0A        			JR      TRUE
 679+ A2FA              ;
 680+ A2FA CD DE A5     SNE:			CALL    SCP
 681+ A2FD C8           			RET     Z
 682+ A2FE 18 04        			JR      TRUE
 683+ A300              ;
 684+ A300 CD DE A5     SEQ:			CALL    SCP
 685+ A303 C0           			RET     NZ
 686+ A304 3E FF        TRUE:			LD      A,-1
 687+ A306 D9           			EXX
 688+ A307 67           			LD      H,A
 689+ A308 6F           			LD      L,A
 690+ A309 D9           			EXX
 691+ A30A 67           			LD      H,A
 692+ A30B 6F           			LD      L,A
 693+ A30C 3C           			INC     A
 694+ A30D 4F           			LD      C,A
 695+ A30E C9           			RET
 696+ A30F              ;
 697+ A30F              ;PI - Return PI (3.141592654)
 698+ A30F              ;Result is floating-point numeric.
 699+ A30F              ;
 700+ A30F 3E 23        PI:			LD      A,35
 701+ A311 18 43        			JR      FPP1
 702+ A313              ;
 703+ A313              ;ABS - Absolute value
 704+ A313              ;Result is numeric, variable type.
 705+ A313              ;
 706+ A313 3E 10        ABS:			LD      A,16
 707+ A315 18 3A        			JR      FPPN
 708+ A317              ;
 709+ A317              ;NOT - Complement integer.
 710+ A317              ;Result is integer numeric.
 711+ A317              ;
 712+ A317 3E 1A        NOTK:			LD      A,26
 713+ A319 18 36        			JR      FPPN
 714+ A31B              ;
 715+ A31B              ;DEG - Convert radians to degrees
 716+ A31B              ;Result is floating-point numeric.
 717+ A31B              ;
 718+ A31B 3E 15        DEG:			LD      A,21
 719+ A31D 18 32        			JR      FPPN
 720+ A31F              ;
 721+ A31F              ;RAD - Convert degrees to radians
 722+ A31F              ;Result is floating-point numeric.
 723+ A31F              ;
 724+ A31F 3E 1B        RAD:			LD      A,27
 725+ A321 18 2E        			JR      FPPN
 726+ A323              ;
 727+ A323              ;SGN - Return -1, 0 or +1
 728+ A323              ;Result is integer numeric.
 729+ A323              ;
 730+ A323 3E 1C        SGN:			LD      A,28
 731+ A325 18 2A        			JR      FPPN
 732+ A327              ;
 733+ A327              ;INT - Floor function
 734+ A327              ;Result is integer numeric.
 735+ A327              ;
 736+ A327 3E 17        INT:			LD      A,23
 737+ A329 18 26        			JR      FPPN
 738+ A32B              ;
 739+ A32B              ;SQR - square root
 740+ A32B              ;Result is floating-point numeric.
 741+ A32B              ;
 742+ A32B 3E 1E        SQR:			LD      A,30
 743+ A32D 18 22        			JR      FPPN
 744+ A32F              ;
 745+ A32F              ;TAN - Tangent function
 746+ A32F              ;Result is floating-point numeric.
 747+ A32F              ;
 748+ A32F 3E 1F        TAN:			LD      A,31
 749+ A331 18 1E        			JR      FPPN
 750+ A333              ;
 751+ A333              ;COS - Cosine function
 752+ A333              ;Result is floating-point numeric.
 753+ A333              ;
 754+ A333 3E 14        COS:			LD      A,20
 755+ A335 18 1A        			JR      FPPN
 756+ A337              ;
 757+ A337              ;SIN - Sine function
 758+ A337              ;Result is floating-point numeric.
 759+ A337              ;
 760+ A337 3E 1D        SIN:			LD      A,29
 761+ A339 18 16        			JR      FPPN
 762+ A33B              ;
 763+ A33B              ;EXP - Exponential function
 764+ A33B              ;Result is floating-point numeric.
 765+ A33B              ;
 766+ A33B 3E 16        EXP:			LD      A,22
 767+ A33D 18 12        			JR      FPPN
 768+ A33F              ;
 769+ A33F              ;LN - Natural log.
 770+ A33F              ;Result is floating-point numeric.
 771+ A33F              ;
 772+ A33F 3E 18        LN:			LD      A,24
 773+ A341 18 0E        			JR      FPPN
 774+ A343              ;
 775+ A343              ;LOG - base-10 logarithm.
 776+ A343              ;Result is floating-point numeric.
 777+ A343              ;
 778+ A343 3E 19        LOG:			LD      A,25
 779+ A345 18 0A        			JR      FPPN
 780+ A347              ;
 781+ A347              ;ASN - Arc-sine
 782+ A347              ;Result is floating-point numeric.
 783+ A347              ;
 784+ A347 3E 12        ASN:			LD      A,18
 785+ A349 18 06        			JR      FPPN
 786+ A34B              ;
 787+ A34B              ;ATN - arc-tangent
 788+ A34B              ;Result is floating-point numeric.
 789+ A34B              ;
 790+ A34B 3E 13        ATN:			LD      A,19
 791+ A34D 18 02        			JR      FPPN
 792+ A34F              ;
 793+ A34F              ;ACS - arc-cosine
 794+ A34F              ;Result is floating point numeric.
 795+ A34F              ;
 796+ A34F 3E 11        ACS:			LD      A,17
 797+ A351 F5           FPPN:			PUSH    AF
 798+ A352 CD C7 A0     			CALL    ITEMN
 799+ A355 F1           			POP     AF
 800+ A356 CD BF A6     FPP1:			CALL    FPP
 801+ A359 DA FE 88     			JP      C,ERROR
 802+ A35C AF           			XOR     A
 803+ A35D C9           			RET
 804+ A35E              ;
 805+ A35E              ;SFIX - Convert to fixed-point notation
 806+ A35E              ;
 807+ A35E 3E 26        @SFIX:			LD      A,38
 808+ A360 18 F4        			JR      FPP1
 809+ A362              ;
 810+ A362              ;SFLOAT - Convert to floating-point notation
 811+ A362              ;
 812+ A362 3E 27        SFLOAT:			LD      A,39
 813+ A364 18 F0        			JR      FPP1
 814+ A366              ;
 815+ A366              ;VAL - Return numeric value of string.
 816+ A366              ;Result is variable type numeric.
 817+ A366              ;
 818+ A366 CD D7 A0     VAL:			CALL    ITEMS
 819+ A369 AF           @VAL0:			XOR     A
 820+ A36A 12           			LD      (DE),A
 821+ A36B DD 21 00 B4  			LD      IX,ACCS
 822+ A36F 3E 24        			LD      A,36
 823+ A371 18 E3        			JR      FPP1
 824+ A373              ;
 825+ A373              ;EVAL - Pass string to expression evaluator.
 826+ A373              ;Result is variable type (numeric or string).
 827+ A373              ;
 828+ A373 CD D7 A0     EVAL:			CALL    ITEMS
 829+ A376 3E 0D        			LD      A,CR
 830+ A378 12           			LD      (DE),A
 831+ A379 FD E5        			PUSH    IY
 832+ A37B 11 00 B4     			LD      DE,ACCS
 833+ A37E FD 21 00 B4  			LD      IY,ACCS
 834+ A382 0E 00        			LD      C,0
 835+ A384 CD 78 8D     			CALL    LEXAN2          ;TOKENISE
 836+ A387 12           			LD      (DE),A
 837+ A388 13           			INC     DE
 838+ A389 AF           			XOR     A
 839+ A38A CD 02 A6     			CALL    PUSHS           ;PUT ON STACK
 840+ A38D FD 21 02 00  			LD      IY,2
 841+ A391 FD 39        			ADD     IY,SP
 842+ A393 CD A7 9F     			CALL    EXPR
 843+ A396 FD E1        			POP     IY
 844+ A398 FD 39        			ADD     IY,SP
 845+ A39A FD F9        			LD      SP,IY           ;ADJUST STACK POINTER
 846+ A39C FD E1        			POP     IY
 847+ A39E 08           			EX      AF,AF'
 848+ A39F C9           			RET
 849+ A3A0              ;
 850+ A3A0              ;RND - Random number function.
 851+ A3A0              ; RND gives random integer 0-&FFFFFFFF
 852+ A3A0              ; RND(-n) seeds random number & returns -n.
 853+ A3A0              ; RND(0) returns last value in RND(1) form.
 854+ A3A0              ; RND(1) returns floating-point 0-0.99999999.
 855+ A3A0              ; RND(n) returns random integer 1-n.
 856+ A3A0              ;
 857+ A3A0 DD 21 F6 B6  RND:			LD      IX,RANDOM
 858+ A3A4 CD 9B A6     			CALL    NXT
 859+ A3A7 FE 28        			CP      '('
 860+ A3A9 28 1C        			JR      Z,RND5          ;ARGUMENT FOLLOWS
 861+ A3AB CD 79 A1     			CALL    LOAD5
 862+ A3AE CB 19        RND1:			RR      C
 863+ A3B0 06 20        			LD      B,32
 864+ A3B2 D9           RND2:			EXX                     ;CALCULATE NEXT
 865+ A3B3 ED 6A        			ADC     HL,HL
 866+ A3B5 D9           			EXX
 867+ A3B6 ED 6A        			ADC     HL,HL
 868+ A3B8 CB 5D        			BIT     3,L
 869+ A3BA 28 01        			JR      Z,RND3
 870+ A3BC 3F           			CCF
 871+ A3BD 10 F3        RND3:			DJNZ    RND2
 872+ A3BF CB 11        RND4:			RL      C               ;SAVE CARRY
 873+ A3C1 CD 86 97     			CALL    STORE5          ;STORE NEW NUMBER
 874+ A3C4 AF           			XOR     A
 875+ A3C5 4F           			LD      C,A
 876+ A3C6 C9           			RET
 877+ A3C7 CD CE A0     RND5:			CALL    ITEMI
 878+ A3CA DD 21 F6 B6  			LD      IX,RANDOM
 879+ A3CE CB 7C        			BIT     7,H             ;NEGATIVE?
 880+ A3D0 37           			SCF
 881+ A3D1 20 EC        			JR      NZ,RND4         ;SEED
 882+ A3D3 CD 42 A5     			CALL    TEST
 883+ A3D6 F5           			PUSH    AF
 884+ A3D7 CD 3A A5     			CALL    SWAP
 885+ A3DA D9           			EXX
 886+ A3DB CD 79 A1     			CALL    LOAD5
 887+ A3DE C4 AE A3     			CALL    NZ,RND1         ;NEXT IF NON-ZERO
 888+ A3E1 D9           			EXX                     ;SCRAMBLE (CARE!)
 889+ A3E2 0E 7F        			LD      C,7FH
 890+ A3E4 CB 7C        RND6:			BIT     7,H             ;FLOAT
 891+ A3E6 20 08        			JR      NZ,RND7
 892+ A3E8 D9           			EXX
 893+ A3E9 29           			ADD     HL,HL
 894+ A3EA D9           			EXX
 895+ A3EB ED 6A        			ADC     HL,HL
 896+ A3ED 0D           			DEC     C
 897+ A3EE 20 F4        			JR      NZ,RND6
 898+ A3F0 CB BC        RND7:			RES     7,H             ;POSITIVE 0-0.999999
 899+ A3F2 F1           			POP     AF
 900+ A3F3 C8           			RET     Z               ;ZERO ARGUMENT
 901+ A3F4 D9           			EXX
 902+ A3F5 7B           			LD      A,E
 903+ A3F6 3D           			DEC     A
 904+ A3F7 B2           			OR      D
 905+ A3F8 D9           			EXX
 906+ A3F9 B3           			OR      E
 907+ A3FA B2           			OR      D
 908+ A3FB C8           			RET     Z               ;ARGUMENT=1
 909+ A3FC 06 00        			LD      B,0             ;INTEGER MARKER
 910+ A3FE 3E 0A        			LD      A,10
 911+ A400 CD BF A6     			CALL    FPP             ;MULTIPLY
 912+ A403 DA FE 88     			JP      C,ERROR
 913+ A406 CD 5E A3     			CALL    SFIX
 914+ A409 C3 29 A1     			JP      ADD1
 915+ A40C              ;
 916+ A40C              ;INSTR - String search.
 917+ A40C              ;Result is integer numeric.
 918+ A40C              ;
 919+ A40C CD 50 A6     INSTR:			CALL    EXPRSC          ;STRING TO SEARCH
 920+ A40F CD 02 A6     			CALL    PUSHS           ;SAVE STRING ON STACK
 921+ A412 CD C0 A0     			CALL    EXPRS           ;SUB-STRING
 922+ A415 C1           			POP     BC
 923+ A416 21 00 00     			LD      HL,0
 924+ A419 39           			ADD     HL,SP           ;HL ADDRESSES MAIN
 925+ A41A C5           			PUSH    BC              ;C = MAIN STRING LENGTH
 926+ A41B 43           			LD      B,E             ;B = SUB-STRING LENGTH
 927+ A41C CD 9B A6     			CALL    NXT
 928+ A41F FE 2C        			CP      ','
 929+ A421 3E 00        			LD      A,0
 930+ A423 20 17        			JR      NZ,INSTR1
 931+ A425 FD 23        			INC     IY              ;SKIP COMMA
 932+ A427 C5           			PUSH    BC              ;SAVE LENGTHS
 933+ A428 E5           			PUSH    HL              ;SAVE MAIN ADDRESS
 934+ A429 CD 02 A6     			CALL    PUSHS
 935+ A42C CD B7 A0     			CALL    EXPRI
 936+ A42F C1           			POP     BC
 937+ A430 CD 21 A6     			CALL    POPS
 938+ A433 E1           			POP     HL              ;RESTORE MAIN ADDRESS
 939+ A434 C1           			POP     BC              ;RESTORE LENGTHS
 940+ A435 D9           			EXX
 941+ A436 7D           			LD      A,L
 942+ A437 D9           			EXX
 943+ A438 B7           			OR      A
 944+ A439 28 01        			JR      Z,INSTR1
 945+ A43B 3D           			DEC     A
 946+ A43C 11 00 B4     INSTR1:			LD      DE,ACCS         ;DE ADDRESSES SUB
 947+ A43F CD 56 A4     			CALL    SEARCH
 948+ A442 D1           			POP     DE
 949+ A443 28 03        			JR      Z,INSTR2        ;N.B. CARRY CLEARED
 950+ A445 ED 62        			SBC     HL,HL
 951+ A447 39           			ADD     HL,SP
 952+ A448 ED 72        INSTR2:			SBC     HL,SP
 953+ A44A EB           			EX      DE,HL
 954+ A44B 26 00        			LD      H,0
 955+ A44D 39           			ADD     HL,SP
 956+ A44E F9           			LD      SP,HL
 957+ A44F EB           			EX      DE,HL
 958+ A450 CD 5F A6     			CALL    BRAKET
 959+ A453 C3 97 A2     			JP      COUNT1
 960+ A456              ;
 961+ A456              ;SEARCH - Search string for sub-string
 962+ A456              ;   Inputs: Main string at HL length C
 963+ A456              ;           Sub-string  at DE length B
 964+ A456              ;           Starting offset A
 965+ A456              ;  Outputs: NZ - not found
 966+ A456              ;           Z - found at location HL-1
 967+ A456              ;           Carry always cleared
 968+ A456              ;
 969+ A456 C5           @SEARCH:		PUSH    BC
 970+ A457 06 00        			LD      B,0
 971+ A459 4F           			LD      C,A
 972+ A45A 09           			ADD     HL,BC           ;NEW START ADDRESS
 973+ A45B C1           			POP     BC
 974+ A45C 91           			SUB     C
 975+ A45D 30 28        			JR      NC,SRCH4
 976+ A45F ED 44        			NEG
 977+ A461 4F           			LD      C,A             ;REMAINING LENGTH
 978+ A462 1A           SRCH1:			LD      A,(DE)
 979+ A463 C5           			PUSH    BC
 980+ A464 06 00        			LD      B,0
 981+ A466 ED B1        			CPIR                    ;FIND FIRST CHARACTER
 982+ A468 79           			LD      A,C
 983+ A469 C1           			POP     BC
 984+ A46A 20 1B        			JR      NZ,SRCH4
 985+ A46C 4F           			LD      C,A
 986+ A46D 05           			DEC     B               ;Bug fix
 987+ A46E B8           			CP      B               ;Bug fix
 988+ A46F 04           			INC     B               ;Bug fix
 989+ A470 38 15        			JR      C,SRCH4         ;Bug fix
 990+ A472 C5           			PUSH    BC
 991+ A473 D5           			PUSH    DE
 992+ A474 E5           			PUSH    HL
 993+ A475 05           			DEC     B
 994+ A476 28 08        			JR      Z,SRCH3         ;FOUND !
 995+ A478 13           SRCH2:			INC     DE
 996+ A479 1A           			LD      A,(DE)
 997+ A47A BE           			CP      (HL)
 998+ A47B 20 03        			JR      NZ,SRCH3
 999+ A47D 23           			INC     HL
1000+ A47E 10 F8        			DJNZ    SRCH2
1001+ A480 E1           SRCH3:			POP     HL
1002+ A481 D1           			POP     DE
1003+ A482 C1           			POP     BC
1004+ A483 20 DD        			JR      NZ,SRCH1
1005+ A485 AF           			XOR     A               ;Z, NC
1006+ A486 C9           			RET                     ;FOUND
1007+ A487              ;
1008+ A487 F6 FF        SRCH4:			OR      0FFH            ;NZ, NC
1009+ A489 C9           			RET                     ;NOT FOUND
1010+ A48A              ;
1011+ A48A              ;CHRS - Return character with given ASCII value.
1012+ A48A              ;Result is string.
1013+ A48A              ;
1014+ A48A CD CE A0     CHRS:			CALL    ITEMI
1015+ A48D D9           			EXX
1016+ A48E 7D           			LD      A,L
1017+ A48F 18 03        			JR      GET1
1018+ A491              ;
1019+ A491              ;GETS - Return key pressed as string.
1020+ A491              ;Result is string.
1021+ A491              ;
1022+ A491 CD D4 B2     GETS:			CALL    OSRDCH
1023+ A494 37           GET1:			SCF
1024+ A495 18 07        			JR      INKEY1
1025+ A497              ;
1026+ A497              ;INKEYS - Wait up to n centiseconds for keypress.
1027+ A497              ;         Return key pressed as string or null
1028+ A497              ;         string if time elapsed.
1029+ A497              ;Result is string.
1030+ A497              ;
1031+ A497 CD CE A0     INKEYS:			CALL    ITEMI
1032+ A49A D9           			EXX
1033+ A49B CD DC B2     			CALL    OSKEY
1034+ A49E 11 00 B4     INKEY1:			LD      DE,ACCS
1035+ A4A1 12           			LD      (DE),A
1036+ A4A2 3E 80        			LD      A,80H
1037+ A4A4 D0           			RET     NC
1038+ A4A5 1C           			INC     E
1039+ A4A6 C9           			RET
1040+ A4A7              ;
1041+ A4A7              ;MID$ - Return sub-string.
1042+ A4A7              ;Result is string.
1043+ A4A7              ;
1044+ A4A7 CD 50 A6     MIDS:			CALL    EXPRSC
1045+ A4AA CD 02 A6     			CALL    PUSHS           ;SAVE STRING ON STACK
1046+ A4AD CD B7 A0     			CALL    EXPRI
1047+ A4B0 C1           			POP     BC
1048+ A4B1 CD 21 A6     			CALL    POPS
1049+ A4B4 D9           			EXX
1050+ A4B5 7D           			LD      A,L
1051+ A4B6 D9           			EXX
1052+ A4B7 B7           			OR      A
1053+ A4B8 28 0D        			JR      Z,MIDS1
1054+ A4BA 3D           			DEC     A
1055+ A4BB 6F           			LD      L,A
1056+ A4BC 93           			SUB     E
1057+ A4BD 1E 00        			LD      E,0
1058+ A4BF 30 06        			JR      NC,MIDS1
1059+ A4C1 ED 44        			NEG
1060+ A4C3 4F           			LD      C,A
1061+ A4C4 CD FE A4     			CALL    RIGHT1
1062+ A4C7 CD 9B A6     MIDS1:			CALL    NXT
1063+ A4CA FE 2C        			CP      ','
1064+ A4CC FD 23        			INC     IY
1065+ A4CE 28 0B        			JR      Z,LEFT1
1066+ A4D0 FD 2B        			DEC     IY
1067+ A4D2 CD 5F A6     			CALL    BRAKET
1068+ A4D5 3E 80        			LD      A,80H
1069+ A4D7 C9           			RET
1070+ A4D8              ;
1071+ A4D8              ;LEFT$ - Return left part of string.
1072+ A4D8              ;Carry cleared if entire string returned.
1073+ A4D8              ;Result is string.
1074+ A4D8              ;
1075+ A4D8 CD 50 A6     LEFTS:			CALL    EXPRSC
1076+ A4DB CD 02 A6     LEFT1:			CALL    PUSHS           ;SAVE STRING ON STACK
1077+ A4DE CD B7 A0     			CALL    EXPRI
1078+ A4E1 C1           			POP     BC
1079+ A4E2 CD 21 A6     			CALL    POPS
1080+ A4E5 CD 5F A6     			CALL    BRAKET
1081+ A4E8 D9           			EXX
1082+ A4E9 7D           			LD      A,L
1083+ A4EA D9           			EXX
1084+ A4EB BB           			CP      E
1085+ A4EC 30 02        			JR      NC,LEFT3
1086+ A4EE 6B           			LD      L,E             ;FOR RIGHTS
1087+ A4EF 5F           LEFT2:			LD      E,A
1088+ A4F0 3E 80        LEFT3:			LD      A,80H           ;STRING MARKER
1089+ A4F2 C9           			RET
1090+ A4F3              ;
1091+ A4F3              ;RIGHT$ - Return right part of string.
1092+ A4F3              ;Result is string.
1093+ A4F3              ;
1094+ A4F3 CD D8 A4     RIGHTS:			CALL    LEFTS
1095+ A4F6 D0           			RET     NC
1096+ A4F7 1C           			INC     E
1097+ A4F8 1D           			DEC     E
1098+ A4F9 C8           			RET     Z
1099+ A4FA 4B           			LD      C,E
1100+ A4FB 7D           			LD      A,L
1101+ A4FC 93           			SUB     E
1102+ A4FD 6F           			LD      L,A
1103+ A4FE 06 00        RIGHT1:			LD      B,0
1104+ A500 62           			LD      H,D
1105+ A501 58           			LD      E,B
1106+ A502 ED B0        			LDIR                    ;MOVE
1107+ A504 3E 80        			LD      A,80H
1108+ A506 C9           			RET
1109+ A507              ;
1110+ A507              ;STRINGS - Return n concatenations of a string.
1111+ A507              ;Result is string.
1112+ A507              ;
1113+ A507 CD B7 A0     STRING:			CALL    EXPRI
1114+ A50A CD 53 A6     			CALL    COMMA
1115+ A50D D9           			EXX
1116+ A50E 7D           			LD      A,L
1117+ A50F D9           			EXX
1118+ A510 F5           			PUSH    AF
1119+ A511 CD C0 A0     			CALL    EXPRS
1120+ A514 CD 5F A6     			CALL    BRAKET
1121+ A517 F1           			POP     AF
1122+ A518 B7           			OR      A
1123+ A519 28 D4        			JR      Z,LEFT2         ;N=0
1124+ A51B 3D           			DEC     A
1125+ A51C 4F           			LD      C,A
1126+ A51D 3E 80        			LD      A,80H           ;STRING MARKER
1127+ A51F C8           			RET     Z
1128+ A520 1C           			INC     E
1129+ A521 1D           			DEC     E
1130+ A522 C8           			RET     Z               ;NULL STRING
1131+ A523 43           			LD      B,E
1132+ A524 62           			LD      H,D
1133+ A525 2E 00        			LD      L,0
1134+ A527 C5           STRIN1:			PUSH    BC
1135+ A528 7E           STRIN2:			LD      A,(HL)
1136+ A529 23           			INC     HL
1137+ A52A 12           			LD      (DE),A
1138+ A52B 1C           			INC     E
1139+ A52C 3E 13        			LD      A,19
1140+ A52E CA FE 88     			JP      Z,ERROR         ;"String too long"
1141+ A531 10 F5        			DJNZ    STRIN2
1142+ A533 C1           			POP     BC
1143+ A534 0D           			DEC     C
1144+ A535 20 F0        			JR      NZ,STRIN1
1145+ A537 3E 80        			LD      A,80H
1146+ A539 C9           			RET
1147+ A53A              ;
1148+ A53A              ;SUBROUTINES
1149+ A53A              ;
1150+ A53A              ;SWAP - Swap arguments
1151+ A53A              ;Exchanges DE,HL D'E',H'L' and B,C
1152+ A53A              ;Destroys: A,B,C,D,E,H,L,D',E',H',L'
1153+ A53A              ;
1154+ A53A 79           @SWAP:			LD      A,C
1155+ A53B 48           			LD      C,B
1156+ A53C 47           			LD      B,A
1157+ A53D EB           			EX      DE,HL
1158+ A53E D9           			EXX
1159+ A53F EB           			EX      DE,HL
1160+ A540 D9           			EXX
1161+ A541 C9           			RET
1162+ A542              ;
1163+ A542              ;TEST - Test HLH'L' for zero
1164+ A542              ;Outputs: Z-flag set & A=0 if zero
1165+ A542              ;Destroys: A,F
1166+ A542              ;
1167+ A542 7C           @TEST:			LD      A,H
1168+ A543 B5           			OR      L
1169+ A544 D9           			EXX
1170+ A545 B4           			OR      H
1171+ A546 B5           			OR      L
1172+ A547 D9           			EXX
1173+ A548 C9           			RET
1174+ A549              ;
1175+ A549              ;DECODE - Decode line number in pseudo-binary.
1176+ A549              ;   Inputs: IY = Text pointer.
1177+ A549              ;   Outputs: HL=0, H'L'=line number, C=0.
1178+ A549              ;   Destroys: A,C,H,L,H',L',IY,F
1179+ A549              ;
1180+ A549 D9           @DECODE:		EXX
1181+ A54A FD 7E 00     			LD      A,(IY)
1182+ A54D FD 23        			INC     IY
1183+ A54F 17           			RLA
1184+ A550 17           			RLA
1185+ A551 67           			LD      H,A
1186+ A552 E6 C0        			AND     0C0H
1187+ A554 FD AE 00     			XOR     (IY)
1188+ A557 FD 23        			INC     IY
1189+ A559 6F           			LD      L,A
1190+ A55A 7C           			LD      A,H
1191+ A55B 17           			RLA
1192+ A55C 17           			RLA
1193+ A55D E6 C0        			AND     0C0H
1194+ A55F FD AE 00     			XOR     (IY)
1195+ A562 FD 23        			INC     IY
1196+ A564 67           			LD      H,A
1197+ A565 D9           			EXX
1198+ A566 AF           			XOR     A
1199+ A567 4F           			LD      C,A
1200+ A568 67           			LD      H,A
1201+ A569 6F           			LD      L,A
1202+ A56A C9           			RET
1203+ A56B              ;
1204+ A56B              ;HEXSTR - convert numeric value to HEX string.
1205+ A56B              ;   Inputs: HLH'L'C = integer or floating-point number
1206+ A56B              ;  Outputs: String in string accumulator.
1207+ A56B              ;           E = string length.  D = ACCS/256
1208+ A56B              ;
1209+ A56B FD 23        HEXSTS:			INC     IY              ;SKIP TILDE
1210+ A56D CD C7 A0     			CALL    ITEMN
1211+ A570 CD 76 A5     			CALL    HEXSTR
1212+ A573 3E 80        			LD      A,80H
1213+ A575 C9           			RET
1214+ A576              ;
1215+ A576 CD 5E A3     @HEXSTR:		CALL    SFIX
1216+ A579 01 08 00     			LD      BC,8
1217+ A57C 11 00 B4     			LD      DE,ACCS
1218+ A57F C5           HEXST1:			PUSH    BC
1219+ A580 06 04        			LD      B,4
1220+ A582 AF           			XOR     A
1221+ A583 D9           HEXST2:			EXX
1222+ A584 29           			ADD     HL,HL
1223+ A585 D9           			EXX
1224+ A586 ED 6A        			ADC     HL,HL
1225+ A588 17           			RLA
1226+ A589 10 F8        			DJNZ    HEXST2
1227+ A58B C1           			POP     BC
1228+ A58C 0D           			DEC     C
1229+ A58D F8           			RET     M
1230+ A58E 28 06        			JR      Z,HEXST3
1231+ A590 B7           			OR      A
1232+ A591 20 03        			JR      NZ,HEXST3
1233+ A593 B8           			CP      B
1234+ A594 28 E9        			JR      Z,HEXST1
1235+ A596 C6 90        HEXST3:			ADD     A,90H
1236+ A598 27           			DAA
1237+ A599 CE 40        			ADC     A,40H
1238+ A59B 27           			DAA
1239+ A59C 12           			LD      (DE),A
1240+ A59D 13           			INC     DE
1241+ A59E 47           			LD      B,A
1242+ A59F 18 DE        			JR      HEXST1
1243+ A5A1              ;
1244+ A5A1              ;Function STR - convert numeric value to ASCII string.
1245+ A5A1              ;   Inputs: HLH'L'C = integer or floating-point number.
1246+ A5A1              ;  Outputs: String in string accumulator.
1247+ A5A1              ;           E = length, D = ACCS/256
1248+ A5A1              ;           A = 80H (type=string)
1249+ A5A1              ;
1250+ A5A1              ;First normalise for decimal output:
1251+ A5A1              ;
1252+ A5A1 CD 9B A6     STRS:			CALL    NXT
1253+ A5A4 FE 7E        			CP      '~'
1254+ A5A6 28 C3        			JR      Z,HEXSTS
1255+ A5A8 CD C7 A0     			CALL    ITEMN
1256+ A5AB DD 21 00 B6  			LD      IX,STAVAR
1257+ A5AF DD 7E 03     			LD      A,(IX+3)
1258+ A5B2 B7           			OR      A
1259+ A5B3 DD 21 DB A5  			LD      IX,G9-1         ;G9 FORMAT
1260+ A5B7 28 04        			JR      Z,STR0
1261+ A5B9 DD 21 00 B6  @STR:			LD      IX,STAVAR
1262+ A5BD 11 00 B4     STR0:			LD      DE,ACCS
1263+ A5C0 3E 25        			LD      A,37
1264+ A5C2 CD BF A6     			CALL    FPP
1265+ A5C5 DA FE 88     			JP      C,ERROR
1266+ A5C8 DD CB 02 46  			BIT     0,(IX+2)
1267+ A5CC 3E 80        STR1:			LD      A,80H           ;STRING MARKER
1268+ A5CE C8           			RET     Z
1269+ A5CF 79           			LD      A,C
1270+ A5D0 C6 04        			ADD     A,4
1271+ A5D2 BB           STR2:			CP      E
1272+ A5D3 28 F7        			JR      Z,STR1
1273+ A5D5 EB           			EX      DE,HL
1274+ A5D6 36 20        			LD      (HL),' '        ;TRAILING SPACE
1275+ A5D8 23           			INC     HL
1276+ A5D9 EB           			EX      DE,HL
1277+ A5DA 18 F6        			JR      STR2
1278+ A5DC              ;
1279+ A5DC 09 00        G9:			DEFW    9
1280+ A5DE              ;
1281+ A5DE              ;STRING COMPARE
1282+ A5DE              ;Compare string (DE) length B with string (HL) length C.
1283+ A5DE              ;Result preset to false.
1284+ A5DE              ;
1285+ A5DE CD EB A5     SCP:			CALL    SCP0
1286+ A5E1 3E 00        @ZERO:			LD      A,0
1287+ A5E3 D9           			EXX
1288+ A5E4 67           			LD      H,A
1289+ A5E5 6F           			LD      L,A
1290+ A5E6 D9           			EXX
1291+ A5E7 67           			LD      H,A
1292+ A5E8 6F           			LD      L,A
1293+ A5E9 4F           			LD      C,A
1294+ A5EA C9           			RET
1295+ A5EB              ;
1296+ A5EB 04           SCP0:			INC     B
1297+ A5EC 0C           			INC     C
1298+ A5ED 05           SCP1:			DEC     B
1299+ A5EE 28 0A        			JR      Z,SCP2
1300+ A5F0 0D           			DEC     C
1301+ A5F1 28 0C        			JR      Z,SCP3
1302+ A5F3 1A           			LD      A,(DE)
1303+ A5F4 BE           			CP      (HL)
1304+ A5F5 C0           			RET     NZ
1305+ A5F6 13           			INC     DE
1306+ A5F7 23           			INC     HL
1307+ A5F8 18 F3        			JR      SCP1
1308+ A5FA B7           SCP2:			OR      A
1309+ A5FB 0D           				DEC     C
1310+ A5FC C8           			RET     Z
1311+ A5FD 37           			SCF
1312+ A5FE C9           			RET
1313+ A5FF B7           SCP3:			OR      A
1314+ A600 0C           			INC     C
1315+ A601 C9           			RET
1316+ A602              ;
1317+ A602              ;PUSHS - SAVE STRING ON STACK.
1318+ A602              ;    Inputs: String in string accumulator.
1319+ A602              ;            E = string length.
1320+ A602              ;            A - saved on stack.
1321+ A602              ;  Destroys: B,C,D,E,H,L,IX,SP,F
1322+ A602              ;
1323+ A602 CD E2 97     @PUSHS:			CALL    CHECK
1324+ A605 DD E1        			POP     IX              ;RETURN ADDRESS
1325+ A607 B7           			OR      A               ;CLEAR CARRY
1326+ A608 21 00 B4     			LD      HL,ACCS
1327+ A60B 54           			LD      D,H
1328+ A60C 45           			LD      B,L             ;B=0
1329+ A60D ED 52        			SBC     HL,DE
1330+ A60F 39           			ADD     HL,SP
1331+ A610 F9           			LD      SP,HL
1332+ A611 57           			LD      D,A
1333+ A612 D5           			PUSH    DE
1334+ A613 28 0A        			JR      Z,PUSHS1        ;ZERO LENGTH
1335+ A615 4B           			LD      C,E
1336+ A616 11 00 B4     			LD      DE,ACCS
1337+ A619 EB           			EX      DE,HL
1338+ A61A ED B0        			LDIR                    ;COPY TO STACK
1339+ A61C CD E2 97     			CALL    CHECK
1340+ A61F DD E9        PUSHS1:			JP      (IX)            ;"RETURN"
1341+ A621              ;
1342+ A621              ;POPS - RESTORE STRING FROM STACK.
1343+ A621              ;    Inputs: C = string length.
1344+ A621              ;   Outputs: String in string accumulator.
1345+ A621              ;            E = string length.
1346+ A621              ;  Destroys: B,C,D,E,H,L,IX,SP,F
1347+ A621              ;
1348+ A621 DD E1        @POPS:			POP     IX              ;RETURN ADDRESS
1349+ A623 21 00 00     			LD      HL,0
1350+ A626 44           			LD      B,H             ;B=0
1351+ A627 39           			ADD     HL,SP
1352+ A628 11 00 B4     			LD      DE,ACCS
1353+ A62B 0C           			INC     C
1354+ A62C 0D           			DEC     C
1355+ A62D 28 02        			JR      Z,POPS1         ;ZERO LENGTH
1356+ A62F ED B0        			LDIR                    ;COPY FROM STACK
1357+ A631 F9           POPS1:			LD      SP,HL
1358+ A632 DD E9        			JP      (IX)            ;"RETURN"
1359+ A634              ;
1360+ A634 FD 7E 00     HEXDIG:			LD      A,(IY)
1361+ A637 FE 30        			CP      '0'
1362+ A639 D8           			RET     C
1363+ A63A FE 3A        			CP      '9'+1
1364+ A63C 3F           			CCF
1365+ A63D D0           			RET     NC
1366+ A63E FE 41        			CP      'A'
1367+ A640 D8           			RET     C
1368+ A641 D6 37        			SUB     'A'-10
1369+ A643 FE 10        			CP      16
1370+ A645 3F           			CCF
1371+ A646 C9           			RET
1372+ A647              ;
1373+ A647 FE 3E        RELOP?:			CP      '>'
1374+ A649 D0           			RET     NC
1375+ A64A FE 3D        			CP      '='
1376+ A64C D0           			RET     NC
1377+ A64D FE 3C        			CP      '<'
1378+ A64F C9           			RET
1379+ A650              ;
1380+ A650 CD C0 A0     EXPRSC:			CALL    EXPRS
1381+ A653 CD 9B A6     @COMMA:			CALL    NXT
1382+ A656 FD 23        			INC     IY
1383+ A658 FE 2C        			CP      ','
1384+ A65A C8           			RET     Z
1385+ A65B 3E 05        			LD      A,5
1386+ A65D 18 0A        			JR      ERROR1          ;"Missing ,"
1387+ A65F              ;
1388+ A65F CD 9B A6     @BRAKET:		CALL    NXT
1389+ A662 FD 23        			INC     IY
1390+ A664 FE 29        			CP      ')'
1391+ A666 C8           			RET     Z
1392+ A667 3E 1B        			LD      A,27
1393+ A669 C3 FE 88     ERROR1:			JP      ERROR           ;"Missing )"
1394+ A66C              ;
1395+ A66C FD 23        SAVE:			INC     IY
1396+ A66E 08           SAVE1:			EX      AF,AF'
1397+ A66F FA DC A0     			JP      M,TYPE
1398+ A672 08           			EX      AF,AF'
1399+ A673 E3           			EX      (SP),HL
1400+ A674 D9           			EXX
1401+ A675 E5           			PUSH    HL
1402+ A676 D9           			EXX
1403+ A677 F5           			PUSH    AF
1404+ A678 C5           			PUSH    BC
1405+ A679 E9           			JP      (HL)
1406+ A67A              ;
1407+ A67A 08           DOIT:			EX      AF,AF'
1408+ A67B FA DC A0     			JP      M,TYPE
1409+ A67E D9           			EXX
1410+ A67F C1           			POP     BC              ;RETURN ADDRESS
1411+ A680 D9           			EXX
1412+ A681 79           			LD      A,C
1413+ A682 C1           			POP     BC
1414+ A683 47           			LD      B,A
1415+ A684 F1           			POP     AF              ;OPERATOR
1416+ A685 D9           			EXX
1417+ A686 EB           			EX      DE,HL
1418+ A687 E1           			POP     HL
1419+ A688 D9           			EXX
1420+ A689 EB           			EX      DE,HL
1421+ A68A E1           			POP     HL
1422+ A68B D9           			EXX
1423+ A68C C5           			PUSH    BC
1424+ A68D D9           			EXX
1425+ A68E E6 0F        			AND     0FH
1426+ A690 CD BF A6     			CALL    FPP
1427+ A693 38 D4        			JR      C,ERROR1
1428+ A695 AF           			XOR     A
1429+ A696 08           			EX      AF,AF'          ;TYPE
1430+ A697 FD 7E 00     			LD      A,(IY)
1431+ A69A C9           			RET
1432+ A69B              ;
1433+ A69B FD 7E 00     @NXT:			LD      A,(IY)
1434+ A69E FE 20        			CP      ' '
1435+ A6A0 C0           			RET     NZ
1436+ A6A1 FD 23        			INC     IY
1437+ A6A3 C3 9B A6     			JP      NXT
1438+ A6A6              ;
1439+ A6A6 E5           DISPT2:			PUSH    HL
1440+ A6A7 21 9B 9F     			LD      HL,SOPTBL
1441+ A6AA 18 06        			JR      DISPT0
1442+ A6AC              ;
1443+ A6AC E5           DISPAT:			PUSH    HL
1444+ A6AD D6 8D        			SUB     FUNTOK
1445+ A6AF 21 29 9F     			LD      HL,FUNTBL
1446+ A6B2 C5           DISPT0:			PUSH    BC
1447+ A6B3 87           			ADD     A,A
1448+ A6B4 4F           			LD      C,A
1449+ A6B5 06 00        			LD      B,0
1450+ A6B7 09           			ADD     HL,BC
1451+ A6B8 7E           			LD      A,(HL)
1452+ A6B9 23           			INC     HL
1453+ A6BA 66           			LD      H,(HL)
1454+ A6BB 6F           			LD      L,A
1455+ A6BC C1           			POP     BC
1456+ A6BD E3           			EX      (SP),HL
1457+ A6BE C9           			RET                     ;OFF TO ROUTINE
1458+ A6BF              ;
1459+ A6BF              CR			EQU     0DH
1460+ A6BF
1461+ A6BF              			ENDMODULE
# file closed: h:\My Code\Breadboard Z80\Z80\BBC Basic\eval.z80
  13  A6BF              			include "fpp.z80"
# file opened: h:\My Code\Breadboard Z80\Z80\BBC Basic\fpp.z80
   1+ A6BF              ;
   2+ A6BF              ;Z80 FLOATING POINT PACKAGE
   3+ A6BF              ;(C) COPYRIGHT  R.T.RUSSELL  1986
   4+ A6BF              ;VERSION 0.0, 26-10-1986
   5+ A6BF              ;VERSION 0.1, 14-12-1988 (BUG FIX)
   6+ A6BF              ;
   7+ A6BF              ;BINARY FLOATING POINT REPRESENTATION:
   8+ A6BF              ;   32 BIT SIGN-MAGNITUDE NORMALIZED MANTISSA
   9+ A6BF              ;    8 BIT EXCESS-128 SIGNED EXPONENT
  10+ A6BF              ;   SIGN BIT REPLACES MANTISSA MSB (IMPLIED "1")
  11+ A6BF              ;   MANTISSA=0 & EXPONENT=0 IMPLIES VALUE IS ZERO.
  12+ A6BF              ;
  13+ A6BF              ;BINARY INTEGER REPRESENTATION:
  14+ A6BF              ;   32 BIT 2'S-COMPLEMENT SIGNED INTEGER
  15+ A6BF              ;    "EXPONENT" BYTE = 0 (WHEN PRESENT)
  16+ A6BF              ;
  17+ A6BF              ;NORMAL REGISTER ALLOCATION: MANTISSA - HLH'L'
  18+ A6BF              ;                            EXPONENT - C
  19+ A6BF              ;ALTERNATE REGISTER ALLOCATION: MANTISSA - DED'E'
  20+ A6BF              ;                               EXPONENT - B
  21+ A6BF              ;
  22+ A6BF              ;Error codes:
  23+ A6BF              ;
  24+ A6BF              			MODULE FPP
  25+ A6BF
  26+ A6BF              BADOP:			EQU     1               ;Bad operation code
  27+ A6BF              DIVBY0:			EQU     18              ;Division by zero
  28+ A6BF              TOOBIG:			EQU     20              ;Too big
  29+ A6BF              NGROOT:			EQU     21              ;Negative root
  30+ A6BF              LOGRNG:			EQU     22              ;Log range
  31+ A6BF              ACLOST:			EQU     23              ;Accuracy lost
  32+ A6BF              EXPRNG:			EQU     24              ;Exp range
  33+ A6BF              ;
  34+ A6BF              ;Call entry and despatch code:
  35+ A6BF              ;
  36+ A6BF FD E5        @FPP:			PUSH    IY              ;Save IY
  37+ A6C1 FD 21 00 00          		LD      IY,0
  38+ A6C5 FD 39                		ADD     IY,SP           ;Save SP in IY
  39+ A6C7 CD D6 A6             		CALL    OP              ;Perform operation
  40+ A6CA BF                   		CP      A               ;Good return (Z, NC)
  41+ A6CB FD E1        EXIT:			POP     IY              ;Restore IY
  42+ A6CD C9                   		RET                     ;Return to caller
  43+ A6CE              ;
  44+ A6CE              ;Error exit:
  45+ A6CE              ;
  46+ A6CE 3E 01        BAD:			LD      A,BADOP         ;"Bad operation code"
  47+ A6D0 FD F9        ERROR:			LD      SP,IY           ;Restore SP from IY
  48+ A6D2 B7                   		OR      A               ;Set NZ
  49+ A6D3 37                   		SCF                     ;Set C
  50+ A6D4 18 F5                		JR      EXIT
  51+ A6D6              ;
  52+ A6D6              ;Perform operation or function:
  53+ A6D6              ;
  54+ A6D6 FE 2A        OP:			CP      (RTABLE-DTABLE)/2
  55+ A6D8 30 F4                		JR      NC,BAD
  56+ A6DA FE 10                		CP      (FTABLE-DTABLE)/2
  57+ A6DC 30 07                		JR      NC,DISPAT
  58+ A6DE 08                   		EX      AF,AF'
  59+ A6DF 78                   		LD      A,B
  60+ A6E0 B1                   		OR      C               ;Both integer?
  61+ A6E1 C4 60 B0             		CALL    NZ,FLOATA       ;No, so float both
  62+ A6E4 08                   		EX      AF,AF'
  63+ A6E5 E5           DISPAT:			PUSH    HL
  64+ A6E6 21 F6 A6             		LD      HL,DTABLE
  65+ A6E9 C5                   		PUSH    BC
  66+ A6EA 87                   		ADD     A,A             ;A = op-code * 2
  67+ A6EB 4F                   		LD      C,A
  68+ A6EC 06 00                		LD      B,0             ;BC = op-code * 2
  69+ A6EE 09                   		ADD     HL,BC
  70+ A6EF 7E                   		LD      A,(HL)          ;Get low byte
  71+ A6F0 23                   		INC     HL
  72+ A6F1 66                   		LD      H,(HL)          ;Get high byte
  73+ A6F2 6F                   		LD      L,A
  74+ A6F3 C1                   		POP     BC
  75+ A6F4 E3                   		EX      (SP),HL
  76+ A6F5 C9                   		RET                     ;Off to routine
  77+ A6F6              ;
  78+ A6F6              ;Despatch table:
  79+ A6F6              ;
  80+ A6F6 6D A7        DTABLE:			DEFW    IAND            ;AND (INTEGER)
  81+ A6F8 D0 A7                		DEFW    IBDIV           ;DIV
  82+ A6FA 7F A7                		DEFW    IEOR            ;EOR
  83+ A6FC A3 A7                		DEFW    IMOD            ;MOD
  84+ A6FE 91 A7                		DEFW    IOR             ;OR
  85+ A700 FF A9                		DEFW    ILE             ;<=
  86+ A702 0C AA                		DEFW    INE             ;<>
  87+ A704 F4 A9                		DEFW    IGE             ;>=
  88+ A706 DD A9                		DEFW    ILT             ;<
  89+ A708 17 AA                		DEFW    IEQ             ;=
  90+ A70A 9A A8                		DEFW    IMUL            ;*
  91+ A70C F3 A7                		DEFW    IADD            ;+
  92+ A70E E8 A9                		DEFW    IGT             ;>
  93+ A710 DD A7                		DEFW    ISUB            ;-
  94+ A712 38 A9                		DEFW    IPOW            ;^
  95+ A714 52 A8                		DEFW    IDIV            ;/
  96+ A716              ;
  97+ A716 26 AA        FTABLE:			DEFW    ABS             ;ABS
  98+ A718 82 AD                		DEFW    ACS             ;ACS
  99+ A71A DE AC                		DEFW    ASN             ;ASN
 100+ A71C 03 AD                		DEFW    ATN             ;ATN
 101+ A71E 1C AB                		DEFW    COS             ;COS
 102+ A720 50 AA                		DEFW    DEG             ;DEG
 103+ A722 C1 AB                		DEFW    EXP             ;EXP
 104+ A724 96 AA                		DEFW    INT             ;INT
 105+ A726 4C AC                		DEFW    LN              ;LN
 106+ A728 CC AC                		DEFW    LOG             ;LOG
 107+ A72A 31 AA                		DEFW    NOTK            ;NOT
 108+ A72C 58 AA                		DEFW    RAD             ;RAD
 109+ A72E 6E AA                		DEFW    SGN             ;SGN
 110+ A730 27 AB                		DEFW    SIN             ;SIN
 111+ A732 AC AA                		DEFW    SQR             ;SQR
 112+ A734 FF AA                		DEFW    TAN             ;TAN
 113+ A736              ;
 114+ A736 DC B0        		        DEFW    ZERO            ;ZERO
 115+ A738 A0 AB                		DEFW    FONE            ;FONE
 116+ A73A 1B AA                		DEFW    TRUE            ;TRUE
 117+ A73C 44 AA                		DEFW    PI              ;PI
 118+ A73E              ;
 119+ A73E 7E AA        		        DEFW    VAL             ;VAL
 120+ A740 8A AD                		DEFW    STR             ;STR$
 121+ A742              ;
 122+ A742 B1 AF                		DEFW    SFIX            ;FIX
 123+ A744 6D B0                		DEFW    SFLOAT          ;FLOAT
 124+ A746              ;
 125+ A746 B2 B0        		        DEFW    FTEST           ;TEST
 126+ A748 C3 B0                		DEFW    FCOMP           ;COMPARE
 127+ A74A              ;
 128+ A74A 6A A7        RTABLE:			DEFW    FAND            ;AND (FLOATING-POINT)
 129+ A74C CD A7                		DEFW    FBDIV           ;DIV
 130+ A74E 7C A7                		DEFW    FEOR            ;EOR
 131+ A750 A0 A7                		DEFW    FMOD            ;MOD
 132+ A752 8E A7                		DEFW    FOR             ;OR
 133+ A754 FA A9                		DEFW    FLE             ;<=
 134+ A756 07 AA                		DEFW    FNE             ;<>
 135+ A758 EF A9                		DEFW    FGE             ;>=
 136+ A75A D8 A9                		DEFW    FLT             ;<
 137+ A75C 12 AA                		DEFW    FEQ             ;=
 138+ A75E E8 A8                		DEFW    FMUL            ;*
 139+ A760 FD A7                		DEFW    FADD            ;+
 140+ A762 E3 A9                		DEFW    FGT             ;>
 141+ A764 E7 A7                		DEFW    FSUB            ;-
 142+ A766 AE A9                		DEFW    FPOW            ;^
 143+ A768 55 A8                		DEFW    FDIV            ;/
 144+ A76A              ;
 145+ A76A              ;       PAGE
 146+ A76A              ;
 147+ A76A              ;ARITHMETIC AND LOGICAL OPERATORS:
 148+ A76A              ;All take two arguments, in HLH'L'C & DED'E'B.
 149+ A76A              ;Output in HLH'L'C
 150+ A76A              ;All registers except IX, IY destroyed.
 151+ A76A              ; (N.B. FPOW destroys IX).
 152+ A76A              ;
 153+ A76A              ;FAND - Floating-point AND.
 154+ A76A              ;IAND - Integer AND.
 155+ A76A              ;
 156+ A76A CD A8 AF     FAND:			CALL    FIX2
 157+ A76D 7C           IAND:			LD      A,H
 158+ A76E A2                   		AND     D
 159+ A76F 67                   		LD      H,A
 160+ A770 7D                   		LD      A,L
 161+ A771 A3                   		AND     E
 162+ A772 6F                   		LD      L,A
 163+ A773 D9                   		EXX
 164+ A774 7C                   		LD      A,H
 165+ A775 A2                   		AND     D
 166+ A776 67                   		LD      H,A
 167+ A777 7D                   		LD      A,L
 168+ A778 A3                   		AND     E
 169+ A779 6F                   		LD      L,A
 170+ A77A D9                   		EXX
 171+ A77B C9                   		RET
 172+ A77C              ;
 173+ A77C              ;FEOR - Floating-point exclusive-OR.
 174+ A77C              ;IEOR - Integer exclusive-OR.
 175+ A77C              ;
 176+ A77C CD A8 AF     FEOR:			CALL    FIX2
 177+ A77F 7C           IEOR:			LD      A,H
 178+ A780 AA                   		XOR     D
 179+ A781 67                   		LD      H,A
 180+ A782 7D                   		LD      A,L
 181+ A783 AB                   		XOR     E
 182+ A784 6F                   		LD      L,A
 183+ A785 D9                   		EXX
 184+ A786 7C                   		LD      A,H
 185+ A787 AA                   		XOR     D
 186+ A788 67                   		LD      H,A
 187+ A789 7D                   		LD      A,L
 188+ A78A AB                   		XOR     E
 189+ A78B 6F                   		LD      L,A
 190+ A78C D9                   		EXX
 191+ A78D C9                   		RET
 192+ A78E              ;
 193+ A78E              ;FOR - Floating-point OR.
 194+ A78E              ;IOR - Integer OR.
 195+ A78E              ;
 196+ A78E CD A8 AF     FOR:			CALL    FIX2
 197+ A791 7C           IOR:			LD      A,H
 198+ A792 B2                   		OR      D
 199+ A793 67                   		LD      H,A
 200+ A794 7D                   		LD      A,L
 201+ A795 B3                   		OR      E
 202+ A796 6F                   		LD      L,A
 203+ A797 D9                   		EXX
 204+ A798 7C                   		LD      A,H
 205+ A799 B2                   		OR      D
 206+ A79A 67                   		LD      H,A
 207+ A79B 7D                   		LD      A,L
 208+ A79C B3                   		OR      E
 209+ A79D 6F                   		LD      L,A
 210+ A79E D9                   		EXX
 211+ A79F C9                   		RET
 212+ A7A0              ;
 213+ A7A0              ;FMOD - Floating-point remainder.
 214+ A7A0              ;IMOD - Integer remainder.
 215+ A7A0              ;
 216+ A7A0 CD A8 AF     FMOD:			CALL    FIX2
 217+ A7A3 7C           IMOD:			LD      A,H
 218+ A7A4 AA                   		XOR     D               ;DIV RESULT SIGN
 219+ A7A5 CB 7C                		BIT     7,H
 220+ A7A7 08                   		EX      AF,AF'
 221+ A7A8 CB 7C                		BIT     7,H
 222+ A7AA C4 C0 AF             		CALL    NZ,NEGATE       ;MAKE ARGUMENTS +VE
 223+ A7AD CD 97 B0             		CALL    SWAP
 224+ A7B0 CB 7C                		BIT     7,H
 225+ A7B2 C4 C0 AF             		CALL    NZ,NEGATE
 226+ A7B5 44                   		LD      B,H
 227+ A7B6 4D                   		LD      C,L
 228+ A7B7 21 00 00             		LD      HL,0
 229+ A7BA D9                   		EXX
 230+ A7BB 44                   		LD      B,H
 231+ A7BC 4D                   		LD      C,L
 232+ A7BD 21 00 00             		LD      HL,0
 233+ A7C0 3E DF                		LD      A,-33
 234+ A7C2 CD EC B1             		CALL    DIVA            ;DIVIDE
 235+ A7C5 D9                   		EXX
 236+ A7C6 0E 00                		LD      C,0             ;INTEGER MARKER
 237+ A7C8 08                   		EX      AF,AF'
 238+ A7C9 C8                   		RET     Z
 239+ A7CA C3 C0 AF             		JP      NEGATE
 240+ A7CD              ;
 241+ A7CD              ;BDIV - Integer division.
 242+ A7CD              ;
 243+ A7CD CD A8 AF     FBDIV:			CALL    FIX2
 244+ A7D0 CD A3 A7     IBDIV:			CALL    IMOD
 245+ A7D3 B7                   		OR      A
 246+ A7D4 CD 97 B0             		CALL    SWAP
 247+ A7D7 0E 00                		LD      C,0
 248+ A7D9 F0                   		RET     P
 249+ A7DA C3 C0 AF             		JP      NEGATE
 250+ A7DD              ;
 251+ A7DD              ;ISUB - Integer subtraction.
 252+ A7DD              ;FSUB - Floating point subtraction with rounding.
 253+ A7DD              ;
 254+ A7DD CD 1F B1     ISUB:			CALL    SUB
 255+ A7E0 E0                   		RET     PO
 256+ A7E1 CD 19 B1             		CALL    ADD
 257+ A7E4 CD 64 B0             		CALL    FLOAT2
 258+ A7E7 7A           FSUB:			LD      A,D
 259+ A7E8 EE 80                		XOR     80H             ;CHANGE SIGN THEN ADD
 260+ A7EA 57                   		LD      D,A
 261+ A7EB 18 10                		JR      FADD
 262+ A7ED              ;
 263+ A7ED              ;Reverse subtract.
 264+ A7ED              ;
 265+ A7ED 7C           RSUB:			LD      A,H
 266+ A7EE EE 80                		XOR     80H
 267+ A7F0 67                   		LD      H,A
 268+ A7F1 18 0A                		JR      FADD
 269+ A7F3              ;
 270+ A7F3              ;IADD - Integer addition.
 271+ A7F3              ;FADD - Floating point addition with rounding.
 272+ A7F3              ;
 273+ A7F3 CD 19 B1     IADD:			CALL    ADD
 274+ A7F6 E0                   		RET     PO
 275+ A7F7 CD 1F B1             		CALL    SUB
 276+ A7FA CD 64 B0             		CALL    FLOAT2
 277+ A7FD 05           FADD:			DEC     B
 278+ A7FE 04                   		INC     B
 279+ A7FF C8                   		RET     Z               ;ARG 2 ZERO
 280+ A800 0D                   		DEC     C
 281+ A801 0C                   		INC     C
 282+ A802 CA 97 B0             		JP      Z,SWAP          ;ARG 1 ZERO
 283+ A805 D9                   		EXX
 284+ A806 01 00 00             		LD      BC,0            ;INITIALISE
 285+ A809 D9                   		EXX
 286+ A80A 7C                   		LD      A,H
 287+ A80B AA                   		XOR     D               ;XOR SIGNS
 288+ A80C F5                   		PUSH    AF
 289+ A80D 78                   		LD      A,B
 290+ A80E B9                   		CP      C               ;COMPARE EXPONENTS
 291+ A80F DC 97 B0             		CALL    C,SWAP          ;MAKE DED'E'B LARGEST
 292+ A812 78                   		LD      A,B
 293+ A813 CB FC                		SET     7,H             ;IMPLIED 1
 294+ A815 C4 98 AF             		CALL    NZ,FIX          ;ALIGN
 295+ A818 F1                   		POP     AF
 296+ A819 7A                   		LD      A,D             ;SIGN OF LARGER
 297+ A81A CB FA                		SET     7,D             ;IMPLIED 1
 298+ A81C FA 29 A8             		JP      M,FADD3         ;SIGNS DIFFERENT
 299+ A81F CD 19 B1             		CALL    ADD             ;HLH'L'=HLH'L'+DED'E'
 300+ A822 DC 9F B0             		CALL    C,DIV2          ;NORMALISE
 301+ A825 CB FC                		SET     7,H
 302+ A827 18 0A                		JR      FADD4
 303+ A829              ;
 304+ A829 CD 1F B1     FADD3:			CALL    SUB             ;HLH'L'=HLH'L'-DED'E'
 305+ A82C DC D4 AF             		CALL    C,NEG           ;NEGATE HLH'L'B'C'
 306+ A82F CD 41 B0             		CALL    FLO48
 307+ A832 2F                   		CPL                     ;CHANGE RESULT SIGN
 308+ A833 D9           FADD4:			EXX
 309+ A834 EB                   		EX      DE,HL
 310+ A835 21 00 80             		LD      HL,8000H
 311+ A838 B7                   		OR      A               ;CLEAR CARRY
 312+ A839 ED 42                		SBC     HL,BC
 313+ A83B EB                   		EX      DE,HL
 314+ A83C D9                   		EXX
 315+ A83D CC 91 B0             		CALL    Z,ODD           ;ROUND UNBIASSED
 316+ A840 DC 83 B0             		CALL    C,ADD1          ;ROUND UP
 317+ A843 DC AB B0             		CALL    C,INCC
 318+ A846 CB BC                		RES     7,H
 319+ A848 0D                   		DEC     C
 320+ A849 0C                   		INC     C
 321+ A84A CA DC B0             		JP      Z,ZERO
 322+ A84D B7                   		OR      A               ;RESULT SIGNQ
 323+ A84E F0                   		RET     P               ;POSITIVE
 324+ A84F CB FC                		SET     7,H             ;NEGATIVE
 325+ A851 C9                   		RET
 326+ A852              ;
 327+ A852              ;IDIV - Integer division.
 328+ A852              ;FDIV - Floating point division with rounding.
 329+ A852              ;
 330+ A852 CD 64 B0     IDIV:			CALL    FLOAT2
 331+ A855 05           FDIV:			DEC     B               ;TEST FOR ZERO
 332+ A856 04                   		INC     B
 333+ A857 3E 12                		LD      A,DIVBY0
 334+ A859 CA D0 A6             		JP      Z,ERROR         ;"Division by zero"
 335+ A85C 0D                   		DEC     C               ;TEST FOR ZERO
 336+ A85D 0C                   		INC     C
 337+ A85E C8                   		RET     Z
 338+ A85F 7C                   		LD      A,H
 339+ A860 AA                   		XOR     D               ;CALC. RESULT SIGN
 340+ A861 08                   		EX      AF,AF'          ;SAVE SIGN
 341+ A862 CB FA                		SET     7,D             ;REPLACE IMPLIED 1's
 342+ A864 CB FC                		SET     7,H
 343+ A866 C5                   		PUSH    BC              ;SAVE EXPONENTS
 344+ A867 42                   		LD      B,D             ;LOAD REGISTERS
 345+ A868 4B                   		LD      C,E
 346+ A869 11 00 00             		LD      DE,0
 347+ A86C D9                   		EXX
 348+ A86D 42                   		LD      B,D
 349+ A86E 4B                   		LD      C,E
 350+ A86F 11 00 00             		LD      DE,0
 351+ A872 3E E0                		LD      A,-32           ;LOOP COUNTER
 352+ A874 CD EC B1             		CALL    DIVA            ;DIVIDE
 353+ A877 D9                   		EXX
 354+ A878 CB 7A                		BIT     7,D
 355+ A87A D9                   		EXX
 356+ A87B CC 07 B2             		CALL    Z,DIVB          ;NORMALISE & INC A
 357+ A87E EB                   		EX      DE,HL
 358+ A87F D9                   		EXX
 359+ A880 CB 38                		SRL     B               ;DIVISOR/2
 360+ A882 CB 19                		RR      C
 361+ A884 B7                   		OR      A               ;CLEAR CARRY
 362+ A885 ED 42                		SBC     HL,BC           ;REMAINDER-DIVISOR/2
 363+ A887 3F                   		CCF
 364+ A888 EB                   		EX      DE,HL           ;RESULT IN HLH'L'
 365+ A889 CC 91 B0             		CALL    Z,ODD           ;ROUND UNBIASSED
 366+ A88C DC 83 B0             		CALL    C,ADD1          ;ROUND UP
 367+ A88F C1                   		POP     BC              ;RESTORE EXPONENTS
 368+ A890 DC AB B0             		CALL    C,INCC
 369+ A893 1F                   		RRA                     ;LSB OF A TO CARRY
 370+ A894 79                   		LD      A,C             ;COMPUTE NEW EXPONENT
 371+ A895 98                   		SBC     A,B
 372+ A896 3F                   		CCF
 373+ A897 C3 21 A9             		JP      CHKOVF
 374+ A89A              ;
 375+ A89A              ;IMUL - Integer multiplication.
 376+ A89A              ;
 377+ A89A 7C           IMUL:			LD      A,H
 378+ A89B AA                   		XOR     D
 379+ A89C 08                   		EX      AF,AF'          ;SAVE RESULT SIGN
 380+ A89D CB 7C                		BIT     7,H
 381+ A89F C4 C0 AF             		CALL    NZ,NEGATE
 382+ A8A2 CD 97 B0             		CALL    SWAP
 383+ A8A5 CB 7C                		BIT     7,H
 384+ A8A7 C4 C0 AF             		CALL    NZ,NEGATE
 385+ A8AA 44                   		LD      B,H
 386+ A8AB 4D                   		LD      C,L
 387+ A8AC 21 00 00             		LD      HL,0
 388+ A8AF D9                   		EXX
 389+ A8B0 44                   		LD      B,H
 390+ A8B1 4D                   		LD      C,L
 391+ A8B2 21 00 00             		LD      HL,0
 392+ A8B5 3E DF                		LD      A,-33
 393+ A8B7 CD 1A B2             		CALL    MULA            ;MULTIPLY
 394+ A8BA D9                   		EXX
 395+ A8BB 0E BF                		LD      C,191           ;PRESET EXPONENT
 396+ A8BD CD BC B0             		CALL    TEST            ;TEST RANGE
 397+ A8C0 20 0D                		JR      NZ,IMUL1        ;TOO BIG
 398+ A8C2 CB 7A                		BIT     7,D
 399+ A8C4 20 09                		JR      NZ,IMUL1
 400+ A8C6 CD 97 B0             		CALL    SWAP
 401+ A8C9 4A                   		LD      C,D             ;INTEGER MARKER
 402+ A8CA 08                   		EX      AF,AF'
 403+ A8CB F0                   		RET     P
 404+ A8CC C3 C0 AF             		JP      NEGATE
 405+ A8CF              ;
 406+ A8CF 0D           IMUL1:			DEC     C
 407+ A8D0 D9                   		EXX
 408+ A8D1 CB 23                		SLA     E
 409+ A8D3 CB 12                		RL      D
 410+ A8D5 D9                   		EXX
 411+ A8D6 CB 13                		RL      E
 412+ A8D8 CB 12                		RL      D
 413+ A8DA D9                   		EXX
 414+ A8DB ED 6A                		ADC     HL,HL
 415+ A8DD D9                   		EXX
 416+ A8DE ED 6A                		ADC     HL,HL
 417+ A8E0 F2 CF A8             		JP      P,IMUL1         ;NORMALISE
 418+ A8E3 08                   		EX      AF,AF'
 419+ A8E4 F8                   		RET     M
 420+ A8E5 CB BC                		RES     7,H             ;POSITIVE
 421+ A8E7 C9                   		RET
 422+ A8E8              ;
 423+ A8E8              ;FMUL - Floating point multiplication with rounding.
 424+ A8E8              ;
 425+ A8E8 05           FMUL:			DEC     B               ;TEST FOR ZERO
 426+ A8E9 04                   		INC     B
 427+ A8EA CA DC B0             		JP      Z,ZERO
 428+ A8ED 0D                   		DEC     C               ;TEST FOR ZERO
 429+ A8EE 0C                   		INC     C
 430+ A8EF C8                   		RET     Z
 431+ A8F0 7C                   		LD      A,H
 432+ A8F1 AA                   		XOR     D               ;CALC. RESULT SIGN
 433+ A8F2 08                   		EX      AF,AF'
 434+ A8F3 CB FA                		SET     7,D             ;REPLACE IMPLIED 1's
 435+ A8F5 CB FC                		SET     7,H
 436+ A8F7 C5                   		PUSH    BC              ;SAVE EXPONENTS
 437+ A8F8 44                   		LD      B,H             ;LOAD REGISTERS
 438+ A8F9 4D                   		LD      C,L
 439+ A8FA 21 00 00             		LD      HL,0
 440+ A8FD D9                   		EXX
 441+ A8FE 44                   		LD      B,H
 442+ A8FF 4D                   		LD      C,L
 443+ A900 21 00 00             		LD      HL,0
 444+ A903 3E E0                		LD      A,-32           ;LOOP COUNTER
 445+ A905 CD 1A B2             		CALL    MULA            ;MULTIPLY
 446+ A908 DC 2E B2             		CALL    C,MULB          ;NORMALISE & INC A
 447+ A90B D9                   		EXX
 448+ A90C E5                   		PUSH    HL
 449+ A90D 21 00 80             		LD      HL,8000H
 450+ A910 B7                   		OR      A               ;CLEAR CARRY
 451+ A911 ED 52                		SBC     HL,DE
 452+ A913 E1                   		POP     HL
 453+ A914 CC 91 B0             		CALL    Z,ODD           ;ROUND UNBIASSED
 454+ A917 DC 83 B0             		CALL    C,ADD1          ;ROUND UP
 455+ A91A C1                   		POP     BC              ;RESTORE EXPONENTS
 456+ A91B DC AB B0             		CALL    C,INCC
 457+ A91E 1F                   		RRA                     ;LSB OF A TO CARRY
 458+ A91F 79                   		LD      A,C             ;COMPUTE NEW EXPONENT
 459+ A920 88                   		ADC     A,B
 460+ A921 38 05        CHKOVF:			JR      C,CHKO1
 461+ A923 F2 DC B0             		JP      P,ZERO          ;UNDERFLOW
 462+ A926 18 03                		JR      CHKO2
 463+ A928 FA AD B0     CHKO1:			JP      M,OFLOW         ;OVERFLOW
 464+ A92B C6 80        CHKO2:			ADD     A,80H
 465+ A92D 4F                   		LD      C,A
 466+ A92E CA DC B0             		JP      Z,ZERO
 467+ A931 08                   		EX      AF,AF'          ;RESTORE SIGN BIT
 468+ A932 CB BC                		RES     7,H
 469+ A934 F0                   		RET     P
 470+ A935 CB FC                		SET     7,H
 471+ A937 C9                   		RET
 472+ A938              ;
 473+ A938              ;IPOW - Integer involution.
 474+ A938              ;
 475+ A938 CD 97 B0     IPOW:			CALL    SWAP
 476+ A93B CB 7C                		BIT     7,H
 477+ A93D F5                   		PUSH    AF              ;SAVE SIGN
 478+ A93E C4 C0 AF             		CALL    NZ,NEGATE
 479+ A941 48           IPOW0:			LD      C,B
 480+ A942 06 20                		LD      B,32            ;LOOP COUNTER
 481+ A944 CD 36 B1     IPOW1:			CALL    X2
 482+ A947 38 08                		JR      C,IPOW2
 483+ A949 10 F9                		DJNZ    IPOW1
 484+ A94B F1                   		POP     AF
 485+ A94C D9                   		EXX
 486+ A94D 2C                   		INC     L               ;RESULT=1
 487+ A94E D9                   		EXX
 488+ A94F 4C                   		LD      C,H
 489+ A950 C9                   		RET
 490+ A951              ;
 491+ A951 F1           IPOW2:			POP     AF
 492+ A952 C5                   		PUSH    BC
 493+ A953 EB                   		EX      DE,HL
 494+ A954 E5                   		PUSH    HL
 495+ A955 D9                   		EXX
 496+ A956 EB                   		EX      DE,HL
 497+ A957 E5                   		PUSH    HL
 498+ A958 D9                   		EXX
 499+ A959 DD 21 00 00          		LD      IX,0
 500+ A95D DD 39                		ADD     IX,SP
 501+ A95F 28 42                		JR      Z,IPOW4
 502+ A961 C5                   		PUSH    BC
 503+ A962 D9                   		EXX
 504+ A963 D5                   		PUSH    DE
 505+ A964 D9                   		EXX
 506+ A965 D5                   		PUSH    DE
 507+ A966 CD 6D B0             		CALL    SFLOAT
 508+ A969 CD 38 AC             		CALL    RECIP
 509+ A96C DD 71 04             		LD      (IX+4),C
 510+ A96F D9                   		EXX
 511+ A970 DD 75 00             		LD      (IX+0),L
 512+ A973 DD 74 01             		LD      (IX+1),H
 513+ A976 D9                   		EXX
 514+ A977 DD 75 02             		LD      (IX+2),L
 515+ A97A DD 74 03             		LD      (IX+3),H
 516+ A97D 18 1D                		JR      IPOW5
 517+ A97F              ;
 518+ A97F C5           IPOW3:			PUSH    BC
 519+ A980 D9                   		EXX
 520+ A981 CB 23                		SLA     E
 521+ A983 CB 12                		RL      D
 522+ A985 D5                   		PUSH    DE
 523+ A986 D9                   		EXX
 524+ A987 CB 13                		RL      E
 525+ A989 CB 12                		RL      D
 526+ A98B D5                   		PUSH    DE
 527+ A98C 3E 0A                		LD      A,'*' AND 0FH
 528+ A98E F5                   		PUSH    AF
 529+ A98F CD 48 B1             		CALL    COPY
 530+ A992 CD D6 A6             		CALL    OP              ;SQUARE
 531+ A995 F1                   		POP     AF
 532+ A996 CD DC AE             		CALL    DLOAD5
 533+ A999 DC D6 A6             		CALL    C,OP            ;MULTIPLY BY X
 534+ A99C D1           IPOW5:			POP     DE
 535+ A99D D9                   		EXX
 536+ A99E D1                   		POP     DE
 537+ A99F D9                   		EXX
 538+ A9A0 79                   		LD      A,C
 539+ A9A1 C1                   		POP     BC
 540+ A9A2 4F                   		LD      C,A
 541+ A9A3 10 DA        IPOW4:			DJNZ    IPOW3
 542+ A9A5 F1                   		POP     AF
 543+ A9A6 F1                   		POP     AF
 544+ A9A7 F1                   		POP     AF
 545+ A9A8 C9                   		RET
 546+ A9A9              ;
 547+ A9A9 F1           FPOW0:			POP     AF
 548+ A9AA F1                   		POP     AF
 549+ A9AB F1                   		POP     AF
 550+ A9AC 18 93                		JR      IPOW0
 551+ A9AE              ;
 552+ A9AE              ;FPOW - Floating-point involution.
 553+ A9AE              ;
 554+ A9AE CB 7A        FPOW:			BIT     7,D
 555+ A9B0 F5                   		PUSH    AF
 556+ A9B1 CD 97 B0             		CALL    SWAP
 557+ A9B4 CD 56 B1             		CALL    PUSH5
 558+ A9B7 0D                   		DEC     C
 559+ A9B8 0C                   		INC     C
 560+ A9B9 28 EE                		JR      Z,FPOW0
 561+ A9BB 3E 9E                		LD      A,158
 562+ A9BD B9                   		CP      C
 563+ A9BE 38 08                		JR      C,FPOW1
 564+ A9C0 3C                   		INC     A
 565+ A9C1 CD 98 AF             		CALL    FIX
 566+ A9C4 08                   		EX      AF,AF'
 567+ A9C5 F2 A9 A9             		JP      P,FPOW0
 568+ A9C8 CD 97 B0     FPOW1:			CALL    SWAP
 569+ A9CB CD 4F AC             		CALL    LN0
 570+ A9CE CD 5F B1             		CALL    POP5
 571+ A9D1 F1                   		POP     AF
 572+ A9D2 CD E8 A8             		CALL    FMUL
 573+ A9D5 C3 C4 AB             		JP      EXP0
 574+ A9D8              ;
 575+ A9D8              ;Integer and floating-point compare.
 576+ A9D8              ;Result is TRUE (-1) or FALSE (0).
 577+ A9D8              ;
 578+ A9D8 CD E6 B0     FLT:			CALL    FCP
 579+ A9DB 18 03                		JR      ILT1
 580+ A9DD CD D9 B0     ILT:			CALL    ICP
 581+ A9E0 D0           ILT1:			RET     NC
 582+ A9E1 18 38                		JR      TRUE
 583+ A9E3              ;
 584+ A9E3 CD E6 B0     FGT:			CALL    FCP
 585+ A9E6 18 03                		JR      IGT1
 586+ A9E8 CD D9 B0     IGT:			CALL    ICP
 587+ A9EB C8           IGT1:			RET     Z
 588+ A9EC D8                   		RET     C
 589+ A9ED 18 2C                		JR      TRUE
 590+ A9EF              ;
 591+ A9EF CD E6 B0     FGE:			CALL    FCP
 592+ A9F2 18 03                		JR      IGE1
 593+ A9F4 CD D9 B0     IGE:			CALL    ICP
 594+ A9F7 D8           IGE1:			RET     C
 595+ A9F8 18 21                		JR      TRUE
 596+ A9FA              ;
 597+ A9FA CD E6 B0     FLE:			CALL    FCP
 598+ A9FD 18 03                		JR      ILE1
 599+ A9FF CD D9 B0     ILE:			CALL    ICP
 600+ AA02 28 17        ILE1:			JR      Z,TRUE
 601+ AA04 D0                   		RET     NC
 602+ AA05 18 14                		JR      TRUE
 603+ AA07              ;
 604+ AA07 CD E6 B0     FNE:			CALL    FCP
 605+ AA0A 18 03                		JR      INE1
 606+ AA0C CD D9 B0     INE:			CALL    ICP
 607+ AA0F C8           INE1:			RET     Z
 608+ AA10 18 09                		JR      TRUE
 609+ AA12              ;
 610+ AA12 CD E6 B0     FEQ:			CALL    FCP
 611+ AA15 18 03                		JR      IEQ1
 612+ AA17 CD D9 B0     IEQ:			CALL    ICP
 613+ AA1A C0           IEQ1:			RET     NZ
 614+ AA1B 21 FF FF     TRUE:			LD      HL,-1
 615+ AA1E D9                   		EXX
 616+ AA1F 21 FF FF             		LD      HL,-1
 617+ AA22 D9                   		EXX
 618+ AA23 AF                   		XOR     A
 619+ AA24 4F                   		LD      C,A
 620+ AA25 C9                   		RET
 621+ AA26              ;
 622+ AA26              ;FUNCTIONS:
 623+ AA26              ;
 624+ AA26              ;Result returned in HLH'L'C (floating point)
 625+ AA26              ;Result returned in HLH'L' (C=0) (integer)
 626+ AA26              ;All registers except IY destroyed.
 627+ AA26              ;
 628+ AA26              ;ABS - Absolute value
 629+ AA26              ;Result is numeric, variable type.
 630+ AA26              ;
 631+ AA26 CB 7C        ABS:			BIT     7,H
 632+ AA28 C8                   		RET     Z               ;POSITIVE/ZERO
 633+ AA29 0D                   		DEC     C
 634+ AA2A 0C                   		INC     C
 635+ AA2B CA C0 AF             		JP      Z,NEGATE        ;INTEGER
 636+ AA2E CB BC                		RES     7,H
 637+ AA30 C9                   		RET
 638+ AA31              ;
 639+ AA31              ;NOT - Complement integer.
 640+ AA31              ;Result is integer numeric.
 641+ AA31              ;
 642+ AA31 CD B1 AF     NOTK:			CALL    SFIX
 643+ AA34 7C                   		LD      A,H
 644+ AA35 2F                   		CPL
 645+ AA36 67                   		LD      H,A
 646+ AA37 7D                   		LD      A,L
 647+ AA38 2F                   		CPL
 648+ AA39 6F                   		LD      L,A
 649+ AA3A D9                   		EXX
 650+ AA3B 7C                   		LD      A,H
 651+ AA3C 2F                   		CPL
 652+ AA3D 67                   		LD      H,A
 653+ AA3E 7D                   		LD      A,L
 654+ AA3F 2F                   		CPL
 655+ AA40 6F                   		LD      L,A
 656+ AA41 D9                   		EXX
 657+ AA42 AF                   		XOR     A               ;NUMERIC MARKER
 658+ AA43 C9                   		RET
 659+ AA44              ;
 660+ AA44              ;PI - Return PI (3.141592654)
 661+ AA44              ;Result is floating-point numeric.
 662+ AA44              ;
 663+ AA44 21 0F 49     PI:			LD      HL,490FH
 664+ AA47 D9                   		EXX
 665+ AA48 21 A2 DA             		LD      HL,0DAA2H
 666+ AA4B D9                   		EXX
 667+ AA4C 0E 81                		LD      C,81H
 668+ AA4E AF                   		XOR     A               ;NUMERIC MARKER
 669+ AA4F C9                   		RET
 670+ AA50              ;
 671+ AA50              ;DEG - Convert radians to degrees
 672+ AA50              ;Result is floating-point numeric.
 673+ AA50              ;
 674+ AA50 CD 60 AA     DEG:			CALL    FPI180
 675+ AA53 CD E8 A8             		CALL    FMUL
 676+ AA56 AF                   		XOR     A
 677+ AA57 C9                   		RET
 678+ AA58              ;
 679+ AA58              ;RAD - Convert degrees to radians
 680+ AA58              ;Result is floating-point numeric.
 681+ AA58              ;
 682+ AA58 CD 60 AA     RAD:			CALL    FPI180
 683+ AA5B CD 55 A8             		CALL    FDIV
 684+ AA5E AF                   		XOR     A
 685+ AA5F C9                   		RET
 686+ AA60              ;
 687+ AA60              ;180/PI
 688+ AA60              ;
 689+ AA60 CD 6D B0     FPI180:			CALL    SFLOAT
 690+ AA63 11 2E 65             		LD      DE,652EH
 691+ AA66 D9                   		EXX
 692+ AA67 11 D3 E0             		LD      DE,0E0D3H
 693+ AA6A D9                   		EXX
 694+ AA6B 06 85                		LD      B,85H
 695+ AA6D C9                   		RET
 696+ AA6E              ;
 697+ AA6E              ;SGN - Return -1, 0 or +1
 698+ AA6E              ;Result is integer numeric.
 699+ AA6E              ;
 700+ AA6E CD BC B0     SGN:			CALL    TEST
 701+ AA71 B1                   		OR      C
 702+ AA72 C8                   		RET     Z               ;ZERO
 703+ AA73 CB 7C                		BIT     7,H
 704+ AA75 C2 1B AA             		JP      NZ,TRUE         ;-1
 705+ AA78 CD DC B0             		CALL    ZERO
 706+ AA7B C3 83 B0             		JP      ADD1            ;1
 707+ AA7E              ;
 708+ AA7E              ;VAL - Return numeric value of string.
 709+ AA7E              ;Input: ASCII string at IX
 710+ AA7E              ;Result is variable type numeric.
 711+ AA7E              ;
 712+ AA7E CD A7 B2     VAL:			CALL    SIGNQ
 713+ AA81 F5                   		PUSH    AF
 714+ AA82 CD EE AE             		CALL    CON
 715+ AA85 F1                   		POP     AF
 716+ AA86 FE 2D                		CP      '-'
 717+ AA88 3E 00                		LD      A,0             ;NUMERIC MARKER
 718+ AA8A C0                   		RET     NZ
 719+ AA8B 0D                   		DEC     C
 720+ AA8C 0C                   		INC     C
 721+ AA8D CA C0 AF             		JP      Z,NEGATE        ;ZERO/INTEGER
 722+ AA90 7C                   		LD      A,H
 723+ AA91 EE 80                		XOR     80H             ;CHANGE SIGN (FP)
 724+ AA93 67                   		LD      H,A
 725+ AA94 AF                   		XOR     A
 726+ AA95 C9                   		RET
 727+ AA96              ;
 728+ AA96              ;INT - Floor function
 729+ AA96              ;Result is integer numeric.
 730+ AA96              ;
 731+ AA96 0D           INT:			DEC     C
 732+ AA97 0C                   		INC     C
 733+ AA98 C8                   		RET     Z               ;ZERO/INTEGER
 734+ AA99 3E 9F                		LD      A,159
 735+ AA9B 44                   		LD      B,H             ;B7=SIGN BIT
 736+ AA9C CD 98 AF             		CALL    FIX
 737+ AA9F 08                   		EX      AF,AF'
 738+ AAA0 A0                   		AND     B
 739+ AAA1 FC 83 B0             		CALL    M,ADD1          ;NEGATIVE NON-INTEGER
 740+ AAA4 78                   		LD      A,B
 741+ AAA5 B7                   		OR      A
 742+ AAA6 FC C0 AF             		CALL    M,NEGATE
 743+ AAA9 AF                   		XOR     A
 744+ AAAA 4F                   		LD      C,A
 745+ AAAB C9                   		RET
 746+ AAAC              ;
 747+ AAAC              ;SQR - square root
 748+ AAAC              ;Result is floating-point numeric.
 749+ AAAC              ;
 750+ AAAC CD 6D B0     SQR:			CALL    SFLOAT
 751+ AAAF CB 7C        SQR0:			BIT     7,H
 752+ AAB1 3E 15                		LD      A,NGROOT
 753+ AAB3 C2 D0 A6             		JP      NZ,ERROR        ;"-ve root"
 754+ AAB6 0D                   		DEC     C
 755+ AAB7 0C                   		INC     C
 756+ AAB8 C8                   		RET     Z               ;ZERO
 757+ AAB9 CB FC                		SET     7,H             ;IMPLIED 1
 758+ AABB CB 41                		BIT     0,C
 759+ AABD CC 9F B0             		CALL    Z,DIV2          ;MAKE EXPONENT ODD
 760+ AAC0 79                   		LD      A,C
 761+ AAC1 D6 80                		SUB     80H
 762+ AAC3 CB 2F                		SRA     A               ;HALVE EXPONENT
 763+ AAC5 C6 80                		ADD     A,80H
 764+ AAC7 4F                   		LD      C,A
 765+ AAC8 C5                   		PUSH    BC              ;SAVE EXPONENT
 766+ AAC9 EB                   		EX      DE,HL
 767+ AACA 21 00 00             		LD      HL,0
 768+ AACD 44                   		LD      B,H
 769+ AACE 4D                   		LD      C,L
 770+ AACF D9                   		EXX
 771+ AAD0 EB                   		EX      DE,HL
 772+ AAD1 21 00 00             		LD      HL,0
 773+ AAD4 44                   		LD      B,H
 774+ AAD5 4D                   		LD      C,L
 775+ AAD6 3E E1                		LD      A,-31
 776+ AAD8 CD 4D B2             		CALL    SQRA            ;ROOT
 777+ AADB D9                   		EXX
 778+ AADC CB 78                		BIT     7,B
 779+ AADE D9                   		EXX
 780+ AADF CC 4D B2             		CALL    Z,SQRA          ;NORMALISE & INC A
 781+ AAE2 CD 86 B2             		CALL    SQRB
 782+ AAE5 B7                   		OR      A               ;CLEAR CARRY
 783+ AAE6 CD 07 B2             		CALL    DIVB
 784+ AAE9 CB 1B                		RR      E               ;LSB TO CARRY
 785+ AAEB 60                   		LD      H,B
 786+ AAEC 69                   		LD      L,C
 787+ AAED D9                   		EXX
 788+ AAEE 60                   		LD      H,B
 789+ AAEF 69                   		LD      L,C
 790+ AAF0 DC 83 B0             		CALL    C,ADD1          ;ROUND UP
 791+ AAF3 C1                   		POP     BC              ;RESTORE EXPONENT
 792+ AAF4 DC AB B0             		CALL    C,INCC
 793+ AAF7 1F                   		RRA
 794+ AAF8 9F                   		SBC     A,A
 795+ AAF9 81                   		ADD     A,C
 796+ AAFA 4F                   		LD      C,A
 797+ AAFB CB BC                		RES     7,H             ;POSITIVE
 798+ AAFD AF                   		XOR     A
 799+ AAFE C9                   		RET
 800+ AAFF              ;
 801+ AAFF              ;TAN - Tangent function
 802+ AAFF              ;Result is floating-point numeric.
 803+ AAFF              ;
 804+ AAFF CD 6D B0     TAN:			CALL    SFLOAT
 805+ AB02 CD 56 B1             		CALL    PUSH5
 806+ AB05 CD 1F AB             		CALL    COS0
 807+ AB08 CD 5F B1             		CALL    POP5
 808+ AB0B CD 56 B1             		CALL    PUSH5
 809+ AB0E CD 97 B0             		CALL    SWAP
 810+ AB11 CD 2A AB             		CALL    SIN0
 811+ AB14 CD 5F B1             		CALL    POP5
 812+ AB17 CD 55 A8             		CALL    FDIV
 813+ AB1A AF                   		XOR     A               ;NUMERIC MARKER
 814+ AB1B C9                   		RET
 815+ AB1C              ;
 816+ AB1C              ;COS - Cosine function
 817+ AB1C              ;Result is floating-point numeric.
 818+ AB1C              ;
 819+ AB1C CD 6D B0     COS:			CALL    SFLOAT
 820+ AB1F CD E2 AF     COS0:			CALL    SCALE
 821+ AB22 1C                   		INC     E
 822+ AB23 1C                   		INC     E
 823+ AB24 7B                   		LD      A,E
 824+ AB25 18 0E                		JR      SIN1
 825+ AB27              ;
 826+ AB27              ;SIN - Sine function
 827+ AB27              ;Result is floating-point numeric.
 828+ AB27              ;
 829+ AB27 CD 6D B0     SIN:			CALL    SFLOAT
 830+ AB2A E5           SIN0:			PUSH    HL              ;H7=SIGN
 831+ AB2B CD E2 AF             		CALL    SCALE
 832+ AB2E F1                   		POP     AF
 833+ AB2F 07                   		RLCA
 834+ AB30 07                   		RLCA
 835+ AB31 07                   		RLCA
 836+ AB32 E6 04                		AND     4
 837+ AB34 AB                   		XOR     E
 838+ AB35 F5           SIN1:			PUSH    AF              ;OCTANT
 839+ AB36 CB BC                		RES     7,H
 840+ AB38 1F                   		RRA
 841+ AB39 CD B6 AB             		CALL    PIBY4
 842+ AB3C DC ED A7             		CALL    C,RSUB          ;X=(PI/4)-X
 843+ AB3F F1                   		POP     AF
 844+ AB40 F5                   		PUSH    AF
 845+ AB41 E6 03                		AND     3
 846+ AB43 E2 74 AB             		JP      PO,SIN2         ;USE COSINE APPROX.
 847+ AB46 CD 56 B1             		CALL    PUSH5           ;SAVE X
 848+ AB49 CD 50 B1             		CALL    SQUARE          ;PUSH X*X
 849+ AB4C CD 89 B1             		CALL    POLY
 850+ AB4F B7 A8                		DEFW    0A8B7H          ;a(8)
 851+ AB51 11 36                		DEFW    3611H
 852+ AB53 6D                   		DEFB    6DH
 853+ AB54 26 DE                		DEFW    0DE26H          ;a(6)
 854+ AB56 05 D0                		DEFW    0D005H
 855+ AB58 73                   		DEFB    73H
 856+ AB59 C0 80                		DEFW    80C0H           ;a(4)
 857+ AB5B 88 08                		DEFW    888H
 858+ AB5D 79                   		DEFB    79H
 859+ AB5E 9D AA                		DEFW    0AA9DH          ;a(2)
 860+ AB60 AA AA                		DEFW    0AAAAH
 861+ AB62 7D                   		DEFB    7DH
 862+ AB63 00 00                		DEFW    0               ;a(0)
 863+ AB65 00 00                		DEFW    0
 864+ AB67 80                   		DEFB    80H
 865+ AB68 CD 5F B1             		CALL    POP5
 866+ AB6B CD 5F B1             		CALL    POP5
 867+ AB6E CD E8 A8             		CALL    FMUL
 868+ AB71 C3 96 AB             		JP      SIN3
 869+ AB74              ;
 870+ AB74 CD 50 B1     SIN2:			CALL    SQUARE          ;PUSH X*X
 871+ AB77 CD 89 B1             		CALL    POLY
 872+ AB7A 71 D5                		DEFW    0D571H          ;b(8)
 873+ AB7C 78 4C                		DEFW    4C78H
 874+ AB7E 70                   		DEFB    70H
 875+ AB7F AF 94                		DEFW    94AFH           ;b(6)
 876+ AB81 03 B6                		DEFW    0B603H
 877+ AB83 76                   		DEFB    76H
 878+ AB84 C8 9C                		DEFW    9CC8H           ;b(4)
 879+ AB86 AA 2A                		DEFW    2AAAH
 880+ AB88 7B                   		DEFB    7BH
 881+ AB89 DD FF                		DEFW    0FFDDH          ;b(2)
 882+ AB8B FF FF                		DEFW    0FFFFH
 883+ AB8D 7E                   		DEFB    7EH
 884+ AB8E 00 00                		DEFW    0               ;b(0)
 885+ AB90 00 00                		DEFW    0
 886+ AB92 80                   		DEFB    80H
 887+ AB93 CD 5F B1             		CALL    POP5
 888+ AB96 F1           SIN3:			POP     AF
 889+ AB97 E6 04                		AND     4
 890+ AB99 C8                   		RET     Z
 891+ AB9A 0D                   		DEC     C
 892+ AB9B 0C                   		INC     C
 893+ AB9C C8                   		RET     Z               ;ZERO
 894+ AB9D CB FC                		SET     7,H             ;MAKE NEGATIVE
 895+ AB9F C9                   		RET
 896+ ABA0              ;
 897+ ABA0              ;Floating-point one:
 898+ ABA0              ;
 899+ ABA0 21 00 00     FONE:			LD      HL,0
 900+ ABA3 D9                   		EXX
 901+ ABA4 21 00 00             		LD      HL,0
 902+ ABA7 D9                   		EXX
 903+ ABA8 0E 80                		LD      C,80H
 904+ ABAA C9                   		RET
 905+ ABAB              ;
 906+ ABAB 11 00 00     DONE:			LD      DE,0
 907+ ABAE D9                   		EXX
 908+ ABAF 11 00 00             		LD      DE,0
 909+ ABB2 D9                   		EXX
 910+ ABB3 06 80                		LD      B,80H
 911+ ABB5 C9                   		RET
 912+ ABB6              ;
 913+ ABB6 11 0F 49     PIBY4:			LD      DE,490FH
 914+ ABB9 D9                   		EXX
 915+ ABBA 11 A2 DA             		LD      DE,0DAA2H
 916+ ABBD D9                   		EXX
 917+ ABBE 06 7F                		LD      B,7FH
 918+ ABC0 C9                   		RET
 919+ ABC1              ;
 920+ ABC1              ;EXP - Exponential function
 921+ ABC1              ;Result is floating-point numeric.
 922+ ABC1              ;
 923+ ABC1 CD 6D B0     EXP:			CALL    SFLOAT
 924+ ABC4 CD 41 AC     EXP0:			CALL    LN2             ;LN(2)
 925+ ABC7 D9                   		EXX
 926+ ABC8 1D           	        	DEC     E
 927+ ABC9 01 CF D1     		        LD      BC,0D1CFH       ;0.6931471805599453
 928+ ABCC D9                   		EXX
 929+ ABCD E5                   		PUSH    HL              ;H7=SIGN
 930+ ABCE CD F2 AF             		CALL    MOD48           ;"MODULUS"
 931+ ABD1 F1                   		POP     AF
 932+ ABD2 CB 7B                		BIT     7,E
 933+ ABD4 28 09                		JR      Z,EXP1
 934+ ABD6 17                   		RLA
 935+ ABD7 DA DC B0             		JP      C,ZERO
 936+ ABDA 3E 18                		LD      A,EXPRNG
 937+ ABDC C3 D0 A6             		JP      ERROR           ;"Exp range"
 938+ ABDF              ;
 939+ ABDF E6 80        EXP1:			AND     80H
 940+ ABE1 B3                   		OR      E
 941+ ABE2 F5                   		PUSH    AF              ;INTEGER PART
 942+ ABE3 CB BC                		RES     7,H
 943+ ABE5 CD 56 B1             		CALL    PUSH5           ;PUSH X*LN(2)
 944+ ABE8 CD 89 B1             		CALL    POLY
 945+ ABEB 72 40                		DEFW    4072H           ;a(7)
 946+ ABED 2E 94                		DEFW    942EH
 947+ ABEF 73                   		DEFB    73H
 948+ ABF0 65 6F                		DEFW    6F65H           ;a(6)
 949+ ABF2 4F 2E                		DEFW    2E4FH
 950+ ABF4 76                   		DEFB    76H
 951+ ABF5 37 6D                		DEFW    6D37H           ;a(5)
 952+ ABF7 02 88                		DEFW    8802H
 953+ ABF9 79                   		DEFB    79H
 954+ ABFA 12 E5                		DEFW    0E512H          ;a(4)
 955+ ABFC A0 2A                		DEFW    2AA0H
 956+ ABFE 7B                   		DEFB    7BH
 957+ ABFF 14 4F                		DEFW    4F14H           ;a(3)
 958+ AC01 AA AA                		DEFW    0AAAAH
 959+ AC03 7D                   		DEFB    7DH
 960+ AC04 56 FD                		DEFW    0FD56H          ;a(2)
 961+ AC06 FF 7F                		DEFW    7FFFH
 962+ AC08 7E                   		DEFB    7EH
 963+ AC09 FE FF                		DEFW    0FFFEH          ;a(1)
 964+ AC0B FF FF                		DEFW    0FFFFH
 965+ AC0D 7F                   		DEFB    7FH
 966+ AC0E 00 00                		DEFW    0               ;a(0)
 967+ AC10 00 00                		DEFW    0
 968+ AC12 80                   		DEFB    80H
 969+ AC13 CD 5F B1             		CALL    POP5
 970+ AC16 F1                   		POP     AF
 971+ AC17 F5                   		PUSH    AF
 972+ AC18 F4 38 AC             		CALL    P,RECIP         ;X=1/X
 973+ AC1B F1                   		POP     AF
 974+ AC1C F2 23 AC             		JP      P,EXP4
 975+ AC1F E6 7F                		AND     7FH
 976+ AC21 ED 44                		NEG
 977+ AC23 C6 80        EXP4:			ADD     A,80H
 978+ AC25 81                   		ADD     A,C
 979+ AC26 38 05                		JR      C,EXP2
 980+ AC28 F2 DC B0             		JP      P,ZERO          ;UNDERFLOW
 981+ AC2B 18 03                		JR      EXP3
 982+ AC2D FA AD B0     EXP2:			JP      M,OFLOW         ;OVERFLOW
 983+ AC30 C6 80        EXP3:			ADD     A,80H
 984+ AC32 CA DC B0             		JP      Z,ZERO
 985+ AC35 4F                   		LD      C,A
 986+ AC36 AF                   		XOR     A               ;NUMERIC MARKER
 987+ AC37 C9                   		RET
 988+ AC38              ;
 989+ AC38 CD AB AB     RECIP:			CALL    DONE
 990+ AC3B CD 97 B0     RDIV:			CALL    SWAP
 991+ AC3E C3 55 A8             		JP      FDIV            ;RECIPROCAL
 992+ AC41              ;
 993+ AC41 11 72 31     LN2:			LD      DE,3172H        ;LN(2)
 994+ AC44 D9                   		EXX
 995+ AC45 11 F8 17             		LD      DE,17F8H
 996+ AC48 D9                   		EXX
 997+ AC49 06 7F                		LD      B,7FH
 998+ AC4B C9                   		RET
 999+ AC4C              ;
1000+ AC4C              ;LN - Natural log.
1001+ AC4C              ;Result is floating-point numeric.
1002+ AC4C              ;
1003+ AC4C CD 6D B0     LN:			CALL    SFLOAT
1004+ AC4F 3E 16        LN0:			LD      A,LOGRNG
1005+ AC51 CB 7C                		BIT     7,H
1006+ AC53 C2 D0 A6             		JP      NZ,ERROR        ;"Log range"
1007+ AC56 0C                   		INC     C
1008+ AC57 0D                   		DEC     C
1009+ AC58 CA D0 A6             		JP      Z,ERROR
1010+ AC5B 11 04 35             		LD      DE,3504H        ;SQR(2)
1011+ AC5E D9                   		EXX
1012+ AC5F 11 33 F3             		LD      DE,0F333H       ;1.41421356237
1013+ AC62 D9                   		EXX
1014+ AC63 CD EE B0             		CALL    ICP0            ;MANTISSA>SQR(2)?
1015+ AC66 79                   		LD      A,C             ;EXPONENT
1016+ AC67 0E 80                		LD      C,80H           ;1 <= X < 2
1017+ AC69 38 02                		JR      C,LN4
1018+ AC6B 0D                   		DEC     C
1019+ AC6C 3C                   		INC     A
1020+ AC6D F5           LN4:			PUSH    AF              ;SAVE EXPONENT
1021+ AC6E CD 6B B1             		CALL    RATIO           ;X=(X-1)/(X+1)
1022+ AC71 CD 56 B1             		CALL    PUSH5
1023+ AC74 CD 50 B1     		        CALL    SQUARE          ;PUSH X*X
1024+ AC77 CD 89 B1             		CALL    POLY
1025+ AC7A 48 CC                		DEFW    0CC48H          ;a(9)
1026+ AC7C FB 74                		DEFW    74FBH
1027+ AC7E 7D                   		DEFB    7DH
1028+ AC7F AF AE                		DEFW    0AEAFH          ;a(7)
1029+ AC81 FF 11                		DEFW    11FFH
1030+ AC83 7E                   		DEFB    7EH
1031+ AC84 8C D9                		DEFW    0D98CH          ;a(5)
1032+ AC86 CD 4C                		DEFW    4CCDH
1033+ AC88 7E                   		DEFB    7EH
1034+ AC89 E3 A9                		DEFW    0A9E3H          ;a(3)
1035+ AC8B AA 2A                		DEFW    2AAAH
1036+ AC8D 7F                   		DEFB    7FH
1037+ AC8E 00 00                		DEFW    0               ;a(1)
1038+ AC90 00 00                		DEFW    0
1039+ AC92 81                   		DEFB    81H
1040+ AC93 CD 5F B1             		CALL    POP5
1041+ AC96 CD 5F B1             		CALL    POP5
1042+ AC99 CD E8 A8             		CALL    FMUL
1043+ AC9C F1                   		POP     AF              ;EXPONENT
1044+ AC9D CD 56 B1             		CALL    PUSH5
1045+ ACA0 08                   		EX      AF,AF'
1046+ ACA1 CD DC B0             		CALL    ZERO
1047+ ACA4 08                   		EX      AF,AF'
1048+ ACA5 D6 80                		SUB     80H
1049+ ACA7 28 1B                		JR      Z,LN3
1050+ ACA9 30 02                		JR      NC,LN1
1051+ ACAB 2F                   		CPL
1052+ ACAC 3C                   		INC     A
1053+ ACAD 67           LN1:			LD      H,A
1054+ ACAE 0E 87                		LD      C,87H
1055+ ACB0 F5                   		PUSH    AF
1056+ ACB1 CD 53 B0             		CALL    FLOAT
1057+ ACB4 CB BC                		RES     7,H
1058+ ACB6 CD 41 AC             		CALL    LN2
1059+ ACB9 CD E8 A8             		CALL    FMUL
1060+ ACBC F1                   		POP     AF
1061+ ACBD 30 05                		JR      NC,LN3
1062+ ACBF FA C4 AC             		JP      M,LN3
1063+ ACC2 CB FC                		SET     7,H
1064+ ACC4 CD 5F B1     LN3:			CALL    POP5
1065+ ACC7 CD FD A7             		CALL    FADD
1066+ ACCA AF                   		XOR     A
1067+ ACCB C9                   		RET
1068+ ACCC              ;
1069+ ACCC              ;LOG - base-10 logarithm.
1070+ ACCC              ;Result is floating-point numeric.
1071+ ACCC              ;
1072+ ACCC CD 4C AC     LOG:			CALL    LN
1073+ ACCF 11 5B 5E             		LD      DE,5E5BH        ;LOG(e)
1074+ ACD2 D9                   		EXX
1075+ ACD3 11 A9 D8             		LD      DE,0D8A9H
1076+ ACD6 D9                   		EXX
1077+ ACD7 06 7E                		LD      B,7EH
1078+ ACD9 CD E8 A8             		CALL    FMUL
1079+ ACDC AF                   		XOR     A
1080+ ACDD C9                   		RET
1081+ ACDE              ;
1082+ ACDE              ;ASN - Arc-sine
1083+ ACDE              ;Result is floating-point numeric.
1084+ ACDE              ;
1085+ ACDE CD 6D B0     ASN:			CALL    SFLOAT
1086+ ACE1 CD 56 B1             		CALL    PUSH5
1087+ ACE4 CD 48 B1             		CALL    COPY
1088+ ACE7 CD E8 A8             		CALL    FMUL
1089+ ACEA CD AB AB             		CALL    DONE
1090+ ACED CD ED A7             		CALL    RSUB
1091+ ACF0 CD AF AA             		CALL    SQR0
1092+ ACF3 CD 5F B1             		CALL    POP5
1093+ ACF6 0C                   		INC     C
1094+ ACF7 0D                   		DEC     C
1095+ ACF8 3E 02                		LD      A,2
1096+ ACFA D5                   		PUSH    DE
1097+ ACFB 28 70                		JR      Z,ACS1
1098+ ACFD D1                   		POP     DE
1099+ ACFE CD 3B AC             		CALL    RDIV
1100+ AD01 18 03                		JR      ATN0
1101+ AD03              ;
1102+ AD03              ;ATN - arc-tangent
1103+ AD03              ;Result is floating-point numeric.
1104+ AD03              ;
1105+ AD03 CD 6D B0     ATN:			CALL    SFLOAT
1106+ AD06 E5           ATN0:			PUSH    HL              ;SAVE SIGN
1107+ AD07 CB BC                		RES     7,H
1108+ AD09 11 13 54             		LD      DE,5413H        ;TAN(PI/8)=SQR(2)-1
1109+ AD0C D9                   		EXX
1110+ AD0D 11 D0 CC             		LD      DE,0CCD0H
1111+ AD10 D9                   		EXX
1112+ AD11 06 7E                		LD      B,7EH
1113+ AD13 CD EB B0             		CALL    FCP0            ;COMPARE
1114+ AD16 06 00                		LD      B,0
1115+ AD18 38 1C                		JR      C,ATN2
1116+ AD1A 11 82 1A             		LD      DE,1A82H        ;TAN(3*PI/8)=SQR(2)+1
1117+ AD1D D9                   		EXX
1118+ AD1E 11 9A 79             		LD      DE,799AH
1119+ AD21 D9                   		EXX
1120+ AD22 06 81                		LD      B,81H
1121+ AD24 CD EB B0             		CALL    FCP0            ;COMPARE
1122+ AD27 38 08                		JR      C,ATN1
1123+ AD29 CD 38 AC             		CALL    RECIP           ;X=1/X
1124+ AD2C 06 02                		LD      B,2
1125+ AD2E C3 36 AD             		JP      ATN2
1126+ AD31 CD 6B B1     ATN1:			CALL    RATIO           ;X=(X-1)/(X+1)
1127+ AD34 06 01                		LD      B,1
1128+ AD36 C5           ATN2:			PUSH    BC              ;SAVE FLAG
1129+ AD37 CD 56 B1             		CALL    PUSH5
1130+ AD3A CD 50 B1             		CALL    SQUARE          ;PUSH X*X
1131+ AD3D CD 89 B1             		CALL    POLY
1132+ AD40 35 F3                		DEFW    0F335H          ;a(13)
1133+ AD42 D8 37                		DEFW    37D8H
1134+ AD44 7B                   		DEFB    7BH
1135+ AD45 91 6B                		DEFW    6B91H           ;a(11)
1136+ AD47 B9 AA                		DEFW    0AAB9H
1137+ AD49 7C                   		DEFB    7CH
1138+ AD4A DE 41                		DEFW    41DEH           ;a(9)
1139+ AD4C 97 61                		DEFW    6197H
1140+ AD4E 7C                   		DEFB    7CH
1141+ AD4F 7B 9D                		DEFW    9D7BH           ;a(7)
1142+ AD51 37 92                		DEFW    9237H
1143+ AD53 7D                   		DEFB    7DH
1144+ AD54 5A 2A                		DEFW    2A5AH           ;a(5)
1145+ AD56 CC 4C                		DEFW    4CCCH
1146+ AD58 7D                   		DEFB    7DH
1147+ AD59 5C A9                		DEFW    0A95CH          ;a(3)
1148+ AD5B AA AA                		DEFW    0AAAAH
1149+ AD5D 7E                   		DEFB    7EH
1150+ AD5E 00 00                		DEFW    0               ;a(1)
1151+ AD60 00 00                		DEFW    0
1152+ AD62 80                   		DEFB    80H
1153+ AD63 CD 5F B1             		CALL    POP5
1154+ AD66 CD 5F B1             		CALL    POP5
1155+ AD69 CD E8 A8             		CALL    FMUL
1156+ AD6C F1                   		POP     AF
1157+ AD6D CD B6 AB     ACS1:			CALL    PIBY4           ;PI/4
1158+ AD70 1F                   		RRA
1159+ AD71 F5                   		PUSH    AF
1160+ AD72 DC FD A7             		CALL    C,FADD
1161+ AD75 F1                   		POP     AF
1162+ AD76 04                   		INC     B
1163+ AD77 1F                   		RRA
1164+ AD78 DC ED A7             		CALL    C,RSUB
1165+ AD7B F1                   		POP     AF
1166+ AD7C B7                   		OR      A
1167+ AD7D F0                   		RET     P
1168+ AD7E CB FC                		SET     7,H             ;MAKE NEGATIVE
1169+ AD80 AF                   		XOR     A
1170+ AD81 C9                   		RET
1171+ AD82              ;
1172+ AD82              ;ACS - Arc cosine=PI/2-ASN.
1173+ AD82              ;Result is floating point numeric.
1174+ AD82              ;
1175+ AD82 CD DE AC     ACS:			CALL    ASN
1176+ AD85 3E 02                		LD      A,2
1177+ AD87 F5                   		PUSH    AF
1178+ AD88 18 E3                		JR      ACS1
1179+ AD8A              ;
1180+ AD8A              ;Function STR - convert numeric value to ASCII string.
1181+ AD8A              ;   Inputs: HLH'L'C = integer or floating-point number
1182+ AD8A              ;           DE = address at which to store string
1183+ AD8A              ;           IX = address of @% format control
1184+ AD8A              ;  Outputs: String stored, with NUL terminator
1185+ AD8A              ;
1186+ AD8A              ;First normalise for decimal output:
1187+ AD8A              ;
1188+ AD8A CD 6D B0     STR:			CALL    SFLOAT
1189+ AD8D 06 00                		LD      B,0             ;DEFAULT PT. POSITION
1190+ AD8F CB 7C                		BIT     7,H             ;NEGATIVE?
1191+ AD91 28 06                		JR      Z,STR10
1192+ AD93 CB BC                		RES     7,H
1193+ AD95 3E 2D                		LD      A,'-'
1194+ AD97 12                   		LD      (DE),A          ;STORE SIGN
1195+ AD98 13                   		INC     DE
1196+ AD99 AF           STR10:			XOR     A               ;CLEAR A
1197+ AD9A B9                   		CP      C
1198+ AD9B 28 47                		JR      Z,STR2          ;ZERO
1199+ AD9D D5                   		PUSH    DE              ;SAVE TEXT POINTER
1200+ AD9E 78                   		LD      A,B
1201+ AD9F F5           STR11:			PUSH    AF              ;SAVE DECIMAL COUNTER
1202+ ADA0 79                   		LD      A,C             ;BINARY EXPONENT
1203+ ADA1 FE A1                		CP      161
1204+ ADA3 30 1A                		JR      NC,STR14
1205+ ADA5 FE 9B                		CP      155
1206+ ADA7 30 25                		JR      NC,STR15
1207+ ADA9 2F                   		CPL
1208+ ADAA FE E1                		CP      225
1209+ ADAC 38 02                		JR      C,STR13
1210+ ADAE 3E F8                		LD      A,-8
1211+ ADB0 C6 1C        STR13:			ADD     A,28
1212+ ADB2 CD B0 B1             		CALL    POWR10
1213+ ADB5 F5                   		PUSH    AF
1214+ ADB6 CD E8 A8             		CALL    FMUL
1215+ ADB9 F1                   		POP     AF
1216+ ADBA 47                   		LD      B,A
1217+ ADBB F1                   		POP     AF
1218+ ADBC 90                   		SUB     B
1219+ ADBD 18 E0                		JR      STR11
1220+ ADBF D6 20        STR14:			SUB     32
1221+ ADC1 CD B0 B1             		CALL    POWR10
1222+ ADC4 F5                   		PUSH    AF
1223+ ADC5 CD 55 A8             		CALL    FDIV
1224+ ADC8 F1                   		POP     AF
1225+ ADC9 47                   		LD      B,A
1226+ ADCA F1                   		POP     AF
1227+ ADCB 80                   		ADD     A,B
1228+ ADCC 18 D1                		JR      STR11
1229+ ADCE 3E 09        STR15:			LD      A,9
1230+ ADD0 CD B0 B1             		CALL    POWR10          ;10^9
1231+ ADD3 CD EB B0             		CALL    FCP0
1232+ ADD6 79                   		LD      A,C
1233+ ADD7 C1                   		POP     BC
1234+ ADD8 4F                   		LD      C,A
1235+ ADD9 CB FC                		SET     7,H             ;IMPLIED 1
1236+ ADDB DC 0D B1             		CALL    C,X10B          ;X10, DEC B
1237+ ADDE D1                   		POP     DE              ;RESTORE TEXT POINTER
1238+ ADDF CB B9                		RES     7,C
1239+ ADE1 3E 00                		LD      A,0
1240+ ADE3 17                   		RLA                     ;PUT CARRY IN LSB
1241+ ADE4              ;
1242+ ADE4              ;At this point decimal normalisation has been done,
1243+ ADE4              ;now convert to decimal digits:
1244+ ADE4              ;      AHLH'L' = number in normalised integer form
1245+ ADE4              ;            B = decimal place adjustment
1246+ ADE4              ;            C = binary place adjustment (29-33)
1247+ ADE4              ;
1248+ ADE4 0C           STR2:			INC     C
1249+ ADE5 08                   		EX      AF,AF'          ;SAVE A
1250+ ADE6 78                   		LD      A,B
1251+ ADE7 DD CB 02 4E          		BIT     1,(IX+2)
1252+ ADEB 20 08                		JR      NZ,STR20
1253+ ADED AF                   		XOR     A
1254+ ADEE DD BE 01             		CP      (IX+1)
1255+ ADF1 28 0A                		JR      Z,STR21
1256+ ADF3 3E F6                		LD      A,-10
1257+ ADF5 DD 86 01     STR20:			ADD     A,(IX+1)        ;SIG. FIG. COUNT
1258+ ADF8 B7                   		OR      A               ;CLEAR CARRY
1259+ ADF9 FA FD AD             		JP      M,STR21
1260+ ADFC AF                   		XOR     A
1261+ ADFD F5           STR21:			PUSH    AF
1262+ ADFE 08                   		EX      AF,AF'          ;RESTORE A
1263+ ADFF CD 36 B1     STR22:			CALL    X2              ;RL AHLH'L'
1264+ AE02 8F                   		ADC     A,A
1265+ AE03 FE 0A                		CP      10
1266+ AE05 38 05                		JR      C,STR23
1267+ AE07 D6 0A                		SUB     10
1268+ AE09 D9                   		EXX
1269+ AE0A 2C                   		INC     L               ;SET RESULT BIT
1270+ AE0B D9                   		EXX
1271+ AE0C 0D           STR23:			DEC     C
1272+ AE0D 20 F0                		JR      NZ,STR22        ;32 TIMES
1273+ AE0F 4F                   		LD      C,A             ;REMAINDER
1274+ AE10 7C                   		LD      A,H
1275+ AE11 E6 3F                		AND     3FH             ;CLEAR OUT JUNK
1276+ AE13 67                   		LD      H,A
1277+ AE14 F1                   		POP     AF
1278+ AE15 F2 22 AE             		JP      P,STR24
1279+ AE18 3C                   		INC     A
1280+ AE19 20 1C                		JR      NZ,STR26
1281+ AE1B 3E 04                		LD      A,4
1282+ AE1D B9                   		CP      C               ;ROUND UP?
1283+ AE1E 3E 00                		LD      A,0
1284+ AE20 18 15                		JR      STR26
1285+ AE22 F5           STR24:			PUSH    AF
1286+ AE23 79                   		LD      A,C
1287+ AE24 CE 30                		ADC     A,'0'           ;ADD CARRY
1288+ AE26 FE 30                		CP      '0'
1289+ AE28 28 05                		JR      Z,STR25         ;SUPPRESS ZERO
1290+ AE2A FE 3A                		CP      '9'+1
1291+ AE2C 3F                   		CCF
1292+ AE2D 30 08                		JR      NC,STR26
1293+ AE2F E3           STR25:			EX      (SP),HL
1294+ AE30 CB 75                		BIT     6,L             ;ZERO FLAG
1295+ AE32 E3           		        EX      (SP),HL
1296+ AE33 20 05                		JR      NZ,STR27
1297+ AE35 3E 30                		LD      A,'0'
1298+ AE37 3C           STR26:			INC     A               ;SET +VE
1299+ AE38 3D                   		DEC     A
1300+ AE39 F5                   		PUSH    AF              ;PUT ON STACK + CARRY
1301+ AE3A 04           STR27:			INC     B
1302+ AE3B CD BC B0             		CALL    TEST            ;IS HLH'L' ZERO?
1303+ AE3E 0E 20                		LD      C,32
1304+ AE40 3E 00                		LD      A,0
1305+ AE42 20 BB                		JR      NZ,STR22
1306+ AE44 F1                   		POP     AF
1307+ AE45 F5                   		PUSH    AF
1308+ AE46 3E 00                		LD      A,0
1309+ AE48 38 B5                		JR      C,STR22
1310+ AE4A              ;
1311+ AE4A              ;At this point, the decimal character string is stored
1312+ AE4A              ; on the stack. Trailing zeroes are suppressed and may
1313+ AE4A              ; need to be replaced.
1314+ AE4A              ;B register holds decimal point position.
1315+ AE4A              ;Now format number and store as ASCII string:
1316+ AE4A              ;
1317+ AE4A EB           STR3:			EX      DE,HL           ;STRING POINTER
1318+ AE4B 0E FF                		LD      C,-1            ;FLAG "E"
1319+ AE4D 16 01                		LD      D,1
1320+ AE4F DD 5E 01             		LD      E,(IX+1)        ;f2
1321+ AE52 DD CB 02 46          		BIT     0,(IX+2)
1322+ AE56 20 32                		JR      NZ,STR34        ;E MODE
1323+ AE58 DD CB 02 4E          		BIT     1,(IX+2)
1324+ AE5C 28 11                		JR      Z,STR31
1325+ AE5E 78                   		LD      A,B             ;F MODE
1326+ AE5F B7                   		OR      A
1327+ AE60 28 04                		JR      Z,STR30
1328+ AE62 FA 66 AE             		JP      M,STR30
1329+ AE65 50                   		LD      D,B
1330+ AE66 7A           STR30:			LD      A,D
1331+ AE67 DD 86 01             		ADD     A,(IX+1)
1332+ AE6A 5F                   		LD      E,A
1333+ AE6B FE 0B                		CP      11
1334+ AE6D 38 17                		JR      C,STR32
1335+ AE6F 78           STR31:			LD      A,B             ;G MODE
1336+ AE70 11 01 01             		LD      DE,101H
1337+ AE73 B7                   		OR      A
1338+ AE74 FA 8A AE             		JP      M,STR34
1339+ AE77 28 0D                		JR      Z,STR32
1340+ AE79 DD 7E 01             		LD      A,(IX+1)
1341+ AE7C B7                   		OR      A
1342+ AE7D 20 02                		JR      NZ,STR3A
1343+ AE7F 3E 0A                		LD      A,10
1344+ AE81 B8           STR3A:			CP      B
1345+ AE82 38 06                		JR      C,STR34
1346+ AE84 50                   		LD      D,B
1347+ AE85 58                   		LD      E,B
1348+ AE86 78           STR32:			LD      A,B
1349+ AE87 C6 81                		ADD     A,129
1350+ AE89 4F                   		LD      C,A
1351+ AE8A CB FA        STR34:			SET     7,D
1352+ AE8C 1D                   		DEC     E
1353+ AE8D 7A           STR35:			LD      A,D
1354+ AE8E B9                   		CP      C
1355+ AE8F 30 0C                		JR      NC,STR33
1356+ AE91 F1           STR36:			POP     AF
1357+ AE92 28 03                		JR      Z,STR37
1358+ AE94 F2 9F AE             		JP      P,STR38
1359+ AE97 F5           STR37:			PUSH    AF
1360+ AE98 1C                   		INC     E
1361+ AE99 1D                   		DEC     E
1362+ AE9A FA AE AE             		JP      M,STR4
1363+ AE9D 3E 30        STR33:			LD      A,'0'
1364+ AE9F 15           STR38:			DEC     D
1365+ AEA0 E2 A6 AE             		JP      PO,STR39
1366+ AEA3 36 2E                		LD      (HL),'.'
1367+ AEA5 23                   		INC     HL
1368+ AEA6 77           STR39:			LD      (HL),A
1369+ AEA7 23                   		INC     HL
1370+ AEA8 1D                   		DEC     E
1371+ AEA9 F2 8D AE             		JP      P,STR35
1372+ AEAC 18 E3                		JR      STR36
1373+ AEAE              ;
1374+ AEAE F1           STR4:			POP     AF
1375+ AEAF 0C           STR40:			INC     C
1376+ AEB0 4D                   		LD      C,L
1377+ AEB1 20 27                		JR      NZ,STR44
1378+ AEB3 36 45                		LD      (HL),'E'        ;EXPONENT
1379+ AEB5 23                   		INC     HL
1380+ AEB6 78                   		LD      A,B
1381+ AEB7 3D                   		DEC     A
1382+ AEB8 F2 C0 AE             		JP      P,STR41
1383+ AEBB 36 2D                		LD      (HL),'-'
1384+ AEBD 23                   		INC     HL
1385+ AEBE ED 44                		NEG
1386+ AEC0 36 30        STR41:			LD      (HL),'0'
1387+ AEC2 28 15                		JR      Z,STR47
1388+ AEC4 FE 0A                		CP      10
1389+ AEC6 47                   		LD      B,A
1390+ AEC7 3E 3A                		LD      A,':'
1391+ AEC9 38 03                		JR      C,STR42
1392+ AECB 23                   		INC     HL
1393+ AECC 36 30                		LD      (HL),'0'
1394+ AECE 34           STR42:			INC     (HL)
1395+ AECF BE                   		CP      (HL)
1396+ AED0 20 05                		JR      NZ,STR43
1397+ AED2 36 30                		LD      (HL),'0'
1398+ AED4 2B                   		DEC     HL
1399+ AED5 34                   		INC     (HL)
1400+ AED6 23                   		INC     HL
1401+ AED7 10 F5        STR43:			DJNZ    STR42
1402+ AED9 23           STR47:			INC     HL
1403+ AEDA EB           STR44:			EX      DE,HL
1404+ AEDB C9                 			RET
1405+ AEDC              ;
1406+ AEDC              ;Support subroutines:
1407+ AEDC              ;
1408+ AEDC DD 46 04     DLOAD5:			LD      B,(IX+4)
1409+ AEDF D9                   		EXX
1410+ AEE0 DD 5E 00             		LD      E,(IX+0)
1411+ AEE3 DD 56 01             		LD      D,(IX+1)
1412+ AEE6 D9                   		EXX
1413+ AEE7 DD 5E 02             		LD      E,(IX+2)
1414+ AEEA DD 56 03             		LD      D,(IX+3)
1415+ AEED C9                   		RET
1416+ AEEE              ;
1417+ AEEE              ;CON - Get unsigned numeric constant from ASCII string.
1418+ AEEE              ;   Inputs: ASCII string at (IX).
1419+ AEEE              ;  Outputs: Variable-type result in HLH'L'C
1420+ AEEE              ;           IX updated (points to delimiter)
1421+ AEEE              ;           A7 = 0 (numeric marker)
1422+ AEEE              ;
1423+ AEEE CD DC B0     CON:			CALL    ZERO            ;INITIALISE TO ZERO
1424+ AEF1 0E 00                		LD      C,0             ;TRUNCATION COUNTER
1425+ AEF3 CD 73 AF             		CALL    NUMBER          ;GET INTEGER PART
1426+ AEF6 FE 2E                		CP      '.'
1427+ AEF8 06 00                		LD      B,0             ;DECL. PLACE COUNTER
1428+ AEFA CC 71 AF             		CALL    Z,NUMBIX        ;GET FRACTION PART
1429+ AEFD FE 45                		CP      'E'
1430+ AEFF 3E 00                		LD      A,0             ;INITIALISE EXPONENT
1431+ AF01 CC 42 AF             		CALL    Z,GETEXP        ;GET EXPONENT
1432+ AF04 CB 7C                		BIT     7,H
1433+ AF06 20 08                		JR      NZ,CON0         ;INTEGER OVERFLOW
1434+ AF08 B7                   		OR      A
1435+ AF09 20 05                		JR      NZ,CON0         ;EXPONENT NON-ZERO
1436+ AF0B B8                   		CP      B
1437+ AF0C 20 02                		JR      NZ,CON0         ;DECIMAL POINT
1438+ AF0E B9                   		CP      C
1439+ AF0F C8                   		RET     Z               ;INTEGER
1440+ AF10 90           CON0:			SUB     B
1441+ AF11 81                   		ADD     A,C
1442+ AF12 0E 9F                		LD      C,159
1443+ AF14 CD 53 B0             		CALL    FLOAT
1444+ AF17 CB BC                		RES     7,H             ;DITCH IMPLIED 1
1445+ AF19 B7                   		OR      A
1446+ AF1A C8                   		RET     Z               ;DONE
1447+ AF1B FA 26 AF             		JP      M,CON2          ;NEGATIVE EXPONENT
1448+ AF1E CD B0 B1             		CALL    POWR10
1449+ AF21 CD E8 A8             		CALL    FMUL            ;SCALE
1450+ AF24 AF                   		XOR     A
1451+ AF25 C9                   		RET
1452+ AF26 FE DA        CON2:			CP      -38
1453+ AF28 38 0A                		JR      C,CON3          ;CAN'T SCALE IN ONE GO
1454+ AF2A ED 44                		NEG
1455+ AF2C CD B0 B1             		CALL    POWR10
1456+ AF2F CD 55 A8             		CALL    FDIV            ;SCALE
1457+ AF32 AF                   		XOR     A
1458+ AF33 C9                   		RET
1459+ AF34 F5           CON3:			PUSH    AF
1460+ AF35 3E 26                		LD      A,38
1461+ AF37 CD B0 B1             		CALL    POWR10
1462+ AF3A CD 55 A8             		CALL    FDIV
1463+ AF3D F1                   		POP     AF
1464+ AF3E C6 26                		ADD     A,38
1465+ AF40 18 E4                		JR      CON2
1466+ AF42              ;
1467+ AF42              ;GETEXP - Get decimal exponent from string
1468+ AF42              ;     Inputs: ASCII string at (IX)
1469+ AF42              ;             (IX points at 'E')
1470+ AF42              ;             A = initial value
1471+ AF42              ;    Outputs: A = new exponent
1472+ AF42              ;             IX updated.
1473+ AF42              ;   Destroys: A,A',IX,F,F'
1474+ AF42              ;
1475+ AF42 C5           GETEXP:			PUSH    BC              ;SAVE REGISTERS
1476+ AF43 47                   		LD      B,A             ;INITIAL VALUE
1477+ AF44 0E 02                		LD      C,2             ;2 DIGITS MAX
1478+ AF46 DD 23                		INC     IX              ;BUMP PAST 'E'
1479+ AF48 CD A7 B2             		CALL    SIGNQ
1480+ AF4B 08                   		EX      AF,AF'          ;SAVE EXPONENT SIGN
1481+ AF4C CD 9D B2     GETEX1:			CALL    DIGITQ
1482+ AF4F 38 17                		JR      C,GETEX2
1483+ AF51 78                   		LD      A,B             ;B=B*10
1484+ AF52 87                   		ADD     A,A
1485+ AF53 87                   		ADD     A,A
1486+ AF54 80                   		ADD     A,B
1487+ AF55 87                   		ADD     A,A
1488+ AF56 47                   		LD      B,A
1489+ AF57 DD 7E 00             		LD      A,(IX)          ;GET BACK DIGIT
1490+ AF5A DD 23                		INC     IX
1491+ AF5C E6 0F                		AND     0FH             ;MASK UNWANTED BITS
1492+ AF5E 80                   		ADD     A,B             ;ADD IN DIGIT
1493+ AF5F 47                   		LD      B,A
1494+ AF60 0D                   		DEC     C
1495+ AF61 F2 4C AF             		JP      P,GETEX1
1496+ AF64 06 64                		LD      B,100           ;FORCE OVERFLOW
1497+ AF66 18 E4                		JR      GETEX1
1498+ AF68 08           GETEX2:			EX      AF,AF'          ;RESTORE SIGN
1499+ AF69 FE 2D                		CP      '-'
1500+ AF6B 78                   		LD      A,B
1501+ AF6C C1                   		POP     BC              ;RESTORE
1502+ AF6D C0                   		RET     NZ
1503+ AF6E ED 44                		NEG                     ;NEGATE EXPONENT
1504+ AF70 C9                   		RET
1505+ AF71              ;
1506+ AF71              ;NUMBER: Get unsigned integer from string.
1507+ AF71              ;    Inputs: string at (IX)
1508+ AF71              ;            C = truncated digit count
1509+ AF71              ;                (initially zero)
1510+ AF71              ;            B = total digit count
1511+ AF71              ;            HLH'L' = initial value
1512+ AF71              ;   Outputs: HLH'L' = number (binary integer)
1513+ AF71              ;            A = delimiter.
1514+ AF71              ;            B, C & IX updated
1515+ AF71              ;  Destroys: A,B,C,D,E,H,L,B',C',D',E',H',L',IX,F
1516+ AF71              ;
1517+ AF71 DD 23        NUMBIX:			INC     IX
1518+ AF73 CD 9D B2     NUMBER:			CALL    DIGITQ
1519+ AF76 D8                   		RET     C
1520+ AF77 04                   		INC     B               ;INCREMENT DIGIT COUNT
1521+ AF78 DD 23                		INC     IX
1522+ AF7A CD 27 B1             		CALL    X10             ;*10 & COPY OLD VALUE
1523+ AF7D 38 13                		JR      C,NUMB1         ;OVERFLOW
1524+ AF7F 0D                   		DEC     C               ;SEE IF TRUNCATED
1525+ AF80 0C                   		INC     C
1526+ AF81 20 0F                		JR      NZ,NUMB1        ;IMPORTANT!
1527+ AF83 E6 0F                		AND     0FH
1528+ AF85 D9                   		EXX
1529+ AF86 06 00                		LD      B,0
1530+ AF88 4F                   		LD      C,A
1531+ AF89 09                   		ADD     HL,BC           ;ADD IN DIGIT
1532+ AF8A D9                   		EXX
1533+ AF8B 30 E6                		JR      NC,NUMBER
1534+ AF8D 23                   		INC     HL              ;CARRY
1535+ AF8E 7C                   		LD      A,H
1536+ AF8F B5                   		OR      L
1537+ AF90 20 E1                		JR      NZ,NUMBER
1538+ AF92 0C           NUMB1:			INC     C               ;TRUNCATION COUNTER
1539+ AF93 CD 9A B0             		CALL    SWAP1           ;RESTORE PREVIOUS VALUE
1540+ AF96 18 DB                		JR      NUMBER
1541+ AF98              ;
1542+ AF98              ;FIX - Fix number to specified exponent value.
1543+ AF98              ;    Inputs: HLH'L'C = +ve non-zero number (floated)
1544+ AF98              ;            A = desired exponent (A>C)
1545+ AF98              ;   Outputs: HLH'L'C = fixed number (unsigned)
1546+ AF98              ;            fraction shifted into B'C'
1547+ AF98              ;            A'F' positive if integer input
1548+ AF98              ;  Destroys: C,H,L,A',B',C',H',L',F,F'
1549+ AF98              ;
1550+ AF98 08           FIX:			EX      AF,AF'
1551+ AF99 AF                   		XOR     A
1552+ AF9A 08                   		EX      AF,AF'
1553+ AF9B CB FC                		SET     7,H             ;IMPLIED 1
1554+ AF9D CD 9F B0     FIX1:			CALL    DIV2
1555+ AFA0 B9                   		CP      C
1556+ AFA1 C8                   		RET     Z
1557+ AFA2 D2 9D AF             		JP      NC,FIX1
1558+ AFA5 C3 AD B0             		JP      OFLOW
1559+ AFA8              ;
1560+ AFA8              ;SFIX - Convert to integer if necessary.
1561+ AFA8              ;    Input: Variable-type number in HLH'L'C
1562+ AFA8              ;   Output: Integer in HLH'L', C=0
1563+ AFA8              ; Destroys: A,C,H,L,A',B',C',H',L',F,F'
1564+ AFA8              ;
1565+ AFA8              ;NEGATE - Negate HLH'L'
1566+ AFA8              ;    Destroys: H,L,H',L',F
1567+ AFA8              ;
1568+ AFA8 CD 97 B0     FIX2:			CALL    SWAP
1569+ AFAB CD B1 AF             		CALL    SFIX
1570+ AFAE CD 97 B0             		CALL    SWAP
1571+ AFB1 0D           SFIX:			DEC     C
1572+ AFB2 0C                   		INC     C
1573+ AFB3 C8                   		RET     Z               ;INTEGER/ZERO
1574+ AFB4 CB 7C                		BIT     7,H             ;SIGN
1575+ AFB6 F5                   		PUSH    AF
1576+ AFB7 3E 9F                		LD      A,159
1577+ AFB9 CD 98 AF             		CALL    FIX
1578+ AFBC F1                   		POP     AF
1579+ AFBD 0E 00                		LD      C,0
1580+ AFBF C8                   		RET     Z
1581+ AFC0 B7           NEGATE:			OR      A               ;CLEAR CARRY
1582+ AFC1 D9                   		EXX
1583+ AFC2 D5           NEG0:			PUSH    DE
1584+ AFC3 EB                   		EX      DE,HL
1585+ AFC4 21 00 00             		LD      HL,0
1586+ AFC7 ED 52                		SBC     HL,DE
1587+ AFC9 D1                   		POP     DE
1588+ AFCA D9                   		EXX
1589+ AFCB D5                   		PUSH    DE
1590+ AFCC EB                   		EX      DE,HL
1591+ AFCD 21 00 00             		LD      HL,0
1592+ AFD0 ED 52                		SBC     HL,DE
1593+ AFD2 D1                   		POP     DE
1594+ AFD3 C9                   		RET
1595+ AFD4              ;
1596+ AFD4              ;NEG - Negate HLH'L'B'C'
1597+ AFD4              ;    Also complements A (used in FADD)
1598+ AFD4              ;    Destroys: A,H,L,B',C',H',L',F
1599+ AFD4              ;
1600+ AFD4 D9           NEG:			EXX
1601+ AFD5 2F                   		CPL
1602+ AFD6 E5                   		PUSH    HL
1603+ AFD7 B7                   		OR      A               ;CLEAR CARRY
1604+ AFD8 21 00 00             		LD      HL,0
1605+ AFDB ED 42                		SBC     HL,BC
1606+ AFDD 44                   		LD      B,H
1607+ AFDE 4D                   		LD      C,L
1608+ AFDF E1                   		POP     HL
1609+ AFE0 18 E0                		JR      NEG0
1610+ AFE2              ;
1611+ AFE2              ;SCALE - Trig scaling.
1612+ AFE2              ;MOD48 - 48-bit floating-point "modulus" (remainder).
1613+ AFE2              ;   Inputs: HLH'L'C unsigned floating-point dividend
1614+ AFE2              ;           DED'E'B'C'B unsigned 48-bit FP divisor
1615+ AFE2              ;  Outputs: HLH'L'C floating point remainder (H7=1)
1616+ AFE2              ;           E = quotient (bit 7 is sticky)
1617+ AFE2              ; Destroys: A,B,C,D,E,H,L,B',C',D',E',H',L',IX,F
1618+ AFE2              ;FLO48 - Float unsigned number (48 bits)
1619+ AFE2              ;    Input/output in HLH'L'B'C'C
1620+ AFE2              ;   Destroys: C,H,L,B',C',H',L',F
1621+ AFE2              ;
1622+ AFE2 3E 96        SCALE:			LD      A,150
1623+ AFE4 B9                   		CP      C
1624+ AFE5 3E 17                		LD      A,ACLOST
1625+ AFE7 DA D0 A6             		JP      C,ERROR         ;"Accuracy lost"
1626+ AFEA CD B6 AB             		CALL    PIBY4
1627+ AFED D9                   		EXX
1628+ AFEE 01 69 21             		LD      BC,2169H        ;3.141592653589793238
1629+ AFF1 D9                   		EXX
1630+ AFF2 CB FA        MOD48:			SET     7,D             ;IMPLIED 1
1631+ AFF4 CB FC                		SET     7,H
1632+ AFF6 79                   		LD      A,C
1633+ AFF7 0E 00                		LD      C,0             ;INIT QUOTIENT
1634+ AFF9 DD 21 00 00          		LD      IX,0
1635+ AFFD DD E5                		PUSH    IX              ;PUT ZERO ON STACK
1636+ AFFF B8                   		CP      B
1637+ B000 38 3A                		JR      C,MOD485        ;DIVIDEND<DIVISOR
1638+ B002 D9           MOD481:			EXX                     ;CARRY=0 HERE
1639+ B003 E3                   		EX      (SP),HL
1640+ B004 ED 42                		SBC     HL,BC
1641+ B006 E3                   		EX      (SP),HL
1642+ B007 ED 52                		SBC     HL,DE
1643+ B009 D9                   		EXX
1644+ B00A ED 52                		SBC     HL,DE
1645+ B00C 30 09                		JR      NC,MOD482       ;DIVIDEND>=DIVISOR
1646+ B00E D9                   		EXX
1647+ B00F E3                   		EX      (SP),HL
1648+ B010 09                   		ADD     HL,BC
1649+ B011 E3                   		EX      (SP),HL
1650+ B012 ED 5A                		ADC     HL,DE
1651+ B014 D9                   		EXX
1652+ B015 ED 5A                		ADC     HL,DE
1653+ B017 3F           MOD482:			CCF
1654+ B018 CB 11                		RL      C               ;QUOTIENT
1655+ B01A 30 02                		JR      NC,MOD483
1656+ B01C CB F9                		SET     7,C             ;STICKY BIT
1657+ B01E 3D           MOD483:			DEC     A
1658+ B01F B8                   		CP      B
1659+ B020 38 19                		JR      C,MOD484        ;DIVIDEND<DIVISOR
1660+ B022 E3                   		EX      (SP),HL
1661+ B023 29                   		ADD     HL,HL           ;DIVIDEND * 2
1662+ B024 E3                   		EX      (SP),HL
1663+ B025 D9                   		EXX
1664+ B026 ED 6A                		ADC     HL,HL
1665+ B028 D9                   		EXX
1666+ B029 ED 6A                		ADC     HL,HL
1667+ B02B 30 D5                		JR      NC,MOD481       ;AGAIN
1668+ B02D B7                   		OR      A
1669+ B02E D9                   		EXX
1670+ B02F E3                   		EX      (SP),HL
1671+ B030 ED 42                		SBC     HL,BC           ;OVERFLOW, SO SUBTRACT
1672+ B032 E3                   		EX      (SP),HL
1673+ B033 ED 52                		SBC     HL,DE
1674+ B035 D9                   		EXX
1675+ B036 ED 52                		SBC     HL,DE
1676+ B038 B7                   		OR      A
1677+ B039 18 DC                		JR      MOD482
1678+ B03B              ;
1679+ B03B 3C           MOD484:			INC     A
1680+ B03C 59           MOD485:			LD      E,C             ;QUOTIENT
1681+ B03D 4F                   		LD      C,A             ;REMAINDER EXPONENT
1682+ B03E D9                   		EXX
1683+ B03F C1                   		POP     BC
1684+ B040 D9                   		EXX
1685+ B041 CB 7C        FLO48:			BIT     7,H
1686+ B043 C0                   		RET     NZ
1687+ B044 D9                   		EXX
1688+ B045 CB 21                		SLA     C
1689+ B047 CB 10                		RL      B
1690+ B049 ED 6A                		ADC     HL,HL
1691+ B04B D9                   		EXX
1692+ B04C ED 6A                		ADC     HL,HL
1693+ B04E 0D                   		DEC     C
1694+ B04F C2 41 B0             		JP      NZ,FLO48
1695+ B052 C9                   		RET
1696+ B053              ;
1697+ B053              ;Float unsigned number
1698+ B053              ;    Input/output in HLH'L'C
1699+ B053              ;   Destroys: C,H,L,H',L',F
1700+ B053              ;
1701+ B053 CB 7C        FLOAT:			BIT     7,H
1702+ B055 C0                   		RET     NZ
1703+ B056 D9                   		EXX                     ;SAME AS "X2"
1704+ B057 29                   		ADD     HL,HL           ;TIME-CRITICAL
1705+ B058 D9                   		EXX                     ;REGION
1706+ B059 ED 6A                		ADC     HL,HL           ;(BENCHMARKS)
1707+ B05B 0D                   		DEC     C
1708+ B05C C2 53 B0             		JP      NZ,FLOAT
1709+ B05F C9                   		RET
1710+ B060              ;
1711+ B060              ;SFLOAT - Convert to floating-point if necessary.
1712+ B060              ;    Input: Variable-type number in HLH'L'C
1713+ B060              ;    Output: Floating-point in HLH'L'C
1714+ B060              ;    Destroys: A,C,H,L,H',L',F
1715+ B060              ;
1716+ B060 08           FLOATA:			EX      AF,AF'
1717+ B061 C6 2A                		ADD     A,(RTABLE-DTABLE)/2
1718+ B063 08                   		EX      AF,AF'
1719+ B064 CD 97 B0     FLOAT2:			CALL    SWAP
1720+ B067 CD 6D B0             		CALL    SFLOAT
1721+ B06A CD 97 B0             		CALL    SWAP
1722+ B06D 0D           SFLOAT:			DEC     C
1723+ B06E 0C                   		INC     C
1724+ B06F C0                   		RET     NZ              ;ALREADY FLOATING-POINT
1725+ B070 CD BC B0             		CALL    TEST
1726+ B073 C8                   		RET     Z               ;ZERO
1727+ B074 7C                   		LD      A,H
1728+ B075 B7                   		OR      A
1729+ B076 FC C0 AF             		CALL    M,NEGATE
1730+ B079 0E 9F                		LD      C,159
1731+ B07B CD 53 B0             		CALL    FLOAT
1732+ B07E B7                   		OR      A
1733+ B07F F8                   		RET     M               ;NEGATIVE
1734+ B080 CB BC                		RES     7,H
1735+ B082 C9                   		RET
1736+ B083              ;
1737+ B083              ;ROUND UP
1738+ B083              ;Return with carry set if 32-bit overflow
1739+ B083              ;   Destroys: H,L,B',C',H',L',F
1740+ B083              ;
1741+ B083 D9           ADD1:			EXX
1742+ B084 01 01 00             		LD      BC,1
1743+ B087 09                   		ADD     HL,BC
1744+ B088 D9                   		EXX
1745+ B089 D0                   		RET     NC
1746+ B08A C5                   		PUSH    BC
1747+ B08B 01 01 00             		LD      BC,1
1748+ B08E 09                   		ADD     HL,BC
1749+ B08F C1                   		POP     BC
1750+ B090 C9                   		RET
1751+ B091              ;
1752+ B091              ;ODD - Add one if even, leave alone if odd.
1753+ B091              ; (Used to perform unbiassed rounding, i.e.
1754+ B091              ;  number is rounded up half the time)
1755+ B091              ;    Destroys: L',F (carry cleared)
1756+ B091              ;
1757+ B091 B7           ODD:			OR      A               ;CLEAR CARRY
1758+ B092 D9                   		EXX
1759+ B093 CB C5                		SET     0,L             ;MAKE ODD
1760+ B095 D9                   		EXX
1761+ B096 C9                   		RET
1762+ B097              ;
1763+ B097              ;SWAP - Swap arguments.
1764+ B097              ;    Exchanges DE,HL D'E',H'L' and B,C
1765+ B097              ;    Destroys: A,B,C,D,E,H,L,D',E',H',L'
1766+ B097              ;SWAP1 - Swap DEHL with D'E'H'L'
1767+ B097              ;    Destroys: D,E,H,L,D',E',H',L'
1768+ B097              ;
1769+ B097 79           SWAP:			LD      A,C
1770+ B098 48                   		LD      C,B
1771+ B099 47                   		LD      B,A
1772+ B09A EB           SWAP1:			EX      DE,HL
1773+ B09B D9                   		EXX
1774+ B09C EB                   		EX      DE,HL
1775+ B09D D9                   		EXX
1776+ B09E C9                   		RET
1777+ B09F              ;
1778+ B09F              ;DIV2 - destroys C,H,L,A',B',C',H',L',F,F'
1779+ B09F              ;INCC - destroys C,F
1780+ B09F              ;OFLOW
1781+ B09F              ;
1782+ B09F CD 3D B1     DIV2:			CALL    D2
1783+ B0A2 D9                   		EXX
1784+ B0A3 CB 18                		RR      B
1785+ B0A5 CB 19                		RR      C
1786+ B0A7 08                   		EX      AF,AF'
1787+ B0A8 B0                   		OR      B
1788+ B0A9 08                   		EX      AF,AF'
1789+ B0AA D9                   		EXX
1790+ B0AB 0C           INCC:			INC     C
1791+ B0AC C0                   		RET     NZ
1792+ B0AD 3E 14        OFLOW:			LD      A,TOOBIG
1793+ B0AF C3 D0 A6             		JP      ERROR           ;"Too big"
1794+ B0B2              ;
1795+ B0B2              ;FTEST - Test for zero & sign
1796+ B0B2              ;    Output: A=0 if zero, A=&40 if +ve, A=&C0 if -ve
1797+ B0B2              ;
1798+ B0B2 CD BC B0     FTEST:			CALL    TEST
1799+ B0B5 C8                   		RET     Z
1800+ B0B6 7C                   		LD      A,H
1801+ B0B7 E6 80                		AND     10000000B
1802+ B0B9 F6 40                		OR      01000000B
1803+ B0BB C9                   		RET
1804+ B0BC              ;
1805+ B0BC              ;TEST - Test HLH'L' for zero.
1806+ B0BC              ;    Output: Z-flag set & A=0 if HLH'L'=0
1807+ B0BC              ;    Destroys: A,F
1808+ B0BC              ;
1809+ B0BC 7C           TEST:			LD      A,H
1810+ B0BD B5                   		OR      L
1811+ B0BE D9                   		EXX
1812+ B0BF B4                   		OR      H
1813+ B0C0 B5                   		OR      L
1814+ B0C1 D9                   		EXX
1815+ B0C2 C9                   		RET
1816+ B0C3              ;
1817+ B0C3              ;FCOMP - Compare two numbers
1818+ B0C3              ;    Output: A=0 if equal, A=&40 if L>R, A=&C0 if L<R
1819+ B0C3              ;
1820+ B0C3 78           FCOMP:			LD      A,B
1821+ B0C4 B1                   		OR      C               ;Both integer?
1822+ B0C5 20 0A                		JR      NZ,FCOMP1
1823+ B0C7 CD D9 B0             		CALL    ICP
1824+ B0CA 3E 00        FCOMP0:			LD      A,0
1825+ B0CC C8                   		RET     Z               ;Equal
1826+ B0CD 3E 80                		LD      A,80H
1827+ B0CF 1F                   		RRA
1828+ B0D0 C9                   		RET
1829+ B0D1              ;
1830+ B0D1 CD 64 B0     FCOMP1:			CALL    FLOAT2          ;Float both
1831+ B0D4 CD E6 B0             		CALL    FCP
1832+ B0D7 18 F1                		JR      FCOMP0
1833+ B0D9              ;
1834+ B0D9              ;Integer and floating point compare.
1835+ B0D9              ;Sets carry & zero flags according to HLH'L'C-DED'E'B
1836+ B0D9              ;Result pre-set to FALSE
1837+ B0D9              ;ICP1, FCP1 destroy A,F
1838+ B0D9              ;
1839+ B0D9              ;ZERO - Return zero.
1840+ B0D9              ; Destroys: A,C,H,L,H',L'
1841+ B0D9              ;
1842+ B0D9 CD 05 B1     ICP:			CALL    ICP1
1843+ B0DC 3E 00        ZERO:			LD      A,0
1844+ B0DE D9                   		EXX
1845+ B0DF 67                   		LD      H,A
1846+ B0E0 6F                   		LD      L,A
1847+ B0E1 D9                   		EXX
1848+ B0E2 67                   		LD      H,A
1849+ B0E3 6F                   		LD      L,A
1850+ B0E4 4F                   		LD      C,A
1851+ B0E5 C9                   		RET
1852+ B0E6              ;
1853+ B0E6 CD F8 B0     FCP:			CALL    FCP1
1854+ B0E9 18 F1                		JR      ZERO            ;PRESET FALSE
1855+ B0EB              ;
1856+ B0EB 79           FCP0:			LD      A,C
1857+ B0EC B8                   		CP      B               ;COMPARE EXPONENTS
1858+ B0ED C0                   		RET     NZ
1859+ B0EE ED 52        ICP0:			SBC     HL,DE           ;COMP MANTISSA MSB
1860+ B0F0 19                   		ADD     HL,DE
1861+ B0F1 C0                   		RET     NZ
1862+ B0F2 D9                   		EXX
1863+ B0F3 ED 52                		SBC     HL,DE           ;COMP MANTISSA LSB
1864+ B0F5 19                   		ADD     HL,DE
1865+ B0F6 D9                   		EXX
1866+ B0F7 C9                   		RET
1867+ B0F8              ;
1868+ B0F8 7C           FCP1:			LD      A,H
1869+ B0F9 AA                   		XOR     D
1870+ B0FA 7C                   		LD      A,H
1871+ B0FB 17                   		RLA
1872+ B0FC F8                   		RET     M
1873+ B0FD 30 EC                		JR      NC,FCP0
1874+ B0FF CD EB B0             		CALL    FCP0
1875+ B102 C8                   		RET     Z               ;** V0.1 BUG FIX
1876+ B103 3F                   		CCF
1877+ B104 C9                   		RET
1878+ B105              ;
1879+ B105 7C           ICP1:			LD      A,H
1880+ B106 AA                   		XOR     D
1881+ B107 F2 EE B0             		JP      P,ICP0
1882+ B10A 7C                   		LD      A,H
1883+ B10B 17                   		RLA
1884+ B10C C9                   		RET
1885+ B10D              ;
1886+ B10D              ;ADD - Integer add.
1887+ B10D              ;Carry, sign & zero flags valid on exit
1888+ B10D              ;    Destroys: H,L,H',L',F
1889+ B10D              ;
1890+ B10D 05           X10B:			DEC     B
1891+ B10E 0C                   		INC     C
1892+ B10F CD 49 B1     X5:			CALL    COPY0
1893+ B112 CD 3C B1             		CALL    D2C
1894+ B115 CD 3C B1             		CALL    D2C
1895+ B118 08                   		EX      AF,AF'          ;SAVE CARRY
1896+ B119 D9           ADD:			EXX
1897+ B11A 19                   		ADD     HL,DE
1898+ B11B D9                   		EXX
1899+ B11C ED 5A                		ADC     HL,DE
1900+ B11E C9                   		RET
1901+ B11F              ;
1902+ B11F              ;SUB - Integer subtract.
1903+ B11F              ;Carry, sign & zero flags valid on exit
1904+ B11F              ;    Destroys: H,L,H',L',F
1905+ B11F              ;
1906+ B11F D9           SUB:			EXX
1907+ B120 B7                   		OR      A
1908+ B121 ED 52                		SBC     HL,DE
1909+ B123 D9                   		EXX
1910+ B124 ED 52                		SBC     HL,DE
1911+ B126 C9                   		RET
1912+ B127              ;
1913+ B127              ;X10 - unsigned integer * 10
1914+ B127              ;   Inputs: HLH'L' initial value
1915+ B127              ;  Outputs: DED'E' = initial HLH'L'
1916+ B127              ;           Carry bit set if overflow
1917+ B127              ;           If carry not set HLH'L'=result
1918+ B127              ; Destroys: D,E,H,L,D',E',H',L',F
1919+ B127              ;X2 - Multiply HLH'L' by 2 as 32-bit integer.
1920+ B127              ;    Carry set if MSB=1 before shift.
1921+ B127              ;    Sign set if MSB=1 after shift.
1922+ B127              ;    Destroys: H,L,H',L',F
1923+ B127              ;
1924+ B127 CD 49 B1     X10:			CALL    COPY0           ;DED'E'=HLH'L'
1925+ B12A CD 36 B1             		CALL    X2
1926+ B12D D8                   		RET     C               ;TOO BIG
1927+ B12E CD 36 B1             		CALL    X2
1928+ B131 D8                   		RET     C
1929+ B132 CD 19 B1             		CALL    ADD
1930+ B135 D8                   		RET     C
1931+ B136 D9           X2:			EXX
1932+ B137 29                   		ADD     HL,HL
1933+ B138 D9                   		EXX
1934+ B139 ED 6A                		ADC     HL,HL
1935+ B13B C9                   		RET
1936+ B13C              ;
1937+ B13C              ;D2 - Divide HLH'L' by 2 as 32-bit integer.
1938+ B13C              ;    Carry set if LSB=1 before shift.
1939+ B13C              ;    Destroys: H,L,H',L',F
1940+ B13C              ;
1941+ B13C 0C           D2C:			INC     C
1942+ B13D CB 3C        D2:			SRL     H
1943+ B13F CB 1D                		RR      L
1944+ B141 D9                   		EXX
1945+ B142 CB 1C                		RR      H
1946+ B144 CB 1D                		RR      L
1947+ B146 D9                   		EXX
1948+ B147 C9                   		RET
1949+ B148              ;
1950+ B148              ;COPY - COPY HLH'L'C INTO DED'E'B
1951+ B148              ;  Destroys: B,C,D,E,H,L,D',E',H',L'
1952+ B148              ;
1953+ B148 41           COPY:			LD      B,C
1954+ B149 54           COPY0:			LD      D,H
1955+ B14A 5D                   		LD      E,L
1956+ B14B D9                   		EXX
1957+ B14C 54                   		LD      D,H
1958+ B14D 5D                   		LD      E,L
1959+ B14E D9                   		EXX
1960+ B14F C9                   		RET
1961+ B150              ;
1962+ B150              ;SQUARE - PUSH X*X
1963+ B150              ;PUSH5 - PUSH HLH'L'C ONTO STACK.
1964+ B150              ;  Destroys: SP,IX
1965+ B150              ;
1966+ B150 CD 48 B1     SQUARE:			CALL    COPY
1967+ B153 CD E8 A8             		CALL    FMUL
1968+ B156 DD E1        PUSH5:			POP     IX              ;RETURN ADDRESS
1969+ B158 C5                   		PUSH    BC
1970+ B159 E5                   		PUSH    HL
1971+ B15A D9                   		EXX
1972+ B15B E5                   		PUSH    HL
1973+ B15C D9                   		EXX
1974+ B15D DD E9                		JP      (IX)            ;"RETURN"
1975+ B15F              ;
1976+ B15F              ;POP5 - POP DED'E'B OFF STACK.
1977+ B15F              ;  Destroys: A,B,D,E,D',E',SP,IX
1978+ B15F              ;
1979+ B15F DD E1        POP5:			POP     IX              ;RETURN ADDRESS
1980+ B161 D9                   		EXX
1981+ B162 D1                   		POP     DE
1982+ B163 D9                   		EXX
1983+ B164 D1                   		POP     DE
1984+ B165 79                   		LD      A,C
1985+ B166 C1                   		POP     BC
1986+ B167 41                   		LD      B,C
1987+ B168 4F                   		LD      C,A
1988+ B169 DD E9                		JP      (IX)            ;"RETURN"
1989+ B16B              ;
1990+ B16B              ;RATIO - Calculate (X-1)/(X+1)
1991+ B16B              ;    Inputs: X in HLH'L'C
1992+ B16B              ;   Outputs: (X-1)/(X+1) in HLH'L'C
1993+ B16B              ;  Destroys: Everything except IY,SP,I
1994+ B16B              ;
1995+ B16B CD 56 B1     RATIO:			CALL    PUSH5           ;SAVE X
1996+ B16E CD AB AB             		CALL    DONE
1997+ B171 CD FD A7             		CALL    FADD
1998+ B174 CD 5F B1             		CALL    POP5            ;RESTORE X
1999+ B177 CD 56 B1             		CALL    PUSH5           ;SAVE X+1
2000+ B17A CD 97 B0             		CALL    SWAP
2001+ B17D CD AB AB             		CALL    DONE
2002+ B180 CD E7 A7             		CALL    FSUB
2003+ B183 CD 5F B1             		CALL    POP5            ;RESTORE X+1
2004+ B186 C3 55 A8             		JP      FDIV
2005+ B189              ;
2006+ B189              ;POLY - Evaluate a polynomial.
2007+ B189              ;    Inputs: X in HLH'L'C and also stored at (SP+2)
2008+ B189              ;            Polynomial coefficients follow call.
2009+ B189              ;   Outputs: Result in HLH'L'C
2010+ B189              ;  Destroys: Everything except IY,SP,I
2011+ B189              ;Routine terminates on finding a coefficient >=1.
2012+ B189              ;Note: The last coefficient is EXECUTED on return
2013+ B189              ;      so must contain only innocuous bytes!
2014+ B189              ;
2015+ B189 DD 21 02 00  POLY:			LD      IX,2
2016+ B18D DD 39                		ADD     IX,SP
2017+ B18F DD E3                		EX      (SP),IX
2018+ B191 CD DC AE             		CALL    DLOAD5          ;FIRST COEFFICIENT
2019+ B194 CD E8 A8     POLY1:			CALL    FMUL
2020+ B197 11 05 00             		LD      DE,5
2021+ B19A DD 19                		ADD     IX,DE
2022+ B19C CD DC AE             		CALL    DLOAD5          ;NEXT COEFFICIENT
2023+ B19F DD E3                		EX      (SP),IX
2024+ B1A1 04                   		INC     B
2025+ B1A2 05                   		DEC     B               ;TEST
2026+ B1A3 FA FD A7             		JP      M,FADD
2027+ B1A6 CD FD A7             		CALL    FADD
2028+ B1A9 CD DC AE             		CALL    DLOAD5          ;X
2029+ B1AC DD E3                		EX      (SP),IX
2030+ B1AE 18 E4                		JR      POLY1
2031+ B1B0              ;
2032+ B1B0              ;POWR10 - Calculate power of ten.
2033+ B1B0              ;    Inputs: A=power of 10 required (A<128)
2034+ B1B0              ;            A=binary exponent to be exceeded (A>=128)
2035+ B1B0              ;   Outputs: DED'E'B = result
2036+ B1B0              ;            A = actual power of ten returned
2037+ B1B0              ;  Destroys: A,B,D,E,A',D',E',F,F'
2038+ B1B0              ;
2039+ B1B0 3C           POWR10:			INC     A
2040+ B1B1 08                   		EX      AF,AF'
2041+ B1B2 E5                   		PUSH    HL
2042+ B1B3 D9                   		EXX
2043+ B1B4 E5                   		PUSH    HL
2044+ B1B5 D9                   		EXX
2045+ B1B6 CD AB AB             		CALL    DONE
2046+ B1B9 CD 97 B0             		CALL    SWAP
2047+ B1BC AF                   		XOR     A
2048+ B1BD 08           POWR11:			EX      AF,AF'
2049+ B1BE 3D                   		DEC     A
2050+ B1BF 28 20                		JR      Z,POWR14        ;EXIT TYPE 1
2051+ B1C1 F2 C8 B1             		JP      P,POWR13
2052+ B1C4 B9                   		CP      C
2053+ B1C5 38 1A                		JR      C,POWR14        ;EXIT TYPE 2
2054+ B1C7 3C                   		INC     A
2055+ B1C8 08           POWR13:			EX      AF,AF'
2056+ B1C9 3C                   		INC     A
2057+ B1CA CB FC                		SET     7,H
2058+ B1CC CD 0F B1             		CALL    X5
2059+ B1CF 30 05                		JR      NC,POWR12
2060+ B1D1 08                   		EX      AF,AF'
2061+ B1D2 CD 3C B1             		CALL    D2C
2062+ B1D5 08                   		EX      AF,AF'
2063+ B1D6 08           POWR12:			EX      AF,AF'
2064+ B1D7 DC 83 B0             		CALL    C,ADD1          ;ROUND UP
2065+ B1DA 0C                   		INC     C
2066+ B1DB FA BD B1             		JP      M,POWR11
2067+ B1DE C3 AD B0             		JP      OFLOW
2068+ B1E1 CD 97 B0     POWR14:			CALL    SWAP
2069+ B1E4 CB BA                		RES     7,D
2070+ B1E6 D9                   		EXX
2071+ B1E7 E1                   		POP     HL
2072+ B1E8 D9                   		EXX
2073+ B1E9 E1                   		POP     HL
2074+ B1EA 08                   		EX      AF,AF'
2075+ B1EB C9                   		RET
2076+ B1EC              ;
2077+ B1EC              ;DIVA, DIVB - DIVISION PRIMITIVE.
2078+ B1EC              ;    Function: D'E'DE = H'L'HLD'E'DE / B'C'BC
2079+ B1EC              ;              Remainder in H'L'HL
2080+ B1EC              ;    Inputs: A = loop counter (normally -32)
2081+ B1EC              ;    Destroys: A,D,E,H,L,D',E',H',L',F
2082+ B1EC              ;
2083+ B1EC B7           DIVA:			OR      A               ;CLEAR CARRY
2084+ B1ED ED 42        DIV0:			SBC     HL,BC           ;DIVIDEND-DIVISOR
2085+ B1EF D9                   		EXX
2086+ B1F0 ED 42                		SBC     HL,BC
2087+ B1F2 D9                   		EXX
2088+ B1F3 30 05                		JR      NC,DIV1
2089+ B1F5 09                   		ADD     HL,BC           ;DIVIDEND+DIVISOR
2090+ B1F6 D9                   		EXX
2091+ B1F7 ED 4A                		ADC     HL,BC
2092+ B1F9 D9                   		EXX
2093+ B1FA 3F           DIV1:			CCF
2094+ B1FB CB 13        DIVC:			RL      E               ;SHIFT RESULT INTO DE
2095+ B1FD CB 12                		RL      D
2096+ B1FF D9                   		EXX
2097+ B200 CB 13                		RL      E
2098+ B202 CB 12                		RL      D
2099+ B204 D9                   		EXX
2100+ B205 3C                   		INC     A
2101+ B206 F0                   		RET     P
2102+ B207 ED 6A        DIVB:			ADC     HL,HL           ;DIVIDEND*2
2103+ B209 D9                   		EXX
2104+ B20A ED 6A                		ADC     HL,HL
2105+ B20C D9                   		EXX
2106+ B20D 30 DE                		JR      NC,DIV0
2107+ B20F B7                   		OR      A
2108+ B210 ED 42                		SBC     HL,BC           ;DIVIDEND-DIVISOR
2109+ B212 D9                   		EXX
2110+ B213 ED 42                		SBC     HL,BC
2111+ B215 D9                   		EXX
2112+ B216 37                   		SCF
2113+ B217 C3 FB B1             		JP      DIVC
2114+ B21A              ;
2115+ B21A              ;MULA, MULB - MULTIPLICATION PRIMITIVE.
2116+ B21A              ;    Function: H'L'HLD'E'DE = B'C'BC * D'E'DE
2117+ B21A              ;    Inputs: A = loop counter (usually -32)
2118+ B21A              ;            H'L'HL = 0
2119+ B21A              ;    Destroys: D,E,H,L,D',E',H',L',A,F
2120+ B21A              ;
2121+ B21A B7           MULA:			OR      A               ;CLEAR CARRY
2122+ B21B D9           MUL0:			EXX
2123+ B21C CB 1A                		RR      D               ;MULTIPLIER/2
2124+ B21E CB 1B                		RR      E
2125+ B220 D9                   		EXX
2126+ B221 CB 1A                		RR      D
2127+ B223 CB 1B                		RR      E
2128+ B225 30 05                		JR      NC,MUL1
2129+ B227 09                   		ADD     HL,BC           ;ADD IN MULTIPLICAND
2130+ B228 D9                   		EXX
2131+ B229 ED 4A                		ADC     HL,BC
2132+ B22B D9                   		EXX
2133+ B22C 3C           MUL1:			INC     A
2134+ B22D F0                   		RET     P
2135+ B22E D9           MULB:			EXX
2136+ B22F CB 1C                		RR      H               ;PRODUCT/2
2137+ B231 CB 1D                		RR      L
2138+ B233 D9                   		EXX
2139+ B234 CB 1C                		RR      H
2140+ B236 CB 1D                		RR      L
2141+ B238 C3 1B B2             		JP      MUL0
2142+ B23B              ;
2143+ B23B              ;SQRA, SQRB - SQUARE ROOT PRIMITIVES
2144+ B23B              ;    Function: B'C'BC = SQR (D'E'DE)
2145+ B23B              ;    Inputs: A = loop counter (normally -31)
2146+ B23B              ;            B'C'BCH'L'HL initialised to 0
2147+ B23B              ;  Destroys: A,B,C,D,E,H,L,B',C',D',E',H',L',F
2148+ B23B              ;
2149+ B23B ED 42        SQR1:		SBC     HL,BC
2150+ B23D D9                   		EXX
2151+ B23E ED 42                		SBC     HL,BC
2152+ B240 D9                   		EXX
2153+ B241 0C                   		INC     C
2154+ B242 30 07                		JR      NC,SQR2
2155+ B244 0D                   		DEC     C
2156+ B245 09                   		ADD     HL,BC
2157+ B246 D9                   		EXX
2158+ B247 ED 4A                		ADC     HL,BC
2159+ B249 D9                   		EXX
2160+ B24A 0D                   		DEC     C
2161+ B24B 3C           SQR2:			INC     A
2162+ B24C F0                   		RET     P
2163+ B24D CB 21        SQRA:			SLA     C
2164+ B24F CB 10                		RL      B
2165+ B251 D9                   		EXX
2166+ B252 CB 11                		RL      C
2167+ B254 CB 10                		RL      B
2168+ B256 D9                   		EXX
2169+ B257 0C                   		INC     C
2170+ B258 CB 23                		SLA     E
2171+ B25A CB 12                		RL      D
2172+ B25C D9                   		EXX
2173+ B25D CB 13                		RL      E
2174+ B25F CB 12                		RL      D
2175+ B261 D9                   		EXX
2176+ B262 ED 6A                		ADC     HL,HL
2177+ B264 D9                   		EXX
2178+ B265 ED 6A                		ADC     HL,HL
2179+ B267 D9                   		EXX
2180+ B268 CB 23                		SLA     E
2181+ B26A CB 12                		RL      D
2182+ B26C D9                   		EXX
2183+ B26D CB 13                		RL      E
2184+ B26F CB 12                		RL      D
2185+ B271 D9                   		EXX
2186+ B272 ED 6A                		ADC     HL,HL
2187+ B274 D9                   		EXX
2188+ B275 ED 6A                		ADC     HL,HL
2189+ B277 D9                   		EXX
2190+ B278 D2 3B B2             		JP      NC,SQR1
2191+ B27B B7           SQR3:			OR      A
2192+ B27C ED 42                		SBC     HL,BC
2193+ B27E D9                   		EXX
2194+ B27F ED 42                		SBC     HL,BC
2195+ B281 D9                   		EXX
2196+ B282 0C                   		INC     C
2197+ B283 C3 4B B2             		JP      SQR2
2198+ B286              ;
2199+ B286 29           SQRB:			ADD     HL,HL
2200+ B287 D9                   		EXX
2201+ B288 ED 6A                		ADC     HL,HL
2202+ B28A D9                   		EXX
2203+ B28B 38 EE                		JR      C,SQR3
2204+ B28D 3C                   		INC     A
2205+ B28E 0C                   		INC     C
2206+ B28F ED 42                		SBC     HL,BC
2207+ B291 D9                   		EXX
2208+ B292 ED 42                		SBC     HL,BC
2209+ B294 D9                   		EXX
2210+ B295 D0                   		RET     NC
2211+ B296 09                   		ADD     HL,BC
2212+ B297 D9                   		EXX
2213+ B298 ED 4A                		ADC     HL,BC
2214+ B29A D9                   		EXX
2215+ B29B 0D                   		DEC     C
2216+ B29C C9                   		RET
2217+ B29D              ;
2218+ B29D DD 7E 00     DIGITQ:			LD      A,(IX)
2219+ B2A0 FE 3A                		CP      '9'+1
2220+ B2A2 3F                   		CCF
2221+ B2A3 D8                   		RET     C
2222+ B2A4 FE 30                		CP      '0'
2223+ B2A6 C9                   		RET
2224+ B2A7              ;
2225+ B2A7 DD 7E 00     SIGNQ:			LD      A,(IX)
2226+ B2AA DD 23                		INC     IX
2227+ B2AC FE 20                		CP      ' '
2228+ B2AE 28 F7                		JR      Z,SIGNQ
2229+ B2B0 FE 2B                		CP      '+'
2230+ B2B2 C8                   		RET     Z
2231+ B2B3 FE 2D                		CP      '-'
2232+ B2B5 C8                   		RET     Z
2233+ B2B6 DD 2B                		DEC     IX
2234+ B2B8 C9                   		RET
2235+ B2B9
2236+ B2B9              			ENDMODULE
# file closed: h:\My Code\Breadboard Z80\Z80\BBC Basic\fpp.z80
  14  B2B9              			include "sorry.z80"
# file opened: h:\My Code\Breadboard Z80\Z80\BBC Basic\sorry.z80
   1+ B2B9              			MODULE SORRY
   2+ B2B9
   3+ B2B9              @CLG:
   4+ B2B9              @COLOUR:
   5+ B2B9              @DRAW:
   6+ B2B9              @ENVEL:
   7+ B2B9              @GCOL:
   8+ B2B9              @MODE:
   9+ B2B9              @MOVE:
  10+ B2B9              @PLOT:
  11+ B2B9              @SOUND:
  12+ B2B9              @ADVAL:
  13+ B2B9              @POINT:
  14+ B2B9              @GETIMS:
  15+ B2B9              @PUTIMS:
  16+ B2B9 AF           			XOR     A
  17+ B2BA CD 13 89     			CALL    EXTERR
  18+ B2BD 53 6F 72 72  			DEFM    'Sorry'
  18+ B2C1 79
  19+ B2C2 00           			DEFB    0
  20+ B2C3
  21+ B2C3              			ENDMODULE
# file closed: h:\My Code\Breadboard Z80\Z80\BBC Basic\sorry.z80
  15  B2C3              			include "patch.z80"
# file opened: h:\My Code\Breadboard Z80\Z80\BBC Basic\patch.z80
   1+ B2C3              			MODULE PATCH
   2+ B2C3
   3+ B2C3              ; CLRSCN: clears the screen.
   4+ B2C3              ;
   5+ B2C3 C9           @CLRSCN:		RET
   6+ B2C4
   7+ B2C4              ; PUTIME: set current time to DE:HL, in centiseconds.
   8+ B2C4              ;
   9+ B2C4 C9           @PUTIME:		RET
  10+ B2C5
  11+ B2C5              ; GETIME: return current time in DE:HL, in centiseconds.
  12+ B2C5              ;
  13+ B2C5 11 00 00     @GETIME:		LD DE, 0
  14+ B2C8 21 00 00      	  		LD HL, 0
  15+ B2CB C9           			RET
  16+ B2CC
  17+ B2CC              ; PUTCSR: move to cursor to x=DE, y=HL
  18+ B2CC              ;
  19+ B2CC C9           @PUTCSR:		RET
  20+ B2CD
  21+ B2CD              ; GETCSR: return cursor position in x=DE, y=HL
  22+ B2CD              ;
  23+ B2CD 11 00 00     @GETCSR:		LD DE,0
  24+ B2D0 21 00 00     			LD HL,0
  25+ B2D3 C9           			RET
  26+ B2D4
  27+ B2D4              ; OSRDCH: read a character in from the keyboard
  28+ B2D4              ;
  29+ B2D4 DB 00        @OSRDCH:		IN A,(0)
  30+ B2D6 C9           			RET
  31+ B2D7
  32+ B2D7              ; PROMPT: output the input prompt
  33+ B2D7              ;
  34+ B2D7 3E 3E        @PROMPT: 		LD A,'>'
  35+ B2D9
  36+ B2D9              ; OSWRCH: write a character out to the serial port
  37+ B2D9              ;
  38+ B2D9 D3 00        @OSWRCH:		OUT (0),A
  39+ B2DB C9           			RET
  40+ B2DC
  41+ B2DC              ;OSKEY - Read key with time-limit, test for ESCape.
  42+ B2DC              ;Main function is carried out in user patch.
  43+ B2DC              ;   Inputs: HL = time limit (centiseconds)
  44+ B2DC              ;  Outputs: Carry reset if time-out
  45+ B2DC              ;           If carry set A = character
  46+ B2DC              ; Destroys: A,H,L,F
  47+ B2DC              ;
  48+ B2DC 2B           @OSKEY:			DEC HL
  49+ B2DD 7C           			LD A,H
  50+ B2DE B5           			OR L
  51+ B2DF C8           			RET Z
  52+ B2E0 DB 00        			IN A,(0)
  53+ B2E2 28 F8        			JR Z,@OSKEY
  54+ B2E4 37           			SCF
  55+ B2E5 C9           			RET
  56+ B2E6              ;
  57+ B2E6              ;OSINIT - Initialise RAM mapping etc.
  58+ B2E6              ;If BASIC is entered by BBCBASIC FILENAME then file
  59+ B2E6              ;FILENAME.BBC is automatically CHAINed.
  60+ B2E6              ;   Outputs: DE = initial value of HIMEM (top of RAM)
  61+ B2E6              ;            HL = initial value of PAGE (user program)
  62+ B2E6              ;            Z-flag reset indicates AUTO-RUN.
  63+ B2E6              ;  Destroys: A,D,E,H,L,F
  64+ B2E6              ;
  65+ B2E6 AF           @OSINIT: 		XOR A
  66+ B2E7 11 FF FF              		LD DE,0xFFFF		;DE = HIMEM
  67+ B2EA 5F                    		LD E,A             	;PAGE BOUNDARY
  68+ B2EB 21 00 B7              		LD HL,@USER
  69+ B2EE C9                    		RET
  70+ B2EF
  71+ B2EF              ;
  72+ B2EF              ;OSLINE - Read/edit a complete line, terminated by CR.
  73+ B2EF              ;   Inputs: HL addresses destination buffer.
  74+ B2EF              ;           (L=0)
  75+ B2EF              ;  Outputs: Buffer filled, terminated by CR.
  76+ B2EF              ;           A=0.
  77+ B2EF              ; Destroys: A,B,C,D,E,H,L,F
  78+ B2EF              ;
  79+ B2EF DB 00        @OSLINE:		IN A,(0)
  80+ B2F1 B7           			OR A
  81+ B2F2 28 FB        			JR Z,OSLINE
  82+ B2F4 77           			LD (HL),A
  83+ B2F5 23           			INC HL
  84+ B2F6 FE 0D        			CP 0x0D
  85+ B2F8 28 05        			JR Z,1F
  86+ B2FA CD D9 B2     			CALL OSWRCH
  87+ B2FD 18 F0        			JR OSLINE
  88+ B2FF CD 90 8A     1:			CALL @CRLF
  89+ B302 A7           			AND A
  90+ B303 C9           			RET
  91+ B304
  92+ B304              ; Stuff not implemented yet
  93+ B304              ;
  94+ B304              @OSCLI:
  95+ B304              @OSBPUT:
  96+ B304              @OSBGET:
  97+ B304              @OSSTAT:
  98+ B304              @OSSHUT:
  99+ B304              @OSOPEN:
 100+ B304              @OSCALL:
 101+ B304              @OSSAVE:
 102+ B304              @OSLOAD:
 103+ B304              @GETPTR:
 104+ B304              @PUTPTR:
 105+ B304              @GETEXT:
 106+ B304              @RESET:
 107+ B304              @TEST20:
 108+ B304              @LTRAP:
 109+ B304              @TRAP:
 110+ B304 C9           			RET
 111+ B305
 112+ B305              			ENDMODULE
# file closed: h:\My Code\Breadboard Z80\Z80\BBC Basic\patch.z80
  16  B305              			include "ram.z80"
# file opened: h:\My Code\Breadboard Z80\Z80\BBC Basic\ram.z80
   1+ B305              ;
   2+ B305              ;RAM MODULE FOR BBC BASIC INTERPRETER
   3+ B305              ;FOR USE WITH VERSION 2.0 OF BBC BASIC
   4+ B305              ;*STANDARD CP/M DISTRIBUTION VERSION*
   5+ B305              ;(C) COPYRIGHT R.T.RUSSELL 31-12-1983
   6+ B305              ;
   7+ B305              			MODULE RAM
   8+ B305              ;
   9+ B305              ;n.b. ACCS, BUFFER & STAVAR must be on page boundaries.
  10+ B305              ;
  11+ B305 00 00 00...  			ALIGN 256
  12+ B400
  13+ B400 00 00 00...  @ACCS:			DEFS    256             ;STRING ACCUMULATOR
  14+ B500 00 00 00...  @BUFFER:		DEFS    256             ;STRING INPUT BUFFER
  15+ B600 00 00 00...  @STAVAR:		DEFS    27*4            ;STATIC VARIABLES
  16+ B66C              @OC:			EQU     STAVAR+15*4     ;CODE ORIGIN (O%)
  17+ B66C              @PC:			EQU     STAVAR+16*4     ;PROGRAM COUNTER (P%)
  18+ B66C 00 00 00...  @DYNVAR: 		DEFS    54*2            ;DYN. VARIABLE POINTERS
  19+ B6D8 00 00        @FNPTR:  		DEFS    2               ;DYN. FUNCTION POINTER
  20+ B6DA 00 00        @PROPTR: 		DEFS    2               ;DYN. PROCEDURE POINTER
  21+ B6DC              ;
  22+ B6DC 00 00        @PAGE:   		DEFS    2               ;START OF USER PROGRAM
  23+ B6DE 00 00        @TOP:    		DEFS    2               ;FIRST LOCN AFTER PROG.
  24+ B6E0 00 00        @LOMEM:  		DEFS    2               ;START OF DYN. STORAGE
  25+ B6E2 00 00        @FREE:   		DEFS    2               ;FIRST FREE-SPACE BYTE
  26+ B6E4 00 00        @HIMEM:  		DEFS    2               ;FIRST PROTECTED BYTE
  27+ B6E6              ;
  28+ B6E6 00 00        @LINENO: 		DEFS    2               ;LINE NUMBER
  29+ B6E8 00 00        @TRACEN:		DEFS    2               ;TRACE FLAG
  30+ B6EA 00 00        @AUTONO:		DEFS    2               ;AUTO FLAG
  31+ B6EC 00 00        @ERRTRP:		DEFS    2               ;ERROR TRAP
  32+ B6EE 00 00        @ERRTXT:		DEFS    2               ;ERROR MESSAGE POINTER
  33+ B6F0 00 00        @DATPTR:		DEFS    2               ;DATA POINTER
  34+ B6F2 00 00        @ERL:			DEFS    2               ;ERROR LINE
  35+ B6F4 00 00        @ERRLIN:		DEFS    2               ;"ON ERROR" LINE
  36+ B6F6 00 00 00...  @RANDOM:		DEFS    5               ;RANDOM NUMBER
  37+ B6FB 00           @COUNT:			DEFS    1               ;PRINT POSITION
  38+ B6FC 00           @WIDTH:			DEFS    1               ;PRINT WIDTH
  39+ B6FD 00           @ERR:			DEFS    1               ;ERROR NUMBER
  40+ B6FE 00           @LISTON:		DEFS    1               ;LISTO & OPT FLAG
  41+ B6FF 00           @INCREM:		DEFS    1               ;AUTO INCREMENT
  42+ B700
  43+ B700              			ENDMODULE
# file closed: h:\My Code\Breadboard Z80\Z80\BBC Basic\ram.z80
  17  B700
  18  B700              @USER:  		ENDMODULE
# file closed: h:\My Code\Breadboard Z80\Z80\BBC Basic\build.z80
